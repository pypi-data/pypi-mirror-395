"""This module provides the assets for extracting the camera frame acquisition timestamps from the .npz log archives
generated by behavior video cameras used in the Sun lab.
"""

from pathlib import Path  # noqa: TC003

import polars as pl
from sl_shared_assets import SessionData, ProcessingTracker
from ataraxis_video_system import extract_logged_camera_timestamps
from ataraxis_base_utilities import LogLevel, console
from sl_forgery.shared_assets import ProcessingTrackers

_CAMERA_OUTPUT_NAMES = {
    51: "face_camera_timestamps",
    62: "body_camera_timestamps",  # Formerly 'left_camera'.
    73: "right_camera_timestamps",  # LEGACY, deprecated in the current Mesoscope-VR system.
}
"""Maps supported camera log identifiers to output file names."""


def process_camera_timestamps(
    session_path: Path,
    log_id: int,
    job_id: str,
    workers: int = -1,
) -> None:
    """Reads the specified camera log .npz file and extracts the frame acquisition timestamps as an uncompressed
    .feather file.

    This function is used to process the log archives generated by Mesoscope-VR video cameras used in the Sun lab.
    It assumes that the data was logged using the assets from the ataraxis-video-system library.

    Args:
        session_path: The path to the session's data directory for which to process the camera log file.
        log_id: The unique identifier of the camera log file to process: 51 (face), 62 (body), or 73 (right).
        job_id: The unique hexadecimal identifier for this processing job.
        workers: The number of worker processes to use for extracting the camera frame timestamps in parallel. Setting
            this argument to a value less than 1 uses all available CPU cores. Setting this to a value of 1 conducts
            the processing sequentially.
    """
    # Loads the target session's data hierarchy into memory.
    session = SessionData.load(session_path=session_path)

    # Resolves the path to the processed log file.
    log_path = session.raw_data.behavior_data_path.joinpath(f"{log_id}_log.npz")

    # Resolves the output path based on the log ID.
    output_name = _CAMERA_OUTPUT_NAMES[log_id]
    output_path = session.processed_data.camera_data_path.joinpath(f"{output_name}.feather")

    # Initializes the processing tracker for this pipeline.
    tracker = ProcessingTracker(
        file_path=session.tracking_data.tracking_data_path.joinpath(ProcessingTrackers.BEHAVIOR)
    )

    # Marks the job as running.
    tracker.start_job(job_id=job_id)

    try:
        console.echo(message=f"Extracting video camera frame timestamps from '{log_id}' log file...")

        # Extracts timestamp data from the log archive using the function from ataraxis-video-system.
        timestamp_data = extract_logged_camera_timestamps(log_path=log_path, n_workers=workers)

        # Converts extracted data to Polars series.
        timestamps_series = pl.Series(name="frame_time_us", values=timestamp_data)

        # Saves extracted data using Feather format and no compression to support memory-mapping the file during
        # processing.
        timestamps_series.to_frame().write_ipc(file=output_path, compression="uncompressed")

        # Marks the job as successfully completed.
        tracker.complete_job(job_id=job_id)
        console.echo(message="Camera frame timestamp processing: Complete.", level=LogLevel.SUCCESS)

    # If the runtime encounters an error, marks the job as failed.
    except Exception:
        tracker.fail_job(job_id=job_id)
        raise
