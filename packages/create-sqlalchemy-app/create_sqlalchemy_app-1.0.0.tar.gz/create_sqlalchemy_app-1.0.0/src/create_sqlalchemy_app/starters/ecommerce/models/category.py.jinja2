"""
Category model for organizing products.
"""

from sqlalchemy import Column, ForeignKey, String, Text
from sqlalchemy.orm import relationship
{% if is_postgresql %}
from sqlalchemy.dialects.postgresql import UUID
import uuid
{% else %}
from sqlalchemy import String as UUID_TYPE
import uuid

def generate_uuid():
    return str(uuid.uuid4())
{% endif %}

from .base import Base


class Category(Base):
    """Product category with hierarchical support."""

    __tablename__ = "category"

{% if is_postgresql %}
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    parent_id = Column(UUID(as_uuid=True), ForeignKey("category.id", ondelete="SET NULL"), nullable=True)
{% else %}
    id = Column(String(36), primary_key=True, default=generate_uuid)
    parent_id = Column(String(36), ForeignKey("category.id", ondelete="SET NULL"), nullable=True)
{% endif %}

    name = Column(String(100), nullable=False, index=True)
    slug = Column(String(100), nullable=False, unique=True, index=True)
    description = Column(Text, nullable=True)
    image_url = Column(String(500), nullable=True)

    # Relationships
    products = relationship("Product", back_populates="category")

    # Self-referential for subcategories
    parent = relationship("Category", remote_side="Category.id", backref="children")

    def __repr__(self) -> str:
        return f"<Category(id={{ '{' }}self.id{{ '}' }}, name='{{ '{' }}self.name{{ '}' }}')>"
