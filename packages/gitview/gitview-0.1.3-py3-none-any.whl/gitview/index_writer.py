"""Generate index reports for multi-branch analysis."""

from pathlib import Path
from typing import List, Dict
from datetime import datetime

from .branches import BranchInfo


class IndexWriter:
    """Write index reports for multi-branch analysis."""

    @staticmethod
    def write_branch_index(
        branches: List[BranchInfo],
        output_dir: Path,
        repo_name: str
    ):
        """Write index.md with links to all branch reports.

        Args:
            branches: List of analyzed branches
            output_dir: Base output directory
            repo_name: Repository name
        """
        output_file = output_dir / "index.md"

        content = []
        content.append(f"# {repo_name} - Branch Analysis Index\n")
        content.append(f"**Generated:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
        content.append(f"**Total Branches Analyzed:** {len(branches)}\n")

        # Branch overview table
        content.append("## Branch Overview\n")
        content.append("| Branch | Type | Commits | Last Activity | Report |\n")
        content.append("|--------|------|---------|---------------|--------|\n")

        for branch in sorted(branches, key=lambda b: (b.is_remote, b.name)):
            branch_type = "Remote" if branch.is_remote else "Local"
            last_date = branch.last_commit_date[:10]  # Just the date part
            report_link = f"[View Report](./{branch.sanitized_name}/history_story.md)"

            content.append(
                f"| `{branch.name}` | {branch_type} | {branch.commit_count:,} | "
                f"{last_date} | {report_link} |\n"
            )

        # Statistics section
        content.append("\n## Statistics\n")

        local_branches = [b for b in branches if not b.is_remote]
        remote_branches = [b for b in branches if b.is_remote]
        total_commits = sum(b.commit_count for b in branches)

        content.append(f"- **Local Branches:** {len(local_branches)}\n")
        content.append(f"- **Remote Branches:** {len(remote_branches)}\n")
        content.append(f"- **Total Commits:** {total_commits:,}\n")
        content.append(f"- **Average Commits per Branch:** {total_commits // len(branches) if branches else 0:,}\n")

        # Remote grouping
        if remote_branches:
            content.append("\n### Remote Branch Distribution\n")
            remotes: Dict[str, int] = {}
            for branch in remote_branches:
                if branch.remote_name:
                    remotes[branch.remote_name] = remotes.get(branch.remote_name, 0) + 1

            for remote, count in sorted(remotes.items()):
                content.append(f"- **{remote}:** {count} branches\n")

        # Navigation section
        content.append("\n## Branch Reports\n")
        content.append("\nClick on any branch name below to view its detailed analysis:\n\n")

        # Group by type
        if local_branches:
            content.append("### Local Branches\n")
            for branch in sorted(local_branches, key=lambda b: b.name):
                content.append(f"- [{branch.name}](./{branch.sanitized_name}/history_story.md) "
                             f"({branch.commit_count:,} commits)\n")

        if remote_branches:
            content.append("\n### Remote Branches\n")
            # Group by remote
            by_remote: Dict[str, List[BranchInfo]] = {}
            for branch in remote_branches:
                remote = branch.remote_name or "unknown"
                if remote not in by_remote:
                    by_remote[remote] = []
                by_remote[remote].append(branch)

            for remote in sorted(by_remote.keys()):
                content.append(f"\n**{remote}:**\n")
                for branch in sorted(by_remote[remote], key=lambda b: b.short_name):
                    content.append(f"- [{branch.name}](./{branch.sanitized_name}/history_story.md) "
                                 f"({branch.commit_count:,} commits)\n")

        # About section
        content.append("\n---\n")
        content.append("\n## About This Report\n")
        content.append("\nThis index was generated by GitView's multi-branch analysis feature. ")
        content.append("Each branch has been analyzed independently to show its evolution over time.\n")
        content.append("\n**Report Contents:**\n")
        content.append("- **Executive Summary:** High-level overview for stakeholders\n")
        content.append("- **Timeline:** Chronological phases with key events\n")
        content.append("- **Full Narrative:** Complete story of the branch's evolution\n")
        content.append("- **Technical Evolution:** Architectural decisions and changes\n")
        content.append("- **Phase Details:** Detailed breakdown of each development phase\n")
        content.append("- **Statistics:** Comprehensive metrics and analysis\n")

        # Write file
        output_dir.mkdir(parents=True, exist_ok=True)
        output_file.write_text(''.join(content))

    @staticmethod
    def write_branch_metadata(
        branches: List[BranchInfo],
        output_dir: Path
    ):
        """Write branches.json with metadata about all branches.

        Args:
            branches: List of analyzed branches
            output_dir: Base output directory
        """
        import json

        output_file = output_dir / "branches.json"

        data = {
            'generated_at': datetime.now().isoformat(),
            'total_branches': len(branches),
            'branches': [b.to_dict() for b in branches]
        }

        output_dir.mkdir(parents=True, exist_ok=True)
        with open(output_file, 'w') as f:
            json.dump(data, f, indent=2)

    @staticmethod
    def write_simple_branch_list(
        branches: List[BranchInfo],
        output_dir: Path
    ):
        """Write a simple text file listing all branches.

        Args:
            branches: List of branches
            output_dir: Output directory
        """
        output_file = output_dir / "branches.txt"

        lines = []
        lines.append("Available Branches\n")
        lines.append("==================\n\n")

        local_branches = [b for b in branches if not b.is_remote]
        remote_branches = [b for b in branches if b.is_remote]

        if local_branches:
            lines.append("Local Branches:\n")
            for branch in sorted(local_branches, key=lambda b: b.name):
                lines.append(f"  - {branch.name} ({branch.commit_count:,} commits)\n")
            lines.append("\n")

        if remote_branches:
            lines.append("Remote Branches:\n")
            for branch in sorted(remote_branches, key=lambda b: b.name):
                lines.append(f"  - {branch.name} ({branch.commit_count:,} commits)\n")
            lines.append("\n")

        lines.append(f"Total: {len(branches)} branches\n")

        output_dir.mkdir(parents=True, exist_ok=True)
        output_file.write_text(''.join(lines))
