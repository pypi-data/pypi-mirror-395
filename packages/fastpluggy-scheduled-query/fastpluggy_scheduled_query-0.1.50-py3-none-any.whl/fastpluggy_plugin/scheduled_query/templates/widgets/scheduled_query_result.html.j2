<div class="card scheduled-query-result-widget">
    {% if widget.show_query_info and widget.scheduled_query %}
    <div class="card-header">
        <div class="d-flex align-items-center justify-content-between">
            <h3 class="card-title d-flex align-items-center">
                <i class="ti ti-database icon me-2"></i>
                {{ widget.scheduled_query.name }}
            </h3>
            <div class="card-options d-flex align-items-center">
                {% if widget.scheduled_query.enabled %}
                    <span class="badge bg-success d-inline-flex align-items-center">
                        <i class="ti ti-power me-1"></i> Enabled
                    </span>
                {% else %}
                    <span class="badge bg-secondary d-inline-flex align-items-center">
                        <i class="ti ti-power-off me-1"></i> Disabled
                    </span>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="card-body">
        {% if widget.result_type == "table" %}
            <div class="table-responsive">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h4 class="m-0">Query Results</h4>
                    <span class="badge bg-primary">{{ widget.processed_result.total_rows }} rows</span>
                </div>

                <table class="table table-vcenter card-table" id="query-result-table-{{ widget.widget_id }}">
                    <thead>
                        <tr>
                            {% for column in (widget.processed_result.columns or []) %}
                                <th>{{ column | replace('_', ' ') | title }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody class="limited-rows">
                        {% for row in (widget.processed_result.data_limited or []) %}
                        <tr>
                            {% for cell in row %}
                                <td>
                                    {{ cell }}
                                </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tbody class="all-rows" style="display: none;">
                        {% for row in (widget.processed_result.data or []) %}
                        <tr>
                            {% for cell in row %}
                                <td>
                                    {{ cell }}
                                </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                {% if widget.processed_result.total_rows > widget.max_table_rows %}
                <div class="text-center mt-3">
                    <button class="btn btn-sm btn-outline-primary toggle-rows-btn" data-table-id="query-result-table-{{ widget.widget_id }}">
                        <i class="ti ti-arrows-vertical me-1"></i>
                        <span class="btn-text">Show All ({{ widget.processed_result.total_rows }} rows)</span>
                    </button>
                    <div class="text-muted mt-2">
                        <small class="row-info">Showing first {{ widget.max_table_rows }} of {{ widget.processed_result.total_rows }} rows</small>
                    </div>
                </div>
                {% endif %}
            </div>

        {% elif widget.result_type == "error" %}
            <div class="alert alert-danger">
                <div class="d-flex align-items-center mb-2">
                    <i class="ti ti-alert-circle me-2"></i>
                    <strong>Execution Error</strong>
                </div>
                {% if widget.error_message %}
                <details class="cursor-pointer">
                    <summary class="mb-2">View Error Details</summary>
                    <pre class="bg-light p-2 rounded border text-wrap" style="white-space: pre-wrap; word-break: break-word;">{{ widget.error_message }}</pre>
                </details>
                {% endif %}
            </div>

        {% elif widget.result_type == "no_result" %}
            <div class="text-center py-4">
                <i class="ti ti-database-off icon icon-lg text-muted mb-3"></i>
                <h4 class="text-muted">No Result Available</h4>
                <p class="text-muted">This query hasn't been executed yet or produced no output.</p>
            </div>

        {% else %}
            <div class="alert alert-warning">
                <div class="d-flex align-items-center">
                    <i class="ti ti-alert-triangle me-2"></i>
                    <span>Unknown result format: {{ widget.result_type }}</span>
                </div>
            </div>
        {% endif %}
    </div>

    {% if widget.show_query_info and widget.scheduled_query %}
    <div class="card-footer sq-footer">
        {% if widget.show_execution_details %}
        <div class="sq-details-grid">
            <div class="p-1">
                <i class="ti ti-calendar-time me-2"></i>Frequency: <code>{{ widget.scheduled_query.cron_schedule }}</code>
            </div>

            <div class="p-1">
                <i class="ti ti-clock me-2"></i>Last Run: 
                {% if widget.execution_result and widget.execution_result.executed_at %}
                    {{ widget.execution_result.executed_at.strftime('%Y-%m-%d %H:%M:%S') if widget.execution_result.executed_at.strftime else widget.execution_result.executed_at }}
                {% else %}
                    <span class="text-muted">Never</span>
                {% endif %}
            </div>

            <div class="p-1">
                <i class="ti ti-hourglass me-2"></i>Duration: 
                {% if widget.execution_result and widget.execution_result.duration_ms %}
                    {{ widget.execution_result.duration_ms }} ms
                {% else %}
                    <span class="text-muted">N/A</span>
                {% endif %}
            </div>

            <div class="p-1">
                <i class="ti ti-activity me-2"></i>Status: 
                {% if widget.execution_result and widget.execution_result.status %}
                    {% set st = widget.execution_result.status %}
                    <span class="badge badge-sm {% if st == 'success' %}bg-success{% elif st == 'error' %}bg-danger{% else %}bg-secondary{% endif %}">
                        {{ st|title }}
                    </span>
                {% else %}
                    <span class="text-muted">N/A</span>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if widget.scheduled_query.grafana_metric_config %}
        <div class="sq-grafana-info {% if widget.show_execution_details %}mt-3{% endif %}">
            <div class="d-flex align-items-center">
                <i class="ti ti-chart-line me-2"></i>
                <small>
                    <strong>Grafana Export:</strong>
                    {{ widget.scheduled_query.grafana_metric_config.metric_name }}
                    {% if widget.scheduled_query.grafana_metric_config.labels and widget.scheduled_query.grafana_metric_config.labels.service %}
                        <span class="text-muted">({{ widget.scheduled_query.grafana_metric_config.labels.service }})</span>
                    {% endif %}
                </small>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<style>
.scheduled-query-result-widget .cursor-pointer { cursor: pointer; }
.scheduled-query-result-widget .cursor-pointer:hover { opacity: 0.9; }

/* Footer Styles */
.scheduled-query-result-widget .sq-footer {
    background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
    border-top: 2px solid #e9ecef;
    padding: 1rem 1.25rem;
}

/* Details Grid - 4 columns */
.scheduled-query-result-widget .sq-details-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
}

.scheduled-query-result-widget .sq-details-grid > div {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 0.5rem;
}

.scheduled-query-result-widget .sq-details-grid code {
    padding: 0.25rem 0.5rem;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 0.25rem;
    font-size: 0.8rem;
    color: #495057;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
}

.scheduled-query-result-widget .sq-details-grid .badge {
    font-size: 0.75rem;
    padding: 0.35rem 0.65rem;
    font-weight: 600;
}

/* Grafana Info */
.scheduled-query-result-widget .sq-grafana-info {
    padding: 0.75rem;
    background: #fff9e6;
    border: 1px solid #ffe69c;
    border-radius: 0.5rem;
    color: #856404;
}

.scheduled-query-result-widget .sq-grafana-info i {
    color: #ffc107;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .scheduled-query-result-widget .sq-details-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.toggle-rows-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const tableId = this.getAttribute('data-table-id');
            const table = document.getElementById(tableId);
            const limitedRows = table.querySelector('.limited-rows');
            const allRows = table.querySelector('.all-rows');
            const btnText = this.querySelector('.btn-text');
            const rowInfo = this.parentElement.querySelector('.row-info');
            
            if (limitedRows.style.display === 'none') {
                // Switch back to limited view
                limitedRows.style.display = '';
                allRows.style.display = 'none';
                btnText.textContent = 'Show All (' + allRows.querySelectorAll('tr').length + ' rows)';
                rowInfo.textContent = 'Showing first ' + limitedRows.querySelectorAll('tr').length + ' of ' + allRows.querySelectorAll('tr').length + ' rows';
            } else {
                // Switch to full view
                limitedRows.style.display = 'none';
                allRows.style.display = '';
                btnText.textContent = 'Show Less';
                rowInfo.textContent = 'Showing all ' + allRows.querySelectorAll('tr').length + ' rows';
            }
        });
    });
});
</script>
