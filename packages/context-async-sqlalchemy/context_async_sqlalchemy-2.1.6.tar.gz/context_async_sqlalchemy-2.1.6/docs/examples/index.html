<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Usage Examples - context-async-sqlalchemy</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Usage Examples";
        var mkdocs_page_input_path = "examples.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
    <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> context-async-sqlalchemy
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">context-async-sqlalchemy</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../problem">The Problem It Solves</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../getting_started">Getting Started</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Usage Examples</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#basic-usage">Basic usage</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#atomic">Atomic</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#manually-close-the-transaction-and-session">Manually close the transaction and session</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#multiple-sessions-and-concurrent-execution">Multiple sessions and concurrent execution</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#rollback">Rollback</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../api">API Reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../concurrent_queries">Concurrent SQL Queries</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../master_replica">Master/Replica or several databases at the same time</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../testing">Testing</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../how_middleware_works">How middleware works</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">context-async-sqlalchemy</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Usage Examples</li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="usage-examples">Usage examples</h1>
<p>You can see not only fragments of examples, but also
<a href="https://github.com/krylosov-aa/context-async-sqlalchemy/tree/main/examples">web application examples</a>.</p>
<h3 id="basic-usage">Basic usage</h3>
<pre><code class="language-python">from sqlalchemy import insert

from context_async_sqlalchemy import db_session

from ..database import connection
from ..models import ExampleTable


async def handler_with_db_session() -&gt; None:
    &quot;&quot;&quot;
    An example of a typical handle that uses a context session to work with
        a database.
    Autocommit or autorollback occurs automatically at the end of a request
        (in middleware).
    &quot;&quot;&quot;
    # Created a session (no connection to the database yet)
    # If you call db_session again, it will return the same session
    # even in child coroutines.
    session = await db_session(connection)

    stmt = insert(ExampleTable).values(text=&quot;example_with_db_session&quot;)

    # On the first request, a connection and transaction were opened
    await session.execute(stmt)

    # Commit will happen automatically
</code></pre>
<h3 id="atomic">Atomic</h3>
<pre><code class="language-python">from context_async_sqlalchemy import atomic_db_session, db_session
from sqlalchemy import insert

from ..database import connection
from ..models import ExampleTable


async def handler_with_db_session_and_atomic() -&gt; None:
    &quot;&quot;&quot;
    Let's imagine you already have a function that works with a contextual
    session, and its use case calls autocommit at the end of the request.
    You want to reuse this function, but you need to commit immediately,
        rather than wait for the request to complete.
    &quot;&quot;&quot;
    # the transaction will be committed or rolled back automatically
    # using the context manager
    async with atomic_db_session(connection):
        await _insert_1()

    # This is a new transaction in the same connection
    await _insert_1()


async def _insert_1() -&gt; None:
    session = await db_session(connection)
    stmt = insert(ExampleTable).values(
        text=&quot;example_with_db_session_and_atomic&quot;
    )
    await session.execute(stmt)
</code></pre>
<h3 id="manually-close-the-transaction-and-session">Manually close the transaction and session</h3>
<pre><code class="language-python">from context_async_sqlalchemy import (
    close_db_session,
    commit_db_session,
    db_session,
)
from sqlalchemy import insert

from ..database import connection
from ..models import ExampleTable


async def handler_with_db_session_and_manual_close() -&gt; None:
    &quot;&quot;&quot;
    An example of a handle that uses a session in context,
        but commits manually and even closes the session to release the
        connection.
    &quot;&quot;&quot;
    # new connect -&gt; new transaction -&gt; commit
    await _insert_1()
    # old connect -&gt; new transaction -&gt; commit -&gt; close connect
    await _insert_2()
    # new connect -&gt; new transaction
    await _insert_3()
    # same connect -&gt; same transaction
    await _insert_3()
    # autocommit


async def _insert_1() -&gt; None:
    session = await db_session(connection)
    stmt = insert(ExampleTable).values(
        text=&quot;example_with_db_session_and_manual_close&quot;
    )
    await session.execute(stmt)

    # Here we closed the transaction
    await session.commit()  # or await commit_db_session()


async def _insert_2() -&gt; None:
    session = await db_session(connection)
    stmt = insert(ExampleTable).values(
        text=&quot;example_with_db_session_and_manual_close&quot;
    )
    await session.execute(stmt)

    # Here we closed the transaction
    await commit_db_session(connection)

    # And here we closed the session = returned the connection to the pool
    # This is useful if, for example, at the beginning of the handle a
    # database query is needed, and then there is some other long-term work
    # and you don't want to keep the connection opened.
    await close_db_session(connection)


async def _insert_3() -&gt; None:
    session = await db_session(connection)
    stmt = insert(ExampleTable).values(
        text=&quot;example_with_db_session_and_manual_close&quot;
    )
    await session.execute(stmt)
</code></pre>
<h2 id="multiple-sessions-and-concurrent-execution">Multiple sessions and concurrent execution</h2>
<pre><code class="language-python">import asyncio

from context_async_sqlalchemy import (
    close_db_session,
    commit_db_session,
    db_session,
    new_non_ctx_atomic_session,
    new_non_ctx_session,
    run_in_new_ctx,
)
from sqlalchemy import insert

from ..database import connection
from ..models import ExampleTable


async def handler_multiple_sessions() -&gt; None:
    &quot;&quot;&quot;
    In some situations, you need to have multiple sessions running
        simultaneously. For example, to run several queries concurrently.

    You can also use these same techniques to create new sessions whenever you
        need them. Not necessarily just because of the concurrent processing.
    &quot;&quot;&quot;
    await asyncio.gather(
        _insert(),  # context session
        run_in_new_ctx(_insert),  # new context and session with autocommit
        run_in_new_ctx(  # new context and session with manual commit
            _insert_manual, &quot;example_multiple_sessions&quot;,
        ),
        _insert_non_ctx(),  # new non context session
        _insert_non_ctx_manual(),  # new non context session
    )


async def _insert() -&gt; None:
    session = await db_session(connection)
    stmt = insert(ExampleTable).values(text=&quot;example_multiple_sessions&quot;)
    await session.execute(stmt)


async def _insert_manual(text: str) -&gt; None:
    session = await db_session(connection)
    stmt = insert(ExampleTable).values(text=text)
    await session.execute(stmt)

    # You can manually commit the transaction if you want, but it is not
    #   necessary
    await commit_db_session(connection)

    # You can manually close the session if you want, but it is not necessary
    await close_db_session(connection)


async def _insert_non_ctx() -&gt; None:
    &quot;&quot;&quot;
    You don't have to use the context to work with sessions at all
    &quot;&quot;&quot;
    async with new_non_ctx_atomic_session(connection) as session:
        stmt = insert(ExampleTable).values(text=&quot;example_multiple_sessions&quot;)
        await session.execute(stmt)


async def _insert_non_ctx_manual() -&gt; None:
    &quot;&quot;&quot;
    You don't have to use the context to work with sessions at all
    &quot;&quot;&quot;
    async with new_non_ctx_session(connection) as session:
        stmt = insert(ExampleTable).values(text=&quot;example_multiple_sessions&quot;)
        await session.execute(stmt)
        await session.commit()
</code></pre>
<h3 id="rollback">Rollback</h3>
<pre><code class="language-python">from context_async_sqlalchemy import db_session
from sqlalchemy import insert

from ..database import connection
from ..models import ExampleTable


async def handler_with_db_session_and_exception() -&gt; None:
    &quot;&quot;&quot;
    let's imagine that an exception occurred.
    &quot;&quot;&quot;
    session = await db_session(connection)
    stmt = insert(ExampleTable).values(text=&quot;example_with_db_session&quot;)
    await session.execute(stmt)

    raise Exception(&quot;Some exception&quot;)
    # transaction will be automatically rolled back
</code></pre>
<pre><code class="language-python">from fastapi import HTTPException

from context_async_sqlalchemy import db_session
from sqlalchemy import insert

from ..database import connection
from ..models import ExampleTable


async def handler_with_db_session_and_http_exception() -&gt; None:
    &quot;&quot;&quot;
    let's imagine that an http exception occurred.
    &quot;&quot;&quot;
    session = await db_session(connection)
    stmt = insert(ExampleTable).values(text=&quot;example_with_db_session&quot;)
    await session.execute(stmt)

    raise HTTPException(status_code=500)
    # transaction will be automatically rolled back by status code
</code></pre>
<pre><code class="language-python">from context_async_sqlalchemy import db_session, rollback_db_session
from sqlalchemy import insert

from ..database import connection
from ..models import ExampleTable


async def handler_with_db_session_and_manual_rollback() -&gt; None:
    &quot;&quot;&quot;
    An example of a handle that uses a rollback
    &quot;&quot;&quot;
    # it's convenient this way
    await _insert()
    await rollback_db_session(connection)

    # but it's possible this way too
    await _insert()
    session = await db_session(connection)
    await session.rollback()


async def _insert() -&gt; None:
    session = await db_session(connection)
    stmt = insert(ExampleTable).values(
        text=&quot;example_with_db_session_and_manual_close&quot;
    )
    await session.execute(stmt)
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../getting_started" class="btn btn-neutral float-left" title="Getting Started"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../api" class="btn btn-neutral float-right" title="API Reference">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/krylosov-aa/context-async-sqlalchemy" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../getting_started" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../api" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
