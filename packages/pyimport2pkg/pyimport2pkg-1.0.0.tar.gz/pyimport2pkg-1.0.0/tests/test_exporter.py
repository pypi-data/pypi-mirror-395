"""Tests for the Exporter module - v0.2.0 comprehensive tests."""

import pytest
import json
from pathlib import Path
from io import StringIO

from pyimport2pkg import __version__
from pyimport2pkg.exporter import Exporter, export_requirements, export_json
from pyimport2pkg.models import ImportInfo, MappingResult, PackageCandidate, ImportContext


class TestExporterRequirementsTxt:
    """Test requirements.txt export."""

    def test_basic_export_format(self):
        """Test basic requirements.txt format is correct."""
        exporter = Exporter(include_comments=False)

        results = [
            MappingResult(
                import_info=ImportInfo.from_module_name("numpy"),
                resolved_package="numpy",
            ),
            MappingResult(
                import_info=ImportInfo.from_module_name("pandas"),
                resolved_package="pandas",
            ),
        ]

        content = exporter.export_requirements_txt(results)
        lines = content.strip().split("\n")

        # Should have exactly 2 packages, sorted alphabetically
        assert len(lines) == 2
        assert lines[0] == "numpy"
        assert lines[1] == "pandas"

    def test_export_with_comments_structure(self):
        """Test export with comments has correct structure."""
        exporter = Exporter(include_comments=True)

        results = [
            MappingResult(
                import_info=ImportInfo.from_module_name("numpy"),
                resolved_package="numpy",
            ),
        ]

        content = exporter.export_requirements_txt(results)

        # Check header
        assert "# Auto-generated by pyimport2pkg" in content
        assert "# Generated at:" in content
        # Check section header
        assert "# === Required packages ===" in content
        # Check package is included
        assert "\nnumpy\n" in content or content.endswith("numpy\n")

    def test_conditional_imports_section(self):
        """Test conditional imports (if块) have their own section."""
        exporter = Exporter(include_optional=True, include_comments=True)

        required = [
            MappingResult(
                import_info=ImportInfo.from_module_name("numpy"),
                resolved_package="numpy",
            ),
        ]

        optional = [
            MappingResult(
                import_info=ImportInfo(
                    module_name="pywin32",
                    top_level="pywin32",
                    context=ImportContext.CONDITIONAL,
                    is_optional=True,
                ),
                resolved_package="pywin32",
            ),
        ]

        content = exporter.export_requirements_txt(required, optional)

        # Check conditional section exists
        assert "# === Conditional imports" in content
        assert "platform" in content or "environment" in content
        # Check package is included (not commented out)
        assert "pywin32  # conditional" in content
        # Verify it's NOT a comment line (the package itself)
        lines = content.split("\n")
        pywin32_lines = [l for l in lines if "pywin32" in l and not l.startswith("# ===")]
        assert any(l.startswith("pywin32") for l in pywin32_lines)

    def test_try_except_imports_section(self):
        """Test try-except imports have their own section."""
        exporter = Exporter(include_optional=True, include_comments=True)

        required = [
            MappingResult(
                import_info=ImportInfo.from_module_name("requests"),
                resolved_package="requests",
            ),
        ]

        optional = [
            MappingResult(
                import_info=ImportInfo(
                    module_name="ujson",
                    top_level="ujson",
                    context=ImportContext.TRY_EXCEPT,
                    is_optional=True,
                ),
                resolved_package="ujson",
            ),
        ]

        content = exporter.export_requirements_txt(required, optional)

        # Check try-except section exists
        assert "# === Try-except imports" in content
        # Check English description
        assert "optional" in content or "dependencies" in content
        # Check package is included as actual entry (not commented)
        assert "ujson  # try_except" in content
        lines = content.split("\n")
        ujson_lines = [l for l in lines if "ujson" in l and not l.startswith("# ===")]
        assert any(l.startswith("ujson") for l in ujson_lines)

    def test_optional_packages_not_commented_by_default(self):
        """Test that optional packages are actual entries, not comments."""
        exporter = Exporter(include_optional=True)

        required = []
        optional = [
            MappingResult(
                import_info=ImportInfo(
                    module_name="ujson",
                    top_level="ujson",
                    context=ImportContext.TRY_EXCEPT,
                    is_optional=True,
                ),
                resolved_package="ujson",
            ),
        ]

        content = exporter.export_requirements_txt(required, optional)

        # The package line should NOT start with #
        lines = content.split("\n")
        ujson_line = next((l for l in lines if "ujson" in l and "# ===" not in l), None)
        assert ujson_line is not None
        assert not ujson_line.strip().startswith("# ujson")
        assert ujson_line.strip().startswith("ujson")

    def test_exclude_optional_excludes_optional_packages(self):
        """Test that exclude_optional=True excludes optional packages."""
        exporter = Exporter(include_optional=False)

        required = [
            MappingResult(
                import_info=ImportInfo.from_module_name("numpy"),
                resolved_package="numpy",
            ),
        ]

        optional = [
            MappingResult(
                import_info=ImportInfo(
                    module_name="ujson",
                    top_level="ujson",
                    context=ImportContext.TRY_EXCEPT,
                    is_optional=True,
                ),
                resolved_package="ujson",
            ),
        ]

        content = exporter.export_requirements_txt(required, optional)

        # ujson should not appear
        assert "ujson" not in content
        assert "numpy" in content

    def test_multiple_candidates_with_download_counts(self):
        """Test that multiple candidates show download counts."""
        exporter = Exporter(include_comments=True)

        results = [
            MappingResult(
                import_info=ImportInfo.from_module_name("cv2"),
                candidates=[
                    PackageCandidate("opencv-python", download_count=10_500_000),
                    PackageCandidate("opencv-contrib-python", download_count=2_100_000),
                    PackageCandidate("opencv-python-headless", download_count=1_800_000),
                ],
                resolved_package="opencv-python",
            ),
        ]

        content = exporter.export_requirements_txt(results)

        # Check section exists
        assert "# === Packages with multiple candidates ===" in content
        # Check download counts are formatted
        assert "10.5M" in content or "10.5M)" in content
        assert "2.1M" in content
        assert "1.8M" in content
        # Check alternatives are listed
        assert "opencv-contrib-python" in content
        assert "opencv-python-headless" in content

    def test_error_section_syntax_error(self):
        """Test that syntax errors are reported in output."""
        exporter = Exporter(include_comments=True)

        required = [
            MappingResult(
                import_info=ImportInfo.from_module_name("numpy"),
                resolved_package="numpy",
            ),
        ]

        errors = [
            ImportInfo(
                module_name="<syntax_error>",
                top_level="<syntax_error>",
                file_path=Path("broken.py"),
                line_number=10,
                warnings=["invalid syntax"],
            ),
        ]

        content = exporter.export_requirements_txt(required, errors=errors)

        # Check error section exists
        assert "# === Errors" in content
        assert "需要手动检查" in content or "Errors" in content
        # Check error details
        assert "Syntax Error" in content
        assert "broken.py" in content

    def test_error_section_dynamic_import(self):
        """Test that unresolvable dynamic imports are reported."""
        exporter = Exporter(include_comments=True)

        required = []
        errors = [
            ImportInfo(
                module_name="<dynamic>",
                top_level="<dynamic>",
                file_path=Path("utils.py"),
                line_number=25,
                warnings=["Dynamic import with non-literal argument"],
            ),
        ]

        content = exporter.export_requirements_txt(required, errors=errors)

        assert "# === Errors" in content
        assert "Dynamic Import" in content
        assert "utils.py:25" in content

    def test_export_to_file(self, tmp_path: Path):
        """Test exporting to a file works correctly."""
        exporter = Exporter(include_comments=False)

        results = [
            MappingResult(
                import_info=ImportInfo.from_module_name("numpy"),
                resolved_package="numpy",
            ),
            MappingResult(
                import_info=ImportInfo.from_module_name("pandas"),
                resolved_package="pandas",
            ),
        ]

        output_path = tmp_path / "requirements.txt"
        exporter.export_requirements_txt(results, output=output_path)

        assert output_path.exists()
        content = output_path.read_text()
        lines = [l for l in content.strip().split("\n") if l]
        assert lines == ["numpy", "pandas"]

    def test_unique_packages_deduplication(self):
        """Test that duplicate packages are properly deduplicated."""
        exporter = Exporter(include_comments=False)

        results = [
            MappingResult(
                import_info=ImportInfo.from_module_name("numpy"),
                resolved_package="numpy",
            ),
            MappingResult(
                import_info=ImportInfo.from_module_name("numpy.random"),
                resolved_package="numpy",
            ),
            MappingResult(
                import_info=ImportInfo.from_module_name("numpy.linalg"),
                resolved_package="numpy",
            ),
        ]

        content = exporter.export_requirements_txt(results)
        lines = [l for l in content.strip().split("\n") if l and not l.startswith("#")]

        # Should only have numpy once
        assert lines == ["numpy"]

    def test_sorted_output_alphabetically(self):
        """Test that packages are sorted alphabetically."""
        exporter = Exporter(include_comments=False)

        results = [
            MappingResult(
                import_info=ImportInfo.from_module_name("zlib"),
                resolved_package="zlib-wrapper",
            ),
            MappingResult(
                import_info=ImportInfo.from_module_name("aiohttp"),
                resolved_package="aiohttp",
            ),
            MappingResult(
                import_info=ImportInfo.from_module_name("numpy"),
                resolved_package="numpy",
            ),
        ]

        content = exporter.export_requirements_txt(results)
        lines = [l for l in content.strip().split("\n") if l and not l.startswith("#")]

        assert lines == ["aiohttp", "numpy", "zlib-wrapper"]

    def test_mixed_conditional_and_try_except(self):
        """Test output with both conditional and try-except imports."""
        exporter = Exporter(include_optional=True, include_comments=True)

        required = [
            MappingResult(
                import_info=ImportInfo.from_module_name("requests"),
                resolved_package="requests",
            ),
        ]

        optional = [
            MappingResult(
                import_info=ImportInfo(
                    module_name="pywin32",
                    top_level="pywin32",
                    context=ImportContext.CONDITIONAL,
                    is_optional=True,
                ),
                resolved_package="pywin32",
            ),
            MappingResult(
                import_info=ImportInfo(
                    module_name="ujson",
                    top_level="ujson",
                    context=ImportContext.TRY_EXCEPT,
                    is_optional=True,
                ),
                resolved_package="ujson",
            ),
        ]

        content = exporter.export_requirements_txt(required, optional)

        # Both sections should exist
        assert "# === Conditional imports" in content
        assert "# === Try-except imports" in content

        # Verify order: Required -> Conditional -> Try-except
        req_pos = content.find("# === Required")
        cond_pos = content.find("# === Conditional")
        try_pos = content.find("# === Try-except")

        assert req_pos < cond_pos < try_pos


class TestExporterJson:
    """Test JSON export."""

    def test_json_structure(self):
        """Test JSON output has correct structure."""
        exporter = Exporter()

        results = [
            MappingResult(
                import_info=ImportInfo.from_module_name("numpy"),
                resolved_package="numpy",
                source="guessed",
            ),
        ]

        content = exporter.export_json(results)
        data = json.loads(content)

        # Check structure
        assert "meta" in data
        assert "required" in data
        assert "optional" in data
        assert "unresolved" in data
        assert "warnings" in data

        # Check meta
        assert data["meta"]["tool"] == "pyimport2pkg"
        assert data["meta"]["version"] == __version__
        assert "generated_at" in data["meta"]

    def test_json_required_entry_format(self):
        """Test JSON required entry has correct format."""
        exporter = Exporter()

        results = [
            MappingResult(
                import_info=ImportInfo(
                    module_name="numpy.random",
                    top_level="numpy",
                    sub_modules=["random"],
                    file_path=Path("main.py"),
                    line_number=10,
                ),
                resolved_package="numpy",
                source="guessed",
            ),
        ]

        content = exporter.export_json(results)
        data = json.loads(content)

        entry = data["required"][0]
        assert entry["package"] == "numpy"
        assert entry["module"] == "numpy.random"
        assert entry["source"] == "guessed"
        assert "main.py" in entry["file"]
        assert entry["line"] == 10

    def test_json_with_alternatives(self):
        """Test JSON export includes alternatives."""
        exporter = Exporter()

        results = [
            MappingResult(
                import_info=ImportInfo.from_module_name("cv2"),
                candidates=[
                    PackageCandidate("opencv-python"),
                    PackageCandidate("opencv-contrib-python"),
                    PackageCandidate("opencv-python-headless"),
                ],
                resolved_package="opencv-python",
                source="hardcoded",
            ),
        ]

        content = exporter.export_json(results)
        data = json.loads(content)

        entry = data["required"][0]
        assert entry["package"] == "opencv-python"
        assert "alternatives" in entry
        assert set(entry["alternatives"]) == {"opencv-contrib-python", "opencv-python-headless"}

    def test_json_optional_entry_format(self):
        """Test JSON optional entry has correct format."""
        exporter = Exporter()

        required = []
        optional = [
            MappingResult(
                import_info=ImportInfo(
                    module_name="ujson",
                    top_level="ujson",
                    context=ImportContext.TRY_EXCEPT,
                    file_path=Path("utils.py"),
                    line_number=5,
                ),
                resolved_package="ujson",
            ),
        ]

        content = exporter.export_json(required, optional)
        data = json.loads(content)

        entry = data["optional"][0]
        assert entry["package"] == "ujson"
        assert entry["module"] == "ujson"
        assert entry["context"] == "try_except"
        assert "utils.py" in entry["file"]
        assert entry["line"] == 5

    def test_json_conditional_context(self):
        """Test JSON correctly identifies conditional context."""
        exporter = Exporter()

        optional = [
            MappingResult(
                import_info=ImportInfo(
                    module_name="pywin32",
                    top_level="pywin32",
                    context=ImportContext.CONDITIONAL,
                ),
                resolved_package="pywin32",
            ),
        ]

        content = exporter.export_json([], optional)
        data = json.loads(content)

        assert data["optional"][0]["context"] == "conditional"

    def test_json_to_file(self, tmp_path: Path):
        """Test JSON export to file."""
        exporter = Exporter()

        results = [
            MappingResult(
                import_info=ImportInfo.from_module_name("numpy"),
                resolved_package="numpy",
            ),
        ]

        output_path = tmp_path / "output.json"
        exporter.export_json(results, output=output_path)

        assert output_path.exists()
        data = json.loads(output_path.read_text())
        assert len(data["required"]) == 1
        assert data["required"][0]["package"] == "numpy"


class TestExporterSimpleList:
    """Test simple list export."""

    def test_simple_list_format(self):
        """Test simple list returns sorted list."""
        exporter = Exporter()

        results = [
            MappingResult(
                import_info=ImportInfo.from_module_name("zlib"),
                resolved_package="zlib-wrapper",
            ),
            MappingResult(
                import_info=ImportInfo.from_module_name("numpy"),
                resolved_package="numpy",
            ),
            MappingResult(
                import_info=ImportInfo.from_module_name("aiohttp"),
                resolved_package="aiohttp",
            ),
        ]

        packages = exporter.export_simple_list(results)

        # Should be sorted
        assert packages == ["aiohttp", "numpy", "zlib-wrapper"]

    def test_simple_list_deduplicates(self):
        """Test simple list deduplicates packages."""
        exporter = Exporter()

        results = [
            MappingResult(
                import_info=ImportInfo.from_module_name("numpy"),
                resolved_package="numpy",
            ),
            MappingResult(
                import_info=ImportInfo.from_module_name("numpy.random"),
                resolved_package="numpy",
            ),
        ]

        packages = exporter.export_simple_list(results)

        assert packages == ["numpy"]


class TestConvenienceFunctions:
    """Test convenience functions."""

    def test_export_requirements_with_optional_flag(self):
        """Test export_requirements with include_optional flag."""
        required_result = MappingResult(
            import_info=ImportInfo.from_module_name("numpy"),
            resolved_package="numpy",
        )
        optional_result = MappingResult(
            import_info=ImportInfo(
                module_name="ujson",
                top_level="ujson",
                context=ImportContext.TRY_EXCEPT,
                is_optional=True,
            ),
            resolved_package="ujson",
        )

        results = [required_result, optional_result]

        # Without include_optional (default False), only required
        content = export_requirements(results)
        assert "numpy" in content
        assert "ujson" not in content

        # With include_optional=True, both should be present
        content_with_optional = export_requirements(results, include_optional=True)
        assert "numpy" in content_with_optional
        assert "ujson" in content_with_optional

    def test_export_json_function(self):
        """Test export_json convenience function."""
        results = [
            MappingResult(
                import_info=ImportInfo.from_module_name("numpy"),
                resolved_package="numpy",
            ),
        ]

        content = export_json(results)
        data = json.loads(content)

        assert len(data["required"]) == 1
        assert data["required"][0]["package"] == "numpy"


class TestDownloadCountFormatting:
    """Test download count formatting."""

    def test_format_millions(self):
        """Test formatting millions of downloads."""
        exporter = Exporter()

        assert exporter._format_downloads(10_500_000) == "10.5M"
        assert exporter._format_downloads(1_000_000) == "1.0M"
        assert exporter._format_downloads(999_999_999) == "1000.0M"

    def test_format_thousands(self):
        """Test formatting thousands of downloads."""
        exporter = Exporter()

        assert exporter._format_downloads(500_000) == "500.0K"
        assert exporter._format_downloads(1_000) == "1.0K"
        assert exporter._format_downloads(999_999) == "1000.0K"

    def test_format_small_numbers(self):
        """Test formatting small numbers."""
        exporter = Exporter()

        assert exporter._format_downloads(500) == "500"
        assert exporter._format_downloads(1) == "1"

    def test_format_zero(self):
        """Test formatting zero."""
        exporter = Exporter()

        assert exporter._format_downloads(0) == ""
