# Tox configuration for Itential Python SDK
# Runs premerge tests across multiple Python versions

[tox]
# Define test environments for Python 3.10, 3.11, 3.12, and 3.13
envlist = py310,py311,py312,py313
# Skip missing interpreters (useful when not all versions are installed)
skip_missing_interpreters = true
# Use uv for faster dependency management
requires = tox-uv

[testenv]
# Use uv as the package installer via tox-uv plugin
runner = uv-venv-lock-runner
# Install dependencies from uv's dependency groups using --group flag
uv_sync_flags =
    --group
    dev
# Commands to run for each environment (matches premerge target)
commands =
    # Clean build artifacts
    python -c "import shutil; import pathlib; [shutil.rmtree(p, ignore_errors=True) for p in ['.pytest_cache', 'htmlcov', 'dist', 'build'] + list(pathlib.Path('.').rglob('*.egg-info')) + list(pathlib.Path('.').rglob('__pycache__'))]"
    # Run linting checks
    ruff check src/ipsdk
    ruff check tests
    # Run security analysis
    bandit -r src/ipsdk --configfile pyproject.toml
    # Run tests
    pytest tests -v

[testenv:py310]
basepython = python3.10

[testenv:py311]
basepython = python3.11

[testenv:py312]
basepython = python3.12

[testenv:py313]
basepython = python3.13

# Coverage environment for generating coverage reports
[testenv:coverage]
basepython = python3.13
uv_sync_flags =
    --group
    dev
commands =
    pytest --cov=src/ipsdk --cov-report=term --cov-report=html tests/

# Format environment for code formatting
[testenv:format]
basepython = python3.13
uv_sync_flags =
    --group
    dev
commands =
    ruff format src/ipsdk tests

# Quick environment for running only tests (no lint/security)
[testenv:quick]
basepython = python3.13
uv_sync_flags =
    --group
    dev
commands =
    pytest tests -v
