"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9484],{3120:(e,t,o)=>{o.d(t,{_:()=>i});var a=o(704);function n(){let e=window.location.hostname,t=window.location.pathname,o=t.startsWith("/agent/");if("agents.ciris.ai"!==e&&!o)return{mode:"standalone",agentId:"default",apiBase:"/v1"};{let e="default";e=o?t.split("/")[2]||"default":localStorage.getItem("selectedAgentId")||"default";let a="/api/".concat(e,"/v1");return{mode:"managed",agentId:e,apiBase:a}}}var r=o(5950);class s{configure(e,t){let o,{mode:a}=n();if("managed"===a)o="".concat(window.location.origin,"/api/").concat(e);else{let t=localStorage.getItem("agent_".concat(e,"_api_url"));o=t||window.location.origin}t||(t=r.a.getAccessToken()||void 0);let s={baseURL:o,authToken:t,agentId:e,mode:a};return this.hasConfigChanged(s)&&this.applyConfiguration(s),s}configureForOAuthCallback(e,t){let o,{mode:a}=n(),r={baseURL:"managed"===a?"".concat(window.location.origin,"/api/").concat(e):window.location.origin,authToken:t,agentId:e,mode:a};return this.applyConfiguration(r),this.storeConfiguration(r),r}getCurrentConfig(){return this.currentConfig}isConfiguredFor(e){return!!this.currentConfig&&this.currentConfig.agentId===e&&!!this.currentConfig.authToken}clear(){this.currentConfig=null,localStorage.removeItem("sdk_config"),this.log("SDK configuration cleared")}applyConfiguration(e){this.log("Applying SDK configuration:",e),a.AQ.setConfig({baseURL:e.baseURL,authToken:e.authToken}),this.currentConfig=e,this.log("SDK configured successfully")}hasConfigChanged(e){return!this.currentConfig||this.currentConfig.baseURL!==e.baseURL||this.currentConfig.authToken!==e.authToken||this.currentConfig.agentId!==e.agentId||this.currentConfig.mode!==e.mode}storeConfiguration(e){let t={baseURL:e.baseURL,agentId:e.agentId,mode:e.mode};localStorage.setItem("sdk_config",JSON.stringify(t)),"standalone"===e.mode&&e.baseURL!==window.location.origin&&localStorage.setItem("agent_".concat(e.agentId,"_api_url"),e.baseURL)}restoreConfiguration(){let e=localStorage.getItem("sdk_config");if(!e)return null;try{let t=JSON.parse(e),o=r.a.getAccessToken()||void 0;return{...t,authToken:o}}catch(e){return null}}log(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];this.debugMode&&console.log("[SDKConfigManager]",...t)}constructor(){this.currentConfig=null,this.debugMode=!1}}let i=new s},9484:(e,t,o)=>{o.d(t,{A:()=>g,O:()=>u});var a=o(4568),n=o(7620),r=o(2942),s=o(3237),i=o(704),l=o(3120);let c=(0,n.createContext)(void 0);function u(e){let{children:t}=e,[o,u]=(0,n.useState)(null),[g,d]=(0,n.useState)(!0),[h,p]=(0,n.useState)(null),_=(0,r.useRouter)();(0,n.useEffect)(()=>{let e=window.location.pathname;"/login"===e||e.startsWith("/manager")?d(!1):f().then(e=>{e||I()});let t=localStorage.getItem("manager_token");t&&p(t);let o=e=>{if("true"===sessionStorage.getItem("ciris_native_auth_event_handled"))return void console.log("[AuthContext] Native auth ready event received but already handled - skipping");console.log("[AuthContext] Native auth ready event received - processing"),sessionStorage.setItem("ciris_native_auth_event_handled","true"),f()};return window.addEventListener("ciris_native_auth_ready",o),()=>{window.removeEventListener("ciris_native_auth_ready",o)}},[]);let m=()=>{console.log("[AuthContext] doSetupRedirect - setting redirect lock and navigating to /setup"),sessionStorage.setItem("ciris_redirect_in_progress","true"),sessionStorage.setItem("ciris_last_redirect_time",Date.now().toString()),window.location.href="/setup"},A=async()=>{let e=localStorage.getItem("ciris_show_setup");console.log("[AuthContext] checkSetupStatusFromAPI called - localStorage flag:",e);try{let e=await fetch("/v1/setup/status");if(console.log("[AuthContext] Setup status API response code:",e.status),e.ok){let t=await e.json();console.log("[AuthContext] Setup status API raw response:",JSON.stringify(t));let o=t.data||t;console.log("[AuthContext] Setup status unwrapped data:",JSON.stringify(o));let a=o.setup_required,n=o.setup_complete||o.is_complete||o.completed||o.isComplete;if(console.log("[AuthContext] API fields - setup_required:",a,"(type:",typeof a,"), isComplete:",n),!1===a||!0===n)return console.log("[AuthContext] API confirms setup is COMPLETE (setup_required=false or isComplete=true)"),localStorage.setItem("ciris_show_setup","false"),!1;if(!0===a)return console.log("[AuthContext] API confirms setup is REQUIRED (setup_required=true)"),!0;return console.log("[AuthContext] API response unclear, assuming setup IS needed"),!0}console.warn("[AuthContext] Setup status API returned non-OK:",e.status)}catch(e){console.warn("[AuthContext] Failed to check setup status from API:",e)}let t="true"===e;return console.log("[AuthContext] Using localStorage fallback - setup needed:",t),t},f=async()=>{let e="true"===localStorage.getItem("isNativeApp"),t=localStorage.getItem("ciris_native_auth"),o=localStorage.getItem("ciris_auth_method"),a="true"===localStorage.getItem("ciris_show_setup"),n=window.location.pathname,r=localStorage.getItem("ciris_access_token")||localStorage.getItem("access_token"),s=!!r,c="true"===sessionStorage.getItem("ciris_redirect_in_progress"),g=parseInt(sessionStorage.getItem("ciris_last_redirect_time")||"0",10),h=Date.now();if(c||h-g<5e3)return console.log("[AuthContext] SKIPPING - redirect recently in progress, avoiding loop"),!0;if(console.log("[AuthContext] checkNativeAuth called - path:",n,"isNativeApp:",e,"showSetupFlag:",a,"hasInjectedToken:",s),!e||!t)return console.log("[AuthContext] Not native app or no auth data, skipping"),!1;let p="true"===localStorage.getItem("ciris_native_auth_complete"),_=localStorage.getItem("ciris_native_auth_token"),f=r||_;if((p||s)&&f){console.log("[AuthContext] Native auth token available, restoring session (injected:",s,")"),localStorage.setItem("selectedAgentId","datum"),l._.configure("datum",f),s&&r&&(localStorage.setItem("ciris_native_auth_token",r),localStorage.setItem("ciris_native_auth_complete","true"));try{let e=JSON.parse(t),r={user_id:e.googleUserId||"admin",username:e.displayName||e.email||"admin",role:"SYSTEM_ADMIN",api_role:"ADMIN",permissions:["read","write","admin"],created_at:new Date().toISOString()};if(u(r),d(!1),console.log("[AuthContext] Checking if setup redirect needed - showSetupFlag:",a,"currentPath:",n),a&&!n.startsWith("/setup")){console.log("[AuthContext] showSetupFlag is true and not on /setup - checking API...");let e=await A();console.log("[AuthContext] API setupNeeded result:",e),e?(console.log("[AuthContext] REDIRECTING to /setup - API confirmed setup needed"),localStorage.setItem("ciris_native_llm_mode","google"===o?"ciris_proxy":"custom"),m()):(console.log("[AuthContext] NOT redirecting - API says setup is complete"),localStorage.setItem("ciris_show_setup","false"))}else console.log("[AuthContext] NOT checking API - showSetupFlag:",a,"onSetupPage:",n.startsWith("/setup"));return!0}catch(e){console.error("[AuthContext] Failed to restore session:",e),localStorage.removeItem("ciris_native_auth_complete"),localStorage.removeItem("ciris_native_auth_token")}}if(i.AQ.isAuthenticated())return console.log("[AuthContext] Already authenticated in SDK, skipping native auth login"),!0;try{let e=JSON.parse(t);console.log("[AuthContext] Native auth detected - method:",o,"showSetupFlag:",a,"currentPath:",n),localStorage.setItem("selectedAgentId","datum"),l._.configure("datum");try{console.log("[AuthContext] Attempting login with default credentials...");let e=await i.AQ.login("admin","ciris_admin_password"),t=i.AQ.auth.getAccessToken();return t&&(l._.configure("datum",t),localStorage.setItem("ciris_native_auth_token",t),localStorage.setItem("ciris_native_auth_complete","true"),console.log("[AuthContext] Token saved to localStorage")),u(e),console.log("[AuthContext] Native auth login successful"),d(!1),a&&!n.startsWith("/setup")?await A()?(console.log("[AuthContext] Redirecting to setup wizard - API confirmed setup needed"),localStorage.setItem("ciris_native_llm_mode","google"===o?"ciris_proxy":"custom"),m()):console.log("[AuthContext] API says setup complete - NOT redirecting"):console.log("[AuthContext] Not redirecting - showSetupFlag:",a,"currentPath:",n),!0}catch(r){console.error("[AuthContext] Native auth login failed:",r);let t={user_id:e.googleUserId||"native_user",username:e.displayName||"Native User",role:"ADMIN",api_role:"ADMIN",permissions:["read","write","admin"],created_at:new Date().toISOString()};return u(t),d(!1),localStorage.setItem("ciris_native_auth_complete","true"),a&&!n.startsWith("/setup")&&(await A()?(console.log("[AuthContext] Redirecting to setup wizard (mock user) - API confirmed"),localStorage.setItem("ciris_native_llm_mode","google"===o?"ciris_proxy":"custom"),m()):console.log("[AuthContext] API says setup complete (mock user) - NOT redirecting")),!0}}catch(e){return console.error("[AuthContext] Failed to parse native auth data:",e),!1}},I=async()=>{try{if(i.AQ.isAuthenticated()){let e=await i.AQ.auth.getMe();u(e)}}catch(e){console.error("Auth check failed:",e)}finally{d(!1)}},C=(0,n.useCallback)(async(e,t)=>{try{let o=localStorage.getItem("selectedAgentId");if(!o)throw Error("No agent selected");l._.configure(o);let a=await i.AQ.login(e,t),n=i.AQ.auth.getAccessToken();n&&l._.configure(o,n),u(a),s.Ay.success("Welcome, ".concat(a.username||a.user_id,"!")),_.push("/")}catch(e){throw s.Ay.error(e.message||"Login failed"),e}},[_]),S=(0,n.useCallback)(async()=>{try{await i.AQ.logout(),u(null),s.Ay.success("Logged out successfully"),_.push("/login")}catch(e){console.error("Logout failed:",e),s.Ay.error("Logout failed")}},[_]),w=(0,n.useCallback)(e=>!!o&&(o.permissions.includes(e)||"SYSTEM_ADMIN"===o.role),[o]),v=(0,n.useCallback)(e=>{if(!o)return!1;let t=["OBSERVER","ADMIN","AUTHORITY","SYSTEM_ADMIN"];return t.indexOf(o.role)>=t.indexOf(e)},[o]),k=(0,n.useCallback)(e=>{i.AQ.setConfig({authToken:e})},[]),x=(0,n.useCallback)(()=>!!h,[h]);return(0,a.jsx)(c.Provider,{value:{user:o,loading:g,login:C,logout:S,hasPermission:w,hasRole:v,setUser:u,setToken:k,managerToken:h,setManagerToken:p,isManagerAuthenticated:x},children:t})}function g(){let e=(0,n.useContext)(c);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}}}]);
