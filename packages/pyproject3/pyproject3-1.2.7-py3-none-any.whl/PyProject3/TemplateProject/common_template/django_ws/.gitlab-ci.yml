stages:
  - build

variables:
  DEV_REGISTRY: "harbor.xmov.ai/xmov"
  PRO_REGISTRY: "registry.cn-hangzhou.aliyuncs.com/xmov"
  FS_URL: "https://open.feishu.cn/open-apis/bot/v2/hook/596839f6-7241-4e81-b8cf-bca30c299c51"

build:
  stage: build
  only:
    - dev
    - qa
    - master
    - tags
  script:
    # æ„å»º Docker é•œåƒ
    - |
      if [[ $CI_COMMIT_REF_NAME == "master" ]]
      then
        docker buildx build --builder newbuilder --push . -t $PRO_REGISTRY/$CI_PROJECT_NAME:latest -t $PRO_REGISTRY/$CI_PROJECT_NAME:pre
      else
        docker buildx build --builder newbuilder --push . -t $DEV_REGISTRY/$CI_PROJECT_NAME:$CI_COMMIT_REF_NAME
      fi
  tags:
    - node-50

  after_script:
    # å‘é€æ„å»ºç»“æœåˆ°é£ä¹¦æœºå™¨äºº
    - |
      if [ $CI_JOB_STATUS == "success" ]
      then
        curl -X POST $FS_URL -H "Content-Type:application/json" -d '{"msg_type":"text","content":{"text":"ğŸ‘Œæ„å»ºæˆåŠŸï¼š'"$CI_PROJECT_NAME"' '"$CI_COMMIT_REF_NAME"' '"$CI_COMMIT_SHORT_SHA"'ï¼Œæ—¶é—´ï¼š'"$(date +"%Y-%m-%d %H:%M:%S")"'ã€‚"}}';
      else
        curl -X POST $FS_URL -H "Content-Type:application/json" -d '{"msg_type":"text","content":{"text":"ğŸ’”æ„å»ºå¤±è´¥ï¼š'"$CI_PROJECT_NAME"' '"$CI_COMMIT_REF_NAME"' '"$CI_COMMIT_SHORT_SHA"'ï¼Œæ—¶é—´ï¼š'"$(date +"%Y-%m-%d %H:%M:%S")"'ã€‚"}}';
      fi
