# ASR 2.0 部署文档

本次部署包括两个镜像，一个是 asr 算法服务，另一个是 asr 接口服务。

## asr 算法服务

### 物料清单

-   镜像：`harbor.xmov.ai/xmov/asr-2pass:dev`。

### 服务配置

-   端口：本服务的默认监听端口为 10095。供 asr 接口服务调用。可通过环境变量 `PORT` 进行修改。
-   环境变量： 环境变量 `PORT` 可用于修改服务的监听端口，如果不设置该端口，服务会监听默认的 10095 端口。

## asr 接口服务

### 物料

-   镜像：`harbor.xmov.ai/xmov/asr_api:dev`
-   基础依赖：
    -   MySQL 数据库。需要创建一个 名为 asr20 的数据库。
    -   redis。
    -   minio。需要创建一个名为 xmov-star-asr 的 bucket。

### 服务配置

-   端口：本服务默认监听 80 端口，供内部和外网服务调用。

-   域名：需要一个域名。

-   文件映射：本次很多环境变量都通过 supervisor 的配置文件实现。为了设置这些环境变量，需要运维映射一个文件到容器的 `/etc/supervisor/conf.d/xmov_supervisor.conf`。`/etc/supervisor/conf.d/xmov_supervisor.conf` 示例如下：

    ```conf
    [program:daphne]
    directory=/opt/tiger/xmov
    environment=
        PYTHONPATH="/opt/tiger/xmov",
        REDIS_HOST="127.0.0.1",  ; redis 服务地址
        DB_HOST="192.168.88.33",  ; MySQL 数据库地址
        DB_CHARSET="utf8",
        MYSQL_DATABASE="asr20",  ; 用到的 MySQL 库名
        MYSQL_USER="asrapi",     ; MySQL 用户名
        MYSQL_PASSWORD="U!GdfsieWjyn4XUYT",  ; MySQL 密码
        MINIO_ADDR="192.168.88.101:31102",  ; minio 服务的地址和端口
        MINIO_AK="xmov",  ; minio 的 AK
        MINIO_SK="Xmov0115",  ; minio 的 SK
        MINIO_BUCKET_NAME="xmov-star-asr",  ; minio bucket
        ASR_SERVER_HOST="127.0.0.1",  ; asr server 监听地址
        ASR_SERVER_PORT="10095"  ; asr server 监听端口
    stdout_logfile=/opt/logs/xmov/asgi.log
    redirect_stderr=true
    autostart=true
    autorestart=true
    killasgroup=true  ; 允许杀死该进程组内的所有进程
    stopasgroup=true  ; 允许停止该进程组内的所有进程
    command=/opt/py_virtualenvs/xmov/bin/python -m daphne -u /tmp/daphne.sock --proxy-headers asr_api.asgi:application
    
    ```

    

