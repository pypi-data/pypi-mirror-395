version: '3.8'

services:
  app:
    build: .
    ports:
      - "8000:8000"
    volumes:
      - ./src:/app/src
    env_file:
      - .env
    depends_on:
      {% if database_type == 'postgresql' %}- db{% endif %}
      {% if cache_type == 'redis' %}- redis{% endif %}
      {% if queue == 'celery' %}- worker{% endif %}

  {% if database_type == 'postgresql' %}
  db:
    image: postgres:15-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_NAME}
    ports:
      - "5432:5432"
  {% elif database_type == 'mysql' %}
  db:
    image: mysql:8.0
    volumes:
      - mysql_data:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_PASSWORD}
      - MYSQL_DATABASE=${DB_NAME}
    ports:
      - "3306:3306"
  {% endif %}

  {% if cache_type == 'redis' or queue == 'celery' %}
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
  {% endif %}

  {% if queue == 'celery' %}
  worker:
    build: .
    command: celery -A src.worker worker -l info
    volumes:
      - ./src:/app/src
    env_file:
      - .env
    depends_on:
      - app
      - redis
  {% endif %}

  {% if monitoring == 'prometheus' %}
  prometheus:
    image: prom/prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
  
  grafana:
    image: grafana/grafana
    depends_on:
      - prometheus
    ports:
      - "3000:3000"
  {% endif %}

  {% if storage == 'minio' %}
  minio:
    image: minio/minio
    command: server /data
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
  {% endif %}

volumes:
  {% if database_type == 'postgresql' %}postgres_data:{% endif %}
  {% if database_type == 'mysql' %}mysql_data:{% endif %}