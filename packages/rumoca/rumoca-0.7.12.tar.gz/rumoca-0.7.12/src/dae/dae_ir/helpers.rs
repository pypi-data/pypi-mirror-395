//! Helper types for DAE IR serialization.
//!
//! Common serialization helpers used across the DAE IR module.

use crate::dae::ast::Dae;
use serde::ser::{Serialize, SerializeMap, SerializeSeq, Serializer};

/// Helper for empty JSON arrays
pub struct EmptyArray;

impl Serialize for EmptyArray {
    fn serialize<S>(&self, serializer: S) -> Result<S::Ok, S::Error>
    where
        S: Serializer,
    {
        let seq = serializer.serialize_seq(Some(0))?;
        seq.end()
    }
}

/// Helper for empty JSON objects
pub struct EmptyObject;

impl Serialize for EmptyObject {
    fn serialize<S>(&self, serializer: S) -> Result<S::Ok, S::Error>
    where
        S: Serializer,
    {
        let map = serializer.serialize_map(Some(0))?;
        map.end()
    }
}

/// Structure metadata
pub struct Structure<'a> {
    pub dae: &'a Dae,
}

impl<'a> Serialize for Structure<'a> {
    fn serialize<S>(&self, serializer: S) -> Result<S::Ok, S::Error>
    where
        S: Serializer,
    {
        let n_states = self.dae.x.len();
        let n_algebraic = self.dae.y.len();
        let n_equations = self.dae.fx.len();
        let is_ode = n_algebraic == 0;

        let mut map = serializer.serialize_map(Some(5))?;
        map.serialize_entry("n_states", &n_states)?;
        map.serialize_entry("n_algebraic", &n_algebraic)?;
        map.serialize_entry("n_equations", &n_equations)?;
        map.serialize_entry("dae_index", &0)?; // TODO: compute actual index
        map.serialize_entry("is_ode", &is_ode)?;
        map.end()
    }
}

/// Metadata section
pub struct Metadata<'a> {
    pub dae: &'a Dae,
}

impl<'a> Serialize for Metadata<'a> {
    fn serialize<S>(&self, serializer: S) -> Result<S::Ok, S::Error>
    where
        S: Serializer,
    {
        let mut map = serializer.serialize_map(Some(5))?;
        map.serialize_entry(
            "description",
            &format!("Generated by Rumoca {}", self.dae.rumoca_version),
        )?;
        map.serialize_entry("generator", "rumoca")?;
        map.serialize_entry("rumoca_version", &self.dae.rumoca_version)?;
        map.serialize_entry("git_version", &self.dae.git_version)?;
        map.serialize_entry("model_hash", &self.dae.model_hash)?;
        map.end()
    }
}
