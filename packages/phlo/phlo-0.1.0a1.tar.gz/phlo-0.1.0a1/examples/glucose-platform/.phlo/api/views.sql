-- Auto-generated API views from dbt marts
-- Generated by: phlo api generate-views
-- Date: 2024-12-01
--
-- These views expose dbt mart tables through the api schema for PostgREST/Hasura access
-- They provide read-only API endpoints with appropriate permissions

-- Create API schema if it doesn't exist
CREATE SCHEMA IF NOT EXISTS api;

-- ============================================================================
-- View: api.glucose_overview
-- Source: marts_postgres.mrt_glucose_overview
-- Description: Daily glucose metrics with rolling averages and trends
-- ============================================================================

CREATE OR REPLACE VIEW api.glucose_overview AS
SELECT
    reading_date,
    day_name,
    week_of_year,
    month,
    year,
    reading_count,
    avg_glucose_mg_dl,
    min_glucose_mg_dl,
    max_glucose_mg_dl,
    stddev_glucose_mg_dl,
    time_in_range_pct,
    time_below_range_pct,
    time_above_range_pct,
    estimated_a1c_pct,
    estimated_a1c_7d_avg,
    glucose_change_from_prev_day,
    coefficient_of_variation
FROM marts.mrt_glucose_overview
ORDER BY reading_date DESC;

COMMENT ON VIEW api.glucose_overview IS
'Daily glucose overview with aggregated metrics, trends, and A1C estimates. Updated every 30 minutes.';

-- Column comments for API documentation
COMMENT ON COLUMN api.glucose_overview.reading_date IS 'Date of glucose readings';
COMMENT ON COLUMN api.glucose_overview.reading_count IS 'Number of readings on this date';
COMMENT ON COLUMN api.glucose_overview.avg_glucose_mg_dl IS 'Average glucose level (mg/dL)';
COMMENT ON COLUMN api.glucose_overview.time_in_range_pct IS 'Percentage of time in target range (70-180 mg/dL)';
COMMENT ON COLUMN api.glucose_overview.estimated_a1c_pct IS 'Estimated HbA1c percentage';
COMMENT ON COLUMN api.glucose_overview.estimated_a1c_7d_avg IS '7-day rolling average of estimated A1C';
COMMENT ON COLUMN api.glucose_overview.coefficient_of_variation IS 'Glucose variability coefficient';

-- ============================================================================
-- View: api.hourly_patterns
-- Source: marts_postgres.mrt_glucose_hourly_patterns
-- Description: Average glucose patterns by hour of day
-- ============================================================================

CREATE OR REPLACE VIEW api.hourly_patterns AS
SELECT
    hour_of_day,
    day_of_week,
    day_name,
    reading_count,
    avg_glucose_mg_dl,
    median_glucose_mg_dl,
    p25_glucose_mg_dl,
    p75_glucose_mg_dl,
    time_in_range_pct,
    stddev_glucose_mg_dl
FROM marts.mrt_glucose_hourly_patterns
ORDER BY hour_of_day, day_of_week;

COMMENT ON VIEW api.hourly_patterns IS
'Average glucose patterns aggregated by hour of day. Shows typical glucose trends throughout the day.';

-- Column comments
COMMENT ON COLUMN api.hourly_patterns.hour_of_day IS 'Hour of the day (0-23)';
COMMENT ON COLUMN api.hourly_patterns.day_of_week IS 'Day of the week (1=Monday, 7=Sunday)';
COMMENT ON COLUMN api.hourly_patterns.avg_glucose_mg_dl IS 'Average glucose for this hour';
COMMENT ON COLUMN api.hourly_patterns.median_glucose_mg_dl IS 'Median glucose for this hour';
COMMENT ON COLUMN api.hourly_patterns.reading_count IS 'Total number of readings';
COMMENT ON COLUMN api.hourly_patterns.time_in_range_pct IS 'Percentage of readings in target range';

-- ============================================================================
-- Permissions
-- ============================================================================

-- Public read access for analyst role (if role exists)
-- In production, you'd want more granular control
-- Uncomment if you create analyst and admin roles:
-- GRANT USAGE ON SCHEMA api TO analyst;
-- GRANT SELECT ON api.glucose_overview TO analyst;
-- GRANT SELECT ON api.hourly_patterns TO analyst;
-- GRANT ALL ON SCHEMA api TO admin;
-- GRANT SELECT ON api.glucose_overview TO admin;
-- GRANT SELECT ON api.hourly_patterns TO admin;

-- Optional: Allow anonymous read access (uncomment if needed)
-- GRANT USAGE ON SCHEMA api TO anon;
-- GRANT SELECT ON api.glucose_overview TO anon;
-- GRANT SELECT ON api.hourly_patterns TO anon;

-- ============================================================================
-- Row Level Security (RLS) Policies
-- ============================================================================

-- Note: Views don't support RLS directly in PostgreSQL
-- If you need RLS, consider materializing these as tables
-- or implementing RLS on the underlying marts_postgres tables

-- Example of how you would add RLS if these were tables:
-- ALTER TABLE api.glucose_overview ENABLE ROW LEVEL SECURITY;
-- CREATE POLICY analyst_access ON api.glucose_overview
--     FOR SELECT TO analyst USING (true);

-- ============================================================================
-- PostgREST Configuration
-- ============================================================================

-- These views are now accessible via PostgREST at:
-- GET /api/glucose_overview
-- GET /api/hourly_patterns
--
-- Example queries:
-- /api/glucose_overview?select=reading_date,avg_glucose_mg_dl&order=reading_date.desc&limit=30
-- /api/hourly_patterns?hour_of_day=eq.8
-- /api/glucose_overview?time_in_range_pct=gte.70&order=reading_date.desc
