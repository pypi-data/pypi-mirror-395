-- Auto-generated API views from dbt marts
-- Generated by: phlo api generate-views
-- Date: 2025-12-02
--
-- These views expose dbt mart tables through the api schema for PostgREST/Hasura access
-- They provide read-only API endpoints with appropriate permissions

-- Create API schema if it doesn't exist
CREATE SCHEMA IF NOT EXISTS api;

-- ============================================================================
-- View: api.github_activity_overview
-- Source: marts_postgres.mrt_github_activity_overview
-- Description: Daily GitHub activity metrics with rolling averages and trends
-- ============================================================================

CREATE OR REPLACE VIEW api.github_activity_overview AS
SELECT
    activity_date,
    day_name,
    week_of_year,
    month,
    year,
    total_events,
    unique_repos_count,
    push_events,
    pr_events,
    issue_events,
    watch_events,
    fork_events,
    code_contribution_events,
    collaboration_events,
    social_events,
    events_per_repo,
    total_events_7d_avg,
    push_events_7d_avg,
    unique_repos_7d_avg,
    total_events_change_from_prev_day,
    push_events_change_from_prev_day,
    streak_length,
    activity_level
FROM marts.mrt_github_activity_overview
ORDER BY activity_date DESC;

COMMENT ON VIEW api.github_activity_overview IS
'Daily GitHub activity overview with aggregated metrics, trends, and rolling averages. Updated every 6 hours.';

-- Column comments for API documentation
COMMENT ON COLUMN api.github_activity_overview.activity_date IS 'Date of GitHub activity';
COMMENT ON COLUMN api.github_activity_overview.total_events IS 'Total number of GitHub events on this date';
COMMENT ON COLUMN api.github_activity_overview.unique_repos_count IS 'Number of unique repositories with activity';
COMMENT ON COLUMN api.github_activity_overview.push_events IS 'Number of push events (commits)';
COMMENT ON COLUMN api.github_activity_overview.pr_events IS 'Number of pull request events';
COMMENT ON COLUMN api.github_activity_overview.total_events_7d_avg IS '7-day rolling average of total events';
COMMENT ON COLUMN api.github_activity_overview.streak_length IS 'Current contribution streak (consecutive days with activity)';
COMMENT ON COLUMN api.github_activity_overview.activity_level IS 'Activity level classification (very_active, active, moderate, light, inactive)';

-- ============================================================================
-- View: api.contribution_patterns
-- Source: marts_postgres.mrt_contribution_patterns
-- Description: GitHub contribution patterns by hour of day and day of week
-- ============================================================================

CREATE OR REPLACE VIEW api.contribution_patterns AS
SELECT
    hour_of_day,
    day_of_week,
    day_name,
    total_events,
    days_with_activity,
    unique_repos,
    push_events,
    pr_events,
    issue_events,
    watch_events,
    fork_events,
    code_contribution_events,
    collaboration_events,
    social_events,
    avg_events_per_day,
    intensity_score
FROM marts.mrt_contribution_patterns
ORDER BY day_of_week, hour_of_day;

COMMENT ON VIEW api.contribution_patterns IS
'GitHub contribution patterns aggregated by hour of day and day of week. Shows typical activity times and contribution patterns.';

-- Column comments
COMMENT ON COLUMN api.contribution_patterns.hour_of_day IS 'Hour of the day (0-23)';
COMMENT ON COLUMN api.contribution_patterns.day_of_week IS 'Day of the week (1=Monday, 7=Sunday)';
COMMENT ON COLUMN api.contribution_patterns.total_events IS 'Total events in this time slot';
COMMENT ON COLUMN api.contribution_patterns.intensity_score IS 'Activity intensity score (0-100 scale)';
COMMENT ON COLUMN api.contribution_patterns.avg_events_per_day IS 'Average events per active day in this time slot';

-- ============================================================================
-- View: api.language_distribution
-- Source: marts_postgres.mrt_language_distribution
-- Description: Repository language distribution and engagement metrics
-- ============================================================================

CREATE OR REPLACE VIEW api.language_distribution AS
SELECT
    primary_language,
    repository_count,
    total_stars,
    total_forks,
    avg_stars_per_repo,
    avg_forks_per_repo,
    total_popularity_score,
    active_repos_last_30d,
    active_repos_last_90d,
    avg_repo_age_days,
    max_stars_in_language,
    most_starred_repo,
    repo_count_pct,
    star_pct,
    fork_pct,
    stars_per_fork_ratio,
    active_repos_pct,
    popularity_rank
FROM marts.mrt_language_distribution
ORDER BY total_popularity_score DESC;

COMMENT ON VIEW api.language_distribution IS
'Repository language distribution with engagement metrics and popularity rankings. Shows technology preferences and language statistics.';

-- Column comments
COMMENT ON COLUMN api.language_distribution.primary_language IS 'Primary programming language';
COMMENT ON COLUMN api.language_distribution.repository_count IS 'Number of repositories using this language';
COMMENT ON COLUMN api.language_distribution.total_stars IS 'Total stars across all repos in this language';
COMMENT ON COLUMN api.language_distribution.total_popularity_score IS 'Combined popularity score (weighted stars + forks)';
COMMENT ON COLUMN api.language_distribution.repo_count_pct IS 'Percentage of total repositories';
COMMENT ON COLUMN api.language_distribution.star_pct IS 'Percentage of total stars';
COMMENT ON COLUMN api.language_distribution.active_repos_pct IS 'Percentage of repos active in last 30 days';
COMMENT ON COLUMN api.language_distribution.popularity_rank IS 'Rank by popularity score';

-- ============================================================================
-- Permissions
-- ============================================================================

-- Public read access for analyst role (if role exists)
-- In production, you'd want more granular control
-- Uncomment if you create analyst and admin roles:
-- GRANT USAGE ON SCHEMA api TO analyst;
-- GRANT SELECT ON api.github_activity_overview TO analyst;
-- GRANT SELECT ON api.contribution_patterns TO analyst;
-- GRANT SELECT ON api.language_distribution TO analyst;
-- GRANT ALL ON SCHEMA api TO admin;
-- GRANT SELECT ON api.github_activity_overview TO admin;
-- GRANT SELECT ON api.contribution_patterns TO admin;
-- GRANT SELECT ON api.language_distribution TO admin;

-- Optional: Allow anonymous read access (uncomment if needed)
-- GRANT USAGE ON SCHEMA api TO anon;
-- GRANT SELECT ON api.github_activity_overview TO anon;
-- GRANT SELECT ON api.contribution_patterns TO anon;
-- GRANT SELECT ON api.language_distribution TO anon;

-- ============================================================================
-- Row Level Security (RLS) Policies
-- ============================================================================

-- Note: Views don't support RLS directly in PostgreSQL
-- If you need RLS, consider materializing these as tables
-- or implementing RLS on the underlying marts_postgres tables

-- Example of how you would add RLS if these were tables:
-- ALTER TABLE api.github_activity_overview ENABLE ROW LEVEL SECURITY;
-- CREATE POLICY analyst_access ON api.github_activity_overview
--     FOR SELECT TO analyst USING (true);

-- ============================================================================
-- PostgREST Configuration
-- ============================================================================

-- These views are now accessible via PostgREST at:
-- GET /api/github_activity_overview
-- GET /api/contribution_patterns
-- GET /api/language_distribution
--
-- Example queries:
-- /api/github_activity_overview?select=activity_date,total_events,streak_length&order=activity_date.desc&limit=30
-- /api/contribution_patterns?hour_of_day=eq.14&day_of_week=eq.1
-- /api/language_distribution?order=popularity_rank.asc&limit=10
-- /api/github_activity_overview?activity_level=eq.very_active&order=activity_date.desc
