# mrt_github_repo_metrics.yml - Schema and integrity tests for GitHub repository metrics mart

version: 2

models:
  - name: mrt_github_repo_metrics
    description: "Gold layer curated fact table for GitHub repository metrics"
    meta:
      dagster:
        asset_key: ["mrt_github_repo_metrics"]
    columns:
      - name: repo_name
        description: "Name of the repository"
        tests:
          - not_null

      - name: repo_full_name
        description: "Full name of the repository (owner/repo)"
        tests:
          - not_null
          - unique

      - name: repo_id
        description: "GitHub repository ID"
        tests:
          - not_null
          - unique

      - name: repo_owner
        description: "Repository owner"
        tests:
          - not_null

      - name: repo_short_name
        description: "Repository short name"
        tests:
          - not_null

      - name: collection_date
        description: "Date when statistics were collected"
        tests:
          - not_null

      - name: contributor_count
        description: "Number of contributors"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: integer

      - name: total_commits_last_52_weeks
        description: "Total commits in last 52 weeks"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: integer

      - name: net_code_changes
        description: "Net code changes (deletions)"
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: integer

      - name: weeks_with_activity
        description: "Number of weeks with activity"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: integer

      - name: activity_score
        description: "Calculated activity score"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: numeric

      - name: contribution_level
        description: "Contribution level classification"
        tests:
          - not_null

      - name: activity_level
        description: "Activity level classification"
        tests:
          - not_null

      - name: repository_health
        description: "Repository health status"
        tests:
          - not_null

      - name: activity_score_7d_avg
        description: "7-day rolling average activity score"
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: numeric

      - name: contributor_change
        description: "Change in contributor count from previous collection"
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: integer

      - name: activity_change
        description: "Change in activity score from previous collection"
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: numeric

# Custom business logic tests
  - name: test_github_repo_activity_score_positive
    description: "Test that activity scores are non-negative"
    columns:
      - name: activity_score
        tests:
          - dbt_expectations.expect_column_values_to_be_greater_than_or_equal_to:
              value: 0

  - name: test_github_repo_contributor_count_non_negative
    description: "Test that contributor counts are non-negative"
    columns:
      - name: contributor_count
        tests:
          - dbt_expectations.expect_column_values_to_be_greater_than_or_equal_to:
              value: 0

  - name: test_github_repo_commits_non_negative
    description: "Test that commit counts are non-negative"
    columns:
      - name: total_commits_last_52_weeks
        tests:
          - dbt_expectations.expect_column_values_to_be_greater_than_or_equal_to:
              value: 0

  - name: test_github_repo_owner_not_empty
    description: "Test that repository owners are not empty strings"
    columns:
      - name: repo_owner
        tests:
          - dbt_expectations.expect_column_value_lengths_to_be_between:
              min_value: 1
              max_value: 100


