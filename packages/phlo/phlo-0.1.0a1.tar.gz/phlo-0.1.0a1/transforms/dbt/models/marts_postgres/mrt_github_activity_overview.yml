# mrt_github_activity_overview.yml - Schema and integrity tests for GitHub activity overview mart

version: 2

models:
  - name: mrt_github_activity_overview
    description: "PostgreSQL mart providing denormalized daily GitHub activity metrics"
    meta:
      dagster:
        asset_key: ["mrt_github_activity_overview"]
    columns:
      - name: activity_date
        description: "Date of activity"
        tests:
          - not_null
          - unique

      - name: day_name
        description: "Day name (Monday, Tuesday, etc.)"
        tests:
          - not_null

      - name: week_of_year
        description: "Week of year"
        tests:
          - not_null

      - name: month
        description: "Month number"
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

      - name: year
        description: "Year"
        tests:
          - not_null

      - name: event_count
        description: "Total events on this date"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: integer

      - name: unique_repos_count
        description: "Number of unique repositories"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: integer

      - name: unique_actors_count
        description: "Number of unique actors"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: integer

      - name: public_events_count
        description: "Number of public events"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: integer

      - name: private_events_count
        description: "Number of private events"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: integer

      - name: code_contribution_events
        description: "Number of code contribution events"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: integer

      - name: issue_management_events
        description: "Number of issue management events"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: integer

      - name: pull_request_events
        description: "Number of pull request events"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: integer

      - name: repository_management_events
        description: "Number of repository management events"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: integer

      - name: social_events
        description: "Number of social events"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: integer

      - name: avg_events_per_hour
        description: "Average events per hour"
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: numeric

      - name: peak_activity_hour
        description: "Peak activity hour"
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 23

      - name: events_during_work_hours
        description: "Events during work hours (9-17)"
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: integer

      - name: event_count_7d_avg
        description: "7-day rolling average of events"
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: numeric

      - name: event_change_from_prev_day
        description: "Event count change from previous day"
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: numeric

      - name: activity_diversity_score
        description: "Activity diversity score"
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: numeric

# Custom business logic tests
  - name: test_github_event_counts_consistent
    description: "Test that total events equals sum of categorized events"
    tests:
      - dbt_utils.expression_is_true:
          expression: "event_count = (code_contribution_events + issue_management_events + pull_request_events + repository_management_events + social_events)"

  - name: test_github_public_private_consistent
    description: "Test that public + private events equals total events"
    tests:
      - dbt_utils.expression_is_true:
          expression: "event_count = (public_events_count + private_events_count)"

  - name: test_github_no_future_dates
    description: "Test that activity dates are not in the future"
    tests:
      - dbt_utils.expression_is_true:
          expression: "activity_date <= current_date"
