stages:
  - linting
  - test
  - deploy

cache:
  paths:
    - coverage.tar.gz

.env_setup:
  before_script:
    # install uv (handles Python version management automatically)
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - source $HOME/.cargo/env
    - export PATH="$HOME/.cargo/bin:${PATH}"

linting:
  stage: linting
  extends: .env_setup
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_BRANCH == "public"
      when: never
    - if: $CI_COMMIT_BRANCH == "nist-pages"
      when: never
    - when: always
  retry: 2
  script:
    - uv run tox -e lint
  needs: []

nexusLIMS_tests:
  stage: test
  script:
    # run tests with coverage and output coverage report to html
    - TOX_SKIP_ENV=lint uv run tox
  retry: 2
  extends: .env_setup
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_BRANCH == "public"
      when: never
    - if: $CI_COMMIT_BRANCH == "nist-pages"
      when: never
    - when: always
  after_script:
    # cache the coverage results so they can be published, always returning true
    - mv tests/coverage .
    - tar -czf coverage.tar.gz coverage || true
  coverage: /(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/
  artifacts:
    paths:
      - coverage
    reports:
      junit: tests/test_report.xml
    expire_in: 30 days
  needs: ["linting"]

pages:
  stage: deploy
  script:
    - uv run tox -e docs
    - mkdir -p public/doc && rsync -avr _build/ public/doc/
  retry: 2
  extends: .env_setup
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_BRANCH == "public"
      when: never
    - if: $CI_COMMIT_BRANCH == "nist-pages"
      when: never
    - when: always
  after_script:
    - tar -xzf coverage.tar.gz -C public/ || true
  artifacts:
    paths:
      - public
  dependencies:
    - nexusLIMS_tests
  needs: ["nexusLIMS_tests"]
