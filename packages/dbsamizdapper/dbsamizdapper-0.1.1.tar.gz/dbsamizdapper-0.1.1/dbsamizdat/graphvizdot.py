from collections.abc import Iterable

from dbsamizdat.samizdat import Samizdat

from .libgraph import gen_autorefresh_edges, gen_edges, gen_unmanaged_edges, toposort, unmanaged_refs
from .samtypes import entitypes
from .util import nodenamefmt


def dot(samizdats: Iterable[Samizdat]):
    """
    Adorned GraphViz dotfile output.
    """
    # filter out autogenerated functions/triggers â€”
    # autorefresh relationships will be expressed as edges only
    samizdats = {s for s in samizdats if not getattr(s, "autorefresher", False)}
    unmanaged = unmanaged_refs(samizdats)
    samizdat_map = {sd.fq(): sd for sd in samizdats}
    topsorted = list(toposort({k: v.fqdeps_on() for k, v in samizdat_map.items()}))
    samerank = slice(-1, 1)

    def nodefmt(sd: Samizdat):
        styles = {
            entitypes.MATVIEW.name: '"%s" [shape=box3d fillcolor=red]',
            entitypes.VIEW.name: '"%s" [shape=box fillcolor=grey]',
            entitypes.FUNCTION.name: '"%s" [shape=hexagon fillcolor=olivedrab1]',
            entitypes.TRIGGER.name: '"%s" [shape=cds fillcolor=darkorchid1]',
            entitypes.TABLE.name: '"%s" [shape=box fillcolor=lightblue]',
        }
        return styles[sd.entity_type.name] % sd

    def nice_edges(edges):
        for nodepair in edges:
            yield tuple(map(nodenamefmt, nodepair))

    def enquote(thing):
        return f'"{thing}"'

    unmanaged_fmted = {nodenamefmt(n) for n in unmanaged}
    yield """
    digraph {
    {
    node [style="filled" fontname="sans-serif" margin="0.15, 0.15"];
    newrank="true";
    """
    yield "\n".join(f'"{n}" [shape=house fillcolor=yellow]' for n in unmanaged_fmted)
    yield "\n".join(map(nodefmt, samizdats))
    yield "}"

    yield "\n".join('"{}" -> "{}"'.format(*e) for e in nice_edges(gen_edges(samizdats)))
    yield "\n".join(
        '"{}" -> "{}" [arrowhead="dot" color="navy" style="dashed" label="ðŸ—˜" fontname="sans-serif" fontcolor="navy"]'.format(
            *e
        )
        for e in nice_edges(gen_autorefresh_edges(samizdats))
    )
    yield "\n".join('"{}" -> "{}" [color="red"]'.format(*e) for e in nice_edges(gen_unmanaged_edges(samizdats)))

    if unmanaged:
        yield "{{ rank=min; {} }}".format(" ".join(map(enquote, unmanaged_fmted)))
        samerank = slice(0, -1)
    for rank in topsorted[samerank]:
        yield "{{ rank=same; {} }}".format(" ".join(map(enquote, map(nodenamefmt, rank))))
    if topsorted:  # Guard against empty list
        yield "{{ rank=max; {} }}".format(" ".join(map(enquote, map(nodenamefmt, topsorted[-1]))))
    yield "}"
