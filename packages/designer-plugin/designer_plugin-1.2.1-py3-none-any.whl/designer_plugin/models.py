"""
MIT License
Copyright (c) 2025 Disguise Technologies ltd
"""

import json
import traceback
from dataclasses import dataclass
from typing import Any, Generic, TypeVar

import typing_extensions
from pydantic import BaseModel, Field, TypeAdapter, field_validator

###############################################################################
# Plugin endpoint constants
D3_PLUGIN_ENDPOINT = "api/session/python/execute"
D3_PLUGIN_MODULE_REG_ENDPOINT = "api/session/python/registermodule"
D3_PLUGIN_DEFAULT_PORT = 80


###############################################################################
# Plugin response types
class PluginStatusDetail(BaseModel):
    """Detail information for plugin status errors."""

    type_url: str = Field(description="Type URL identifying the error detail.")
    value: str = Field(description="Error detail value.")


class PluginStatus(BaseModel):
    """Status information from plugin API calls."""

    code: int = Field(description="Return code of plugin API call. 0 if good.")
    message: str = Field(description="Message from plugin API call.")
    details: list[PluginStatusDetail] = Field(
        description="List of detailed error information."
    )


# RetType is the return type of the function
RetType = typing_extensions.TypeVar("RetType", default=Any)
RetCastType = TypeVar("RetCastType")


class PluginResponse(BaseModel, Generic[RetType]):
    """Response from a plugin API call."""

    status: PluginStatus = Field(description="Status of plugin API call.")
    d3Log: str | None = Field(
        default=None,
        description="The d3Log field captures the Designer console log for the time the Python script is executing, recording any output generated by running a Python command, including the time taken to execute the Python command. As this captures the Designer console output, it is possible other threads may write to this output during this period causing additional irrelevant output.",
    )
    pythonLog: str | None = Field(
        default=None,
        description="This output field is the pure Python output, recording any print statements or warnings that occur during the execution of the script. This output will also appear in the d3Log field. However, in the d3Log field it will be mixed with other Designer log output.",
    )
    returnValue: RetType = Field(description="Return value of python plugin execution")

    @field_validator("returnValue", mode="before")
    @classmethod
    def parse_returnValue(cls, v: Any) -> Any:
        if not isinstance(v, str):
            return v
        if v == "null":
            return None
        try:
            return json.loads(v)
        except json.JSONDecodeError:
            return v

    def returnCastValue(self, castType: type[RetCastType]) -> RetCastType:
        """Validate and cast the return value to the specified type.

        Args:
            castType: The type to validate and cast the return value to.

        Returns:
            The validated return value as the specified type.

        Raises:
            ValidationError: If the return value cannot be validated as the specified type.
        """
        adapter = TypeAdapter(castType)
        return adapter.validate_python(self.returnValue)

    def debug_string(self) -> str:
        return f"""
{"json ":{'='}<60}
{self.model_dump_json(indent=2)}"""


class PluginError(PluginResponse[None]):
    """Error response when plugin execution fails."""

    returnValue: None = Field(
        default=None, description="Always None for error responses."
    )


class PluginRegisterResponse(BaseModel):
    """Response from a plugin module registration API call."""

    status: PluginStatus = Field(
        description="Status of plugin module registration API call."
    )


@dataclass
class PluginException(Exception):
    """
    Exception raised when plugin execution fails.

    Attributes:
        status: The status information from the failed plugin call
        d3Log: Designer console log output
        pythonLog: Python-specific log output
    """

    status: PluginStatus
    d3Log: str | None = None
    pythonLog: str | None = None

    _traceback_str: str | None = None
    _str: str | None = None

    def __post_init__(self) -> None:
        # Capture current stack trace if not already provided
        if self._traceback_str is None:
            self._traceback_str = "".join(traceback.format_stack()[:-1])

    def __str__(self) -> str:
        if self._str is None:
            details_str = ""
            if self.status.details:
                details_list = "\n".join(
                    [f"  - {d.type_url}: {d.value}" for d in self.status.details]
                )
                details_str = f"\ndetails    :\n{details_list}"
            self._str = "\n".join(
                [
                    Exception.__str__(self),
                    "D3PluginError:",
                    f"- code       : {self.status.code}",
                    f"- messages   :\n{self.status.message}{details_str}",
                    f"- d3Log      : {self.d3Log}",
                    f"- pythonLog  : {self.pythonLog}",
                ]
            )
        return self._str


###############################################################################
# Payload types
class PluginPayload(BaseModel, Generic[RetType]):
    """Type-safe execution payload for plugin calls."""

    moduleName: str | None = Field(
        default=None,
        exclude_if=lambda v: v is None,
        description="Module name to run script on Designer.",
    )
    script: str = Field(description="Script to run on Designer.")

    def is_module_payload(self) -> bool:
        return bool(self.moduleName)

    def debug_string(self) -> str:
        return f"""
{"json ":{'='}<60}
{self.model_dump_json(indent=2)}
{"script ":{'='}<60}
{self.script}"""


class RegisterPayload(BaseModel):
    """Payload for registering a Python module with Designer."""

    moduleName: str = Field(description="Module name to register contents.")
    contents: str = Field(description="Python code to register with the module name.")

    def debug_string(self) -> str:
        return f"""
{"json ":{'='}<60}
{self.model_dump_json(indent=2)}
{"contents ":{'='}<60}
{self.contents}"""
