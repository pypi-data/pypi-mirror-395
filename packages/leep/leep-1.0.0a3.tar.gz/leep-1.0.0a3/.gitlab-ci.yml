stages:
  - lint
  - test
  - build
  - publish

variables:
  CI_REGISTRY: mohs.dhcp.lbl.gov
  CONTAINER_IMAGE: $CI_REGISTRY/python_env_bookworm

image: $CONTAINER_IMAGE

flake8:
  stage: lint
  script:
    - find . -name "*.py" -exec flake8 {} +
  allow_failure: true

test:
  stage: test
  script:
    - python3 -m pip install -r requirements.txt
    - python3 -m pytest -v

build:
  stage: build
  script:
    - python3 -m build
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    expire_in: 4 weeks
    paths:
      - dist/*

.publish:
  stage: publish
  needs:
    - job: build
      artifacts: true
  script:
    - python3 -m twine upload --repository ${PYPI_REPOSITORY} dist/*

publish-pypi:
  extends: .publish
  variables:
    PYPI_REPOSITORY: pypi
    TWINE_USERNAME: ${PYPI_USERNAME}
    TWINE_PASSWORD: ${PYPI_TOKEN}
  rules:
    - if: "$CI_COMMIT_TAG"
      when: on_success
    - when: never
