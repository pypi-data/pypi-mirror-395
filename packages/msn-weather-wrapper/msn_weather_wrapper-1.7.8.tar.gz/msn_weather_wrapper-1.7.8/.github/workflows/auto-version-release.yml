name: Auto Version and Release

# Triggered manually by CI/CD Pipeline after tests pass
on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR Number (if from PR merge)'
        required: false
        type: string
      pr_title:
        description: 'PR Title'
        required: false
        type: string
      pr_merged:
        description: 'Was PR merged'
        required: false
        type: string
        default: 'true'

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  auto-version:
    name: Auto Version Bump and Tag
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          # Use default GITHUB_TOKEN - we'll work around branch protection
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Determine version bump type
        id: bump_type
        run: |
          PR_TITLE="${{ github.event.inputs.pr_title }}"

          echo "PR Title: $PR_TITLE"

          BUMP_TYPE="patch"

          # Check PR title for conventional commit prefixes
          if echo "$PR_TITLE" | grep -qiE "^(breaking|feat|feature)(\(.*\))?!:"; then
            BUMP_TYPE="major"
          elif echo "$PR_TITLE" | grep -qiE "^(feat|feature)(\(.*\))?:"; then
            BUMP_TYPE="minor"
          elif echo "$PR_TITLE" | grep -qiE "^(fix|bugfix|chore|perf|refactor|docs)(\(.*\))?:"; then
            BUMP_TYPE="patch"
          fi

          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Bump type: $BUMP_TYPE"

      - name: Calculate new version
        id: version
        run: |
          # Get current version from pyproject.toml
          CURRENT_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Current version: $CURRENT_VERSION"

          # Parse and increment version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          BUMP_TYPE="${{ steps.bump_type.outputs.bump_type }}"
          case $BUMP_TYPE in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ†• New version: $NEW_VERSION"

      - name: Check if version already exists
        id: check
        run: |
          NEW_VERSION="${{ steps.version.outputs.new }}"

          # Check if tag exists
          if git rev-parse "v$NEW_VERSION" >/dev/null 2>&1; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  Tag v$NEW_VERSION already exists"
            exit 0
          fi

          # Check if version matches what's in main
          MAIN_VERSION=$(git show origin/main:pyproject.toml | grep '^version = ' | sed 's/version = "\(.*\)"/\1/')
          if [ "$NEW_VERSION" == "$MAIN_VERSION" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  Version $NEW_VERSION already in main"
            exit 0
          fi

          echo "skip=false" >> $GITHUB_OUTPUT
          echo "âœ… Version $NEW_VERSION is new"

      - name: Update version files
        if: steps.check.outputs.skip == 'false'
        run: |
          NEW_VERSION="${{ steps.version.outputs.new }}"

          # Update pyproject.toml
          sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" pyproject.toml

          # Update __init__.py
          if [ -f "src/msn_weather_wrapper/__init__.py" ]; then
            sed -i "s/__version__ = \".*\"/__version__ = \"$NEW_VERSION\"/" src/msn_weather_wrapper/__init__.py
          fi

          echo "âœï¸  Updated version files to $NEW_VERSION"

      - name: Create version bump PR
        if: steps.check.outputs.skip == 'false'
        uses: peter-evans/create-pull-request@v6
        id: create_pr
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: bump version to ${{ steps.version.outputs.new }}"
          branch: auto-version/${{ steps.version.outputs.new }}
          delete-branch: true
          title: "chore: bump version to ${{ steps.version.outputs.new }}"
          body: |
            ## ðŸ¤– Automated Version Bump

            **Version**: ${{ steps.version.outputs.current }} â†’ **${{ steps.version.outputs.new }}**
            **Bump Type**: ${{ steps.bump_type.outputs.bump_type }}
            **Triggered by**: CI/CD Pipeline (PR #${{ github.event.inputs.pr_number }} - ${{ github.event.inputs.pr_title }})

            ### Changes
            - Updated `pyproject.toml` version
            - Updated `src/msn_weather_wrapper/__init__.py` version

            ### What happens after merge?
            1. âœ… Version files updated in main
            2. ðŸ·ï¸ Git tag `v${{ steps.version.outputs.new }}` will be created
            3. ðŸš€ CI/CD pipeline will:
               - Build Python package
               - Publish to PyPI
               - Build container images
               - Create GitHub Release

            ---
            *Auto-generated from PR #${{ github.event.inputs.pr_number }}*
          labels: |
            automated
            version-bump

      - name: Auto-merge version bump PR
        if: steps.check.outputs.skip == 'false' && steps.create_pr.outputs.pull-request-number
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.create_pr.outputs.pull-request-number }}"

          # Wait a moment for PR to be fully created
          sleep 5

          # Enable auto-merge
          gh pr merge $PR_NUMBER --auto --squash --delete-branch

          echo "ðŸ”„ Enabled auto-merge for PR #$PR_NUMBER"
          echo "Note: If branch protection requires reviews, the PR will merge after approval"

      - name: Create release tag
        if: steps.check.outputs.skip == 'false' && steps.create_pr.outputs.pull-request-number
        run: |
          NEW_VERSION="${{ steps.version.outputs.new }}"

          # Wait for PR to be merged
          echo "â³ Waiting for version bump PR to be merged..."
          sleep 10

          # Check if PR was merged
          PR_STATE=$(gh pr view ${{ steps.create_pr.outputs.pull-request-number }} --json state --jq .state)
          if [ "$PR_STATE" != "MERGED" ]; then
            echo "â¸ï¸  PR not yet merged - tag will be created manually or in next workflow"
            exit 0
          fi

          # Fetch latest main
          git fetch origin main
          git checkout main
          git pull origin main

          # Get the latest commit SHA on main
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "ðŸ“ Tagging commit: $COMMIT_SHA"

          # Create and push tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "v$NEW_VERSION" "$COMMIT_SHA" \
                  -m "Release v$NEW_VERSION" \
                  -m "Auto-generated from PR #${{ github.event.inputs.pr_number }}: ${{ github.event.inputs.pr_title }}" \
                  -m "Bump type: ${{ steps.bump_type.outputs.bump_type }}"

          git push origin "v$NEW_VERSION"
          echo "ðŸ·ï¸  Created and pushed tag v$NEW_VERSION at commit $COMMIT_SHA"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger publish-release workflow
        if: steps.check.outputs.skip == 'false' && steps.create_pr.outputs.pull-request-number
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.version.outputs.new }}"

          # Wait a moment for tag to be fully processed
          sleep 5

          # Trigger publish-release workflow with the new version tag
          gh workflow run publish-release.yml \
            -f tag="v$NEW_VERSION"

          echo "ðŸš€ Triggered publish-release workflow for v$NEW_VERSION"

      - name: Generate summary
        if: always()
        run: |
          if [ "${{ steps.check.outputs.skip }}" == "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # â„¹ï¸  No Version Bump Needed

          Version ${{ steps.version.outputs.new }} already exists or is already in main.

          **Current version**: ${{ steps.version.outputs.current }}
          **Would-be version**: ${{ steps.version.outputs.new }}
          EOF
          elif [ -n "${{ steps.create_pr.outputs.pull-request-number }}" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸŽ‰ Version Bump Initiated!

          ## Version Change
          - **Previous**: v${{ steps.version.outputs.current }}
          - **New**: v${{ steps.version.outputs.new }}
          - **Bump Type**: ${{ steps.bump_type.outputs.bump_type }}

          ## Version Bump PR
          - **PR Number**: #${{ steps.create_pr.outputs.pull-request-number }}
          - **Status**: Auto-merge enabled (will merge when checks pass)

          ## Next Steps
          1. âœ… Version bump PR will auto-merge
          2. ðŸ·ï¸ Tag v${{ steps.version.outputs.new }} will be created
          3. ðŸš€ CI/CD pipeline will publish release

          ## Bump Type Rules
          - **Major (X.0.0)**: breaking changes, labels: `major`, `breaking`
          - **Minor (0.X.0)**: new features, labels: `minor`, `feature`
          - **Patch (0.0.X)**: bug fixes, everything else (default)
          EOF
          fi
