name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'api.py'
      - 'tests/**'
      - 'tools/**'
      - 'pyproject.toml'
      - 'Containerfile*'
      - 'frontend/**'
      - '.github/workflows/ci.yml'
      - '.github/actions/**'
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'api.py'
      - 'tests/**'
      - 'tools/**'
      - 'pyproject.toml'
      - 'Containerfile*'
      - 'frontend/**'
      - '.github/workflows/ci.yml'
      - '.github/actions/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'
  REPORTS_DIR: 'docs/reports'

jobs:
  # Job 0: Smoke Tests (Fast Fail)
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: ./.github/actions/setup-python-env
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Quick validation
        run: |
          python -c "import msn_weather_wrapper; print(f'Version: {msn_weather_wrapper.__version__}')"
          python -c "from msn_weather_wrapper import WeatherClient; print('Client import OK')"
          ruff check src/ --select E,F  # Syntax errors only
          mypy src/msn_weather_wrapper --no-strict-optional --no-error-summary

  # Job 1: Code Quality and Linting
  code-quality:
    needs: [smoke-tests]
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: ./.github/actions/setup-python-env
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run Ruff format check
        run: ruff format --check .

      - name: Run Ruff linting
        run: ruff check .

      - name: Run mypy type checking
        run: mypy src/msn_weather_wrapper --strict

  # Job 2: Security Scanning (Critical Checks Only)
  security:
    needs: [smoke-tests]
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: ./.github/actions/setup-python-env
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install security tools
        run: pip install bandit pip-audit

      - name: Create security reports directory
        run: mkdir -p security-reports

      - name: Run Bandit (fail on HIGH/CRITICAL)
        run: |
          bandit -r src/ api.py -ll -f txt
          bandit -r src/ api.py -f json -o security-reports/bandit-report.json || true

      - name: Run pip-audit (check for vulnerabilities)
        run: pip-audit

      - name: Generate pip-licenses report
        run: |
          pip install pip-licenses
          pip-licenses --format=json --output-file=security-reports/licenses.json

      - name: Upload security reports
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: security-reports
          path: security-reports/
          retention-days: 7

      - name: Security scan summary
        if: always()
        run: |
          echo "âœ… Critical security checks passed"
          echo "ðŸ“‹ Reports generated and uploaded as artifacts"
          echo "ðŸ“‹ Full security scan with Trivy/Semgrep runs weekly (security-scan.yml)"

  # Job 3: Unit Tests (Python 3.10-3.12)
  unit-tests:
    needs: [smoke-tests]
    name: Unit Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ github.event_name == 'pull_request' && fromJSON('["3.12"]') || fromJSON('["3.10", "3.11", "3.12"]') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: ./.github/actions/setup-python-env
        with:
          python-version: ${{ matrix.python-version }}

      - name: Run unit tests
        run: pytest tests/test_client.py tests/test_models.py tests/test_api.py -v --tb=short --junitxml=junit-${{ matrix.python-version }}.xml

      - name: Run security tests
        run: pytest tests/test_security.py -v --tb=short --junitxml=junit-security-${{ matrix.python-version }}.xml

      - name: Upload test results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: test-results-${{ matrix.python-version }}
          path: junit-*.xml
          retention-days: 7

  # Job 4: Coverage Report
  coverage:
    needs: [smoke-tests]
    name: Test Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: ./.github/actions/setup-python-env
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run tests with coverage
        run: |
          pytest tests/test_client.py tests/test_models.py tests/test_api.py tests/test_security.py \
            --cov=src/msn_weather_wrapper --cov-report=xml --cov-report=html --cov-report=term --cov-report=json

      - name: Generate coverage badge
        run: |
          pip install coverage-badge
          coverage-badge -o coverage.svg -f

      - name: Generate coverage markdown report
        run: |
          pip install pycobertura
          pycobertura show --format markdown coverage.xml > coverage-report.md || echo "Coverage: See HTML report" > coverage-report.md

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload coverage reports
        uses: actions/upload-artifact@v5
        with:
          name: coverage-reports
          path: |
            htmlcov/
            coverage.xml
            coverage.json
            coverage.svg
            coverage-report.md
          retention-days: 7

  # Job 5: Build and Test Docker Images
  docker-build:
    name: Build & Test Docker Images
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.11.1

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5.10.0
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build unified container image (push to registry)
        if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Containerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

      - name: Build unified container image (load for testing)
        if: github.event_name == 'pull_request' || github.ref != 'refs/heads/main'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Containerfile
          push: false
          tags: msn-weather-app:test
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Test unified container
        if: github.event_name == 'pull_request' || github.ref != 'refs/heads/main'
        run: |
          docker run -d --name test-app -p 8080:80 msn-weather-app:test
          sleep 15
          curl -f http://localhost:8080/api/health || exit 1
          curl -f http://localhost:8080/ || exit 1
          docker stop test-app

      - name: Save Docker image as artifact
        if: github.event_name == 'pull_request' || github.ref != 'refs/heads/main'
        run: |
          docker save msn-weather-app:test -o /tmp/docker-image.tar
          gzip /tmp/docker-image.tar

      - name: Upload Docker image artifact
        if: github.event_name == 'pull_request' || github.ref != 'refs/heads/main'
        uses: actions/upload-artifact@v5
        with:
          name: docker-image
          path: /tmp/docker-image.tar.gz
          retention-days: 1

  # Job 6: Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [docker-build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: ./.github/actions/setup-python-env
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull image from registry
        if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
        run: |
          docker pull ghcr.io/${{ github.repository }}:${{ github.ref_name }}
          docker tag ghcr.io/${{ github.repository }}:${{ github.ref_name }} msn-weather-app:test

      - name: Download Docker image artifact
        if: github.event_name == 'pull_request' || github.ref != 'refs/heads/main'
        uses: actions/download-artifact@v6
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker image from artifact
        if: github.event_name == 'pull_request' || github.ref != 'refs/heads/main'
        run: |
          gunzip /tmp/docker-image.tar.gz
          docker load -i /tmp/docker-image.tar

      - name: Start container with cached image
        run: |
          docker run -d --name msn-weather-app -p 8080:80 \
            -e FLASK_DEBUG=false \
            -e CORS_ORIGINS="*" \
            -e RATE_LIMIT_ENABLED=true \
            -e CACHE_ENABLED=true \
            msn-weather-app:test
          sleep 15

      - name: Wait for API to be ready
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:8080/api/v1/health; then
              echo "API is ready!"
              break
            fi
            echo "Waiting for API... ($i/30)"
            sleep 2
          done

      - name: Run integration tests
        run: pytest tests/test_integration.py -v --tb=short

      - name: Show container logs on failure
        if: failure()
        run: docker logs msn-weather-app

      - name: Stop services
        if: always()
        run: docker stop msn-weather-app && docker rm msn-weather-app || true

  # Job 7: SBOM Generation
  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    needs: [docker-build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: ./.github/actions/setup-python-env
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Generate Source SBOM
        run: |
          mkdir -p sbom_output
          syft dir:. -o spdx-json > sbom_output/source_sbom.json
          syft dir:. -o cyclonedx-json > sbom_output/source_cyclonedx.json

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v5
        with:
          name: sbom-reports
          path: sbom_output/
          retention-days: 30

  # Job 8: Build Documentation
  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: ./.github/actions/setup-python-env
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          install-dependencies: 'false'

      - name: Install MkDocs
        run: pip install mkdocs-material

      - name: Build documentation
        run: mkdocs build --strict

      - name: Upload documentation
        uses: actions/upload-artifact@v5
        with:
          name: documentation
          path: site/
          retention-days: 30

  # Job 9: Generate Report Documentation
  generate-reports:
    name: Generate Report Documentation
    runs-on: ubuntu-latest
    needs: [coverage, security, unit-tests]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download coverage reports
        uses: actions/download-artifact@v6
        with:
          name: coverage-reports
          path: artifacts/coverage/
        continue-on-error: true

      - name: Download security reports
        uses: actions/download-artifact@v6
        with:
          name: security-reports
          path: artifacts/security/
        continue-on-error: true

      - name: Download test results
        uses: actions/download-artifact@v6
        with:
          pattern: test-results-*
          path: artifacts/tests/
          merge-multiple: true
        continue-on-error: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install report generation tools
        run: |
          pip install jinja2 junit2html pyyaml

      - name: Create reports directory
        run: mkdir -p ${{ env.REPORTS_DIR }}

      - name: Generate test report
        run: |
          python tools/generate_reports.py --type test \
            --input artifacts/tests/ \
            --output ${{ env.REPORTS_DIR }}/test-report.md
        continue-on-error: true

      - name: Generate coverage report
        run: |
          python tools/generate_reports.py --type coverage \
            --input artifacts/coverage/ \
            --output ${{ env.REPORTS_DIR }}/coverage-report.md
        continue-on-error: true

      - name: Generate security report
        run: |
          python tools/generate_reports.py --type security \
            --input artifacts/security/ \
            --output ${{ env.REPORTS_DIR }}/security-report.md
        continue-on-error: true

      - name: Generate license report
        run: |
          python tools/generate_reports.py --type license \
            --input artifacts/security/ \
            --output ${{ env.REPORTS_DIR }}/license-report.md
        continue-on-error: true

      - name: Generate CI/CD summary
        run: |
          python tools/generate_reports.py --type cicd \
            --output ${{ env.REPORTS_DIR }}/ci-cd.md
        continue-on-error: true

      - name: Upload report documentation
        uses: actions/upload-artifact@v5
        with:
          name: report-documentation
          path: ${{ env.REPORTS_DIR }}/

  # Job 10: Deploy Documentation to GitHub Pages (only on main branch)
  deploy-docs:
    name: Deploy Documentation to GitHub Pages
    runs-on: ubuntu-latest
    needs: [docs, integration-tests, generate-reports]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download report documentation
        uses: actions/download-artifact@v6
        with:
          name: report-documentation
          path: ci-reports/
        continue-on-error: true

      - name: Download coverage reports (for badges)
        uses: actions/download-artifact@v6
        with:
          name: coverage-reports
          path: docs/assets/
        continue-on-error: true

      - name: Verify and merge reports
        run: |
          echo "=== Generated Reports (from CI) ==="
          ls -la ci-reports/ || echo "No generated reports found"
          echo ""
          echo "=== Existing Reports (from repo) ==="
          git ls-files ${{ env.REPORTS_DIR }}/ || echo "No existing reports in repo"
          echo ""
          # Copy generated reports over existing ones if they exist
          if [ -d "ci-reports" ] && [ "$(ls -A ci-reports 2>/dev/null)" ]; then
            echo "Merging CI-generated reports into docs..."
            cp -f ci-reports/*.md ${{ env.REPORTS_DIR }}/ 2>/dev/null || true
          fi
          echo ""
          echo "=== Final Reports for Deployment ==="
          find docs/reports -type f -name "*.md" | sort

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install MkDocs
        run: pip install mkdocs-material

      - name: Configure Git
        run: |
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com

      - name: Deploy to GitHub Pages
        run: mkdocs gh-deploy --force

  # Job 11: Build Python Package
  build-package:
    name: Build Python Package
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: ./.github/actions/setup-python-env
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          install-dependencies: 'false'

      - name: Install build tools
        run: pip install build twine

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Verify version matches pyproject.toml
        run: |
          PYPROJECT_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          TAG_VERSION=${{ steps.version.outputs.version }}
          echo "Tag version: $TAG_VERSION"
          echo "pyproject.toml version: $PYPROJECT_VERSION"
          if [ "$TAG_VERSION" != "$PYPROJECT_VERSION" ]; then
            echo "Error: Version mismatch!"
            echo "Git tag: v$TAG_VERSION"
            echo "pyproject.toml: $PYPROJECT_VERSION"
            echo "Please update pyproject.toml version to match the tag"
            exit 1
          fi

      - name: Build package
        run: python -m build

      - name: Check package
        run: twine check dist/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: python-package
          path: dist/

  # Job 12: Publish to PyPI
  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [build-package]
    if: startsWith(github.ref, 'refs/tags/v')
    environment:
      name: pypi
      url: https://pypi.org/p/msn-weather-wrapper
    permissions:
      id-token: write
    steps:
      - name: Download package
        uses: actions/download-artifact@v6
        with:
          name: python-package
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@v1.13.0
        with:
          print-hash: true

  # Job 13: Create GitHub Release
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-package, sbom, generate-reports, publish-pypi]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Extract version info
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          # Check if this is a prerelease (contains alpha, beta, rc)
          if [[ $VERSION =~ (alpha|beta|rc) ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Download Python package
        uses: actions/download-artifact@v6
        with:
          name: python-package
          path: release-artifacts/python-package/

      - name: Download SBOM reports
        uses: actions/download-artifact@v6
        with:
          name: sbom-reports
          path: release-artifacts/sbom-reports/
        continue-on-error: true

      - name: Download coverage reports
        uses: actions/download-artifact@v6
        with:
          name: coverage-reports
          path: release-artifacts/coverage-reports/
        continue-on-error: true

      - name: Download security reports
        uses: actions/download-artifact@v6
        with:
          name: security-reports
          path: release-artifacts/security-reports/
        continue-on-error: true

      - name: Create release notes
        run: |
          cat > release-notes.md << 'EOF'
          ## MSN Weather Wrapper v${{ steps.version.outputs.version }}

          ### Installation

          **PyPI:**
          ```bash
          pip install msn-weather-wrapper==${{ steps.version.outputs.version }}
          ```

          **Container:**
          ```bash
          docker pull ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}
          ```

          ### What's Included

          - ðŸ“¦ Python wheel and source distribution
          - ðŸ³ Multi-platform container images (amd64, arm64)
          - ðŸ“‹ SBOM (Software Bill of Materials)
          - ðŸ”’ Security scan reports
          - âœ… Test coverage reports

          ### Documentation

          - ðŸ“– [Full Documentation](https://github.com/${{ github.repository }})
          - ðŸŒ [API Reference](https://github.com/${{ github.repository }}/blob/main/docs/API.md)
          - ðŸ”’ [Security](https://github.com/${{ github.repository }}/blob/main/docs/SECURITY.md)

          ---
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release-notes.md
          files: |
            release-artifacts/python-package/*
            release-artifacts/sbom-reports/*
            release-artifacts/coverage-reports/coverage.xml
            release-artifacts/coverage-reports/coverage.svg
            release-artifacts/security-reports/*.json
            release-artifacts/security-reports/*.md
          generate_release_notes: true
          draft: false
          prerelease: ${{ steps.version.outputs.prerelease }}
          make_latest: ${{ steps.version.outputs.prerelease == 'false' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
