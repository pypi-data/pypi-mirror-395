"""Markdown exporter."""

from typing import Any, Dict, List
from .base import BaseExporter


class MarkdownExporter(BaseExporter):
    """Export system data as Markdown."""

    def export(self) -> str:
        """Export data to Markdown format."""
        md = "# System Inventory Report\n\n"
        md += f"**Generated:** {self.data.get('timestamp', 'N/A')}\n\n"

        # Platform info
        if "platform" in self.data:
            md += "## Platform Information\n\n"
            platform = self.data["platform"]
            md += f"- **System:** {platform.get('system', 'N/A')}\n"
            md += f"- **Release:** {platform.get('release', 'N/A')}\n"
            md += f"- **Version:** {platform.get('version', 'N/A')}\n"
            md += f"- **Machine:** {platform.get('machine', 'N/A')}\n"
            md += f"- **Node:** {platform.get('node', 'N/A')}\n\n"

        # Package managers
        if "package_managers" in self.data:
            md += "## Installed Packages\n\n"
            for pm_name, pm_data in self.data["package_managers"].items():
                md += f"### {pm_name.title()} ({pm_data.get('count', 0)} packages)\n\n"

                packages = pm_data.get("packages", [])
                if packages:
                    md += self._create_table(packages)
                    md += "\n"

                # Updates section
                if "updates" in pm_data and pm_data["updates"]:
                    md += f"#### Available Updates ({len(pm_data['updates'])})\n\n"
                    md += self._create_updates_table(pm_data["updates"])
                    md += "\n"

        # Summary
        md += "## Summary\n\n"
        total_packages = sum(
            pm.get("count", 0)
            for pm in self.data.get("package_managers", {}).values()
        )
        md += f"**Total Packages:** {total_packages}\n\n"

        if any("updates" in pm for pm in self.data.get("package_managers", {}).values()):
            total_updates = sum(
                len(pm.get("updates", []))
                for pm in self.data.get("package_managers", {}).values()
            )
            md += f"**Total Updates Available:** {total_updates}\n\n"

        md += "---\n\n"
        md += "*Generated by [SysMap](https://github.com/yourusername/sysmap)*\n"

        return md

    def _create_table(self, items: List[Dict[str, str]]) -> str:
        """Create a markdown table from list of items."""
        if not items:
            return "_No packages found_\n"

        # Determine columns from first item
        headers = list(items[0].keys())
        headers_title = [h.replace("_", " ").title() for h in headers]

        md = "| " + " | ".join(headers_title) + " |\n"
        md += "| " + " | ".join(["---"] * len(headers)) + " |\n"

        for item in items:
            row = [str(item.get(h, "")).replace("|", "\\|") for h in headers]
            md += "| " + " | ".join(row) + " |\n"

        return md

    def _create_updates_table(self, updates: List[Dict[str, Any]]) -> str:
        """Create a table for available updates."""
        if not updates:
            return "_No updates available_\n"

        md = "| Package | Current | Available |\n"
        md += "| --- | --- | --- |\n"

        for update in updates:
            name = update.get("name", "")
            current = update.get("current_version", "")
            available = update.get("available_version", "")
            md += f"| {name} | {current} | {available} |\n"

        return md
