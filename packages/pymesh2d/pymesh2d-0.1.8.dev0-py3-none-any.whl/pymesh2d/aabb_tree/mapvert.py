import numpy as np

from .scantree import scantree


def mapvert(tr, pi):
    """
    Compute mappings between tree nodes and vertices in an AABB tree.

    This function determines which vertices lie within or intersect 
    the bounding boxes of an Axis-Aligned Bounding Box (AABB) tree.  
    It returns both the tree-to-vertex and vertex-to-tree mappings, 
    allowing efficient bidirectional association between points and 
    spatial partitions.

    Parameters
    ----------
    TR : dict
        AABB tree structure generated by `maketree`, containing:
        - `TR["XX"]` : ndarray of shape (NT, NDIM*2)
          Bounding boxes of tree nodes as `[PMIN, PMAX]`.
        - `TR["II"]` : ndarray of shape (NT, 2)
          Parent–child indices for each node.
        - `TR["LL"]` : list of lists
          Lists of items (indices) associated with each node.
    PI : ndarray of shape (NP, NDIM)
        Array of vertex coordinates, where each row corresponds 
        to a vertex position in the d-dimensional space.

    Returns
    -------
    TM : dict
        Tree-to-vertex mapping:
        - `TM["II"]` : ndarray of shape (M,)
          Indices of tree nodes.
        - `TM["LL"]` : list of lists
          Lists of vertex indices intersecting each node `TM["II"][j]`.
    IM : dict
        Vertex-to-tree mapping:
        - `IM["II"]` : ndarray of shape (N,)
          Indices of vertices.
        - `IM["LL"]` : list of lists
          Lists of tree node indices intersecting each vertex `IM["II"][j]`.

    Notes
    -----
    - Identifies all intersections between input vertices and AABB tree nodes.  
    - Enables bidirectional lookup for geometry–tree associations.  
    - Useful for point location, geometric indexing, and mesh data structures.

    References
    ----------
    Translation of the MESH2D function `MAPVERT`.  
    Original MATLAB source: https://github.com/dengwirda/mesh2d  

    See also
    --------
    queryset : Perform spatial queries within an AABB tree.  
    maprect : Compute rectangle-to-tree mappings.  
    maketree : Build an AABB tree from bounding boxes.
    """


    # ---------------------- call SCANTREE to do the actual work
    results = scantree(tr, pi, partvert)
    if len(results) == 1:
        return results[0], None
    else:
        return results


def partvert(pi, b1, b2):
    """
    PARTVERT partition points between boxes B1,B2 for SCANTREE.

    Parameters
    ----------
    pi : ndarray of shape (N, ND)
        Query points.
    b1, b2 : ndarray of shape (2*ND,)
        Bounding boxes.

    Returns
    -------
    j1, j2 : ndarray of bool of shape (N,)
        Mask of points inside b1 and b2 respectively.

    Notes
    -----
    Traduced from MATLAB aabb-tree repository

    References
    ----------
    Translation of the MESH2D function `PARTVERT`.  
    Original MATLAB source: https://github.com/dengwirda/mesh2d  
    """
    nd = b1.shape[0] // 2

    j1 = np.ones(pi.shape[0], dtype=bool)
    j2 = np.ones(pi.shape[0], dtype=bool)

    for ax in range(nd):
        #--------------- remains TRUE if inside bounds along axis AX
        j1 &= (pi[:, ax] >= b1[ax]) & (pi[:, ax] <= b1[ax + nd])
        #--------------- remains TRUE if inside bounds along axis AX
        j2 &= (pi[:, ax] >= b2[ax]) & (pi[:, ax] <= b2[ax + nd])

    return j1, j2
