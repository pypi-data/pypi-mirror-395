"""ID generation for nodes.

This module provides the IDGenerator class for generating sequential IDs with
prefixes (e.g., BR-001, SR-012). IDs are generated by finding the highest
existing number for a given prefix and incrementing it.
"""

import re
from contextgit.models.index import Index
from contextgit.models.config import Config


class IDGenerator:
    """Generates next sequential ID for nodes.

    The IDGenerator examines existing node IDs in the index to find the highest
    numeric value for a given prefix, then generates the next sequential ID.
    All IDs are zero-padded to 3 digits (e.g., 001, 002, ..., 999).

    Example:
        >>> generator = IDGenerator()
        >>> next_id = generator.next_id('system', index, config)
        >>> print(next_id)
        'SR-012'
    """

    def next_id(self, node_type: str, index: Index, config: Config) -> str:
        """Generate next ID for node type.

        Args:
            node_type: Node type (business, system, architecture, code, test, decision)
            index: Current index containing existing nodes
            config: Configuration with tag prefixes for each node type

        Returns:
            Next sequential ID with zero-padded 3-digit number (e.g., "SR-012")

        Raises:
            ValueError: If node type has no configured prefix in config

        Example:
            If index contains SR-001, SR-002, SR-005, this will return SR-006
        """
        # Get prefix from config
        prefix = config.tag_prefixes.get(node_type)
        if not prefix:
            raise ValueError(f"No prefix configured for type: {node_type}")

        # Find all IDs with this prefix
        matching_ids = [
            node_id for node_id in index.nodes.keys()
            if node_id.startswith(prefix)
        ]

        # Extract numeric portions
        max_num = 0
        pattern = re.compile(rf'^{re.escape(prefix)}(\d+)$')

        for node_id in matching_ids:
            match = pattern.match(node_id)
            if match:
                num = int(match.group(1))
                max_num = max(max_num, num)

        # Generate next ID with zero-padding to 3 digits
        next_num = max_num + 1
        return f"{prefix}{next_num:03d}"
