# PYTEMPLIFY ISOLATED TEST ENVIRONMENT
# This CMakeLists.txt is managed by pytemplify for validation purposes.
# It is independent of your project's build system.
#
# Generated by pytemplify validation framework
# Test: {{ test_name }}

cmake_minimum_required(VERSION 3.14)
project({{ test_name }}_pytemplify_validation)

# Standard C++ settings
set(CMAKE_CXX_STANDARD {{ cxx_standard }})
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Default build type when not specified by caller
if(NOT CMAKE_BUILD_TYPE)
set(CMAKE_BUILD_TYPE {{ build_type | default("Debug") }})
endif()

{% if enable_coverage -%}
# Enable coverage compile/link flags early so FetchContent-built dependencies
# (like googletest) are also built with coverage instrumentation.
message(STATUS "Enabling coverage flags for test build")
# Add compilation flags for coverage and ensure debug info / no optimization
add_compile_options(--coverage -g -O0)

# Also set global C/C++ flags so FetchContent-built targets inherit coverage instrumentation.
# Use both -fprofile-arcs and -ftest-coverage for GCC/Clang compatibility.
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -fprofile-arcs -ftest-coverage -g -O0")
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fprofile-arcs -ftest-coverage -g -O0")

# Ensure linker gets coverage flags too
set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} --coverage")
{% endif %}

{% if policy_cmp0135 | default(False) -%}
# GoogleTest requires this policy for FetchContent
if(POLICY CMP0135)
cmake_policy(SET CMP0135 NEW)
endif()
{% endif %}

{% if policy_cmp0105 | default(False) -%}
# Suppress warnings from GoogleTest about cmake_minimum_required
if(POLICY CMP0105)
cmake_policy(SET CMP0105 NEW)
endif()
{% endif %}

{% if disable_windows -%}
# Platform check
if(WIN32)
message(FATAL_ERROR "This test configuration does not support Windows.")
endif()
{% endif %}

# Google Test setup via FetchContent
include(FetchContent)

# Use shared cache for FetchContent to avoid re-downloading GoogleTest for each test
# This significantly improves performance by reusing the same GoogleTest download
if(NOT DEFINED FETCHCONTENT_BASE_DIR)
set(FETCHCONTENT_BASE_DIR "${CMAKE_CURRENT_SOURCE_DIR}/../.fetchcontent_cache" CACHE PATH "FetchContent base directory")
endif()
FetchContent_Declare(
googletest
GIT_REPOSITORY https://github.com/google/googletest.git
GIT_TAG {{ gtest_version }}
)

# For Windows: Prevent overriding the parent project's compiler/linker settings
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

enable_testing()

# Test executable name
set(TEST_TARGET {{ test_name }})

# Find all source files using glob patterns
{% for pattern in source_patterns -%}
file(GLOB_RECURSE {{ pattern.name }}_{{ loop.index }}_SOURCES "{{ pattern.path }}")
{% endfor %}

# Collect all source files
set(ALL_SOURCES
{% for pattern in source_patterns -%}
{{ "${" + pattern.name + "_" + loop.index|string + "_SOURCES}" }}
{% endfor %}
)

# Create test executable
add_executable(${TEST_TARGET}
{% if test_files is defined and test_files -%}
{%- for file in test_files %}
{{ file }}
{% endfor %}
{% else -%}
{{ test_file }}
{% endif -%}
${ALL_SOURCES}
)

# Include directories
target_include_directories(${TEST_TARGET} PRIVATE
{% for inc_dir in include_dirs -%}
{{ inc_dir }}
{% endfor %}
)

# Compile definitions (e.g., _UNITTEST, UNIT_TEST_BUILD)
# These are typically used with #ifdef/#ifndef in SUT code to differentiate test builds
{% if compile_definitions -%}
target_compile_definitions(${TEST_TARGET} PRIVATE
{% for definition in compile_definitions -%}
{{ definition }}
{% endfor %}
)
{% endif %}

# Link libraries
target_link_libraries(${TEST_TARGET}
{% if use_gmock | default(True) -%}
GTest::gtest_main
GTest::gmock_main
{% else -%}
GTest::gtest_main
{% endif -%}
{% for lib in link_libraries -%}
{{ lib }}
{% endfor %}
)

# Compiler options
target_compile_options(${TEST_TARGET} PRIVATE
-Wall
-Wextra
{% if warnings_as_errors -%}
-Werror
{% endif %}
{% if enable_coverage -%}
-fprofile-arcs
-ftest-coverage
-g
-O0
{% endif %}
{% for flag in extra_compile_options -%}
{{ flag }}
{% endfor %}
)

# Compiler features
target_compile_features(${TEST_TARGET} PRIVATE cxx_std_{{ cxx_standard }})

{% if enable_coverage -%}
# Add coverage linking flags (ensure linker gets coverage instrumentation)
target_link_options(${TEST_TARGET} PRIVATE --coverage)
{% endif %}

# Register tests with CTest
include(GoogleTest)
gtest_discover_tests(${TEST_TARGET}
  DISCOVERY_TIMEOUT {{ test_discovery_timeout | default(30) }}
)

{% if enable_coverage -%}
# Add custom targets to run tests and generate code coverage data
# Supports both gcovr (cross-platform, Windows-compatible) and lcov (Linux/macOS)

# gcovr target (preferred for Windows with MinGW)
# Note: Only includes SUT files (excludes tests, stubs, mocks, and googletest)
{% if sut_root_dir -%}
set(PYTEMPLIFY_SUT_DIR "{{ sut_root_dir }}")
{% else -%}
get_filename_component(PYTEMPLIFY_SUT_DIR "${CMAKE_SOURCE_DIR}/.." ABSOLUTE)
{% endif -%}
{% if gcovr_path -%}
set(GCOVR_EXECUTABLE "{{ gcovr_path }}")
{% else -%}
set(GCOVR_EXECUTABLE "gcovr")
{% endif -%}
add_custom_target(test_coverage_gcovr
COMMAND ${CMAKE_CTEST_COMMAND} --verbose
COMMAND ${CMAKE_COMMAND} -E make_directory ${CMAKE_BINARY_DIR}/coverage_report_gcovr
COMMAND ${GCOVR_EXECUTABLE} --object-directory ${CMAKE_BINARY_DIR} --root ${PYTEMPLIFY_SUT_DIR} --exclude ".*/googletest/.*" --exclude ".*/usr/.*" --exclude ".*_deps.*" --exclude ".*/test_.*\\.cpp$$" --exclude ".*/test_.*\\.cc$$" --exclude ".*_test\\.cpp$$" --exclude ".*_test\\.cc$$" --exclude ".*/tests/.*" --gcov-ignore-errors=no_working_dir_found --print-summary --html --html-details -o ${CMAKE_BINARY_DIR}/coverage_report_gcovr/index.html
WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
COMMENT "Running tests with gcovr coverage (cross-platform, SUT only)"
)

# lcov target (traditional Linux/macOS approach)
add_custom_target(test_coverage_lcov
COMMAND ${CMAKE_CTEST_COMMAND} --verbose
COMMAND lcov --capture --directory ${CMAKE_BINARY_DIR} --output-file ${CMAKE_BINARY_DIR}/coverage.info
COMMAND lcov --remove ${CMAKE_BINARY_DIR}/coverage.info '/usr/*' '*/googletest/*' '*/test_*.cpp' --output-file ${CMAKE_BINARY_DIR}/cleaned_coverage.info
COMMAND lcov --list ${CMAKE_BINARY_DIR}/cleaned_coverage.info
COMMAND genhtml ${CMAKE_BINARY_DIR}/cleaned_coverage.info --output-directory ${CMAKE_BINARY_DIR}/coverage_report_lcov
WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
COMMENT "Running tests with lcov coverage (Linux/macOS, SUT only)"
)

{% endif %}
