name: ðŸ¤– Jules Autofix

# This workflow runs only when the main CI workflow completes and fails on a pull_request
on:
  workflow_run:
    workflows: [CI]
    types: [completed]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: true

jobs:
  jules_autofix:
    name: Run Jules Fix Session
    # Use a faster, lighter runner since it's mostly Python scripting
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write # Needed to comment on the PR
      contents: read # Needed to checkout code
      actions: read # Needed to list/download artifacts

    # Only run if the CI failed AND it was triggered by a pull request
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Use the commit SHA from the failed run to ensure context is correct
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Get PR Number and Author
        id: get_pr
        uses: actions/github-script@v6
        with:
          script: |
            // Find the PR associated with the commit SHA from the failed workflow run
            const { data: pullRequest } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: context.repo.owner + ':' + context.event.workflow_run.head_branch,
            });
            if (pullRequest.length === 0) {
              core.info('Could not find corresponding pull request. Skipping.');
              return;
            }
            core.setOutput('pr_number', pullRequest[0].number);
            core.setOutput('pr_author', pullRequest[0].user.login);
            core.setOutput('pr_repo', pullRequest[0].base.repo.full_name);

      - name: Check if Author is "bnjam" (or other approved user)
        # This conditional check ensures the script only runs for approved users, matching the original logic
        if: ${{ steps.get_pr.outputs.pr_author != 'bnjam' }}
        run: |
          echo "Skipping Jules session. PR author is not 'bnjam'."
          exit 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # --- Download Artifacts from failed run ---
      - name: ðŸ“¥ Find and Download Failure Context
        uses: actions/github-script@v6
        id: download_artifact
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.event.workflow_run.id,
            });

            // Find the artifact uploaded by the failing test job (e.g., failure-context-3.12)
            const matchArtifact = artifacts.data.artifacts.find(artifact =>
              artifact.name.startsWith('failure-context-')
            );

            if (matchArtifact) {
              const download = await github.rest.actions.downloadArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: matchArtifact.id,
                archive_format: 'zip',
              });

              const fs = require('fs');
              const unzip = require('unzip-stream');

              // This downloads the zip, extracts it, and makes the error message available
              fs.writeFileSync('failure-context.zip', Buffer.from(download.data));
              fs.mkdirSync('failure-context');
              const readStream = fs.createReadStream('failure-context.zip');
              const extractStream = unzip.Extract({ path: 'failure-context' });

              await new Promise((resolve, reject) => {
                  extractStream.on('close', resolve);
                  extractStream.on('error', reject);
                  readStream.pipe(extractStream);
              });

              console.log('Successfully downloaded and extracted failure context.');
            } else {
              core.setFailed('Could not find failure-context artifact. Aborting autofix attempt.');
            }

      - name: Install dependencies for API interaction
        run: pip install requests # Need 'requests' to talk to the Jules API

      - name: ðŸ’¬ Run Jules Session Manager
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          REPO_NAME: ${{ steps.get_pr.outputs.pr_repo }}
          PR_NUMBER: ${{ steps.get_pr.outputs.pr_number }}
          BRANCH_NAME: ${{ github.event.workflow_run.head_branch }}
          ERROR_MESSAGE: ""
        run: |
          # Load the error message from the downloaded artifact
          if [ -f failure-context/error_message.txt ]; then
            export ERROR_MESSAGE=$(cat failure-context/error_message.txt)
          else
            export ERROR_MESSAGE="CI failed, but the specific error message artifact was missing."
          fi

          # Execute the Python script that interacts with the fixing system
          python ./scripts/jules_session_manager.py
