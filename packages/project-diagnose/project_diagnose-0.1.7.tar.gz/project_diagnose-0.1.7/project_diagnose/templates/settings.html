<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Diagnose</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
        }
        .settings-card {
            background: var(--panel-bg);
            padding: 12px 14px;
            border-radius: 8px;
        }
        .settings-card h3 {
            margin-top: 0;
            margin-bottom: 6px;
            font-size: 15px;
        }
        .item-row {
            display: flex;
            gap: 6px;
            margin-bottom: 4px;
        }
        .item-row input {
            flex: 1;
        }
        .small-btn {
            padding: 4px 8px;
            font-size: 12px;
        }
        #statusBlock {
            margin-top: 10px;
            white-space: pre-wrap;
        }
		.file-tree {
			background: var(--panel-bg);
			padding: 10px 14px;
			border-radius: 8px;
			max-height: 45vh;
			overflow-y: auto;
			font-family: monospace;
			font-size: 14px;
		}

		.file-item {
			cursor: pointer;
			padding: 2px 0;
		}

		.file-item:hover {
			background: rgba(255,255,255,0.06);
		}

		.folder {
			font-weight: bold;
		}

		.indent-1 { padding-left: 16px; }
		.indent-2 { padding-left: 32px; }
		.indent-3 { padding-left: 48px; }
		.indent-4 { padding-left: 64px; }
    </style>
</head>
<body>
<script>
    if (localStorage.getItem("project_diagnose_theme") === "dark") {
        document.body.classList.add("dark");
    }
</script>
<header>
    <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Diagnose</h1>
    <a href="/" class="button">‚Üê –ù–∞–∑–∞–¥</a>
</header>
<section class="panel">
    <h2>–§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞</h2>
    <div id="fileTree" class="file-tree"></div>
    <p style="font-size:12px; opacity:0.7;">
        –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ —Ñ–∞–π–ª—É –∏–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ –∫–æ–Ω—Ñ–∏–≥.
    </p>
</section>
<section class="panel">
    <h2>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è config.diagnose</h2>

    <div class="settings-grid">
        <div class="settings-card" data-field="include_ext">
            <h3>–†–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è</h3>
            <div class="list" id="include_ext_list"></div>
            <button class="small-btn" data-add="include_ext">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ</button>
        </div>

        <div class="settings-card" data-field="exclude_dirs">
            <h3>–ò—Å–∫–ª—é—á–∞–µ–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏</h3>
            <div class="list" id="exclude_dirs_list"></div>
            <button class="small-btn" data-add="exclude_dirs">+ –î–æ–±–∞–≤–∏—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é</button>
        </div>

        <div class="settings-card" data-field="exclude_files">
            <h3>–ò—Å–∫–ª—é—á–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã</h3>
            <div class="list" id="exclude_files_list"></div>
            <button class="small-btn" data-add="exclude_files">+ –î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª</button>
        </div>

        <div class="settings-card" data-field="include_files">
            <h3>–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã</h3>
            <div class="list" id="include_files_list"></div>
            <button class="small-btn" data-add="include_files">+ –î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª</button>
        </div>

        <div class="settings-card" data-field="special_json">
            <h3>–û—Å–æ–±—ã–µ JSON-—Ñ–∞–π–ª—ã</h3>
            <div class="list" id="special_json_list"></div>
            <button class="small-btn" data-add="special_json">+ –î–æ–±–∞–≤–∏—Ç—å JSON</button>
        </div>
    </div>

    <button id="saveBtn" style="margin-top:15px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <pre id="statusBlock"></pre>
</section>

<script>
	const FILE_TREE = {{ tree | tojson }};
		// –ö–æ–Ω—Ñ–∏–≥, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π —Å –±—ç–∫–∞
		window.CURRENT_CONFIG = {{ config | tojson }};
		
	function renderTree(node, level = 0, basePath = "") {
		let html = "";

		for (const key in node) {

			if (key === "_files") {
				node["_files"].forEach(f => {
					const fullPath = basePath ? `${basePath}/${f}` : f;
					html += `<div class="file-item indent-${level}" data-path="${fullPath}">
								üìÑ ${f}
							 </div>`;
				});
				continue;
			}

			const newPath = basePath ? `${basePath}/${key}` : key;

			html += `<div class="file-item folder indent-${level}" data-path="${newPath}">
						üìÅ ${key}
					 </div>`;

			html += renderTree(node[key], level + 1, newPath);
		}
		return html;
	}

	document.getElementById("fileTree").innerHTML = renderTree(FILE_TREE);

    function createRow(fieldName, value = "") {
        const row = document.createElement("div");
        row.className = "item-row";

        const input = document.createElement("input");
        input.type = "text";
        input.value = value;

        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.textContent = "‚úï";
        delBtn.className = "small-btn";
        delBtn.addEventListener("click", () => {
            row.remove();
        });

        row.appendChild(input);
        row.appendChild(delBtn);
        return row;
    }

    function initList(fieldName) {
        const listId = fieldName + "_list";
        const container = document.getElementById(listId);
        container.innerHTML = "";

        const values = window.CURRENT_CONFIG[fieldName] || [];
        values.forEach(v => {
            container.appendChild(createRow(fieldName, v));
        });
    }

    ["include_ext", "exclude_dirs", "exclude_files", "include_files", "special_json"].forEach(initList);

    document.querySelectorAll("[data-add]").forEach(btn => {
        btn.addEventListener("click", () => {
            const field = btn.getAttribute("data-add");
            const listId = field + "_list";
            const container = document.getElementById(listId);
            container.appendChild(createRow(field, ""));
        });
    });

    document.getElementById("saveBtn").addEventListener("click", () => {
        const fields = ["include_ext", "exclude_dirs", "exclude_files", "include_files", "special_json"];
        const cfg = {};

        fields.forEach(field => {
            const listId = field + "_list";
            const container = document.getElementById(listId);
            const inputs = container.querySelectorAll("input");
            cfg[field] = Array.from(inputs)
                .map(i => i.value.trim())
                .filter(v => v.length > 0);
        });

        fetch("/save_settings", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({config: cfg})
        })
        .then(r => r.json())
        .then(data => {
            const status = document.getElementById("statusBlock");
            if (data.status === "ok") {
                status.textContent = "‚úì –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.\n–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.";
            } else {
                status.textContent = "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:\n" + data.message;
            }
        })
        .catch(err => {
            document.getElementById("statusBlock").textContent = "–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞:\n" + err;
        });
    });
</script>
<script>
	document.getElementById("fileTree").addEventListener("dblclick", (e) => {
		const item = e.target.closest(".file-item");
		if (!item) return;

		const path = item.dataset.path.replace(/^\//, "");

		// –ö—É–¥–∞ –¥–æ–±–∞–≤–ª—è—Ç—å ‚Äî –¥–∞–≤–∞–π –≤ include_files.
		const list = document.getElementById("include_files_list");
		list.appendChild(createRow("include_files", path));
	});
</script>
</body>
</html>
