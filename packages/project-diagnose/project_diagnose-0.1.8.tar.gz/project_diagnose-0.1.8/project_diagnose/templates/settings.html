<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Diagnose</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <style>
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
        }
        .settings-card {
            background: var(--panel-bg);
            padding: 12px 14px;
            border-radius: 8px;
        }
        .settings-card h3 {
            margin-top: 0;
            margin-bottom: 6px;
            font-size: 15px;
        }
        .item-row {
            display: flex;
            gap: 6px;
            margin-bottom: 4px;
        }
        .item-row input {
            flex: 1;
        }
        .small-btn {
            padding: 4px 8px;
            font-size: 12px;
        }
        #statusBlock {
            margin-top: 10px;
            white-space: pre-wrap;
        }

        .file-tree {
            background: var(--panel-bg);
            padding: 10px 14px;
            border-radius: 8px;
            max-height: 45vh;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .file-item {
            cursor: pointer;
            padding: 2px 0;
        }
        .file-item:hover {
            background: rgba(255,255,255,0.06);
        }
        .folder {
            font-weight: bold;
        }
        .indent-1 { padding-left: 16px; }
        .indent-2 { padding-left: 32px; }
        .indent-3 { padding-left: 48px; }
        .indent-4 { padding-left: 64px; }
    </style>
</head>

<body>
<script>
    if (localStorage.getItem("project_diagnose_theme") === "dark") {
        document.body.classList.add("dark");
    }
</script>

<header>
    <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Diagnose</h1>
    <a href="/" class="button">‚Üê –ù–∞–∑–∞–¥</a>
</header>

<section class="panel">
    <h2>–§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞</h2>
    <div id="fileTree" class="file-tree"></div>
    <p style="font-size:12px; opacity:0.7;">
        –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ —Ñ–∞–π–ª—É –∏–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—É—Ç—å –≤ include_files.
    </p>
</section>

<section class="panel">
    <h2>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è config.diagnose</h2>

    <div class="settings-grid">
        <div class="settings-card" data-field="include_ext">
            <h3>–†–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è</h3>
            <div class="list" id="include_ext_list"></div>
            <button class="small-btn" data-add="include_ext">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>

        <div class="settings-card" data-field="exclude_dirs">
            <h3>–ò—Å–∫–ª—é—á–∞–µ–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏</h3>
            <div class="list" id="exclude_dirs_list"></div>
            <button class="small-btn" data-add="exclude_dirs">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>

        <div class="settings-card" data-field="exclude_files">
            <h3>–ò—Å–∫–ª—é—á–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã</h3>
            <div class="list" id="exclude_files_list"></div>
            <button class="small-btn" data-add="exclude_files">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>

        <div class="settings-card" data-field="include_files">
            <h3>–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã</h3>
            <div class="list" id="include_files_list"></div>
            <button class="small-btn" data-add="include_files">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>

        <div class="settings-card" data-field="special_json">
            <h3>–û—Å–æ–±—ã–µ JSON-—Ñ–∞–π–ª—ã</h3>
            <div class="list" id="special_json_list"></div>
            <button class="small-btn" data-add="special_json">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <button id="saveBtn" style="margin-top:15px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <pre id="statusBlock"></pre>
</section>

<script>
    const FILE_TREE = {{ tree | tojson }};
    window.CURRENT_CONFIG = {{ config | tojson }};
</script>

<script>
function renderTree(node, level = 0, basePath = "") {
    let html = "";

    for (const key in node) {
        if (key === "_files") {
            node["_files"].forEach(f => {
                const full = basePath ? `${basePath}/${f}` : f;
                html += `<div class="file-item indent-${level}" data-path="${full}">üìÑ ${f}</div>`;
            });
            continue;
        }

        const newPath = basePath ? `${basePath}/${key}` : key;

        html += `<div class="file-item folder indent-${level}" data-path="${newPath}">üìÅ ${key}</div>`;
        html += renderTree(node[key], level + 1, newPath);
    }

    return html;
}

document.getElementById("fileTree").innerHTML = renderTree(FILE_TREE);
</script>

<script>
function createRow(fieldName, value = "") {
    const row = document.createElement("div");
    row.className = "item-row";

    const input = document.createElement("input");
    input.type = "text";
    input.value = value;

    const delBtn = document.createElement("button");
    delBtn.type = "button";
    delBtn.textContent = "‚úï";
    delBtn.className = "small-btn";
    delBtn.onclick = () => row.remove();

    row.appendChild(input);
    row.appendChild(delBtn);
    return row;
}

function initList(field) {
    const cont = document.getElementById(field + "_list");
    cont.innerHTML = "";
    (window.CURRENT_CONFIG[field] || []).forEach(v => cont.appendChild(createRow(field, v)));
}

["include_ext","exclude_dirs","exclude_files","include_files","special_json"].forEach(initList);

document.querySelectorAll("[data-add]").forEach(btn => {
    btn.addEventListener("click", () => {
        const field = btn.dataset.add;
        document.getElementById(field + "_list").appendChild(createRow(field, ""));
    });
});

document.getElementById("fileTree").addEventListener("dblclick", e => {
    const item = e.target.closest(".file-item");
    if (!item) return;

    const path = item.dataset.path;
    const list = document.getElementById("include_files_list");
    list.appendChild(createRow("include_files", path));
});

document.getElementById("saveBtn").addEventListener("click", () => {
    const fields = ["include_ext","exclude_dirs","exclude_files","include_files","special_json"];
    const cfg = {};

    fields.forEach(field => {
        cfg[field] = Array.from(document.querySelectorAll(`#${field}_list input`))
            .map(i => i.value.trim())
            .filter(v => v);
    });

    fetch("/save_settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ config: cfg })
    })
    .then(r => r.json())
    .then(data => {
        const s = document.getElementById("statusBlock");
        s.textContent = data.status === "ok"
            ? "‚úì –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.\n–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É."
            : "–û—à–∏–±–∫–∞:\n" + data.message;
    });
});
</script>

</body>
</html>
