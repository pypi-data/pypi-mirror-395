"use strict";(globalThis.webpackChunksuperset=globalThis.webpackChunksuperset||[]).push([[1997],{31997:(t,e,n)=>{n.r(e),n.d(e,{default:()=>q});var o=n(67294),a=n(15926),i=n.n(a),l=n(45697),s=n.n(l),r=n(24198),h=n(35932),u=n(51995),c=n(61988),d=n(31069),p=n(11064),m=n(10581),y=n(60524),v=n(95826),b=n(81545),g=n(68135),A=n(82199),f=n(4715),C=n(79684),T=n(79069),Z=n(83734),S=n(82342),w=n(94301);function E(t){return Object.keys(t).reduce(((t,e)=>{const n=t;return n[e]=e,n}),{})}const _={FORMULA:{value:"FORMULA",label:(0,c.t)("Formula")},EVENT:{value:"EVENT",label:(0,c.t)("Event"),supportNativeSource:!0},INTERVAL:{value:"INTERVAL",label:(0,c.t)("Interval"),supportNativeSource:!0},TIME_SERIES:{value:"TIME_SERIES",label:(0,c.t)("Time series")}},L=E(_),N=L.FORMULA,k={NATIVE:{value:"NATIVE",label:"Superset annotation"}},V=E(k);function x(t){return!!t}var I=n(11965);const R="",F={name:s().string,annotationType:s().string,sourceType:s().string,color:s().string,opacity:s().string,style:s().string,width:s().number,showMarkers:s().bool,hideLine:s().bool,value:s().oneOfType([s().string,s().number]),overrides:s().object,show:s().bool,showLabel:s().bool,titleColumn:s().string,descriptionColumns:s().arrayOf(s().string),timeColumn:s().string,intervalEndColumn:s().string,vizType:s().string,error:s().string,colorScheme:s().string,addAnnotationLayer:s().func,removeAnnotationLayer:s().func,close:s().func},M={name:"",annotationType:N,sourceType:"",color:R,opacity:"",style:"solid",width:1,showMarkers:!1,hideLine:!1,overrides:{},colorScheme:"d3Category10",show:!0,showLabel:!1,titleColumn:"",descriptionColumns:[],timeColumn:"",intervalEndColumn:"",addAnnotationLayer:()=>{},removeAnnotationLayer:()=>{},close:()=>{}},O=u.iK.div`
  && > div:first-child {
    padding-left: 0;
    padding-right: 0;
  }
`,D=()=>(0,I.tZ)(O,null,(0,I.tZ)(w.Tc,{title:(0,c.t)("No annotation layers"),description:(0,I.tZ)("span",null,(0,c.t)("Add an annotation layer")," ",(0,I.tZ)("a",{href:"/annotationlayer/list",target:"_blank",rel:"noopener noreferrer"},(0,c.t)("here")),"."),image:"empty.svg"}));class z extends o.PureComponent{constructor(t){super(t),this.fetchNativeAnnotations=async(t,e,n)=>{const o=i().encode({filters:[{col:"name",opr:"ct",value:t}],columns:["id","name"],page:e,page_size:n}),{json:a}=await d.Z.get({endpoint:`/api/v1/annotation_layer/?q=${o}`}),{result:l,count:s}=a;return{data:l.map((t=>({value:t.id,label:t.name}))),totalCount:s}},this.fetchCharts=async(t,e,n)=>{const{annotationType:o}=this.state,a=i().encode({filters:[{col:"slice_name",opr:"chart_all_text",value:t},{col:"id",opr:"chart_owned_created_favored_by_me",value:!0}],columns:["id","slice_name","viz_type"],order_column:"slice_name",order_direction:"asc",page:e,page_size:n}),{json:l}=await d.Z.get({endpoint:`/api/v1/chart/?q=${a}`}),{result:s,count:r}=l,h=(0,p.Z)();return{data:s.filter((t=>{const e=h.get(t.viz_type);return e&&e.canBeAnnotationType(o)})).map((t=>({value:t.id,label:t.slice_name,viz_type:t.viz_type}))),totalCount:r}},this.fetchOptions=(t,e,n)=>{const{sourceType:o}=this.state;return o===V.NATIVE?this.fetchNativeAnnotations(t,e,n):this.fetchCharts(t,e,n)},this.fetchSliceData=t=>{const e=i().encode({columns:["query_context"]});d.Z.get({endpoint:`/api/v1/chart/${t}?q=${e}`}).then((t=>{var e;let{json:n}=t;const{result:o}=n,a=o.query_context,i=JSON.parse(a).form_data,l={data:{...i,groupby:null==(e=i.groupby)?void 0:e.map((t=>(0,m.Z)(t)))}};this.setState({slice:l})}))};const{name:e,annotationType:n,sourceType:o,color:a,opacity:l,style:s,width:r,showMarkers:h,hideLine:u,value:c,overrides:y,show:v,showLabel:b,titleColumn:g,descriptionColumns:A,timeColumn:f,intervalEndColumn:C,vizType:T}=t;("since"in y||"until"in y)&&(y.time_range=null,delete y.since,delete y.until);const Z=(0,p.Z)().get(T),S=(null==Z?void 0:Z.supportedAnnotationTypes)||[],w=S.includes(n)?n:S[0];this.state={name:e,annotationType:w,sourceType:o,value:c,overrides:y,show:v,showLabel:b,titleColumn:g,descriptionColumns:A,timeColumn:f,intervalEndColumn:C,color:a||R,opacity:l,style:s,width:r,showMarkers:h,hideLine:u,isNew:!e,slice:null},this.submitAnnotation=this.submitAnnotation.bind(this),this.deleteAnnotation=this.deleteAnnotation.bind(this),this.applyAnnotation=this.applyAnnotation.bind(this),this.isValidForm=this.isValidForm.bind(this),this.handleAnnotationType=this.handleAnnotationType.bind(this),this.handleAnnotationSourceType=this.handleAnnotationSourceType.bind(this),this.handleSelectValue=this.handleSelectValue.bind(this),this.handleTextValue=this.handleTextValue.bind(this),this.fetchOptions=this.fetchOptions.bind(this),this.fetchCharts=this.fetchCharts.bind(this),this.fetchNativeAnnotations=this.fetchNativeAnnotations.bind(this),this.fetchAppliedAnnotation=this.fetchAppliedAnnotation.bind(this),this.fetchSliceData=this.fetchSliceData.bind(this),this.shouldFetchSliceData=this.shouldFetchSliceData.bind(this),this.fetchAppliedChart=this.fetchAppliedChart.bind(this),this.fetchAppliedNativeAnnotation=this.fetchAppliedNativeAnnotation.bind(this),this.shouldFetchAppliedAnnotation=this.shouldFetchAppliedAnnotation.bind(this)}componentDidMount(){if(this.shouldFetchAppliedAnnotation()){const{value:t}=this.state;this.fetchAppliedAnnotation(t)}}componentDidUpdate(t,e){if(this.shouldFetchSliceData(e)){const{value:t}=this.state;this.fetchSliceData(t.value)}}getSupportedSourceTypes(t){var e;const n=(0,p.Z)().entries().filter((e=>{let{value:n}=e;return n.canBeAnnotationType(t)})).map((t=>{let{key:e,value:n}=t;return{value:e,label:n.name}}));return null!=(e=_[t])&&e.supportNativeSource&&n.unshift(k.NATIVE),n}shouldFetchAppliedAnnotation(){const{value:t,sourceType:e}=this.state;return t&&x(e)}shouldFetchSliceData(t){const{value:e,sourceType:n}=this.state,o=n!==V.NATIVE&&x(n);return e&&t.value!==e&&o}isValidFormulaAnnotation(t,e){return e!==L.FORMULA||(0,y.$)(t)}isValidForm(){const{name:t,annotationType:e,sourceType:n,value:o,timeColumn:a,intervalEndColumn:i}=this.state,l=[(0,v.Z)(t),(0,v.Z)(e),(0,v.Z)(o)];return n!==V.NATIVE&&(e===L.EVENT&&l.push((0,v.Z)(a)),e===L.INTERVAL&&(l.push((0,v.Z)(a)),l.push((0,v.Z)(i)))),l.push(!this.isValidFormulaAnnotation(o,e)),!l.filter((t=>t)).length}handleAnnotationType(t){this.setState({annotationType:t,sourceType:null,value:null,slice:null})}handleAnnotationSourceType(t){const{sourceType:e}=this.state;e!==t&&this.setState({sourceType:t,value:null,slice:null})}handleSelectValue(t){this.setState({value:t,descriptionColumns:[],intervalEndColumn:null,timeColumn:null,titleColumn:null,overrides:{time_range:null}})}handleTextValue(t){this.setState({value:t})}fetchAppliedChart(t){const{annotationType:e}=this.state,n=(0,p.Z)(),o=i().encode({columns:["slice_name","query_context","viz_type"]});d.Z.get({endpoint:`/api/v1/chart/${t}?q=${o}`}).then((o=>{let{json:a}=o;const{result:i}=a,l=i.slice_name,s=i.query_context,r=i.viz_type,h=JSON.parse(s).form_data,u=n.get(r);var c;u&&u.canBeAnnotationType(e)&&this.setState({value:{value:t,label:l},slice:{data:{...h,groupby:null==(c=h.groupby)?void 0:c.map((t=>(0,m.Z)(t)))}}})}))}fetchAppliedNativeAnnotation(t){d.Z.get({endpoint:`/api/v1/annotation_layer/${t}`}).then((t=>{let{json:e}=t;const{result:n}=e,o=n;this.setState({value:{value:o.id,label:o.name}})}))}fetchAppliedAnnotation(t){const{sourceType:e}=this.state;return e===V.NATIVE?this.fetchAppliedNativeAnnotation(t):this.fetchAppliedChart(t)}deleteAnnotation(){this.props.removeAnnotationLayer(),this.props.close()}applyAnnotation(){const{value:t,sourceType:e}=this.state;if(this.isValidForm()){const n={};["name","annotationType","sourceType","color","opacity","style","width","showMarkers","hideLine","overrides","show","showLabel","titleColumn","descriptionColumns","timeColumn","intervalEndColumn"].forEach((t=>{null!==this.state[t]&&(n[t]=this.state[t])}));const o=x(e)?t.value:t;n.value=o,n.color===R&&(n.color=null),this.props.addAnnotationLayer(n),this.setState({isNew:!1})}}submitAnnotation(){this.applyAnnotation(),this.props.close()}renderChartHeader(t,e,n){return(0,I.tZ)(S.Z,{hovered:!0,label:t,description:e,validationErrors:n?[]:["Mandatory"]})}renderValueConfiguration(){const{annotationType:t,sourceType:e,value:n}=this.state;let o="",a="";return x(e)?e===V.NATIVE?(o=(0,c.t)("Annotation layer"),a=(0,c.t)("Select the Annotation Layer you would like to use.")):(o=(0,c.t)("Chart"),a=(0,c.t)("Use another existing chart as a source for annotations and overlays.\n          Your chart must be one of these visualization types: [%s]",this.getSupportedSourceTypes(t).map((t=>t.label)).join(", "))):t===L.FORMULA&&(o=(0,c.t)("Formula"),a=(0,c.t)("Expects a formula with depending time parameter 'x'\n        in milliseconds since epoch. mathjs is used to evaluate the formulas.\n        Example: '2x+5'")),x(e)?(0,I.tZ)(f.qb,{key:e,ariaLabel:(0,c.t)("Annotation layer value"),name:"annotation-layer-value",header:this.renderChartHeader(o,a,n),options:this.fetchOptions,value:n||null,onChange:this.handleSelectValue,notFoundContent:(0,I.tZ)(D,null)}):t===L.FORMULA?(0,I.tZ)(C.Z,{name:"annotation-layer-value",hovered:!0,showHeader:!0,description:a,label:o,placeholder:"",value:n,onChange:this.handleTextValue,validationErrors:this.isValidFormulaAnnotation(n,t)?[]:[(0,c.t)("Bad formula.")]}):""}renderSliceConfiguration(){const{annotationType:t,sourceType:e,value:n,slice:o,overrides:a,titleColumn:i,timeColumn:l,intervalEndColumn:s,descriptionColumns:r}=this.state;if(!o||!n)return"";if(e!==V.NATIVE&&o){const e=(o.data.groupby||[]).concat(o.data.all_columns||[]).map((t=>({value:t,label:t}))),n=o.data.include_time?[{value:"__timestamp",label:"__timestamp"}].concat(e):e;return(0,I.tZ)("div",{style:{marginRight:"2rem"}},(0,I.tZ)(Z.Z,{isSelected:!0,title:(0,c.t)("Annotation Slice Configuration"),info:(0,c.t)("This section allows you to configure how to use the slice\n              to generate annotations.")},(t===L.EVENT||t===L.INTERVAL)&&(0,I.tZ)(A.Z,{ariaLabel:(0,c.t)("Annotation layer time column"),hovered:!0,name:"annotation-layer-time-column",label:t===L.INTERVAL?(0,c.t)("Interval start column"):(0,c.t)("Event time column"),description:(0,c.t)("This column must contain date/time information."),validationErrors:l?[]:["Mandatory"],clearable:!1,options:n,value:l,onChange:t=>this.setState({timeColumn:t})}),t===L.INTERVAL&&(0,I.tZ)(A.Z,{ariaLabel:(0,c.t)("Annotation layer interval end"),hovered:!0,name:"annotation-layer-intervalEnd",label:(0,c.t)("Interval End column"),description:(0,c.t)("This column must contain date/time information."),validationErrors:s?[]:["Mandatory"],options:e,value:s,onChange:t=>this.setState({intervalEndColumn:t})}),(0,I.tZ)(A.Z,{ariaLabel:(0,c.t)("Annotation layer title column"),hovered:!0,name:"annotation-layer-title",label:(0,c.t)("Title Column"),description:(0,c.t)("Pick a title for you annotation."),options:[{value:"",label:(0,c.t)("None")}].concat(e),value:i,onChange:t=>this.setState({titleColumn:t})}),t!==L.TIME_SERIES&&(0,I.tZ)(A.Z,{ariaLabel:(0,c.t)("Annotation layer description columns"),hovered:!0,name:"annotation-layer-title",label:(0,c.t)("Description Columns"),description:(0,c.t)("Pick one or more columns that should be shown in the annotation. If you don't select a column all of them will be shown."),multi:!0,options:e,value:r,onChange:t=>this.setState({descriptionColumns:t})}),(0,I.tZ)("div",{style:{marginTop:"1rem"}},(0,I.tZ)(T.Z,{hovered:!0,name:"annotation-override-time_range",label:(0,c.t)("Override time range"),description:(0,c.t)('This controls whether the "time_range" field from the current\n                  view should be passed down to the chart containing the annotation data.'),value:"time_range"in a,onChange:t=>{delete a.time_range,t?this.setState({overrides:{...a,time_range:null}}):this.setState({overrides:{...a}})}}),(0,I.tZ)(T.Z,{hovered:!0,name:"annotation-override-timegrain",label:(0,c.t)("Override time grain"),description:(0,c.t)("This controls whether the time grain field from the current\n                  view should be passed down to the chart containing the annotation data."),value:"time_grain_sqla"in a,onChange:t=>{delete a.time_grain_sqla,delete a.granularity,t?this.setState({overrides:{...a,time_grain_sqla:null,granularity:null}}):this.setState({overrides:{...a}})}}),(0,I.tZ)(C.Z,{hovered:!0,name:"annotation-layer-timeshift",label:(0,c.t)("Time Shift"),description:(0,c.t)("Time delta in natural language\n                  (example:  24 hours, 7 days, 56 weeks, 365 days)"),placeholder:"",value:a.time_shift,onChange:t=>this.setState({overrides:{...a,time_shift:t}})}))))}return""}renderDisplayConfiguration(){const{color:t,opacity:e,style:n,width:o,showMarkers:a,hideLine:i,annotationType:l}=this.state,s=(0,b.Z)().get(this.props.colorScheme).colors.concat();return t&&t!==R&&!s.find((e=>e.toLowerCase()===t.toLowerCase()))&&s.push(t),(0,I.tZ)(Z.Z,{isSelected:!0,title:(0,c.t)("Display configuration"),info:(0,c.t)("Configure your how you overlay is displayed here.")},(0,I.tZ)(A.Z,{ariaLabel:(0,c.t)("Annotation layer stroke"),name:"annotation-layer-stroke",label:(0,c.t)("Style"),options:[{value:"solid",label:(0,c.t)("Solid")},{value:"dashed",label:(0,c.t)("Dashed")},{value:"longDashed",label:(0,c.t)("Long dashed")},{value:"dotted",label:(0,c.t)("Dotted")}],value:n,clearable:!1,onChange:t=>this.setState({style:t})}),(0,I.tZ)(A.Z,{ariaLabel:(0,c.t)("Annotation layer opacity"),name:"annotation-layer-opacity",label:(0,c.t)("Opacity"),options:[{value:"",label:(0,c.t)("Solid")},{value:"opacityLow",label:"0.2"},{value:"opacityMedium",label:"0.5"},{value:"opacityHigh",label:"0.8"}],value:e,onChange:t=>this.setState({opacity:t})}),(0,I.tZ)("div",null,(0,I.tZ)(S.Z,{label:(0,c.t)("Color")}),(0,I.tZ)("div",{style:{display:"flex",flexDirection:"column"}},(0,I.tZ)(r.Ie,{color:t,colors:s,onChangeComplete:t=>this.setState({color:t.hex})}),(0,I.tZ)(h.Z,{style:{marginTop:"0.5rem",marginBottom:"0.5rem"},buttonStyle:t===R?"success":"default",buttonSize:"xsmall",onClick:()=>this.setState({color:R})},(0,c.t)("Automatic Color")))),(0,I.tZ)(C.Z,{name:"annotation-layer-stroke-width",label:(0,c.t)("Line width"),isInt:!0,value:o,onChange:t=>this.setState({width:t})}),l===L.TIME_SERIES&&(0,I.tZ)(T.Z,{hovered:!0,name:"annotation-layer-show-markers",label:(0,c.t)("Show Markers"),description:(0,c.t)("Shows or hides markers for the time series"),value:a,onChange:t=>this.setState({showMarkers:t})}),l===L.TIME_SERIES&&(0,I.tZ)(T.Z,{hovered:!0,name:"annotation-layer-hide-line",label:(0,c.t)("Hide Line"),description:(0,c.t)("Hides the Line for the time series"),value:i,onChange:t=>this.setState({hideLine:t})}))}render(){const{isNew:t,name:e,annotationType:n,sourceType:a,show:i,showLabel:l}=this.state,s=this.isValidForm(),r=(0,p.Z)().get(this.props.vizType),u=r?r.supportedAnnotationTypes.map((t=>_[t])):[],d=this.getSupportedSourceTypes(n);return(0,I.tZ)(o.Fragment,null,this.props.error&&(0,I.tZ)("span",{style:{color:this.props.theme.colors.error.base}},"ERROR: ",this.props.error),(0,I.tZ)("div",{style:{display:"flex",flexDirection:"row"}},(0,I.tZ)("div",{style:{marginRight:"2rem"}},(0,I.tZ)(Z.Z,{isSelected:!0,title:(0,c.t)("Layer configuration"),info:(0,c.t)("Configure the basics of your Annotation Layer.")},(0,I.tZ)(C.Z,{name:"annotation-layer-name",label:(0,c.t)("Name"),placeholder:"",value:e,onChange:t=>this.setState({name:t}),validationErrors:e?[]:[(0,c.t)("Mandatory")]}),(0,I.tZ)(T.Z,{name:"annotation-layer-hide",label:(0,c.t)("Hide layer"),value:!i,onChange:t=>this.setState({show:!t})}),(0,I.tZ)(T.Z,{name:"annotation-label-show",label:(0,c.t)("Show label"),value:l,hovered:!0,description:(0,c.t)("Whether to always show the annotation label"),onChange:t=>this.setState({showLabel:t})}),(0,I.tZ)(A.Z,{ariaLabel:(0,c.t)("Annotation layer type"),hovered:!0,description:(0,c.t)("Choose the annotation layer type"),label:(0,c.t)("Annotation layer type"),name:"annotation-layer-type",clearable:!1,options:u,value:n,onChange:this.handleAnnotationType}),d.length>0&&(0,I.tZ)(A.Z,{ariaLabel:(0,c.t)("Annotation source type"),hovered:!0,description:(0,c.t)("Choose the source of your annotations"),label:(0,c.t)("Annotation source"),name:"annotation-source-type",options:d,notFoundContent:(0,I.tZ)(D,null),value:a,onChange:this.handleAnnotationSourceType,validationErrors:a?[]:[(0,c.t)("Mandatory")]}),this.renderValueConfiguration())),this.renderSliceConfiguration(),this.renderDisplayConfiguration()),(0,I.tZ)("div",{style:{display:"flex",justifyContent:"space-between"}},t?(0,I.tZ)(h.Z,{buttonSize:"small",onClick:()=>this.props.close()},(0,c.t)("Cancel")):(0,I.tZ)(h.Z,{buttonSize:"small",onClick:this.deleteAnnotation},(0,c.t)("Remove")),(0,I.tZ)("div",null,(0,I.tZ)(h.Z,{buttonSize:"small",disabled:!s,onClick:this.applyAnnotation},(0,c.t)("Apply")),(0,I.tZ)(h.Z,{buttonSize:"small",buttonStyle:"primary",disabled:!s,onClick:this.submitAnnotation},(0,c.t)("OK")))))}}z.propTypes=F,z.defaultProps=M;const q=(0,g.b)(z)},60524:(t,e,n)=>{n.d(e,{$:()=>r,f:()=>s});var o=n(22087),a=n.n(o);const i=[[new RegExp(/==/g),"Eq"],[new RegExp(/>=/g),"Gte"],[new RegExp(/<=/g),"Lte"],[new RegExp(/>/g),"Gt"],[new RegExp(/</g),"Lt"]],l=[{type:3,token:"x",show:"x",value:"x"},{type:2,token:"&",show:"&",value:(t,e)=>t&e},{type:2,token:"|",show:"|",value:(t,e)=>t|e},{type:2,token:"and",show:"and",value:(t,e)=>t&&e},{type:2,token:"xor",show:"xor",value:(t,e)=>t^e},{type:2,token:"or",show:"or",value:(t,e)=>Number(t||e)},{type:2,token:"Eq",show:"Eq",value:(t,e)=>Number(t===e)},{type:2,token:"Lt",show:"Lt",value:(t,e)=>Number(t<e)},{type:2,token:"Lte",show:"Lte",value:(t,e)=>Number(t<=e)},{type:2,token:"Gt",show:"Gt",value:(t,e)=>Number(t>e)},{type:2,token:"Gte",show:"Gte",value:(t,e)=>Number(t>=e)}];function s(t,e){var n;let o=t;i.forEach((t=>{let[e,n]=t;o=o.replace(e,n)}));const s=String(o).split("=");return o=null!=(n=s[1])?n:s[0],Number(a().eval(o,l,{x:e}))}function r(t){try{s(t,0)}catch(t){return!1}return!0}}}]);
//# sourceMappingURL=c800a320ff0516f83fb9.chunk.js.map