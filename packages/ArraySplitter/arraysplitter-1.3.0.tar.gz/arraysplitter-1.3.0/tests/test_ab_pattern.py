"""
Test for A-B pattern detection and merging.

Problem case: chr12_mat_20637969_20812442 from zebra finch satDNA
- Current result: 492 monomers with bimodal distribution (161bp, 536bp)
- Expected: ~250 monomers of ~700bp (A+B merged)
- Root cause: cut sequence appears twice per true monomer
"""
import sys
sys.path.insert(0, 'src')

from collections import Counter
from statistics import mean, stdev

from ArraySplitter.decompose import (
    decompose_array,
    detect_and_fix_ab_pattern,
    rotate_monomers_to_cut,
)


# First 15000bp of chr12_mat_20637969_20812442 (enough for ~20 A-B pairs)
# This produces bimodal distribution: 161bp (21x) and 556bp (7x) before fix
TEST_SEQUENCE = "GCTTTTCCAGCGTGTCTGGCAGGGAGAAAGCTTGCCAGCGCAGTGCACGCATCCCGCCCTTGCCCAGAAACATGGATCTGCTGAACACTCCAAAAACACTACTCTTTCCTAGGCAAGCTTCAAACTGCTGTCAGACATATGTGCTCTCTGTTTTATAATGTCCTGCTCGTTGTAGAAGTGTGCACAGCTCCACCTGACATTCAGTGCACAGCGAAGTCAACTGCAAAACACTAGCAGCTGCTCACTCCCAAACACAAGGCGCTGTCTATGTCCTTGCTTCCCGAGCAACTCAGCGCAGCCCTTCTTCTCTGCATCTCGGAAGCTCAGGGCACGAACAAGAATTCTCCAGATTCGTCTGCATCAGGACCAAGTCAAAACGCAGGAAAGTCGTCCTGGAGCACCTGCCAGAAGCATGCCAGCGGTTAACTGAAAGCGCAGGCAGCGGCAGCCACCGTCTTCTAGCAGTGCCAAGGCTGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCCCCGGCTGCCGGAGGCGAAGAAGCGGCTACTAAGTGCACCGCTGACGTGAACCGCACTTGTAGGCTGCAAAGCGCGGCTTCGGCAGAAAGAAGCCGGCAACCGCCGCTTTCCTGCGGACAGCTACGGAGAGCCGAAGTCGGCGTATCAAGCGGACTGCATCATAGCGAAAAGCTTTTCCAGCGTGTCTGGCAGGGAGAAAGCTTGCCAGCGCAGTGCACGCATCCCGCCCTTGCCCAGAAACATATATTTGCTGAACACTCCAAAAACACTGCTCTTTGCTAGGCAAGCTTCAAACTGCTGTCAGACGTCCGTGCTCTCTATTTTCTGCTGTTCTCCTCGTAGTAGAAGTGTGCACAGCTCCACCTGACATTCAGTGCACAGCGAAGTCAACTGCAAAACACTAGCAGCTGCTCACTCCCAAACACAAGGCGCTGTCTATGTCCTTGCTTCCCGAGCAATTCAGCACAGCCCTTCTTTTCTGCAGCTGCCATCGAGTTCTCTGCCACTCGGAAGCTCAGGGTACGAACAAGAATTCTCCAGATTCGTCTGCATCAGGACCATGTCAAAACGCAGGAAAGTCGTACTGGAGCACCTGCCAGATGCATGCCAGCGGTTAACTGAAAGCGCAGGCAGCGGCAGCCACCGTCTTCTAGCAGTGCCAAGGCTGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCCCCGGCTGCCGGAGGCGAAGAAGCGGCTACTAAGTGCACCGCTGACGTGAACCGCACTTGTAGGCTGCAAAGCGCGGCTTCGGCAGAAAGAAGCCGGCAACCGCCGCTTTCCTGCGGACAGCTGCGGAGAGCCGGAGTCTGCGTCTCTAGCGGACTGCAGCATAGCGAAAAGCTTTTCCAACGTCTCTCGCAGGAAGAAAGCTGGTCAGCACAGTGCACGCATCCCGCCCTTGCCCAGAAACATGGATCTGCTGAACACTCCAAAAACACTGCTCTTTCCTAGGCAAGCTTCAAACTGCCGTCAGACATCTGTGCTCTCTGTTTTGTAGTGTTCTGCTCTTTGTAGAAGTGTGCTCAGCTCACGCTGGCATTCAGTGCACAGCGAAGTCAACTGCAAAAAACCAGCAGCTGCTCACTCCCAAACACAGGGCGCTGTCTATGTCCTTGCTTCCCGAGCAACTCAGCACAGCCCTTCTTTTCTGCAGCTGCCCTCAAGTTCTCTGCATCTCGGAAGCTCAGGGTACGAACAAGAATTCTCCAGATTCGTCTGCATCAGGACCAAGTCAAAACGCAGGAAAGTCGTCCAGGAGCACTTGCCAGAAGCATCCCAGGGGTGAACTGAAAGGGCTGGCAGCTGCAGCCACCGTCCTCTAGCAGTGCCAAGGTTGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCCCCGGCTGCCGGAGGCGAAGAAGCGGCTACTAAGTGCACCGCTGACGTGAACCGCACTTGTAGGCTGCAAAGCGCGGCTTCGGCAGAAAGAAGCCGGCAACCGCCGCTTTCCTGCGGACAGCTGCGGAGAGCCGGAGTCTGCGTCTCTAGCGGACTGCAGCATAGCGAAAAGTTTTTCCAGCGTGTCTCGCAGGGAGAAAGCTTGCCAGCACAGTGCACACATCCCGCCCTTGCCCAGAACAATATATTTGCTGAACACCCCAAAAACACTACTCTTTTCTAGGCAAGCTTCAAACTGCTGTCAGACATCTGTGCTCTCTGTTTTGTGGTGTGCTGCTCGTTGTGGAAGTGTGCACAGCTCCACCTGACATTCAGTGCACAGCGAAGTCAATTGCAAAAAACCAACAGCTGCTCACTCCCAAACACAAGGCGCTGTCTATGTCCTTGCTTCCCGAGCAACTCAGCACAGCCCTTCTTTTCTGCAGCTGCCCTCGAGTTCTCTGCATCTCGGAAGCTCAGGGTACGAACAAGAATTCTCCAGATTCGTCTGCATCAGGACCAAGTCAAAACGCAGGAAAGTCGTCCTGGAGCACTTGCCAGAAGCATCCCAGGGGTGCACTGAAAGGGCTGGCAGCTGCAGCCACCGTCCTCTAGCAGTGCAAAGGCTGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCCCCGGCTGCCGGAGGCGAAGAAGCGGCTACTATGTGCACCGCTGACGTGAACCGCACTTGTAGGCTGCAAAGCGCGGCTTCGGCAGAAAGACGCCGGCAACCGCCGCTTTCCTGCGGACAGCTGAGGAGAGCCGGAGTCTGCGTCTCTATAGGACTACATCATGGCGAAAAGCTTTTCCAACGTCTCTCGCTGGGAGAAAGCTGGTCAGCACAGTGCACGCATCCCGCCCTTGCCCAGAAACATGGATCTGCTGAACACTCCAAAAACACTGCTCTTTGCTAGGCCAGCTTCAAACTGCTGTCAGACGTCCGTGCTCTCTGTTTTCTGCTGCCCTACTCGTTGTAGAGGAGTGCACAGCTCACCCTGGCATTCAGTGCACAGCGAAGTCAATTGCAAAAAACCAGCAGCTGCTCACTCCCAAACACAAGGCGCTGTCTATGTCCTTGCTTCCCGAGCAACTCAGCGCAGCACTTCTTCTCTGCATCTCGGGAGCTCAGGGCACGAACAAGAATTCTCCAGATACGTCTGCATCAGGAACCAAGTCAAAACCCAGGAAAGTCGTCCTGGAGCACTTGCCAGAAGCATCCCAGAGGTGAACTGAAAGGGCTGGTAGTTGCAGCCACTGTACTCTAGCAGTGCCAAGGCTGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCGCCGGCTGCCGGAGGCGAAGAAGCGGCTACTAGGTGCACCGCTGACGTGAACCGCACTTGTAGGCTGCAAAGCGCGGTTTCGGCAGAAAGACGCCGGCAACCGCCGCTTTCCTGCGGACAGCTACGGAGAGCCGAAGTCTGCGTCTCTAGCGGACTGCATCTTAGCGAAAAGCTTTTCCAGCGTGTCTCGCAGGGAGAGAGCTTGCCAGCACAGTGCACGCATCCCGCCCTTGCCCAGAAACATGGATTTGCTGAACACTCCAAAAACACTGCTCTTTCCTAGGCAAGCTTCAAACTGCCGTCAGACATCTGTGCTCTCTGTTTTGTAGTGTTCTGCTCGTTGTAGAAGTGTGCTCAGCTCACGCTGGCATTCAGTGCACAGCGAAGTCAACTGCAAAACAGCAGCAGATGCTCACTCCCAAACACAAGGCGCTGTCTATGTCCTTGCTTCCCGAGCAACTCAGCGCAGCCCTTCTGTGCATCTCGGAAGCTCAGGGCACGAACAAGAATTCTCCAGATTCGGCTGCATCAGGACCAAGTCAAAACGCAGGAAAGTCGTCCTGGAGCACCTGCCAGAAGCATGCCAGCGGTGAACTGAAAGGGCTGGCAGCTGCAGCCACCGTCCTCTAGCAGTGCCAAGGCTGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCCCCGGCTGCCGGAGGCGAAGAAGCGGCTACCAGGTGCACCGCTGACGTGAACCGCACTTGTAGGCTGCAAAGCGCGGCTTCGGCAGAAAGACGCCGGCAACCGCCGCTTTCCTGCGGACAGCTGCGGAGAGCCGGAGTCTGCGTCTCTAGCGGACTGCATCATAGCGAAAAACTTTTCCAGCGTGTCTCGCAGGGAGAAAGCTTGCCAGCACAGTGCACGCATGCCGCCCTTGCCCAGAAACATGGATTTGCTGAACACTACAAAAACACTACTCTTTCCTAGGCAAGCTTCAAACTGCTGTCAGACATCCGTGCTCTCTGTTTTCTGCTGCCCTGCTCGTTGTAGAAGTGTGCTCAGCTCACCCTGGCATTCAGTGCACAGCGAAGTCAATTGCAAAAAACCAACAGCTGCTCACTCCCAAACACAAGGCGCTGTCTATGTCCTTGCTTCCCGAGCAACTCAGCACAGCCCTTCTTTTCTGCAGCTGCCCTCGAGTTCTCTGCATCTCGGAAGCTCAGGGTACGAACAAGAATTCTCCAGATTCGTCTGCATCAGGACCAAGTCAAAACGCAGGAAAGTCGTCCTGGAGCACTTGCCAGAAGCATCCCAGGGGTGCACTGAAAGGGCTGGCAGCTGCAGCCACCGTCCTCTAGCAGTGCCAAGGCTGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCGCCGGCTGCCGGAGGCGAAGAAGCGGCTACTATGTGCACCGCTGACGTGAACCGCACTTGTAGGCTGCAAAGCGCGGCTTCGGCAGAAAGACGCCGGCAACTGCCGCTTTCCTGCGGACAGCTGAGGAGAGCCGGAGTCTGCGTCTCTATAGGACTACATCATGGCGAAAAGCTTTTCCAACGTCTCTCGCAGGAAGAAAGCTGGTCAGCACAGTGCACGCATCCCGCCCTTGCCCAGAAACATGGATCTGCTGAACACTCCAAAAACACTGCTCTTTGCTAGGCCAGCTTCAAACTGCTGTCAGACGTCCGTGCTCTCTGTTTTCTGCTGCCCTACTCGTTGTAGAGGAGTGCACAGCTCACCCTGGCATTCAGTGCACAGCGAAGTCAATTGCAAAAAACCAGCAGCTGCTCACTCCCAAACACAAGGCGCTGTCTATGTCCTTGCTTCCCGAGCAACTCAGCGCAGCACTTCTTCTCTGCATCTCGGGAGCTCAGGGCACGAACAAGAATTCTCCAGATACGTCTGCATCAGGAACCAAGTCAAAACCCAGGAAAGTCGTCCTGGAGCACTTGCCAGAAGCATCCCAGAGGTGAACTGAAAGGGCTGGTAGTTGCAGCCACTGTACTCTAGCAGTGCCAAGGCTGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCGCCGGCTGCCGGAGGCGAAGAAGCGGCTACTAGGTGCACCGCTGACGTGAACCGCACTTGTAGGCTGCAAAGCGCGGTTTCGGCAGAAAGACGCCGGCAACCGCCGCTTTCCTGCGGACAGCTGCGGAGAGCCGAAGTCTGCGTCTCTAGCGGACTGCATCTTAGCGAAAAGCTTTTCCAGCGTGTCTCGCAGGGAGAGAGCTTGCCAGCACAGTGCACGCATCCCGCCCTTGCCCAGAAACATGGATTTGCTGAACACTCCAAAAACACTGCTCTTTCCTAGGCAAGCTTCAAACTGCCGTCAGACATCTGTGCTCTCTGTTTTGTAGTGTTCTGCTCGTTGTAGAAGTGTGCTCAGCTCACGCTGGCATTCAGTGCACAGCGAAGTCAACTGCAAAACAGCAGCAGATGCTCACTCCCAAACACAAGGCGCTGTCTATGTCCTTGCTTCCCGAGCAACTCAGCGCAGCCCTTCTGTGCATCTCGGAAGCTCAGGGCACGAACAAGAATTCTCCAGATTCGTCTGCATCAGGACCAAGTCAAAACGCAGGAAAGTCGTCCTGGAGCACCTGCCAGAAGCATGCCAGCGGTGAACTGAAAGGGCTGGCAGCTGCAGCCACCGTCCTCTAGCAGTGCCAAGGCAGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCGCCGGCTGCCGGAGGCGAAGAAGCGGCTACTATGTGCACCGCTGACGTGAACAGCACTTGTAGGCTGCAAAGCGCGGCTTCGGCAGAAAGACGCCGGCAACCGCCGCTTTCCTGCGGACAGCTGAGGAGAGCCGGAGTCTGCGTCTCTATAGGACTACATCATGGCGAAAAGCTTTTCCAACGTCTCTCGCAGGAAGAAAGCTGGTCAGCACAGTGCACGCATCCCGCCCTTGCCCAGAAACATGGATCTGCTGAACACTCCAAAAACACTGCTCTTTGCTAGGCCAGCTTCAAACTGCTGTCAGACGTCCGTGCTCTCTGTTTTCTGCTGCCCTACTCGTTGTAGAGGAGTGCACAGCTCACCCTGGCATTCAGTGCACAGCGAAGTCAATTGCAAAAAACCAGCAGCTGCTCACTCCCAAACACAAGGCGCTGTCTATGTCCTTGCTTCCCGAGCAACTCAGCGCAGCACTTCTTCTCTGCATCTCGGGAGCTCAGGGCACGAACAAGAATTCTCCAGATACGTCTGCATCAGGAACCAAGTCAAAACCCAGGAAAGTCGTCCTGGAGCACCTGCCAGAAGCATCCCAGGGGTGCACTGAAAGGGCTGGCAGCTGCAGCCACCGTCCTCTAGCAGTGCCAAGGCAGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCCCCGGCTGCCGGAGGCGAAGAAGCGGCTACTAGGTGCACCGCTGACGTGAACCGCACTTGTAGGCTGCAAAGCGCGGCTTCGGCAGAAAGACGCCGGCAACCGCCGCTTTCCTGCGGACAGCTGCGGAGAGCCGGAGTCTGCGTCTCTAGCGGACTGCATCATAGCGAAAAGCTTTTCCAGCGTGTCTCGCAGGGAGAAAGCTTGCCAGCACAGTGCACGCATGCCGCCCTTGCCCAGAAACATGGATTTGCTGAACACTCCAAAAACACTACTCTTTCCTAGGCAAGCTTCAAACTGCTGTCAGACATCCGTGCTCTCTGTTTTCTGCTGCCCTGCTCGTTGTAGAAGTGTGCTCAGCTCACCCTGGCATTCAGTGCACAGCGAAGTCAATTGCAAAAAACCAGCAGCTGCTCACTCCCAAACACAAGGCGCTGTCTATGTCCTTGCTTCCCGAGCAACTCAGCACAGCCCTTCTTTTCTGCAGCTGCCCTCGAGTTCTCTGCATCTCGGAACCCTCAGGGTACGAACAAGAATTCTCCAGATTCGTCTGCATCAGGACCAAGTCAAAACGCAGGAAAGTCGTCCTGGAGCACTTGTCAGAAGCATCCCAGGGGTGCACTGAAAGGGCTGGCAGCTGCAGCCACCGTCCTCTAGCAGTGCCAAGGCTGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCCCCGGCTGCCGGAGGCGAAGAAGCGGCTACTATGTGCACCGCTGACGTGAACCGCACTTGTAGGCTGCAAAGCGCGGCTTCGGCAGAAAGACGCCGGCAACCGCCGCTTTCCTGCGGACAGCTGAGGAGAGCCGGAGTCTGCGTCTCTATAGGACTACATCATGGCGAAAAGCTTTTCCAACGTCTCTCGCAGGAAGAAAGCTGGTCAGCACAGTGCACGCATCCCGCCCTTGCCCAGAAACATGGATCTGCTGAACACTCCAAAAACACTGCTCTTTGCTAGGCCAGCTTCAAACTGCTGTCAGACGTCCGTGCTCTCTGTTTTCTGCTGCCCTACTCGTTGTAGAGGAGTGCACAGCTCACCCTGGCATTCAGTGCACAGCGAAGTCAATTGCAAAAAACCAGCAGCTGCTCACTCCCAAACACAAGGCGCTATGTCCTTGCTTCCCGAGCAACTCAGCGCAGCCCTTCTGTGCATCTCGGAAGCTCAGGGCACAAACAAGAATTCTCCAGATTCGGCTGCATCAGGACCAAGTCAAAACGCAGGAAAGTCGTCCTGGAGCACCTGCCAGAAGCATGCCAGCGGTGAACTGAAAGGGCTGGCAGCTGCAGCCACCGTCCTCTAGCAGTGCCAAGGCTGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCCCCGGCTGCCGGAGGCGAAGAAGCGGCTACCAGGTGCACCGCTGACGTGAACCGCACTTGTAGGCTGCAAAGCGCGGCTTCGGCAGAAAGACGCCGGCAACCGCCGCTTTCCTGCGGACAGCTGCGGAGAGCCGGAGTCTGCGTCTCTAGCGGACTGCATCATAGCGAAAAGCTTTTCCAGCGTGTCTCGCAGGGAGAAAGCTTGCCAGCACAGTGCACGCATGCCGCCCTTGCCCAGAAACATGGATTTGCTGAACACTACAAAAACACTACTCTTTCCTAGGCAAGCTTCAAACTGCTGTCAGACATCCGTGCTCTCTGTTTTCTGCTGCCCTACTCGTAGTAGAAGTGTGCTCAGCTCACCCTGGCATTCAGTGCACAGCGAAGTCAATTGCAAAAAACCAACAGCTGCTCACTCCCAAACACAAGGCGCTGTCTATGTCCTTGCTTCCCGAGCAACTCAGCACAGCCCTTCTTTTCTGCAGCTGCCCTCGAGTTCTCTGCATCTCGGAAGCTCAGGGTACGAACAAGAATTCTCCAGATTCGTCTGCATCAGGACCAAGTCAAAACGCAGGAAAGTCGTCCTGGAGCACTTGCCAGAAGCATCCCAGGGGTGCACTGAAAGGGCTGGCAGCTGCAGCCACCGTCCTCTAGCAGTGCCAAGGCTGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCGCCGGCTGCCGGAGGCGAAGAAGCGGCTACTATGTGCACCGCTGACGTGAACCGCACTTGTAGGCTGCAAAGCGCGGCTTCGGCAGAAAGACGCCGGCAACTGCCGCTTTCCTGCGGACAGCTGAGGAGAGCCGGAGTCTGCGTCTCTATAGGACTACATCATGGCGAAAAGCTTTTCCAACGTCTCTCGCAGGAAGAAAGCTGGTCAGCACAGTGCACGCATCCCGCCCTTGCCCAGAAACATGGATCTGCTGAACACTCCAAAAACACTGCTCTTTGCTAGGCCAGCTTCAAACTGCTGTCAGACGTCCGTGCTCTCTGTTTTCTGCTGCCCTACTCGTTGTAGAGGAGTGCACAGCTCACCCTGGCATTCAGTGCACAGCGAAGTCAATTGCAAAAAACCAGCAGCTGCTCACTCCCAAACACAAGGCGCTGTCTATGTCCTTGCTTCCCGAGCAACTCAGCGCAGCACTTCTTCTCTGCATCTCGGGAGCTCAGGGCACGAACAAGAATTCTCCAGATACGTCTGCATCAGGAACCAAGTCAAAACCCAGGAAAGTCGTCCTGGAGCACTTGCCAGAAGCATCCCAGAGGTGAACTGAAAGGGCTGGTAGTTGCAGCCACTGTACTCTAGCAGTGCCAAGGCTGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCGCCGGCTGCCGGAGGCGAAGAAGCGGCAACTAGGTGCACCGCTGACGTGAACCGCACTTGTAGGCTGCAAAGCGCGGTTTCGGCAGAAAGACGCCGGCAACCGCCGCTTTCCTGCGGACAGCTGCGGAGAGCCGAAGTCTGCGTCTCTAGCGGACTGCATCTTAGCGAAAAGCTTTTCCAGCGTGTCTCGCAGGGAGAGAGCTTGCCAGCACAGTGCACGCATCCCGCCCTTGCCCAGAAACATGGATTTGCTGAACACTCCAAAAACACTGCTCTTTCCTAGGCAAGCTTTAAACTGCCGTCAGACATCTGTGCTCTCTGTTTTGTAGTGTTCTGCTCGTTGTAGAAGTGTGCTCAGCTCACGCTGGCATTCAGTGCACAGCGAAGTCAACTGCAAAACAGCAGCAGATGCTCACTCCCAAACACAAGGCGCTGTCTATGTCCTTGCTTCCCGAGCAACTCAGCGCAGCCCTTCTGTGCATCTCGGAAGCTCAGGGCACGAACAAGAATTCTCCAGATTCGTCTGCATCAGGACCAAGTCAAAACGCAGGAAAGTCGTCCTGGAGCACCTGCCAGAAGCATGCCAGCGGTGAACTGAAAGGGCTGGCAGCTGCAGCCACCGTCCTCTAGCAGTGCCAAGGCAGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCGCCGGCTGCCGGAGGCGAAGAAGCGGCTACTATGTGCACCGCTGACGTGAACCGCACTTGTAGGCTGCAAAGCGCGGCTTCGGCAGAAAGACGCCGGCAACCGCCGCTTTCCTGCGGACAGCTGAGGAGAGCCGGAGTCTGCGTCTCTATAGGACTACATCATGGCGAAAAGCTTTTCCAACGTCTCTCGCAGGAAGAAAGCTGGTCAGCACAGTGCACGCATCCCGCCCTTGCCCAGAAACATGGATCTGCTGAACACTCCAAAAACACTGCTCTTTGCTAGGCCAGCTTCAAACTGCTGTCAGACGTCCGTGCTCTCTGTTTTCTGCTGCCCTACTCGTTGTAGAGGAGTGCACAGCTCACCCTGGCATTCAGTCCACAGCGAAGTCAATTGCAAAAAACCAGCAGCTGCTCACTCCCAAACACAAGGCGCTGTCTATGTCCTTGCTTCCCGAGCAACTCAGCGCAGCACTTCTCTGCATCTCGGGAGCTCAGGGCACGAACAAGAATTCTCCAGATACGTCTGCATCAGGAACCAAGTCAAAACCCAGGAAAGTCGTCCTGGAGCACCTGCCAGAAGCATCCCAGGGGTGCACTGAAAGGGCTGGCAGCTGCAGCCACCGTCCTCTAGCAGTGCCAAGGCAGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCCCCGGCTGCCGGAGGCGAAGAAGCGGCTACTAGGTGCACCGCTGACGTGAACCGCACTTGTAGGCTGCAAAGCGCGGCTTCGGCAGAAAGACGCCGGCAACCGCCGCTTTCCTGCGGACAGCTGCGGAGAGCCGGAGTCTGCGTCTCTAGCGGACTGCATCATAGCGAAAAGCTTTTCCAGCGTGTCTCGCAGGGAGAAAGCTTGCCAGCACAGTGCACGCATGCCGCCCTTGCCCAGAAACATGGATTTGCTGAACACTACAAAAACACTACTCTTTCCTAGGCAAGCTTCAAACTGCTGTCAGACATCCGTGCTCTCTGTTTTCTGCTGCCCTGCTCGTAGTAGAAGTGTGCTCAGCTCACCCTGGCATTCAGTGCACAGCGAAGTCAATTGCAAAAAACCAACAGCTGCTCACTCCCAAACACAAGGCGCTGTCTATGTCCTTGCTTCCCGAGCAACTCAGCACAGCCCTTCTTTTCTGCAGCTGCCCTCGAGTTCTCTGCATCTCGGAAGCTCAGGGTACGAACAAGAATTCTCCAGATTCGTCTGCATCAGGACCAAGTCAAAACGCAGGAAAGTCGTCCTGGAGCACTTGCCAGAAGCATCCCAGGGGTGCACTGAAAGGGCTGGCAGCTGCAGCCACCGTCCTCTAGCAGTGCCAAGGCTGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCGCCGGCTGCCGGAGGCGAAGAAGCGGCTACCAGGTGCACCGCTGACGTGAACCGCACTTGTAGGCTGCAAAGCGCGGCTTCGGCAGAAAGACGCCGGCAACTGCCGCTTTCCTGCGGACAGCTGAGGAGAGCCGGAGTCTGCGTCTCTATAGGACTACATCATGGCGAAAAGCTTTTCCAACGTCTCTCGCAGGAAGAAAGCTGGTCAGCACAGTGCACGCATCCCGCCCTTGCCCAGAAACATGGATCTGCTGAACACTCCAAAAACACTGCTCTTTGCTAGGCCAGCTTCAAACTGCTGTCAGACGTCCGTGCTCTCTGTTTTCTGCTGCCCTACTCGTTGTAGAGGAGTGCACAGCTCACCCTGGCATTCAGTGCACAGCGAAGTCAATTGCAAAAAACCAGCAGCTGCTCACTCCCAAACACAAGGCGCTGTCTATGTCCTTGCTTCCCGAGCAACTCAGCGCAGCACTTCTTCTCTGCATCTCGGGAGCTCAGGGCACGAACAAGAATTCTCCAGATACGTCTGCATCAGGAACCAAGTCAAAACCCAGGAAAGTCGTCCTGGAGCACTTGCCAGAAGCATCCCAGAGGTGAACTGAAAGGGCTGGTAGTTGCAGCCACTGTACTCTAGCAGTGCCAAGGCTGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCGCCGGCTGCCGGAGGCGAAGAAGCGGCTACTAGGTGCACCGCTGACGTGAACCGCACTTGTAGGCTGCAAAGCGCGGTTTCGGCAGAAAGACGCCGGCAACCGCCGCTTTCCTGCGGACAGCTGCGGAGAGCCGAAGTCTGCGTCTCTAGCGGACTGCATCTTAGCGAAAAGCTTTTCCAGCGTGTCTCGCAGGGAGAGAGCTTGCCAGCACAGTGCACGCATCCCGCCCTTGCCCAGAAACATGGATTTGCTGAACACTCCAAAAACACTGCTCTTTCCTAGGCAAGCTTCAAACTGCCGTCAGACATCTGTGCTCTCTGTTTTGTAGTGTTCTGCTCGTTGTAGAAGTGTGCTCAGCTCACGCTGGCATTCAGTGCACAGCGAAGTCAACTGCAAAACAGCAGCAGATGCTCACTCCCAAACACAAGGCGCTGTCTATGTCCTTGCTTCCCGAGCAACTCAGCGCAGCCCTTCTGTGCATCTCGGAAGCTCAGGGCACGAACAAGAATTCTCCAGATTCGTCTGCATCAGGACCAAGTCAAAACGCAGGAAAGTCGTCCTGGAGCACCTGCCAGAAGCATGCCAGCGGTGAACTGAAAGGGCTGGCAGCTGCAGCCACCGTCCTCTAGCAGTGCCAAGGCAGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCCCCGGCTGCCGGAGGCGAAGAAGCGGCTACTAGGTGCACCGCTGACGTGAACCGCACTTGTAGGCTGCAAAGCGCGGCTTCGGCAGAAAGACGCCGGCAACCGCCGCTTTCCTGCGGACAGCTGCGGAGAGCCGGAGTCTGCGTCTCTAGCGGACTGCATCATAGCGAAAAGCTTTTCCAGCGTGTCTCGCCGGGAGAGAGCTTGCCAGCACAGTGCACGCATGCCGCCCTTGCCCAGAAACATGGATTTGCTGAACACTCCAAAAACACTACTCTTTCCTAGGCAAGCTTCAAACTGCTGTCAGACATCCGTGCTCTCTGTTTTCTGCTGCCCTACTCGTTGTAGAAGTGTGCTCAGCTCACCCTGGCATTCAGTGCACAGCGAAGTCAATTCCAAAAAACCAACAGCTGCTCACTCCCAAACACAAGGCGCTGTCTATGTCCTTGCTTCCCGAGCAACTCAGCACAGCCCTTCTTTTCTGCAGCTGCCCTCGAGTTCTCTGCATCTCGGAAGCTCAGGGTACGAACAAGAATTCTCCAGATTCGTCTGCATCAGGACCAAGTCAAAACGCAGGAAAGTCGTCCTGGAGCACTTGCCAGAAGCATCCCAGGGGTGCACTGAAAGGGCTGGCAGCTGCAGCCACCGTCCTCTAGCAGTGCCAAGGCTGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCCCCGGCTGCCGGAGGCGAAGAAGCGGCTACTATGTGCACCGCTGACGTGAACCGCACTTGTAGGCTGCAAAGCGCGGCTTCGGCAGAAAGACGCCGGCAACCGCCGCTTTCCTGCGGACAGCTGAGGAGAGCCGGAGTCTGCGTCTCTATAGGACTACATCATGGCGAAAAGCTTTTCCAACGTCTCTCGCAGGGAGAAAGCTGGTCAGCACAGTGCACGCATCCCGCCCTTGCCCAGAAACATGGATCTGCTGAACACTCCAAAAACACTGCTCTTTGCTAGGCCAGCTTCAAACTGCTGTCAGACGTCCGTGCTCTCTGTTTTCTGCTGCCCTACTCGTTGTAGAGGAGTGCACAGCTCACCCTGGCATTCAGTGCACAGCGAAGTCAATTGCAAAAAACCAGCAGCTGCTCACTCCCAAACACAAGGCGCTGTCTATGTCCTTGCTTCCCGAGCAACTCAGCGCAGCACTTCTTCTCTGCATCTCGGGAGCTCAGGGCACGAACAAGAATTCTCCAGATACGTCTGCATCAGGAACCAAGTCAAAACCCAGGAAAGTCGTCCTGGAGCACTTGCCAGAAGCATCCCAGAGGTGAACTGAAAGGGCTGGTAGTTGCAGCCACTGTACTCTAGCAGTGCCAAGGCTGCGCACACAAGCCGGTTTCGTTCTTCGCCTCTCAGAAGCCAACCGCTCTCGCCGGCTGCCGGAGGCGAAGAAGCGGCTACTAGGTGCACCGCTGACGTGAACCGCACTTGTAGGCTGCAAAGCGCGGTTTCGGCAGAAAGACGCCGGCAACCGCCGCTTTCCTGCGGACAGCTGCGGAGAGCCGAAGTCTGCGTCTCTAGCGGACTGCATCTTAGCGAAAAGCTTTTCCAGCGTGTCTCGCAGGGAGAGAGCTTGCCAGCACAGTGCACGCATCCCGCCCTAGCCCAGAAACTTGGATTTGCTGAACACTCCAAAAACACTGCTCTTTCCTAGGCAAGCTTCAAACTGCTGTCAGACATCTGTGCTCTCTGTTTTGTAGTGTTCTGCTCGTTGTAGAAGTGTGCTCAGCTCACGCTGGCATTCAGTGCACAGCGAAGTCAACTGCAAAACA"


def calculate_cv(lengths):
    """Calculate coefficient of variation."""
    if len(lengths) < 2:
        return 0
    m = mean(lengths)
    s = stdev(lengths)
    return s / m if m > 0 else 0


def test_ab_pattern_detection():
    """Test that A-B pattern is detected and merged."""
    # Run decomposition
    decomp, _, cut_seq, _, period = decompose_array(TEST_SEQUENCE, verbose=False)

    # Rotate monomers
    decomp = rotate_monomers_to_cut(decomp, cut_seq)

    # Get lengths before A-B fix
    lengths_before = [len(m) for m in decomp if m.startswith(cut_seq)]
    cv_before = calculate_cv(lengths_before)
    mean_before = mean(lengths_before) if lengths_before else 0

    print(f"\n=== Before A-B pattern fix ===")
    print(f"Cut sequence: {cut_seq}")
    print(f"Number of monomers: {len(decomp)}")
    print(f"Mean length: {mean_before:.1f}")
    print(f"CV: {cv_before:.3f}")
    print(f"Length distribution: {Counter(lengths_before).most_common(5)}")

    # Apply A-B pattern detection
    decomp_fixed, was_merged = detect_and_fix_ab_pattern(decomp, cut_seq, verbose=True)

    # Get lengths after fix
    lengths_after = [len(m) for m in decomp_fixed if m.startswith(cut_seq)]
    cv_after = calculate_cv(lengths_after)
    mean_after = mean(lengths_after) if lengths_after else 0

    print(f"\n=== After A-B pattern fix ===")
    print(f"Was merged: {was_merged}")
    print(f"Number of monomers: {len(decomp_fixed)}")
    print(f"Mean length: {mean_after:.1f}")
    print(f"CV: {cv_after:.3f}")
    print(f"Length distribution: {Counter(lengths_after).most_common(5)}")

    # Verify reconstruction
    original = "".join(decomp)
    reconstructed = "".join(decomp_fixed)
    assert original == reconstructed, "Reconstruction failed!"
    print(f"\nReconstruction: PERFECT")

    # Assertions for A-B pattern case
    if was_merged:
        # CV should be significantly lower after merge
        assert cv_after < cv_before * 0.6, f"CV not reduced enough: {cv_before:.3f} -> {cv_after:.3f}"

        # Mean length should be approximately doubled (A+B)
        assert mean_after > mean_before * 1.5, f"Mean not increased enough: {mean_before:.1f} -> {mean_after:.1f}"

        # Number of monomers should be roughly halved
        assert len(decomp_fixed) < len(decomp) * 0.7, f"Monomers not reduced enough: {len(decomp)} -> {len(decomp_fixed)}"

        print("\n✓ A-B pattern was correctly detected and merged!")
    else:
        # If not merged, check why
        print("\n⚠ A-B pattern was NOT merged - check if conditions were not met")


def test_no_false_positive_merge():
    """Test that non-A-B patterns are not incorrectly merged."""
    # Create a simple uniform repeat pattern (no A-B)
    uniform_monomer = "CAGTGCAC" + "A" * 150  # 158bp uniform monomers
    uniform_sequence = uniform_monomer * 20

    decomp, _, cut_seq, _, _ = decompose_array(uniform_sequence, verbose=False)
    decomp = rotate_monomers_to_cut(decomp, cut_seq)

    # Apply A-B detection
    decomp_after, was_merged = detect_and_fix_ab_pattern(decomp, cut_seq, verbose=False)

    # Should NOT be merged (uniform pattern, not bimodal)
    assert not was_merged, "False positive: uniform pattern incorrectly merged!"
    assert len(decomp_after) == len(decomp), "Decomposition changed unexpectedly"

    print("✓ Uniform pattern correctly NOT merged")


def test_full_chr12_mat_sequence():
    """Test on full chr12_mat sequence from file (if available)."""
    try:
        from ArraySplitter.core_functions.io.fasta_reader import sc_iter_fasta_file

        fasta_file = "test_data/zebra_finch_satdna.fasta"
        for header, seq in sc_iter_fasta_file(fasta_file):
            if header == "chr12_mat_20637969_20812442":
                print(f"\n=== Testing full sequence: {header} ===")
                print(f"Length: {len(seq)} bp")

                decomp, _, cut_seq, _, _ = decompose_array(seq, verbose=False)
                decomp = rotate_monomers_to_cut(decomp, cut_seq)
                lengths_before = [len(m) for m in decomp if m.startswith(cut_seq)]

                decomp_fixed, was_merged = detect_and_fix_ab_pattern(decomp, cut_seq, verbose=True)
                lengths_after = [len(m) for m in decomp_fixed if m.startswith(cut_seq)]

                print(f"\nBefore: {len(decomp)} monomers, CV={calculate_cv(lengths_before):.3f}")
                print(f"After:  {len(decomp_fixed)} monomers, CV={calculate_cv(lengths_after):.3f}")

                # Verify reconstruction
                assert "".join(decomp_fixed) == seq, "Full sequence reconstruction failed!"

                if was_merged:
                    # Expected: ~250 monomers of ~700bp after merge
                    mean_len = mean(lengths_after)
                    assert 600 < mean_len < 800, f"Mean {mean_len:.0f} not in expected range 600-800"
                    assert len(decomp_fixed) < 300, f"Too many monomers: {len(decomp_fixed)}"
                    print("✓ Full chr12_mat correctly processed!")
                break
    except FileNotFoundError:
        print("⚠ Full test data file not found, skipping full sequence test")


if __name__ == "__main__":
    print("Testing A-B pattern detection\n")
    print("=" * 60)

    test_ab_pattern_detection()

    print("\n" + "=" * 60)
    test_no_false_positive_merge()

    print("\n" + "=" * 60)
    test_full_chr12_mat_sequence()
