/*! For license information please see 208.9e1a5c4c94a641148220.js.LICENSE.txt */
"use strict";(self.webpackChunksparkmonitor=self.webpackChunksparkmonitor||[]).push([[208],{3195:(e,t,s)=>{s.d(t,{t:()=>n});var a=s(3345),o=s.n(a);class n extends o().Component{constructor(e){super(e),this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0}}componentDidCatch(e,t){console.log("SparkMonitor: Caught react error:",e,t)}render(){return this.state.hasError?o().createElement("div",null,"Error: Something went wrong displaying this data."):this.props.children}}},4208:(e,t,s)=>{s.r(t),s.d(t,{default:()=>P});var a=s(6766),o=s(7891),n=s(3345),i=s.n(n),r=s(7262);class l{constructor(e){this.notebookPanel=e,this.isReady=new r.PromiseDelegate,this.cellSlotMap={},this.cellReexecuted=!1,this.numCellsExecuted=0,this.lastBusySignal="",this.init()}async init(){await this.notebookPanel.revealed,this.notebook=this.notebookPanel.content,this.notebook.notebookConfig.recordTiming=!0,this.registerCells(),this.isReady.resolve(void 0)}registerMetadataChanges(e){if((null==e?void 0:e.id)&&!(e.id in this.cellSlotMap)){const t=()=>this.cellMetadataChanged(e);this.cellSlotMap[e.id]=t,e.metadataChanged.connect(t),this.cellMetadataChanged(e)}}deregisterMetadataChanges(e){if(!(null==e?void 0:e.id))return;const t=this.cellSlotMap[e.id];t&&e.metadataChanged.disconnect(t),delete this.cellSlotMap[e.id]}getCodeCellFromModel(e){return"code"===e.type?this.notebookPanel.content.widgets.find(t=>t.model===e):null}cellMetadataChanged(e){const t=this.getCodeCellFromModel(e);if(t){const e=t.model.metadata.execution;e&&e["iopub.status.busy"]&&this.lastBusySignal!==e["iopub.status.busy"]&&(this.activeCell=t,this.cellReexecuted=this.lastExecutedCell===t,this.lastExecutedCell=t,this.numCellsExecuted+=1,this.lastBusySignal=e["iopub.status.busy"])}}registerCells(){const e=this.notebookPanel.context.model.cells;e.changed.connect((e,t)=>{t.oldValues.forEach(e=>{(null==e?void 0:e.id)&&this.deregisterMetadataChanges(e)}),t.newValues.forEach(e=>{(null==e?void 0:e.id)&&this.registerMetadataChanges(e)})});for(let t=0;t<e.length;t+=1)this.registerMetadataChanges(e.get(t))}getActiveCell(){return this.activeCell}getCellReexecuted(){return this.cellReexecuted}getNumCellsExecuted(){return this.numCellsExecuted}ready(){return this.isReady.promise}}var c=s(4943),m=s(7339);const u=(0,c.observer)(()=>{const e=(0,m.Gx)(),t=(0,m.Xp)(),s=e=>t.isCollapsed||t.view!==e?"":"tabbuttonactive",a="jobtabletabbuttonicon tabbutton "+s("jobs"),o="taskviewtabbuttonicon tabbutton "+s("taskchart"),n="timelinetabbuttonicon tabbutton "+s("timeline");return i().createElement("div",{className:"title"},i().createElement("div",{className:"titleleft"},i().createElement("span",{className:"tbitem badgecontainer"},"Apache Spark:",i().createElement("span",{style:{marginLeft:"8px"}},i().createElement("span",{className:"badgeexecutor"},i().createElement("span",{className:"badgeexecutorcount"},e.numExecutors)," ","Executors"),i().createElement("span",{className:"badgeexecutorcores"},i().createElement("span",{className:"badgeexecutorcorescount"},e.numTotalCores)," ","Cores")),i().createElement("span",{style:{marginLeft:"16px"}},"Jobs:"),i().createElement("span",{className:"badges"},t.numActiveJobs?i().createElement("span",{className:"badgerunning"},i().createElement("span",{className:"badgerunningcount"},t.numActiveJobs)," ","Running"):"",t.numCompletedJobs?i().createElement("span",{className:"badgecompleted"},i().createElement("span",{className:"badgecompletedcount"},t.numCompletedJobs)," ","Completed"):"",t.numFailedJobs?i().createElement("span",{className:"badgefailed"},i().createElement("span",{className:"badgefailedcount"},t.numFailedJobs)," ","Failed"):""))),i().createElement("div",{className:"titleright"},i().createElement("div",{className:"tabbuttons"},i().createElement("span",{className:a,title:"Jobs",onClick:()=>{t.setView("jobs")}}),i().createElement("span",{className:o,title:"Tasks",onClick:()=>{t.setView("taskchart")}}),i().createElement("span",{className:n,title:"Event Timeline",onClick:()=>{t.setView("timeline")}}),i().createElement("span",{className:"closebuttonicon tabbutton",title:"Close Display",onClick:()=>{t.toggleHideCellDisplay()}}))))});var d=s(4172),h=s.n(d);const p=e=>{const t=Math.max(e.total,1),s=Math.max(0,Math.min(e.completed,t)),a=s/t*100;let o=Math.max(0,Math.min(e.running,t-s))/t*100;return(s===t||a>=99.99)&&(o=0),i().createElement("div",{className:"tdjobitemprogress cssprogress-container"},i().createElement("div",{className:"cssprogress"},i().createElement("span",{className:"val1",style:{width:a+"%"}}),i().createElement("span",{className:"val2",style:{width:o+"%"}})),i().createElement("div",{className:"data"},e.completed,"/",e.total,e.running>0?` (${e.running})`:""))};var g=s(9069),k=s.n(g),b=s(3195);const S=(0,c.observer)(e=>{var t;const s=(0,m.Gx)().stages[e.stageId];return i().createElement("tr",{className:"stagerow"},i().createElement("td",{className:"tdstageid"},s.stageId),i().createElement("td",{className:"tdstagename"},s.name?String(s.name).charAt(0).toUpperCase()+String(s.name).slice(1).toLowerCase():"Unnamed"),i().createElement("td",{className:"tdstagestatus"},i().createElement("span",{className:s.status},s.status?String(s.status).charAt(0).toUpperCase()+String(s.status).slice(1).toLowerCase():"Unknown")),i().createElement("td",{className:"tdtasks"},i().createElement(p,{total:s.numTasks,running:s.numActiveTasks,completed:s.numCompletedTasks})),i().createElement("td",{className:"tdstagestarttime"},i().createElement(h(),{date:s.submissionTime,minPeriod:10})),i().createElement("td",{className:"tdstageduration"},s.completionTime?k()((null===(t=s.completionTime)||void 0===t?void 0:t.getTime())-s.submissionTime.getTime()):"-"))}),v=(0,c.observer)(e=>{const t=(0,m.Gx)().jobs[e.jobId].uniqueStageIds.map(e=>i().createElement(S,{stageId:e,key:e}));return i().createElement("table",{className:"stagetable"},i().createElement("thead",null,i().createElement("tr",null,i().createElement("th",{className:"thstageid"},"Stage ID"),i().createElement("th",{className:"thstagename"},"Stage Name"),i().createElement("th",{className:"thstagestatus"},"Status"),i().createElement("th",{className:"thstagetasks"},"Tasks"),i().createElement("th",{className:"thstagestart"},"Submission Time"),i().createElement("th",{className:"thstageduration"},"Duration"))),i().createElement("tbody",null,t))}),C=(0,c.observer)(e=>{var t;const s=(0,m.Gx)(),a=null==s?void 0:s.jobs[e.jobId],[o,n]=i().useState(!0);return i().createElement(i().Fragment,null,i().createElement("tr",{className:"jobrow"},i().createElement("td",{className:"tdstagebutton",onClick:()=>{n(e=>!e)}},i().createElement("span",{className:o?"tdstageicon":"tdstageicon tdstageiconcollapsed"})),i().createElement("td",{className:"tdjobid"},a.jobId),i().createElement("td",{className:"tdjobname"},a.name?String(a.name).charAt(0).toUpperCase()+String(a.name).slice(1).toLowerCase():"Unnamed"),i().createElement("td",{className:"tdjobstatus"},i().createElement("span",{className:"tditemjobstatus "+a.status},a.status?String(a.status).charAt(0).toUpperCase()+String(a.status).slice(1).toLowerCase():"Unknown")),i().createElement("td",{className:"tdjobstages"},a.numCompletedStages,"/",a.numStages),i().createElement("td",{className:"tdtasks"},i().createElement(p,{total:a.numTasks,running:a.numActiveTasks,completed:a.numCompletedTasks})),i().createElement("td",{className:"tdjobstarttime"},i().createElement(h(),{date:a.startTime,minPeriod:10})),i().createElement("td",{className:"tdjobduration"},a.endTime?k()((null===(t=a.endTime)||void 0===t?void 0:t.getTime())-a.startTime.getTime()):"-")),!o&&i().createElement("tr",{className:"jobstagedatarow"},i().createElement("td",{colSpan:8,className:"stagedata"},i().createElement(v,{jobId:e.jobId}))))}),E=(0,c.observer)(()=>{const e=(0,m.Xp)();return i().createElement(b.t,null,i().createElement("div",{className:"tabcontent"},i().createElement("table",{className:"jobtable"},i().createElement("thead",null,i().createElement("tr",null,i().createElement("th",{className:"thbutton"}),i().createElement("th",{className:"thjobid"},"Job ID"),i().createElement("th",{className:"thjobname"},"Job Name"),i().createElement("th",{className:"thjobstatus"},"Status"),i().createElement("th",{className:"thjobstages"},"Stages"),i().createElement("th",{className:"thjobtasks"},"Tasks"),i().createElement("th",{className:"thjobstart"},"Submission Time"),i().createElement("th",{className:"thjobtime"},"Duration"))),i().createElement("tbody",{className:"jobtablebody"},e.uniqueJobIds.map(e=>i().createElement(C,{jobId:e,key:e}))))))}),T=i().lazy(()=>Promise.all([s.e(20),s.e(165)]).then(s.bind(s,8331))),y=()=>i().createElement(n.Suspense,{fallback:i().createElement("div",null,"loading")},i().createElement(T,null)),f=i().lazy(()=>s.e(909).then(s.bind(s,5036))),I=()=>i().createElement(n.Suspense,{fallback:i().createElement("div",null,"loading")},i().createElement(f,null)),N=(0,c.observer)(()=>{var e;const t=(0,m.Gx)(),s=(0,m.Xp)();if(!s||(null===(e=null==s?void 0:s.uniqueJobIds)||void 0===e?void 0:e.length)<=0||s.isRemoved||(null==t?void 0:t.hideAllDisplays))return i().createElement("div",{className:"sparkMonitorCellRoot"});let a=i().createElement(i().Fragment,null);return"jobs"===(null==s?void 0:s.view)?a=i().createElement(E,null):"taskchart"===(null==s?void 0:s.view)?a=i().createElement(I,null):"timeline"===(null==s?void 0:s.view)&&(a=i().createElement(y,null)),i().createElement("div",{className:"sparkMonitorCellRoot CellMonitor pm"},i().createElement(u,null),i().createElement("div",{className:"content"},a))}),A=(0,c.observer)(e=>i().createElement(m.Uh.Provider,{value:m.M_.notebooks[e.notebookId]},i().createElement(m.DT.Provider,{value:m.M_.notebooks[e.notebookId].cells[e.cellId]},i().createElement(N,null))));var D,w=s(7324);!function(e){e[e.NOT_READY=0]="NOT_READY",e[e.CREATION_IN_PROGRESS=1]="CREATION_IN_PROGRESS",e[e.READY=2]="READY",e[e.DISPOSED=3]="DISPOSED"}(D||(D={}));const M=/\[Stage \d+:.*\]/;class x{constructor(e,t){var s,a,o;this.notebookPanel=e,this.notebookStore=t,this.cellExecCountSinceSparkJobStart=0,this.retryCount=0,this.commStatus=D.NOT_READY,this.consecutiveCommFailures=0,this.cellWidgets=new Map,this.smOutputObservers=new WeakMap,this.createCellReactElements(),this.currentCellTracker=new l(e),this.kernel=e.session?this.notebookPanel.session.kernel:null===(s=this.notebookPanel.sessionContext.session)||void 0===s?void 0:s.kernel,this.lastKernelId=null===(a=this.kernel)||void 0===a?void 0:a.id,this.attachKernelStatusHandler(),this.startCommWithRetry(),this.notebookPanel.sessionContext.sessionChanged.connect(()=>{this.handleKernelOrSessionChange("Session changed, updating kernel reference and refreshing widgets")}),this.notebookPanel.sessionContext.kernelChanged.connect(()=>{this.handleKernelOrSessionChange("Kernel changed, refreshing widgets")}),null===(o=this.notebookPanel.content.model)||void 0===o||o.cells.changed.connect((e,s)=>{"remove"===s.type&&s.oldValues.forEach(e=>{(null==e?void 0:e.id)&&t.onCellRemoved(e.id)})}),this.startCommHealthCheck()}handleKernelOrSessionChange(e){var t;console.log(`SparkMonitor: ${e}`);const s=null===(t=this.notebookPanel.sessionContext.session)||void 0===t?void 0:t.kernel,a=null==s?void 0:s.id,o=a!==this.lastKernelId;this.kernel=s,this.lastKernelId=a,this.attachKernelStatusHandler(),this.resetCommConnection(),o&&(console.log("SparkMonitor: New kernel detected, resetting failure count"),this.consecutiveCommFailures=0),this.refreshAllCellWidgets()}attachKernelStatusHandler(){this.kernel&&this.kernel.statusChanged.connect((e,t)=>{switch(t){case"starting":console.log(`SparkMonitor: Kernel status changed to: ${t}`),this.currentCellTracker.cellReexecuted=!1,this.resetCommConnection();break;case"restarting":console.log(`SparkMonitor: Kernel status changed to: ${t}`),this.resetCommConnection();break;case"dead":case"unknown":console.log(`SparkMonitor: Kernel status changed to: ${t}`);break;case"idle":case"busy":this.commStatus===D.NOT_READY&&this.consecutiveCommFailures<5&&this.startCommWithRetry()}})}resetCommConnection(){if(console.log("SparkMonitor: Resetting comm connection"),this.commStatus=D.NOT_READY,this.retryCount=0,this.commRetryTimer&&(clearTimeout(this.commRetryTimer),this.commRetryTimer=void 0),this.commStabilityTimer&&(clearTimeout(this.commStabilityTimer),this.commStabilityTimer=void 0),this.comm){try{this.comm.close()}catch(e){console.warn("SparkMonitor: Error closing existing comm:",e)}this.comm=void 0}this.cellExecCountSinceSparkJobStart=0}refreshWidgets(){console.log("SparkMonitor: Widget refresh triggered"),this.refreshAllCellWidgets()}resetAndRetryConnection(){var e,t;console.log("SparkMonitor: Manually resetting failure count and retrying connection"),this.consecutiveCommFailures=0,this.resetCommConnection(),"idle"!==(null===(e=this.kernel)||void 0===e?void 0:e.status)&&"busy"!==(null===(t=this.kernel)||void 0===t?void 0:t.status)||this.startCommWithRetry()}startCommWithRetry(){this.commStatus===D.NOT_READY&&(this.consecutiveCommFailures>=5?5===this.consecutiveCommFailures&&console.error(`SparkMonitor: Too many consecutive comm failures (${this.consecutiveCommFailures}), stopping retry attempts. This usually indicates the kernel doesn't have SparkMonitor installed. Connection attempts will resume if the kernel is restarted or changed.`):!this.kernel||"starting"!==this.kernel.status&&"restarting"!==this.kernel.status&&"dead"!==this.kernel.status?this.retryCount>=10?console.error("SparkMonitor: Failed to establish comm after 10 attempts"):(this.retryCount++,this.commStatus=D.CREATION_IN_PROGRESS,console.log(`SparkMonitor: Attempting to start comm (attempt ${this.retryCount}/10)`),this.startComm().then(e=>{e?(console.log("SparkMonitor: Comm successfully established"),this.commStatus=D.READY):(this.commStatus=D.NOT_READY,this.scheduleCommRetry())}).catch(e=>{this.commStatus=D.NOT_READY,console.warn("SparkMonitor: Error starting comm:",e),this.scheduleCommRetry()})):"starting"!==this.kernel.status&&console.log(`SparkMonitor: Kernel not ready for comm (status: ${this.kernel.status}), skipping retry`))}scheduleCommRetry(){this.commStatus!==D.DISPOSED&&this.retryCount<10&&(this.retryCount<=2&&console.log(`SparkMonitor: Scheduling comm retry in 2000ms (attempt ${this.retryCount+1}/10)`),this.commRetryTimer=window.setTimeout(()=>{this.startCommWithRetry()},2e3))}startCommHealthCheck(){this.healthCheckInterval=window.setInterval(()=>{var e,t;this.commStatus!==D.DISPOSED?this.commStatus===D.NOT_READY&&("idle"===(null===(e=this.kernel)||void 0===e?void 0:e.status)||"busy"===(null===(t=this.kernel)||void 0===t?void 0:t.status))&&this.consecutiveCommFailures<5&&!this.commRetryTimer?(console.log("SparkMonitor: Health check detected comm is not ready, attempting to reconnect"),this.startCommWithRetry()):5===this.consecutiveCommFailures&&console.log(`SparkMonitor: Health check skipping reconnection due to ${this.consecutiveCommFailures} consecutive failures`):this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=void 0)},3e4)}setupSparkLogAndEmptyOutputObserver(e){var t,s;const a=this.smOutputObservers.get(e);if(a)return a;if(this.commStatus!==D.READY)return void console.log("SparkMonitor: Skipping Spark log observer setup as comm is not READY.");if(!(null===(t=null==e?void 0:e.node)||void 0===t?void 0:t.querySelector(".spark-monitor-cell-widget")))return;const o=e.node.querySelector(".jp-Cell-outputWrapper");if(!o)return;const n=null===(s=e.outputArea)||void 0===s?void 0:s.model,i=()=>{o.querySelectorAll(".jp-RenderedText").forEach(e=>{if(!e)return;const t=e.textContent||"";if((M.test(t)||""===t.trim())&&(e.remove(),n))for(let e=n.length-1;e>=0;e--){const t=n.get(e);let s=!1,a=!1;try{const e=t.toJSON(),o=e.output_type;if("stream"===o){const t=e.text,o="string"==typeof t?t:Array.isArray(t)?t.join(""):"";s=M.test(o),a=""===o.trim()}else if("execute_result"===o||"display_data"===o){const t=e.data;t&&"object"==typeof t&&(a=Object.values(t).every(e=>"string"==typeof e?""===e.trim():!!Array.isArray(e)&&""===e.join("").trim()))}else if("error"===o){const t=e.traceback;a=!!Array.isArray(t)&&0===t.length}}catch(e){console.warn("SparkMonitor: Failed to serialize output model to JSON",e)}(s||a)&&n.remove(e)}}),n&&o&&(0===n.length?o.classList.add("sm-hide-output"):o.classList.remove("sm-hide-output"))};i();const r=new MutationObserver(e=>{i()});return r.observe(o,{childList:!0,subtree:!0}),this.smOutputObservers.set(e,r),r}installOutputObserversForAllCells(){const e=this.notebookPanel.content.widgets;for(const t of e)try{t.model&&"code"===t.model.type&&this.setupSparkLogAndEmptyOutputObserver(t)}catch(e){console.warn("SparkMonitor: Error installing output observer for a cell",e)}}refreshAllCellWidgets(){console.log("SparkMonitor: Refreshing all cell widgets"),this.cellWidgets.forEach((e,t)=>{try{e&&!e.isDisposed&&e.dispose(),this.notebookStore.onCellExecutedAgain(t)}catch(e){console.warn(`SparkMonitor: Error disposing widget for cell ${t}:`,e)}}),this.cellWidgets.clear();const e=this.notebookPanel.context.model.cells;for(let t=0;t<e.length;t++){const s=e.get(t);"code"===s.type&&this.createElementIfNotExists&&this.createElementIfNotExists(s)}}createCellReactElements(){const e=e=>{if(!(null==e?void 0:e.id)||"code"!==e.type)return;const t=this.notebookPanel.content.widgets.find(t=>t.model===e),s=this.cellWidgets.get(e.id);if((!s||s.isDisposed)&&t&&!t.node.querySelector(".sparkMonitorCellRoot")&&!t.node.querySelector(".spark-monitor-cell-widget")){const s=w.ReactWidget.create(i().createElement(A,{notebookId:this.notebookPanel.id,cellId:e.id}));s.addClass("spark-monitor-cell-widget"),this.cellWidgets.set(e.id,s);const a=t.layout,o=()=>{let e=1;for(let t=0;t<a.widgets.length;t++){const s=a.widgets[t].node;if(s.classList.contains("jp-Cell-inputWrapper")){e=t+1;break}if(s.classList.contains("jp-Cell-outputWrapper")||s.querySelector(".jp-OutputArea")){e=t;break}}return e},n=()=>{const e=a.widgets.indexOf(s),n=o();e!==n&&-1!==e&&(a.removeWidget(s),a.insertWidget(n,s),t.update())},r=o();a.insertWidget(r,s),t.update();const l=new MutationObserver(e=>{let t=!1;for(const s of e)if("childList"===s.type){for(const e of Array.from(s.addedNodes))if(e instanceof Element&&(e.classList.contains("jp-Cell-outputWrapper")||e.classList.contains("jp-OutputArea")||e.classList.contains("jp-OutputArea-child")||e.querySelector(".jp-OutputArea-executeResult, .jp-OutputArea-output"))){t=!0;break}s.target instanceof Element&&(s.target.classList.contains("jp-Cell-outputWrapper")||s.target.classList.contains("jp-OutputArea"))&&(t=!0)}t&&setTimeout(n,10)});this.setupSparkLogAndEmptyOutputObserver(t),l.observe(t.node,{childList:!0,subtree:!0,attributes:!1}),s._sparkMonitorObserver=l,s.disposed.connect(()=>{s._sparkMonitorObserver&&s._sparkMonitorObserver.disconnect();const a=t&&this.smOutputObservers.get(t);a&&(a.disconnect(),this.smOutputObservers.delete(t)),this.notebookStore.onCellRemoved(e.id),this.cellWidgets.delete(e.id),console.log(`SparkMonitor: Widget disposed for cell ${e.id}`)}),setTimeout(n,100)}};this.createElementIfNotExists=e;const t=this.notebookPanel.context.model.cells;t.changed.connect((t,s)=>{"add"===s.type?s.newValues.forEach(t=>{e(t)}):"remove"===s.type&&s.oldValues.forEach(e=>{if(null==e?void 0:e.id){console.log("SparkMonitor: Cleaning up widget for removed cell ",e.id);const t=this.cellWidgets.get(e.id);t&&!t.isDisposed&&t.dispose(),this.notebookStore.onCellRemoved(e.id),this.cellWidgets.delete(e.id)}})});for(let s=0;s<t.length;s+=1)e(t.get(s))}toggleAll(){this.notebookStore.toggleHideAllDisplays()}async startComm(){if(!this.kernel)return console.warn("SparkMonitor: No kernel available"),!1;if("starting"===this.kernel.status||"restarting"===this.kernel.status||"dead"===this.kernel.status)return console.warn(`SparkMonitor: Kernel not in valid state for comm (status: ${this.kernel.status})`),!1;try{let e;if(await this.currentCellTracker.ready(),"createComm"in this.kernel)e=this.kernel.createComm("SparkMonitor");else{if(!("connectToComm"in this.kernel))return console.warn("SparkMonitor: Kernel does not support comm creation"),!1;e=this.kernel.connectToComm("SparkMonitor")}return e?(this.comm=e,this.comm.onMsg=e=>{this.handleMessage(e)},this.comm.onClose=e=>{console.log("SparkMonitor: Comm closed, marking as not ready"),this.commStatus!==D.DISPOSED&&(this.commStatus=D.NOT_READY),this.consecutiveCommFailures++,console.warn(`SparkMonitor: Comm closed (consecutive failures: ${this.consecutiveCommFailures})`),this.commStabilityTimer&&(clearTimeout(this.commStabilityTimer),this.commStabilityTimer=void 0),this.commStatus!==D.DISPOSED&&this.consecutiveCommFailures<5?setTimeout(()=>{this.commStatus===D.NOT_READY&&this.consecutiveCommFailures<5&&this.startCommWithRetry()},1e3):this.consecutiveCommFailures>=5&&console.warn(`SparkMonitor: Too many consecutive comm failures (${this.consecutiveCommFailures}), stopping automatic retry attempts. This usually indicates the kernel doesn't have SparkMonitor installed.`)},new Promise(e=>{let t=!1;const s=setTimeout(()=>{t||(t=!0,this.commStatus===D.READY?(console.log("SparkMonitor: Comm established successfully (via timeout check)"),e(!0)):(this.consecutiveCommFailures++,e(!1)))},5e3);try{this.comm.open({msgtype:"openfromfrontend"});const a=setInterval(()=>{this.commStatus!==D.READY||t||(t=!0,clearTimeout(s),clearInterval(a),console.log("SparkMonitor: Comm established successfully (via message)"),e(!0))},100);setTimeout(()=>{clearInterval(a)},5e3)}catch(a){t||(t=!0,clearTimeout(s),console.error("SparkMonitor: Error opening comm:",a),e(!1))}})):(console.warn("SparkMonitor: Unable to create comm"),!1)}catch(e){return console.error("SparkMonitor: Error establishing comm:",e),!1}}onSparkJobStart(e){const t=this.currentCellTracker.getActiveCell();t?(this.currentCellTracker.getNumCellsExecuted()>this.cellExecCountSinceSparkJobStart&&(this.cellExecCountSinceSparkJobStart=this.currentCellTracker.getNumCellsExecuted(),this.notebookStore.onCellExecutedAgain(t.model.id)),this.notebookStore.onSparkJobStart(t.model.id,e)):console.warn("SparkMonitor: Job started with no running cell.")}onSparkStageSubmitted(e){const t=this.currentCellTracker.getActiveCell();t?this.notebookStore.onSparkStageSubmitted(t.model.id,e):console.warn("SparkMonitor: Stage started with no running cell.")}handleMessage(e){if(this.commStatus!==D.READY){console.log("SparkMonitor: Received first message from backend, comm is working"),this.commStatus=D.READY,this.retryCount=0,this.consecutiveCommFailures=0,this.commStabilityTimer&&(clearTimeout(this.commStabilityTimer),this.commStabilityTimer=void 0);try{this.installOutputObserversForAllCells()}catch(e){console.warn("SparkMonitor: Error installing output observers on comm ready",e)}}if(this.consecutiveCommFailures>0&&(console.log("SparkMonitor: Received message from backend, resetting consecutive failure count"),this.consecutiveCommFailures=0),e.content.data.msgtype||console.warn("SparkMonitor: Unknown message"),"fromscala"===e.content.data.msgtype){const t=JSON.parse(e.content.data.msg);switch(t.msgtype){case"sparkJobStart":this.onSparkJobStart(t);break;case"sparkJobEnd":this.notebookStore.onSparkJobEnd(t);break;case"sparkStageSubmitted":this.onSparkStageSubmitted(t);break;case"sparkStageCompleted":this.notebookStore.onSparkStageCompleted(t);break;case"sparkStageActive":this.notebookStore.onSparkStageActive(t);break;case"sparkTaskStart":this.notebookStore.onSparkTaskStart(t);break;case"sparkTaskEnd":this.notebookStore.onSparkTaskEnd(t);break;case"sparkApplicationStart":this.notebookStore.onSparkApplicationStart(t);break;case"sparkApplicationEnd":break;case"sparkExecutorAdded":this.notebookStore.onSparkExecutorAdded(t);break;case"sparkExecutorRemoved":this.notebookStore.onSparkExecutorRemoved(t);break;default:console.warn("SparkMonitor: Unknown message")}}}retryCommConnection(){console.log("SparkMonitor: Comm retry triggered"),this.resetCommConnection(),this.startCommWithRetry()}dispose(){console.log("SparkMonitor: Disposing extension"),this.commRetryTimer&&(clearTimeout(this.commRetryTimer),this.commRetryTimer=void 0),this.commStabilityTimer&&(clearTimeout(this.commStabilityTimer),this.commStabilityTimer=void 0),this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=void 0),this.cellWidgets.forEach(e=>{try{e&&!e.isDisposed&&e.dispose()}catch(e){console.warn("SparkMonitor: Error disposing widget during cleanup:",e)}}),this.cellWidgets.clear(),this.resetCommConnection(),this.commStatus=D.DISPOSED}}var R=s(9676);class j{constructor(){this.numActiveTasks=0,this.numCompletedTasks=0,this.numFailedTasks=0,(0,R.makeAutoObservable)(this)}}class O{get numActiveStages(){return this.uniqueStageIds.filter(e=>"PENDING"===this.notebookStore.stages[e].status).length}get numCompletedStages(){return this.uniqueStageIds.filter(e=>"COMPLETED"===this.notebookStore.stages[e].status).length}get numFailedStages(){return this.uniqueStageIds.filter(e=>"FAILED"===this.notebookStore.stages[e].status).length}get numSkippedStages(){return this.uniqueStageIds.filter(e=>"SKIPPED"===this.notebookStore.stages[e].status).length}constructor(e){this.notebookStore=e,this.status="RUNNING",this.name="Unnamed",this.stageIds=[],this.uniqueStageIds=[],this.numStages=0,this.numTasks=0,this.numActiveTasks=0,this.numCompletedTasks=0,this.numFailedTasks=0,(0,R.makeAutoObservable)(this)}}class J{constructor(e){this.notebookStore=e,this.jobDataX=[],this.jobDataY=[],this.jobDataText=[],this.executorDataX=[],this.executorDataY=[],this.taskDataX=[],this.taskDataY=[],this.numActiveTasks=0}reset(){this.jobDataX=[],this.jobDataY=[],this.jobDataText=[],this.executorDataX=[],this.executorDataY=[],this.taskDataX=[],this.taskDataY=[],this.numActiveTasks=0}addExecutorData(e,t){this.executorDataX.push(e),this.executorDataY.push(t)}addTaskData(e,t){this.taskDataX.push(new Date(e).getTime()),this.taskDataY.push(t),this.addExecutorData(new Date(e).getTime(),this.notebookStore.numTotalCores||0)}onSparkJobStart(e){const t=new Date(e.submissionTime).getTime();this.jobDataX.push(t),this.jobDataY.push(0),this.jobDataText.push(`Job ${e.jobId} started`),this.addExecutorData(t,e.totalCores)}onSparkJobEnd(e){const t=new Date(e.completionTime).getTime();this.jobDataX.push(t),this.jobDataY.push(0),this.jobDataText.push(`Job ${e.jobId} ended`)}onSparkTaskStart(e){this.addTaskData(e.launchTime,this.numActiveTasks),this.numActiveTasks+=1,this.addTaskData(e.launchTime,this.numActiveTasks)}onSparkTaskEnd(e){this.addTaskData(e.finishTime,this.numActiveTasks),this.numActiveTasks-=1,this.addTaskData(e.finishTime,this.numActiveTasks)}}class q{constructor(e,t){this.cellId=e,this.notebookStore=t,this.view="jobs",this.isCollapsed=!1,this.isRemoved=!1,this.uniqueJobIds=[],(0,R.makeAutoObservable)(this),this.taskChartStore=new J(this.notebookStore)}reset(){this.view="jobs",this.isCollapsed=!1,this.isRemoved=!1,this.uniqueJobIds=[],this.taskChartStore.reset()}toggleCollapseCellDisplay(){this.isCollapsed=!this.isCollapsed}toggleHideCellDisplay(){this.isRemoved=!this.isRemoved}setView(e){this.view=e,this.isCollapsed=!1,this.isRemoved=!1}get jobs(){return this.uniqueJobIds.map(e=>this.notebookStore.jobs[e])}get numActiveJobs(){return this.jobs.filter(e=>"RUNNING"===e.status).length}get numFailedJobs(){return this.jobs.filter(e=>"FAILED"===e.status).length}get numCompletedJobs(){return this.jobs.filter(e=>"COMPLETED"===e.status).length}get numTotalJobs(){return this.uniqueJobIds.length}}class F{constructor(e){this.notebookPanelId=e,this.uniqueId="default-key",this.hideAllDisplays=!1,this.cells={},this.jobs={},this.stages={},(0,R.makeAutoObservable)(this)}resetNotebook(){Object.values(this.cells).forEach(e=>e.reset())}resetCell(e){const t=this.cells[e];t?t.reset():console.error("Cell not found to reset")}toggleHideAllDisplays(){this.hideAllDisplays=!this.hideAllDisplays}onSparkApplicationStart(e){this.applicationId=e.appId,this.applicationName=e.appName,this.applicationAttemptId=e.appAttemptId,this.uniqueId=`app${this.applicationId}-attempt${this.applicationAttemptId}`}deleteCellData(e){const t=this.cells[e];t&&(t.uniqueJobIds.forEach(e=>{const t=this.jobs[e];t&&(t.uniqueStageIds.forEach(e=>{this.stages[e]&&delete this.stages[e]}),delete this.jobs[e])}),delete this.cells[e])}onCellRemoved(e){this.deleteCellData(e)}onCellExecutedAgain(e){this.deleteCellData(e),this.cells[e]=new q(e,this)}onSparkJobStart(e,t){this.numTotalCores=t.totalCores,this.numExecutors=t.numExecutors;const s=new O(this);s.uniqueId=`${this.uniqueId}-job-${t.jobId}`,s.jobId=t.jobId,s.status=t.status,s.cellId=e;const a=String(t.name).split(" ")[0];if(s.name=a,s.startTime=new Date(t.submissionTime),s.stageIds=t.stageIds,s.numStages=t.stageIds.length,s.numTasks=t.numTasks,t.stageIds.forEach(e=>{const a=`${this.uniqueId}-stage-${e}`;let o=this.stages[a];o||(o=new j,o.status="PENDING",this.stages[a]=o),o.uniqueJobId=s.uniqueId,o.numTasks=t.stageInfos[e].numTasks,o.name=t.stageInfos[e].name,s.uniqueStageIds.push(a)}),s.uniqueStageIds.sort((e,t)=>e.localeCompare(t,void 0,{numeric:!0})),"null"===s.name){const e=Math.max.apply(null,t.stageIds);s.name=this.stages[`${this.uniqueId}-stage-${e}`].name}this.cells[e]||(this.cells[e]=new q(e,this)),this.cells[e].uniqueJobIds.push(s.uniqueId),s.cell=this.cells[e],s.cell.taskChartStore.onSparkJobStart(t),this.jobs[s.uniqueId]=s}onSparkJobEnd(e){var t;const s=`${this.uniqueId}-job-${e.jobId}`,a=this.jobs[s];a?(a.status=e.status,a.endTime=new Date(e.completionTime),a.uniqueStageIds.forEach(e=>{var t;"PENDING"===(null===(t=this.stages[e])||void 0===t?void 0:t.status)&&(this.stages[e].status="SKIPPED",a.numTasks-=this.stages[e].numTasks)}),null===(t=a.cell)||void 0===t||t.taskChartStore.onSparkJobEnd(e)):console.warn("SparkMonitor: Could not identify job")}onSparkStageSubmitted(e,t){const s=-1===t.submissionTime?new Date:new Date(t.submissionTime),a=`${this.uniqueId}-stage-${t.stageId}`;this.stages[a]||(this.stages[a]=new j,this.stages[a].uniqueId=a);const o=this.stages[a];o.cellId=e,o.stageId=t.stageId,o.status="RUNNING",o.name=String(t.name).split(" ")[0],o.submissionTime=s,o.numTasks=t.numTasks}onSparkStageCompleted(e){const t=`${this.uniqueId}-stage-${e.stageId}`,s=this.stages[t];if(s){s.status=e.status,s.completionTime=new Date(e.completionTime),s.submissionTime=new Date(e.submissionTime),s.numActiveTasks=0,s.numCompletedTasks=e.numCompletedTasks,s.numFailedTasks=e.numFailedTasks,s.numTasks=e.numTasks;const t=this.jobs[s.uniqueJobId];t&&(t.numActiveTasks=0,t.numCompletedTasks=0,t.numFailedTasks=0,t.numTasks=0,t.uniqueStageIds.forEach(e=>{var s,a,o,n;t.numActiveTasks+=(null===(s=this.stages[e])||void 0===s?void 0:s.numActiveTasks)||0,t.numCompletedTasks+=(null===(a=this.stages[e])||void 0===a?void 0:a.numCompletedTasks)||0,t.numFailedTasks+=(null===(o=this.stages[e])||void 0===o?void 0:o.numFailedTasks)||0,t.numTasks+=(null===(n=this.stages[e])||void 0===n?void 0:n.numTasks)||0}))}else console.warn("SparkMonitor: Unable to identify stage")}onSparkExecutorAdded(e){this.numTotalCores=e.totalCores,this.numExecutors||(this.numExecutors=0),this.numExecutors+=1}onSparkExecutorRemoved(e){this.numTotalCores=e.totalCores,this.numExecutors||(this.numExecutors=0),this.numExecutors-=1}onSparkTaskStart(e){var t;const s=`${this.uniqueId}-stage-${e.stageId}`,a=this.stages[s];if(a){const s=a.uniqueJobId,o=this.jobs[s];o&&(null===(t=o.cell)||void 0===t||t.taskChartStore.onSparkTaskStart(e))}}onSparkTaskEnd(e){var t;const s=`${this.uniqueId}-stage-${e.stageId}`,a=this.stages[s];if(a){const s=a.uniqueJobId,o=this.jobs[s];o&&(null===(t=o.cell)||void 0===t||t.taskChartStore.onSparkTaskEnd(e))}}onSparkStageActive(e){const t=`${this.uniqueId}-stage-${e.stageId}`,s=this.stages[t];if(s&&"RUNNING"===s.status){s.numActiveTasks=e.numActiveTasks,s.numCompletedTasks=e.numCompletedTasks,s.numFailedTasks=e.numFailedTasks;const t=this.jobs[s.uniqueJobId];t&&(t.numActiveTasks=0,t.numCompletedTasks=0,t.numFailedTasks=0,t.numTasks=0,t.uniqueStageIds.forEach(e=>{var s,a,o,n;t.numActiveTasks+=(null===(s=this.stages[e])||void 0===s?void 0:s.numActiveTasks)||0,t.numCompletedTasks+=(null===(a=this.stages[e])||void 0===a?void 0:a.numCompletedTasks)||0,t.numFailedTasks+=(null===(o=this.stages[e])||void 0===o?void 0:o.numFailedTasks)||0,t.numTasks+=(null===(n=this.stages[e])||void 0===n?void 0:n.numTasks)||0}))}}}const P={id:"jupyterlab_sparkmonitor",autoStart:!0,requires:[a.INotebookTracker,o.IMainMenu],activate(e,t){let s;console.log("JupyterLab SparkMonitor is activated!"),t.widgetAdded.connect(async(e,t)=>{var a;let o,n,i=m.M_.notebooks[t.id];if(i||(i=new F(t.id),m.M_.notebooks[t.id]=i),t.session)await t.session.ready,o=t.session.kernel,await o.ready,n=o.info;else{const{sessionContext:e}=t;await e.ready,o=null===(a=e.session)||void 0===a?void 0:a.kernel,n=await(null==o?void 0:o.info)}"python"===n.language_info.name&&(s=new x(t,i),console.log("Notebook kernel ready"),s.startComm())})}}},7339:(e,t,s)=>{s.d(t,{DT:()=>l,Gx:()=>c,M_:()=>i,Uh:()=>r,Xp:()=>m});var a=s(3345),o=s.n(a),n=s(9676);const i=new class{constructor(){this.notebooks={},(0,n.makeAutoObservable)(this)}},r=(o().createContext(i),o().createContext(void 0)),l=o().createContext(void 0),c=()=>o().useContext(r),m=()=>o().useContext(l)}}]);