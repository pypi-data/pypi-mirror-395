name: Extended Fuzzing

on:
  schedule:
    - cron: "0 3 * * 0" # Weekly on Sunday at 3 AM UTC
  workflow_dispatch: # Allow manual triggering

concurrency:
  group: fuzz-extended
  cancel-in-progress: false # Let fuzzing complete

permissions:
  contents: read

jobs:
  extended-fuzz:
    runs-on: ubuntu-latest
    timeout-minutes: 60 # 1 hour for comprehensive fuzzing
    permissions:
      contents: read

    steps:
      - name: Record job start time
        id: job-start
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Python 3.12
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --require-hashes -r .github/requirements-bootstrap.txt
          python -m pip install --require-hashes -r requirements-dev.txt
          python -m pip install -e . --no-deps

      - name: Run extended fuzzing tests
        env:
          HYPOTHESIS_PROFILE: fuzz
        run: pytest tests/ -m fuzz -v --tb=short --override-ini="addopts="

      - name: Generate extended fuzz summary
        if: always()
        run: |
          # Calculate job duration
          END_TIME=$(date +%s)
          START_TIME=${{ steps.job-start.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          DURATION_MIN=$((DURATION / 60))
          DURATION_SEC=$((DURATION % 60))

          echo "## Extended Fuzzing Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Duration:** ${DURATION_MIN}m ${DURATION_SEC}s" >> $GITHUB_STEP_SUMMARY
          echo "**Profile:** Extended (1000 examples per test)" >> $GITHUB_STEP_SUMMARY
          echo "**Python:** 3.12" >> $GITHUB_STEP_SUMMARY
          echo "**Schedule:** Weekly (Sunday 3 AM UTC)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Extended fuzzing runs more test cases to find edge cases that" >> $GITHUB_STEP_SUMMARY
          echo "might not be caught by regular CI fuzzing." >> $GITHUB_STEP_SUMMARY

      - name: Upload failure artifacts
        if: failure()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: fuzz-failure-artifacts
          path: |
            .hypothesis/
            pytest-*.xml
          retention-days: 14
