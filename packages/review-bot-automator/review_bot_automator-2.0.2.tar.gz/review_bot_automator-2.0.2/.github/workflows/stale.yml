name: Mark stale issues and pull requests

on:
  schedule:
    - cron: "0 0 * * 0" # Weekly on Sunday at midnight UTC
  workflow_dispatch: # Allow manual trigger

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false  # Queue stale checks, don't cancel

# Default permissions: read-only for security
# Individual jobs override with specific permissions as needed
permissions:
  contents: read

jobs:
  stale:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      issues: write          # Required to add stale labels and close issues
      pull-requests: write   # Required to add stale labels and close pull requests
    steps:
      - name: Record job start time
        id: job-start
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT

      - uses: actions/stale@997185467fa4f803885201cee163a9f38240193d # v10.1.1
        with:
          # Configuration for issues
          days-before-stale: 60
          days-before-close: 7
          stale-issue-message: |
            This issue has been automatically marked as stale because it has not had recent activity.

            It will be closed in 7 days if no further activity occurs. If this issue is still relevant, please:

            - Add a comment explaining why it's still important
            - Add the `keep-open` label to prevent automatic closure
            - Assign it to yourself or someone else

            Thank you for your contribution!
          close-issue-message: |
            This issue has been automatically closed due to inactivity.

            If you believe this was closed in error, please reopen it and add the `keep-open` label.

            Thank you for your understanding.
          stale-issue-label: "stale"
          exempt-issue-labels: "keep-open,priority,security,bug,enhancement"

          # Configuration for pull requests
          days-before-pr-stale: 30
          days-before-pr-close: 7
          stale-pr-message: |
            This pull request has been automatically marked as stale because it has not had recent activity.

            It will be closed in 7 days if no further activity occurs. If this PR is still relevant, please:

            - Add a comment explaining the current status
            - Add the `keep-open` label to prevent automatic closure
            - Request a review or assign it to someone

            Thank you for your contribution!
          close-pr-message: |
            This pull request has been automatically closed due to inactivity.

            If you believe this was closed in error, please reopen it and add the `keep-open` label.

            Thank you for your understanding.
          stale-pr-label: "stale"
          exempt-pr-labels: "keep-open,priority,security,ready-for-review,needs-review"

          # General configuration
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          remove-stale-when-updated: true
          remove-pr-stale-when-updated: true
          debug-only: false
          ascending: false
          delete-branch: false
          start-date: ""

      - name: Generate stale workflow summary
        if: always()
        run: |
          END_TIME=$(date +%s)
          START_TIME=${{ steps.job-start.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          DURATION_MIN=$((DURATION / 60))
          DURATION_SEC=$((DURATION % 60))

          echo "## Stale Items Management Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Job Duration:** ${DURATION_MIN}m ${DURATION_SEC}s" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Issues:**" >> $GITHUB_STEP_SUMMARY
          echo "- Stale after: 60 days of inactivity" >> $GITHUB_STEP_SUMMARY
          echo "- Close after: 7 additional days" >> $GITHUB_STEP_SUMMARY
          echo "- Exempt labels: \`keep-open\`, \`priority\`, \`security\`, \`bug\`, \`enhancement\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull Requests:**" >> $GITHUB_STEP_SUMMARY
          echo "- Stale after: 30 days of inactivity" >> $GITHUB_STEP_SUMMARY
          echo "- Close after: 7 additional days" >> $GITHUB_STEP_SUMMARY
          echo "- Exempt labels: \`keep-open\`, \`priority\`, \`security\`, \`ready-for-review\`, \`needs-review\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Actions Taken" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Processed stale issues" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Processed stale pull requests" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Applied stale labels where appropriate" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Closed items past stale threshold" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Note: See action logs above for detailed list of items processed_" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Stale workflow failed"
          echo "## ❌ Stale Workflow Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The stale items management workflow has failed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Possible causes:" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub API rate limiting" >> $GITHUB_STEP_SUMMARY
          echo "- Invalid configuration parameters" >> $GITHUB_STEP_SUMMARY
          echo "- Insufficient permissions (requires issues and pull-requests write)" >> $GITHUB_STEP_SUMMARY
          echo "- Network connectivity issues" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review the workflow logs above for specific error details." >> $GITHUB_STEP_SUMMARY
