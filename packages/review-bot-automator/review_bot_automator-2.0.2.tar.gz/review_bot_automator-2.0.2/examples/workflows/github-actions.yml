# GitHub Actions Workflow for PR Conflict Resolution
# Place this file in: .github/workflows/pr-resolver.yml

name: PR Conflict Resolution

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:  # Allow manual triggering

jobs:
  resolve-conflicts:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install PR Conflict Resolver
        run: |
          pip install review-bot-automator

      - name: Configure environment
        run: |
          # Set environment variables
          echo "CR_MODE=conflicts-only" >> $GITHUB_ENV
          echo "CR_PARALLEL=true" >> $GITHUB_ENV
          echo "CR_MAX_WORKERS=8" >> $GITHUB_ENV
          echo "CR_ENABLE_ROLLBACK=true" >> $GITHUB_ENV
          echo "CR_LOG_LEVEL=INFO" >> $GITHUB_ENV

      - name: Resolve PR conflicts
        env:
          GITHUB_PERSONAL_ACCESS_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr-resolve apply \
            --pr ${{ github.event.pull_request.number }} \
            --owner ${{ github.repository_owner }} \
            --repo ${{ github.event.repository.name }} \
            --parallel --max-workers 8 \
            --rollback \
            --log-file /tmp/pr-resolve.log
        continue-on-error: true

      - name: Upload resolution logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: resolution-logs
          path: /tmp/pr-resolve.log
          retention-days: 7
