# Implementation Plan: Command Line Interface Tool

**Branch**: `002-command-line-interface` | **Date**: 2025-10-13 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/002-command-line-interface/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

The QueryNL CLI is a standalone command-line interface that provides terminal-native access to QueryNL's natural language database query capabilities. It delivers feature parity with IDE extensions, supporting interactive REPL mode for exploratory work and scriptable commands for automation. The CLI targets terminal-focused developers, DevOps engineers, and CI/CD scenarios where IDE extensions are impractical. Core features include natural language query execution, connection management with encrypted credential storage, schema design, migration generation, and multiple output formats (table, JSON, CSV, markdown).

## Technical Context

**Language/Version**: Python 3.11+ (matches existing QueryNL backend, per constitution from CLAUDE.md)
**Primary Dependencies**: Click 8.1+ (CLI framework), Rich 13.0+ (terminal formatting), prompt_toolkit 3.0+ (REPL input), Keyring 25.0+ (credential storage), keyrings.cryptfile 1.3+ (headless fallback)
**Storage**: Files for config (~/.querynl/config.yaml), OS keychain for credentials, SQLite for local query history
**Testing**: pytest (consistent with project standard per CLAUDE.md)
**Target Platform**: Cross-platform (macOS 10.15+, Linux kernel 4.x+, Windows 10+)
**Project Type**: Single project (CLI tool as part of QueryNL monorepo)
**Performance Goals**: <500ms startup time, <3 seconds query execution (90%), <100MB memory during operation
**Constraints**: <50MB binary size (PyInstaller with optimization), no GUI dependencies, must work in headless/non-TTY environments
**Scale/Scope**: Single-user tool, supports multiple connections, REPL session persistence
**Database Drivers**: Reuse existing backend drivers (psycopg2-binary, pymysql, pymongo, sqlite3)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Reference: [QueryNL Constitution v1.0.0](../../.specify/memory/constitution.md)

### I. Security-First Design ✓
- [x] Credential storage uses AES-256 encryption - **FR-009**: Keyring library uses OS native keychain (Keychain/Credential Manager/Secret Service)
- [x] No credentials in logs, errors, or telemetry - **FR-040**: Never display credentials in plain text
- [x] Input validation prevents SQL injection - **FR-044**: Sanitize all user inputs
- [x] OWASP Top 10 vulnerabilities addressed - Covered by input validation, credential encryption, SSL by default
- [x] Security audit plan defined for major release - To be included in release checklist

### II. User Experience Over Technical Purity ✓
- [x] First query completable within 5 minutes of installation - **SC-001**: 3 minute target from install to first query
- [x] Error messages are actionable (not stack traces) - **SC-006**: 95% of errors include remediation suggestions
- [x] IDE integration does not block UI - N/A (CLI-only, no IDE component)
- [x] Query generation latency < 5 seconds (95th percentile) - **FR-007**: <3s for 90% of queries (stricter than constitution)

### III. Transparency and Explainability ✓
- [x] Generated SQL displayed before execution - **FR-003**: Display SQL before execution
- [x] Destructive operations require confirmation - **FR-003**: Explicit confirmation for destructive ops
- [x] Schema/optimization rationale provided - **FR-018**: Schema analysis includes suggestions with rationale
- [x] LLM token usage visible to users - To be added to CLI output and REPL info command

### IV. Multi-Database Parity ✓
- [x] PostgreSQL, MySQL, SQLite, MongoDB equally supported - Inherits from backend service multi-database support
- [x] Test coverage equivalent across all databases - **Testing requirement**: pytest with matrix for all DB types
- [x] Documentation includes database-specific examples - To be included in help text and quickstart guide

### V. Fail-Safe Defaults ✓
- [x] Destructive operations require explicit confirmation - **FR-003**: Confirmation required, **FR-035**: Non-interactive mode needs -y flag
- [x] Migration rollback scripts generated by default - **FR-022**: Generate both up and down scripts
- [x] Rate limiting enabled by default - To be coordinated with backend service rate limiting
- [x] Telemetry is opt-in (not opt-out) - **FR-031**: Config file controls telemetry, default off

## Project Structure

### Documentation (this feature)

```
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```
src/
├── cli/                      # CLI-specific code (new for this feature)
│   ├── __init__.py
│   ├── main.py              # Entry point, Click command groups
│   ├── commands/            # Command implementations
│   │   ├── query.py         # Query execution and REPL
│   │   ├── connect.py       # Connection management
│   │   ├── schema.py        # Schema design commands
│   │   └── migrate.py       # Migration commands
│   ├── formatting/          # Output formatters
│   │   ├── table.py
│   │   ├── json.py
│   │   ├── csv.py
│   │   └── markdown.py
│   ├── config.py            # Configuration management
│   ├── credentials.py       # Keyring integration
│   └── repl.py              # Interactive REPL implementation
├── models/                  # Existing (shared with backend)
├── services/                # Existing (query generation, schema design)
└── lib/                     # Existing (database drivers, utilities)

tests/
├── cli/                     # CLI-specific tests (new)
│   ├── test_commands.py
│   ├── test_repl.py
│   ├── test_formatting.py
│   └── test_credentials.py
├── integration/             # Existing (add CLI integration tests)
└── unit/                    # Existing (add CLI unit tests)

.querynl/                    # User config directory (created at runtime)
├── config.yaml              # User preferences
└── history.db               # Query history (SQLite)
```

**Structure Decision**: Single project structure (Option 1) with CLI as a new submodule under `src/cli/`. The CLI reuses existing `models/`, `services/`, and `lib/` components from the QueryNL backend, promoting code reuse and maintaining consistency. CLI-specific code is isolated in `src/cli/` for clear separation of concerns. User-facing config and data stored in platform-appropriate user directory (`~/.querynl/` on Unix, equivalent on Windows/macOS).

## Complexity Tracking

*Fill ONLY if Constitution Check has violations that must be justified*

No constitutional violations detected. All requirements align with constitution principles.

---

## Post-Design Constitution Re-Check

**Date**: 2025-10-13
**Status**: ✓ PASSED

After completing Phase 0 (research.md) and Phase 1 (data-model.md, contracts/, quickstart.md), all constitutional requirements remain satisfied:

### Design Artifacts Review

1. **research.md**: Technology decisions documented with security (keyring), UX (Click REPL), transparency (Rich output), and fail-safe considerations
2. **data-model.md**: Entities include secure credential storage, configuration validation, query history tracking
3. **contracts/cli-commands.md**: All commands follow fail-safe defaults (confirmations, non-interactive flags)
4. **contracts/output-formats.json**: JSON schemas ensure transparent, parseable output
5. **quickstart.md**: User documentation includes security best practices, troubleshooting

### Constitutional Compliance Confirmation

✓ **I. Security-First Design**: Keyring integration, credential isolation, SSL defaults maintained in all design artifacts

✓ **II. User Experience**: CLI contracts show 3-step quickstart, actionable error messages, multiple output formats

✓ **III. Transparency**: All commands display generated SQL before execution, explain mode available

✓ **IV. Multi-Database Parity**: Data model supports database_type enum, contracts cover all database types equally

✓ **V. Fail-Safe Defaults**: All destructive operations require confirmation, migrations include rollback scripts by design

**Conclusion**: Design phase maintains full constitutional compliance. Ready to proceed to Phase 2 (tasks.md generation via /speckit.tasks).
