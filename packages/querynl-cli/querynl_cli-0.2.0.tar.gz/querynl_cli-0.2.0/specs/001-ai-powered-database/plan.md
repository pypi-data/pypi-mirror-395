# Implementation Plan: QueryNL - AI Database Design and Querying Agent

**Branch**: `001-ai-powered-database` | **Date**: 2025-10-11 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/001-ai-powered-database/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

QueryNL is an AI-powered database assistant that converts natural language to SQL queries, designs database schemas, generates migrations, and provides query optimization. The system consists of:

1. **VS Code Extension** (TypeScript) - IDE integration with context-aware features
2. **Backend Service** (Python/FastAPI) - LLM orchestration, query generation, schema analysis
3. **Database Adapters** (Python) - Multi-database support (PostgreSQL, MySQL, SQLite, MongoDB)
4. **Credential Manager** (OS-native) - Secure credential storage and retrieval

Technical approach: Extension communicates with local backend service via HTTP/WebSocket. Backend uses LangChain for LLM orchestration, SQLAlchemy for database introspection, and database-specific drivers for query execution. Security-first design with encrypted credential storage and comprehensive input validation.

## Technical Context

### Backend Service
**Language/Version**: Python 3.11+
**Primary Dependencies**:
- FastAPI (async web framework)
- LangChain (LLM orchestration)
- SQLAlchemy (database introspection and ORM)
- psycopg2-binary (PostgreSQL driver)
- pymysql (MySQL driver)
- pymongo (MongoDB driver)
- cryptography (credential encryption)
- pydantic (data validation)

**Storage**:
- Local SQLite for user preferences, query history, saved templates
- OS keychain for credential storage (keyring library)
- No primary database dependency (connects to user's databases)

**Testing**: pytest with pytest-asyncio for async tests

### VS Code Extension
**Language/Version**: TypeScript 5.x
**Primary Dependencies**:
- VS Code Extension API
- @vscode/webview-ui-toolkit
- axios (HTTP client for backend communication)
- reconnecting-websocket (WebSocket with auto-reconnect for backend communication)

**Testing**: Mocha (official VS Code recommendation via @vscode/test-cli)

### Multi-Component Architecture
**Project Type**: Multi-component (backend service + IDE extension)
**Target Platform**:
- Backend: Windows 10+, macOS 11+, Linux (Ubuntu 20.04+)
- Extension: VS Code 1.80+ (last 12 months per requirements)

**Performance Goals**:
- Query generation: <3 seconds (90th percentile), <5 seconds (95th percentile)
- IDE extension activation: <2 seconds
- Database connection establishment: <5 seconds
- Schema introspection: <10 seconds for databases with <1000 tables

**Constraints**:
- Backend memory: <500MB idle, <2GB under load
- Extension bundle size: <5MB
- No blocking operations in extension (all I/O via backend)
- Offline mode support (Phase 2 - not initial release)

**Scale/Scope**:
- Support 10,000 concurrent users (backend scalability)
- Handle databases with up to 10,000 tables
- Store up to 1,000 query templates per user
- Support query history of last 10,000 queries per user

**Technology Decisions** (resolved in research.md):
1. ✅ Extension testing: **Mocha** (official VS Code recommendation)
2. ✅ WebSocket library: **reconnecting-websocket** (extension) + **FastAPI native** (backend)
3. ✅ ER diagram rendering: **Mermaid.js** (Crow's Foot support, 1MB bundle)
4. ✅ Migration frameworks: **Phase 1: Alembic + Flyway** | Phase 2: Django Migrations

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Reference: [QueryNL Constitution v1.0.0](../.specify/memory/constitution.md)

### I. Security-First Design ✓
- [ ] Credential storage uses AES-256 encryption
- [ ] No credentials in logs, errors, or telemetry
- [ ] Input validation prevents SQL injection
- [ ] OWASP Top 10 vulnerabilities addressed
- [ ] Security audit plan defined for major release

### II. User Experience Over Technical Purity ✓
- [ ] First query completable within 5 minutes of installation
- [ ] Error messages are actionable (not stack traces)
- [ ] IDE integration does not block UI
- [ ] Query generation latency < 5 seconds (95th percentile)

### III. Transparency and Explainability ✓
- [ ] Generated SQL displayed before execution
- [ ] Destructive operations require confirmation
- [ ] Schema/optimization rationale provided
- [ ] LLM token usage visible to users

### IV. Multi-Database Parity ✓
- [ ] PostgreSQL, MySQL, SQLite, MongoDB equally supported
- [ ] Test coverage equivalent across all databases
- [ ] Documentation includes database-specific examples

### V. Fail-Safe Defaults ✓
- [ ] Destructive operations require explicit confirmation
- [ ] Migration rollback scripts generated by default
- [ ] Rate limiting enabled by default
- [ ] Telemetry is opt-in (not opt-out)

## Project Structure

### Documentation (this feature)

```
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```
backend/
├── src/
│   ├── querynl/
│   │   ├── __init__.py
│   │   ├── api/                  # FastAPI endpoints
│   │   │   ├── __init__.py
│   │   │   ├── query.py          # Natural language to SQL endpoints
│   │   │   ├── schema.py         # Schema design endpoints
│   │   │   ├── migration.py      # Migration generation endpoints
│   │   │   ├── optimization.py   # Query optimization endpoints
│   │   │   └── connection.py     # Database connection management
│   │   ├── core/                 # Core business logic
│   │   │   ├── __init__.py
│   │   │   ├── llm/              # LLM orchestration
│   │   │   ├── query_generator/  # SQL generation from NL
│   │   │   ├── schema_designer/  # Schema design logic
│   │   │   └── optimizer/        # Query optimization
│   │   ├── db/                   # Database adapters
│   │   │   ├── __init__.py
│   │   │   ├── base.py           # Abstract database adapter
│   │   │   ├── postgresql.py
│   │   │   ├── mysql.py
│   │   │   ├── sqlite.py
│   │   │   └── mongodb.py
│   │   ├── security/             # Security components
│   │   │   ├── __init__.py
│   │   │   ├── credentials.py    # Encrypted credential storage
│   │   │   └── validation.py     # Input validation & SQL injection prevention
│   │   ├── models/               # Data models (Pydantic)
│   │   │   ├── __init__.py
│   │   │   ├── connection.py
│   │   │   ├── query.py
│   │   │   └── schema.py
│   │   └── storage/              # Local storage (SQLite)
│   │       ├── __init__.py
│   │       └── repository.py
│   ├── main.py                   # FastAPI application entry point
│   └── config.py                 # Configuration management
├── tests/
│   ├── contract/                 # API contract tests
│   ├── integration/              # Integration tests (with test DBs)
│   └── unit/                     # Unit tests
├── pyproject.toml               # Python dependencies (Poetry or setuptools)
└── README.md

extension/
├── src/
│   ├── extension.ts              # Extension activation and registration
│   ├── commands/                 # Command implementations
│   │   ├── query.ts              # Natural language query command
│   │   ├── schema.ts             # Schema design command
│   │   └── connection.ts         # Connection management command
│   ├── views/                    # Webview panels
│   │   ├── queryPanel.ts         # Query interface panel
│   │   ├── schemaPanel.ts        # Schema visualization panel
│   │   └── connectionPanel.ts    # Connection configuration panel
│   ├── services/                 # Backend communication
│   │   ├── backendClient.ts      # HTTP/WebSocket client
│   │   └── stateManager.ts       # Extension state management
│   ├── providers/                # VS Code providers
│   │   ├── completionProvider.ts # Autocomplete for table/column names
│   │   └── hoverProvider.ts      # Hover info for schema elements
│   └── utils/
│       └── logger.ts
├── media/                        # Extension icons and assets
├── tests/
│   └── suite/                    # Extension integration tests
├── package.json                  # Extension manifest and dependencies
├── tsconfig.json
└── README.md

shared/
├── types/                        # Shared TypeScript/Python type definitions
│   └── api.ts                    # API contract types
└── README.md
```

**Structure Decision**: Multi-component architecture selected due to IDE extension + backend service requirements. The backend is a standalone Python service that can run independently, while the extension is a VS Code-specific client. Shared types ensure contract consistency between frontend and backend.

## Complexity Tracking

*Fill ONLY if Constitution Check has violations that must be justified*

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| [e.g., 4th project] | [current need] | [why 3 projects insufficient] |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient] |
