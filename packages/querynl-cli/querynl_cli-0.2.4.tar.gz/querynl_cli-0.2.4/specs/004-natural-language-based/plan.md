# Implementation Plan: Natural Language Schema Design

**Branch**: `004-natural-language-based` | **Date**: 2025-11-03 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/004-natural-language-based/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

This feature adds conversational schema design capability to QueryNL's REPL mode, enabling users to design database schemas through natural language conversation and data file analysis. Users can describe requirements in plain English, upload CSV/Excel/JSON files for analysis, iteratively refine schema designs, and implement finalized schemas across PostgreSQL, MySQL, SQLite, and MongoDB. The system leverages the existing LLM integration (OpenAI/Anthropic) to understand requirements, ask clarifying questions, propose normalized schemas, and generate database-specific DDL statements.

## Technical Context

**Language/Version**: Python 3.11+ (matches existing QueryNL codebase)
**Primary Dependencies**: Click 8.1+ (CLI), Rich 13.0+ (formatting), prompt_toolkit 3.0+ (REPL), LangChain 0.1+ (LLM orchestration), OpenAI/Anthropic APIs (LLM), pandas 2.0+ (CSV/Excel parsing), openpyxl 3.0+ (Excel support), SQLAlchemy (DDL generation)
**Storage**: SQLite for schema design session persistence with JSON-serialized session data, filesystem for uploaded data files
**Testing**: pytest 8.0+ with coverage, pytest-mock for LLM mocking, hybrid approach (mocked responses for unit tests + optional real LLM integration tests)
**Target Platform**: Cross-platform CLI (Linux, macOS, Windows)
**Project Type**: Single project (CLI extension to existing QueryNL)
**Performance Goals**: <5 seconds for LLM-based schema proposals (95th percentile per NFR-001), <30 seconds for file analysis up to 100MB (per NFR-002)
**Constraints**: REPL-only mode (no batch CLI), session persistence across REPL exits, support 4 database types (PostgreSQL, MySQL, SQLite, MongoDB)
**Scale/Scope**: Single-user interactive sessions, schemas up to 50 tables, data files up to 100MB, 90-day session retention
**ER Diagrams**: Mermaid syntax generation (text-based, no external library dependencies)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Reference: [QueryNL Constitution v1.0.0](../../.specify/memory/constitution.md)

### I. Security-First Design ✓
- [x] Credential storage uses AES-256 encryption - Inherits from existing QueryNL credential management (keyring)
- [x] No credentials in logs, errors, or telemetry - Feature does not handle credentials directly; uses existing DB connections
- [x] Input validation prevents SQL injection - Generated DDL will be parameterized; user input is natural language, not SQL
- [x] OWASP Top 10 vulnerabilities addressed - File upload validation (type, size), session isolation, no user-generated code execution
- [x] Security audit plan defined for major release - Will follow existing QueryNL release process

### II. User Experience Over Technical Purity ✓
- [x] First query completable within 5 minutes of installation - Schema design starts with `\schema design` (immediate)
- [x] Error messages are actionable (not stack traces) - Natural language error explanations via LLM (FR-005)
- [x] IDE integration does not block UI - REPL-based, no IDE integration in this feature
- [x] Query generation latency < 5 seconds (95th percentile) - NFR-001 specifies <5s for schema proposals

### III. Transparency and Explainability ✓
- [x] Generated SQL displayed before execution - FR-025: DDL shown via `\schema show ddl` before `\schema execute`
- [x] Destructive operations require confirmation - FR-027: Transactions with rollback, user confirms via `\schema execute`
- [x] Schema/optimization rationale provided - FR-021: System explains trade-offs for design alternatives
- [x] LLM token usage visible to users - To be added to session info display (see Phase 0 research)

### IV. Multi-Database Parity ✓
- [x] PostgreSQL, MySQL, SQLite, MongoDB equally supported - FR-015 explicitly requires all four database types
- [x] Test coverage equivalent across all databases - Contract tests will validate DDL generation for each DB type
- [x] Documentation includes database-specific examples - Quickstart will include examples for each database

### V. Fail-Safe Defaults ✓
- [x] Destructive operations require explicit confirmation - `\schema execute` requires confirmation before applying DDL
- [x] Migration rollback scripts generated by default - FR-027: Transactional execution with rollback capability
- [x] Rate limiting enabled by default - Inherits from existing LLM service rate limiting
- [x] Telemetry is opt-in (not opt-out) - Inherits from existing QueryNL telemetry settings

**Gate Status**: ✅ PASS - All constitutional requirements met. No violations require justification.

## Project Structure

### Documentation (this feature)

```
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```
src/cli/
├── commands/
│   ├── schema.py              # NEW: \schema command handler (routes subcommands)
│   ├── query.py               # EXISTING: natural language query
│   ├── connect.py             # EXISTING: database connections
│   └── ...
├── schema_design/             # NEW: schema design core logic
│   ├── __init__.py
│   ├── session.py             # Schema design session management
│   ├── conversation.py        # LLM conversation orchestration
│   ├── file_analyzer.py       # CSV/Excel/JSON file analysis
│   ├── schema_generator.py    # Schema proposal generation (normalized schemas)
│   ├── ddl_generator.py       # Database-specific DDL generation
│   ├── visualizer.py          # ER diagram generation (Mermaid text-based)
│   └── validator.py           # Schema validation and conflict detection
├── models.py                  # EXISTING: will add SchemaDesignSession, SchemaProposal
├── repl.py                    # EXISTING: will add \schema command registration
├── database.py                # EXISTING: DB connections (reused)
├── llm.py                     # EXISTING: LLM service (reused/extended)
└── formatting/                # EXISTING: output formatters
    ├── mermaid_formatter.py   # NEW: ER diagram rendering
    └── ...

tests/
├── unit/
│   ├── test_schema_session.py
│   ├── test_file_analyzer.py
│   ├── test_schema_generator.py
│   ├── test_ddl_generator.py
│   └── test_visualizer.py
├── integration/
│   ├── test_schema_workflow.py
│   └── test_database_implementation.py
└── contract/
    └── test_ddl_contracts.py  # Validates DDL for PostgreSQL, MySQL, SQLite, MongoDB
```

**Structure Decision**: Single project (CLI extension). All schema design functionality lives under `src/cli/schema_design/` as a new module. The feature integrates with existing REPL infrastructure ([repl.py](../../src/cli/repl.py)), LLM service ([llm.py](../../src/cli/llm.py)), and database connections ([database.py](../../src/cli/database.py)). New `\schema` command handler added to [commands/schema.py](../../src/cli/commands/schema.py) to route subcommands (`design`, `upload`, `show`, etc.).

## Complexity Tracking

*Fill ONLY if Constitution Check has violations that must be justified*

No constitutional violations - this section is not needed.
