# Implementation Plan: Test Data Generation for Schema Design Mode

**Branch**: `005-add-test-data` | **Date**: 2025-11-28 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/005-add-test-data/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Enable users to populate newly created database schemas with realistic test data through natural language requests. Users can request test data generation (e.g., "add 50 sample users"), and the system will introspect the schema, generate a data generation plan using LLM, synthesize realistic data values with Faker, and execute batch INSERT operations while respecting foreign key dependencies and constraints.

## Technical Context

**Language/Version**: Python 3.10+ (existing codebase uses 3.10-3.12, per setup.py)
**Primary Dependencies**: LangChain (LLM orchestration), OpenAI/Anthropic (LLM providers), SQLAlchemy (schema introspection), Faker (data generation), toposort (dependency ordering), Rich (terminal UI), Click (CLI framework)
**Storage**: N/A (operates on existing user databases - MySQL, PostgreSQL, SQLite)
**Testing**: pytest with pytest-cov and pytest-mock
**Target Platform**: CLI application (cross-platform: macOS, Linux, Windows)
**Project Type**: Single project (CLI extension to existing QueryNL codebase)
**Performance Goals**: Generate and insert test data in <10 seconds for schemas with up to 10 tables and default quantities (10-20 records/table)
**Constraints**: Must respect database constraints (foreign keys, NOT NULL, UNIQUE), maintain 100% referential integrity, no data corruption
**Scale/Scope**: Support schemas up to 50 tables, generate up to 10,000 records per request (with user confirmation for >1000)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Reference: [QueryNL Constitution v1.0.0](../.specify/memory/constitution.md)

### I. Security-First Design ✓
- [X] Credential storage uses AES-256 encryption - Inherits from existing CLI credential management
- [X] No credentials in logs, errors, or telemetry - Test data generation does not log connection strings
- [X] Input validation prevents SQL injection - Uses parameterized queries via SQLAlchemy (except for INSERT VALUES which are sanitized)
- [X] OWASP Top 10 vulnerabilities addressed - No new attack vectors introduced; operates within existing security model
- [X] Security audit plan defined for major release - N/A for this feature; covered by overall QueryNL release process

### II. User Experience Over Technical Purity ✓
- [X] First query completable within 5 minutes of installation - Test data generation is a single natural language command after schema creation
- [X] Error messages are actionable (not stack traces) - Errors identify which table/constraint failed with clear remediation steps
- [X] IDE integration does not block UI - N/A, this is a CLI-only feature
- [X] Query generation latency < 5 seconds (95th percentile) - Target: <10 seconds for schemas with up to 10 tables

### III. Transparency and Explainability ✓
- [X] Generated SQL displayed before execution - INSERT statements are shown before execution with counts per table
- [X] Destructive operations require confirmation - Large datasets (>1000 records) trigger user confirmation prompt
- [X] Schema/optimization rationale provided - Data generation plan explains table ordering and FK resolution strategy
- [X] LLM token usage visible to users - Plan generation reports token usage as part of existing LLM telemetry

### IV. Multi-Database Parity ✓
- [X] PostgreSQL, MySQL, SQLite, MongoDB equally supported - MongoDB not applicable (NoSQL); MySQL, PostgreSQL, SQLite fully supported
- [X] Test coverage equivalent across all databases - Unit and integration tests for MySQL, PostgreSQL, SQLite
- [X] Documentation includes database-specific examples - Quickstart includes examples for each supported DB type

### V. Fail-Safe Defaults ✓
- [X] Destructive operations require explicit confirmation - Threshold set at >1000 records (configurable)
- [X] Migration rollback scripts generated by default - N/A for test data; users can DELETE generated data
- [X] Rate limiting enabled by default - N/A for local database operations
- [X] Telemetry is opt-in (not opt-out) - Inherits from existing QueryNL telemetry configuration

## Project Structure

### Documentation (this feature)

```
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```
src/cli/
├── models.py                              # Data models (TestDataRequest, DataGenerationPlan, InsertionResult, etc.)
├── schema_design/
│   ├── __init__.py                        # Module exports and exceptions
│   ├── test_data_generator.py            # ITestDataGenerator interface and orchestration
│   ├── data_synthesizer.py               # IDataSynthesizer interface and Faker-based implementation
│   └── insertion_executor.py             # IInsertionExecutor interface and batch INSERT execution
├── schema_introspection.py                # Existing schema introspection (reused)
├── llm.py                                 # Existing LLM service (reused)
└── repl.py                                # REPL integration for \data command

tests/
├── unit/
│   ├── test_test_data_generator.py        # Unit tests for orchestration logic
│   ├── test_data_synthesizer.py           # Unit tests for data generation
│   └── test_insertion_executor.py         # Unit tests for INSERT execution
└── integration/
    ├── test_mysql_test_data.py            # MySQL integration tests
    ├── test_postgresql_test_data.py       # PostgreSQL integration tests
    └── test_sqlite_test_data.py           # SQLite integration tests
```

**Structure Decision**: Single project (CLI extension). This feature extends the existing `src/cli/schema_design/` module with three new implementation files and integrates with the existing REPL via a new `\data` command. All data models are defined in `src/cli/models.py` to maintain consistency with existing architecture.

## Complexity Tracking

*Fill ONLY if Constitution Check has violations that must be justified*

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| [e.g., 4th project] | [current need] | [why 3 projects insufficient] |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient] |
