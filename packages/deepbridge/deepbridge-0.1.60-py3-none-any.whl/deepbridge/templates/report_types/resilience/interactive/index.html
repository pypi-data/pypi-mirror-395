<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ report_title }} - {{ model_name }}</title>

    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>

    <!-- Inline CSS -->
    <style>
        {{ css_content|safe }}
    </style>
</head>
<body>
    <div class="report-container">
        <!-- Header -->
        <div class="report-header">
            <h1 class="report-header__title">{{ report_title }}</h1>
            <p class="report-header__subtitle">{{ report_subtitle }}</p>
            <div class="report-header__metadata">
                <span class="report-header__metadata-item">
                    <strong>Model:</strong> {{ model_name }} ({{ model_type }})
                </span>
                <span class="report-header__metadata-item">
                    <strong>Metric:</strong> {{ metric }}
                </span>
                <span class="report-header__metadata-item">
                    <strong>Missing Data %:</strong> {{ missing_percentage|default(0)|round(1) }}%
                </span>
                <span class="report-header__metadata-item">
                    <strong>Features:</strong> {{ features|length if features else 0 }}
                </span>
            </div>
        </div>

        <!-- Metrics Grid -->
        <div class="metrics-grid">
            <div class="metric-card">
                <span class="metric-card__label">Base Score</span>
                <span class="metric-card__value">{{ "%.4f"|format(base_score|default(0)) }}</span>
            </div>
            <div class="metric-card">
                <span class="metric-card__label">Resilience Score</span>
                <span class="metric-card__value">{{ "%.4f"|format(resilience_score|default(0)) }}</span>
            </div>
            <div class="metric-card">
                <span class="metric-card__label">Avg Impact</span>
                <span class="metric-card__value">{{ "%.4f"|format(avg_impact|default(0)) }}</span>
            </div>
            <div class="metric-card">
                <span class="metric-card__label">Max Impact</span>
                <span class="metric-card__value">{{ "%.4f"|format(max_impact|default(0)) }}</span>
            </div>
            <div class="metric-card">
                <span class="metric-card__label">Missing Levels</span>
                <span class="metric-card__value">{{ missing_levels|length if missing_levels else 0 }}</span>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" data-tab="overview">Overview</button>
            <button class="tab-button" data-tab="by-level">By Missing %</button>
            <button class="tab-button" data-tab="features">Feature Impact</button>
            <button class="tab-button" data-tab="patterns">Missing Patterns</button>
        </div>

        <!-- Tab Content -->
        <div id="overview" class="tab-content active">
            <div class="section">
                <h2 class="section__title">Resilience Overview</h2>
                <p>This chart shows how the model performs under different levels of missing data.</p>
                <div class="chart-container">
                    <div id="chart-overview"></div>
                </div>
            </div>

            <div class="section">
                <h2 class="section__title">Score Distribution</h2>
                <p>Distribution of scores across missing data scenarios.</p>
                <div class="chart-container">
                    <div id="chart-distribution"></div>
                </div>
            </div>
        </div>

        <div id="by-level" class="tab-content">
            <div class="section">
                <h2 class="section__title">Impact by Missing Data Level</h2>
                <p>Performance degradation at each missing data percentage.</p>
                <div class="chart-container">
                    <div id="chart-by-level"></div>
                </div>
            </div>

            <div class="section">
                <h2 class="section__title">Detailed Results</h2>
                <div class="data-table-container">
                    <table class="data-table" style="color: #333 !important;">
                        <thead>
                            <tr>
                                <th>Missing %</th>
                                <th>Mean Score</th>
                                <th>Worst Score</th>
                                <th>Std Dev</th>
                                <th>Impact</th>
                            </tr>
                        </thead>
                        <tbody id="levels-table-body" style="color: #333 !important;">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="features" class="tab-content">
            <div class="section">
                <h2 class="section__title">Feature Importance for Resilience</h2>
                <p>Features ranked by their impact when missing.</p>
                <div class="chart-container">
                    <div id="chart-features"></div>
                </div>
            </div>

            <div class="section">
                <h2 class="section__title">Feature Details</h2>
                <div class="data-table-container">
                    <table class="data-table" style="color: #333 !important;">
                        <thead>
                            <tr>
                                <th>Feature</th>
                                <th>Missing Impact</th>
                                <th>Importance</th>
                            </tr>
                        </thead>
                        <tbody id="features-table-body" style="color: #333 !important;">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="patterns" class="tab-content">
            <div class="section">
                <h2 class="section__title">Missing Data Patterns</h2>
                <p>Analysis of different missing data patterns (MCAR, MAR, MNAR).</p>
                <div class="chart-container">
                    <div id="chart-patterns"></div>
                </div>
            </div>

            <div class="section">
                <h2 class="section__title">Imputation Strategy Comparison</h2>
                <p>Performance comparison across different imputation strategies.</p>
                <div class="chart-container">
                    <div id="chart-strategies"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Data -->
    <script>
        window.reportData = {{ report_data_json|safe }};
        console.log('Resilience report data loaded:', window.reportData);
    </script>

    <!-- Tab Navigation JS -->
    <script>
        {{ js_content|safe }}
    </script>

    <!-- Charts Rendering -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const data = window.reportData;

                // Render Overview Chart
                if (data.charts && data.charts.overview) {
                    const overviewData = data.charts.overview;
                    Plotly.newPlot('chart-overview', overviewData.data, overviewData.layout, {responsive: true});
                }

                // Render By Level Chart
                if (data.charts && data.charts.by_level) {
                    const byLevelData = data.charts.by_level;
                    Plotly.newPlot('chart-by-level', byLevelData.data, byLevelData.layout, {responsive: true});
                }

                // Render Feature Impact Chart
                if (data.charts && data.charts.features) {
                    const featuresData = data.charts.features;
                    Plotly.newPlot('chart-features', featuresData.data, featuresData.layout, {responsive: true});
                }

                // Render Score Distribution
                if (data.charts && data.charts.score_distribution) {
                    const distData = data.charts.score_distribution;
                    console.log('Score distribution data:', distData);
                    Plotly.newPlot('chart-distribution', distData.data, distData.layout, {responsive: true});
                }

                // Render Missing Patterns
                if (data.charts && data.charts.patterns) {
                    const patternsData = data.charts.patterns;
                    Plotly.newPlot('chart-patterns', patternsData.data, patternsData.layout, {responsive: true});
                }

                // Render Imputation Strategies
                if (data.charts && data.charts.strategies) {
                    const strategiesData = data.charts.strategies;
                    Plotly.newPlot('chart-strategies', strategiesData.data, strategiesData.layout, {responsive: true});
                }

                // Populate Levels Table
                if (data.levels && data.levels.length > 0) {
                    const tbody = document.getElementById('levels-table-body');
                    data.levels.forEach(level => {
                        const row = document.createElement('tr');
                        row.style.color = '#333';
                        row.innerHTML = `
                            <td style="color: #333 !important;">${level.missing_percentage.toFixed(1)}%</td>
                            <td style="color: #333 !important;">${level.mean_score.toFixed(4)}</td>
                            <td style="color: #333 !important;">${level.worst_score.toFixed(4)}</td>
                            <td style="color: #333 !important;">${level.std_score.toFixed(4)}</td>
                            <td style="color: #333 !important;">${level.impact.toFixed(4)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                // Populate Features Table
                // Use features_table if available (new format), otherwise try features array (old format)
                const featuresArray = data.features_table || (Array.isArray(data.features) ? data.features : []);

                if (featuresArray && featuresArray.length > 0) {
                    const tbody = document.getElementById('features-table-body');
                    featuresArray.forEach(feature => {
                        const row = document.createElement('tr');
                        row.style.color = '#333';
                        row.innerHTML = `
                            <td style="color: #333 !important;">${feature.name}</td>
                            <td style="color: #333 !important;">${feature.missing_impact.toFixed(4)}</td>
                            <td style="color: #333 !important;">${feature.importance.toFixed(4)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    console.log(`Populated features table with ${featuresArray.length} features`);
                } else {
                    console.warn('No features data available for table');
                }

                console.log('All resilience charts and tables rendered successfully');
            } catch (error) {
                console.error('Error rendering resilience report:', error);
            }
        });
    </script>
</body>
</html>
