# ============================================================================
# MPB2D Bulk Driver - Streaming Mode Example
# ============================================================================
#
# Demonstrates real-time streaming output for Python/WASM consumers.
# Results are emitted as computed, enabling live plotting and progressive UI.
#
# TOML RULE: Fields without [section] must appear at the very top.
# ============================================================================

polarization = "TM"

# ----------------------------------------------------------------------------
# DRIVER
# ----------------------------------------------------------------------------
[bulk]
threads = 4          # Workers (null = all cores, 1 for WASM)
verbose = false
dry_run = false

[solver]
type = "maxwell"     # "maxwell" (photonic) or "ea" (envelope approx)

# ----------------------------------------------------------------------------
# GEOMETRY
# ----------------------------------------------------------------------------
[geometry]
eps_bg = 12.0        # Background ε (1.0=air, 12.0=Si/GaAs)

[geometry.lattice]
type = "square"      # "square", "rectangular", "triangular", "hexagonal"
a = 1.0

[[geometry.atoms]]
pos = [0.5, 0.5]     # Fractional coords [0,1)
radius = 0.2         # In units of lattice constant a
eps_inside = 1.0     # Air hole in dielectric

# ----------------------------------------------------------------------------
# COMPUTATIONAL SETTINGS
# ----------------------------------------------------------------------------
[grid]
nx = 32
ny = 32
lx = 1.0
ly = 1.0

[path]
preset = "square"       # Γ→X→M→Γ (matches lattice)
segments_per_leg = 12   # k-points per segment

[eigensolver]
n_bands = 8
tol = 1e-8
max_iter = 200

[dielectric]
smoothing_radius = 0.5  # Subpixel averaging (0=sharp, 0.5-1.0=smooth)

# ----------------------------------------------------------------------------
# SWEEPS - Ordered parameter variations
# ----------------------------------------------------------------------------
# Each [[sweeps]] = one nested loop dimension. First = outermost.
# Total jobs = product of all sweep counts.

[[sweeps]]
parameter = "atom0.radius"
min = 0.15
max = 0.35
step = 0.05            # 5 values: 0.15, 0.20, 0.25, 0.30, 0.35

# ----------------------------------------------------------------------------
# OUTPUT
# ----------------------------------------------------------------------------
[output]
mode = "selective"     # "full" (1 CSV/job) or "selective" (merged CSV)
io_mode = "stream"     # "sync", "batch", or "stream"
directory = "./sweep_output"
filename = "./sweep_results.csv"

[output.selective]
k_indices = [0, 12, 24, 36]   # Γ, X, M, Γ (0-based)
k_labels = ["Γ", "X", "M", "Γ"]
bands = [1, 2, 3, 4]          # 1-based band indices

# ============================================================================
# RESULT STRUCTURE (Python/WASM)
# ============================================================================
#
# Each streamed result dict contains:
#
#   job_index     : int           - Job number (completion order, not sweep order)
#   result_type   : str           - "maxwell" or "ea"
#   num_k_points  : int           - Length of k_path
#   num_bands     : int           - Number of bands computed
#   k_path        : [[kx,ky],...]  - K-points in fractional coords
#   distances     : [float,...]   - Cumulative path distance for plotting
#   bands         : [[ω₁,ω₂,...],...]  - Frequencies at each k-point (ω/2π normalized)
#
#   params        : dict          - Full configuration for this job
#     eps_bg, resolution, polarization, lattice_type, atoms: [...]
#
#   sweep_values  : dict          - Current sweep parameter values
#     e.g., {"atom0.radius": 0.25}
#
#   sweep_order   : str           - Parseable string "param1=val1|param2=val2"
#
# Note: Results arrive in completion order (parallel). Use sweep_order for sorting.
# ============================================================================
