name: Test

on:
  push:
    branches: [ '**' ]        # Run format-check + test-core on ANY push to main

jobs:

  check-no-tags:
    name: Check No-Tags
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Fail if tag pushed from non-main
        run: |
          echo "ERROR: Tags are only allowed on main branch"
          echo "Current ref: ${{ github.ref }}"
          exit 1

  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ruff format --check
        uses: astral-sh/ruff-action@v1
        with:
          args: format --check

  test:
    name: Core Tests
    if: "!startsWith(github.ref, 'refs/tags/')"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ '3.12' ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install deps
        run: |
          uv sync --extra test

      - name: Unit tests + Coverage
        run: |
          uv run pytest --cov=c108 --cov-branch --cov-report=term

      - name: Doctest
        run: |
          uv run pytest --xdoctest c108 --cov=c108 --cov-branch --cov-report=term
  
