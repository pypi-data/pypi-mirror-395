import{b as Z}from"./chunk-FENW22PV.js";import"./chunk-K2P6CES6.js";import{b as T}from"./chunk-LNTKXTVM.js";import"./chunk-MFPRCIVI.js";import{k as A,p as k}from"./chunk-SVHROGNI.js";import{I as v,ka as O,r as N}from"./chunk-DLJYFRIS.js";import{Ka as w,g as I,lb as _,n as p,p as B,ra as z,sa as D,t as y,v as R}from"./chunk-MAT3H5WR.js";import{k as d}from"./chunk-KYPE3LET.js";var F=class X extends O{#t;decodeOptions(t){let i=new v(t),e=this.getObject();i.check("CONST")&&e&&(e.fConstRatio=!0),this.setOptions({Zscale:i.check("Z")})}createRGBA(t){let i=this.getObject(),e=i?.fPalette;if(!e)return null;let o=new Array((t+1)*4).fill(0);for(let a=0,r=1;a<=t;++a){let f=a/t;for(;e.fPoints[r]<f&&r<e.fPoints.length-1;)r++;let n=(e.fPoints[r]-f)/(e.fPoints[r]-e.fPoints[r-1]),s=(f-e.fPoints[r-1])/(e.fPoints[r]-e.fPoints[r-1]);o[a*4]=Math.min(255,Math.round((e.fColorRed[r-1]*n+e.fColorRed[r]*s)/256)),o[a*4+1]=Math.min(255,Math.round((e.fColorGreen[r-1]*n+e.fColorGreen[r]*s)/256)),o[a*4+2]=Math.min(255,Math.round((e.fColorBlue[r-1]*n+e.fColorBlue[r]*s)/256)),o[a*4+3]=Math.min(255,Math.round((e.fColorAlpha[r-1]*n+e.fColorAlpha[r]*s)/256))}return o}cleanup(){this.#t=void 0,super.cleanup()}getContour(){return this.#t}makeUrlFromImageBuf(t,i){return d(this,null,function*(){this.rgba=this.createRGBA(1e3);let o=t.fImgBuf[0],a=t.fImgBuf[0];for(let n=1;n<t.fImgBuf.length;++n){let s=t.fImgBuf[n];o=Math.min(s,o),a=Math.max(s,a)}this.#t={arr:new Array(200),rgba:this.rgba,getLevels(){return this.arr},getPaletteColor(n,s){if(!this.arr||!this.rgba)return"white";let h=Math.round((s-this.arr[0])/(this.arr.at(-1)-this.arr.at(0))*(this.rgba.length-4)/4)*4;return N(this.rgba[h]/255,this.rgba[h+1]/255,this.rgba[h+2]/255,this.rgba[h+3]/255)}};for(let n=0;n<200;n++)this.#t.arr[n]=o+(a-o)/199*n;o>=a&&(a=o+1);let r=this.getImageZoomRange(i,t.fConstRatio,t.fWidth,t.fHeight);return(p()?import("./chunk-FQ6HXOK4.js").then(n=>n.default.createCanvas(r.xmax-r.xmin,r.ymax-r.ymin)):new Promise(n=>{let s=document.createElement("canvas");s.width=r.xmax-r.xmin,s.height=r.ymax-r.ymin,n(s)})).then(n=>{let s=n.getContext("2d"),h=s.getImageData(0,0,n.width,n.height),m=h.data;for(let l=r.ymin;l<r.ymax;++l){let g=(r.ymax-l-1)*(r.xmax-r.xmin)*4,b=l*t.fWidth;for(let u=r.xmin;u<r.xmax;++u){let c=Math.round((t.fImgBuf[b+u]-o)/(a-o)*1e3)*4;m[g++]=this.rgba[c++],m[g++]=this.rgba[c++],m[g++]=this.rgba[c++],m[g++]=this.rgba[c]}}return s.putImageData(h,0,0),{url:n.toDataURL(),constRatio:t.fConstRatio,can_zoom:!0}})})}getImageZoomRange(t,i,e,o){let a={xmin:0,xmax:e,ymin:0,ymax:o};if(!t)return a;let r=0,f=0,n=e,s=o;if(i){let h=o/e,m=t.getFrameHeight()/t.getFrameWidth();if(h>m){let l=o/m;r=Math.round((l-e)/2),n=Math.round(l)}else{let l=m*e;f=Math.round((l-o)/2),s=Math.round(l)}}return t.zoom_xmin!==t.zoom_xmax&&(a.xmin=Math.min(e,Math.max(0,Math.round(t.zoom_xmin*n)-r)),a.xmax=Math.min(e,Math.max(0,Math.round(t.zoom_xmax*n)-r))),t.zoom_ymin!==t.zoom_ymax&&(a.ymin=Math.min(o,Math.max(0,Math.round(t.zoom_ymin*s)-f)),a.ymax=Math.min(o,Math.max(0,Math.round(t.zoom_ymax*s)-f))),a}makeUrlFromPngBuf(t,i){return d(this,null,function*(){let e=t.fPngBuf,o="";if(I(e))o=e;else for(let f=0;f<e.length;++f)o+=String.fromCharCode(e[f]<0?256+e[f]:e[f]);let a={url:"data:image/png;base64,"+B(o),constRatio:t.fConstRatio,can_zoom:i&&!p()},r=R();return!a.can_zoom||i?.zoom_xmin===i?.zoom_xmax&&i?.zoom_ymin===i?.zoom_ymax?a:new Promise(f=>{let n=r.createElement("img");n.onload=()=>{let s=r.createElement("canvas");s.width=n.width,s.height=n.height;let h=s.getContext("2d");h.drawImage(n,0,0);let m=h.getImageData(0,0,n.width,n.height).data,l=this.getImageZoomRange(i,a.constRatio,n.width,n.height),g=r.createElement("canvas");g.width=l.xmax-l.xmin,g.height=l.ymax-l.ymin;let b=g.getContext("2d"),u=b.getImageData(0,0,g.width,g.height),c=u.data;for(let x=l.ymin;x<l.ymax;++x){let P=(l.ymax-x-1)*(l.xmax-l.xmin)*4,C=((n.height-x-1)*n.width+l.xmin)*4;for(let M=l.xmin;M<l.xmax;++M)c[P++]=m[C++],c[P++]=m[C++],c[P++]=m[C++],c[P++]=m[C++]}b.putImageData(u,0,0),a.url=g.toDataURL(),f(a)},n.onerror=()=>f(a),n.src=a.url})})}get _wheel_zoomy(){return!0}drawImage(){return d(this,null,function*(){let t=this.getObject(),i=this.getFramePainter(),e=i?.getFrameRect()??this.getPadPainter().getPadRect();t._blob&&(t._blob.length===15&&!t._blob[0]?(t.fImageQuality=t._blob[1],t.fImageCompression=t._blob[2],t.fConstRatio=t._blob[3],t.fPalette={_typename:D,fUniqueID:t._blob[4],fBits:t._blob[5],fNumPoints:t._blob[6],fPoints:t._blob[7],fColorRed:t._blob[8],fColorGreen:t._blob[9],fColorBlue:t._blob[10],fColorAlpha:t._blob[11]},t.fWidth=t._blob[12],t.fHeight=t._blob[13],t.fImgBuf=t._blob[14],(t.fWidth*t.fHeight!==t.fImgBuf.length||t.fPalette.fNumPoints!==t.fPalette.fPoints.length)&&(console.error(`TASImage _blob decoding error ${t.fWidth*t.fHeight} != ${t.fImgBuf.length} ${t.fPalette.fNumPoints} != ${t.fPalette.fPoints.length}`),delete t.fImgBuf,delete t.fPalette)):t._blob.length===3&&t._blob[0]?(t.fPngBuf=t._blob[2],t.fPngBuf?.length!==t._blob[1]&&(console.error(`TASImage with png buffer _blob error ${t._blob[1]} != ${t.fPngBuf?.length}`),delete t.fPngBuf)):console.error(`TASImage _blob len ${t._blob.length} not recognized`),delete t._blob);let o;return t.fImgBuf&&t.fPalette?o=this.makeUrlFromImageBuf(t,i):t.fPngBuf?o=this.makeUrlFromPngBuf(t,i):o=Promise.resolve(null),o.then(a=>{if(!a?.url)return this;let r=this.createG(i).append("image").attr("href",a.url).attr("width",e.width).attr("height",e.height).attr("preserveAspectRatio",a.constRatio?null:"none");return this.isBatchMode()||((y.MoveResize||y.ContextMenu)&&r.style("pointer-events","visibleFill"),a.can_zoom&&r.style("cursor","pointer")),k(this,A),!i||!a.can_zoom?this:this.drawColorPalette(this.getOptions().Zscale,!0).then(()=>(i.setAxesRanges(_(w),0,1,_(w),0,1,null,0,0),i.createXY({ndim:2,check_pad_range:!1}),i.addInteractivity()))})})}fillContextMenuItems(t){let i=this.getObject(),e=this.getOptions();i&&t.addchk(i.fConstRatio,"Const ratio",o=>{i.fConstRatio=o,this.interactiveRedraw("pad",`exec:SetConstRatio(${o})`)},"Change const ratio flag of image"),i?.fPalette&&t.addchk(e.Zscale,"Color palette",o=>{e.Zscale=o,this.drawColorPalette(o,!0)},"Toggle color palette")}canZoomInside(t,i,e){return this.getObject()?(t==="x"||t==="y")&&e-i>.01:!1}getHistPalette(){return!0}drawColorPalette(t,i){return d(this,null,function*(){if(!this.isMainPainter())return null;if(!this.draw_palette){let a=_(z);Object.assign(a,{fX1NDC:.91,fX2NDC:.95,fY1NDC:.1,fY2NDC:.9,fInit:1}),a.fAxis.fChopt="+",this.draw_palette=a}let e=this.getPadPainter().findPainterFor(this.draw_palette);if(!t)return e&&(e.Enabled=!1,e.removeG()),null;let o=this.getFramePainter();if(i&&o){let a=this.draw_palette;a.fX2NDC=o.fX2NDC+.01+(a.fX2NDC-a.fX1NDC),a.fX1NDC=o.fX2NDC+.01,a.fY1NDC=o.fY1NDC,a.fY2NDC=o.fY2NDC}return e?(e.Enabled=!0,e.drawPave("")):Z.draw(this.getPadPainter(),this.draw_palette).then(a=>{e=a,e.setSecondaryId(this),e.redraw=function(){}})})}toggleColz(){if(this.getObject()?.fPalette){let t=this.getOptions();return t.Zscale=!t.Zscale,this.drawColorPalette(t.Zscale,!0)}}redraw(){return this.drawImage()}clickButton(t){return this.isMainPainter()&&t==="ToggleColorZ"?this.toggleColz():!1}fillToolbar(){let t=this.getPadPainter();t&&this.getObject()?.fPalette&&(t.addPadButton("th2colorz","Toggle color palette","ToggleColorZ"),t.showPadButtons())}static draw(t,i,e){return d(this,null,function*(){let o=new X(t,i,e);return o.setAsMainPainter(),o.decodeOptions(e),T(o,!1).then(()=>o.drawImage()).then(()=>(o.fillToolbar(),o))})}};export{F as TASImagePainter};
