import{h as D,i as C,k as K,p as X,s as Y,t as j}from"./chunk-MFPRCIVI.js";import{a as G,b as N,c as A,d as w,j as $}from"./chunk-SVHROGNI.js";import{e as _,ja as R,pa as U,ra as k,sa as M,ta as W}from"./chunk-DLJYFRIS.js";import{A as y,C as P,Ga as S,J as F,d as z,f,g as T,lb as v,q as L,t as O,u as x,x as b}from"./chunk-MAT3H5WR.js";import{k as u}from"./chunk-KYPE3LET.js";var J=b(15),H=b(17),ee=b(18),V=b(19),q=b(23);function Z(h,e,t){let s=new D(h,e);return s.addToPadPrimitives(),t==="3d"&&(s.mode3d=!0),s.redraw()}var I=class h extends j{#e;#s;#t;#i;#r;#n;constructor(e,t,s,i=!0){super(e,t,s,i),this.#e=null,this.tooltip_allowed=O.Tooltip}cleanup(){this.#s&&this.setLayoutKind("simple"),this.#s=void 0,super.cleanup()}getCanvasName(){return this.getObjectName()}getLayoutKind(){let e=this.selectDom("origin");return(e.empty()?"":e.property("layout"))||"simple"}setLayoutKind(e,t){let s=this.selectDom("origin");s.empty()||(e||(e="simple"),s.property("layout",e),s.property("layout_selector",e!=="simple"&&t?t:null),this.#s=e!=="simple")}changeLayout(e,t){return u(this,null,function*(){if(this.getLayoutKind()===e)return!0;let i=this.selectDom("origin"),n=i.select(".side_panel2"),r=[],a=i.select(".side_panel"),o=this.selectDom(),l;for(;o.node().firstChild;)r.push(o.node().removeChild(o.node().firstChild));if(a.empty()||M(a.node()),n.empty()||M(n.node()),this.setLayoutKind("simple"),i.html(""),e==="simple"){o=i;for(let c=0;c<r.length;++c)o.node().appendChild(r[c]);this.setLayoutKind(e),l=!0}else{let c=new K(i.node(),e);t===void 0&&(t=e.indexOf("vert")===0?0:1),o=_(c.getGridFrame(t)),o.classed("central_panel",!0).style("position","relative"),t===2?(a=_(c.getGridFrame(0)),a.classed("side_panel2",!0).style("position","relative"),a=_(c.getGridFrame(3)),a.classed("side_panel",!0).style("position","relative")):(a=_(c.getGridFrame(1-t)),a.classed("side_panel",!0).style("position","relative"));for(let g=0;g<r.length;++g)o.node().appendChild(r[g]);this.setLayoutKind(e,".central_panel"),i.property("mdi",null)}return k(o.node(),l),!0})}toggleProjection(e){return u(this,null,function*(){if(delete this.proj_painter,e&&(this.proj_painter={X:!1,Y:!1}),f(this.showUI5ProjectionArea))return this.showUI5ProjectionArea(e);let t="simple",s;switch(e){case"XY":t="projxy",s=2;break;case"X":case"bottom":t="vert2_31",s=0;break;case"Y":case"left":t="horiz2_13",s=1;break;case"top":t="vert2_13",s=1;break;case"right":t="horiz2_31",s=0;break}return this.changeLayout(t,s)})}drawProjection(e,t,s){return u(this,null,function*(){if(!this.proj_painter)return!1;if(s===void 0&&(s="hist"),e||(e="X"),this.proj_painter[e]){if(T(this.proj_painter[e]))return console.log("Not ready with first painting",e),!0}else{this.proj_painter[e]="init";let i=v(S),n=this.getRootPad(),r=this.getFramePainter(),a;return e==="X"?(i.fLeftMargin=n.fLeftMargin,i.fRightMargin=n.fRightMargin,i.fLogx=r.logx,i.fUxmin=r.logx?Math.log10(r.scale_xmin):r.scale_xmin,i.fUxmax=r.logx?Math.log10(r.scale_xmax):r.scale_xmax,a="fixframe"):e==="Y"&&(i.fBottomMargin=n.fBottomMargin,i.fTopMargin=n.fTopMargin,i.fLogx=r.logy,i.fUxmin=r.logy?Math.log10(r.scale_ymin):r.scale_ymin,i.fUxmax=r.logy?Math.log10(r.scale_ymax):r.scale_ymax,a="rotate"),i.fPrimitives.Add(t,s),(f(this.drawInUI5ProjectionArea)?this.drawInUI5ProjectionArea(i,a,e):this.drawInSidePanel(i,a,e)).then(l=>(this.proj_painter[e]=l,l))}return this.proj_painter[e].getMainPainter()?.updateObject(t,s),this.proj_painter[e].redrawPad()})}testUI5(){return this.use_openui??!1}drawInSidePanel(e,t,s){return u(this,null,function*(){let i=this.getLayoutKind()==="projxy"&&s==="Y"?".side_panel2":".side_panel",n=this.selectDom("origin").select(i);return n.empty()?null:this.drawObject(n.node(),e,t)})}showMessage(e){this.testUI5()||G(e,7e3)}saveCanvasAsFile(e){let t=e.indexOf(".");this.createImage(e.slice(t+1)).then(s=>this.sendWebsocket(`SAVE:${e}:${s}`))}sendSaveCommand(e){this.sendWebsocket("PRODUCE:"+e)}submitMenuRequest(e,t,s){return u(this,null,function*(){return new Promise(i=>{this.#t=i,this.sendWebsocket("GETMENU:"+s)})})}submitExec(e,t,s){if(!(this.isReadonly()||!e)&&(s||(s=e.getSnapId()),s&&T(s)&&t))return this.sendWebsocket(`OBJEXEC:${s}:${t}`)}getWebsocket(){return this.#e}canSendWebsocket(e=1){return this.#e?.canSend(e)}sendWebsocket(e){return this.#e?.canSend()?(this.#e.send(e),!0):(console.warn(`DROP SEND: ${e}`),!1)}closeWebsocket(e){this.#e&&(this.#e.close(e),this.#e.cleanup(),this.#e=void 0)}useWebsocket(e){this.closeWebsocket(),this.#e=e,this.#e.setReceiver(this),this.#e.connect()}websocketTimeout(e,t){if(!this.#e)return;this.#e._tmouts||(this.#e._tmouts={});let s=this.#e._tmouts[e];if(t===void 0)return s!==void 0;t==="reset"?s&&(clearTimeout(s),delete this.#e._tmouts[e]):!s&&Number.isInteger(t)&&(this.#e._tmouts[e]=setTimeout(()=>{delete this.#e._tmouts[e]},t))}onWebsocketOpened(){}onWebsocketClosed(){this.embed_canvas||N()}onWebsocketMsg(e,t){if(t==="CLOSE")this.onWebsocketClosed(),this.closeWebsocket(!0);else if(t.slice(0,6)==="SNAP6:"){let s=t.indexOf(":",6),i=t.slice(6,s),n=y(t.slice(s+1));this.syncDraw(!0).then(()=>{this.getSnapId()||this.resizeBrowser(n.fSnapshot.fWindowWidth,n.fSnapshot.fWindowHeight),!this.getSnapId()&&f(this.setFixedCanvasSize)&&(this.#i=this.setFixedCanvasSize(n.fSnapshot.fCw,n.fSnapshot.fCh,n.fFixedSize))}).then(()=>this.redrawPadSnap(n)).then(()=>{this.completeCanvasSnapDrawing();let r=this.getWebPadOptions();r&&(r=":"+r),e.send(`READY6:${i}${r}`),this.confirmDraw()}).catch(r=>{f(this.showConsoleError)?this.showConsoleError(r):console.log(r)})}else if(t.slice(0,5)==="MENU:"){let s=y(t.slice(5));f(this.#t)&&(this.#t(s),this.#t=void 0)}else if(t.slice(0,4)==="CMD:"){t=t.slice(4);let s=t.indexOf(":"),i=t.slice(0,s),n=t.slice(s+1),r=`REPLY:${i}:`;n==="SVG"||n==="PNG"||n==="JPEG"||n==="WEBP"||n==="PDF"?this.createImage(n.toLowerCase()).then(a=>e.send(r+a)):(console.log(`Unrecognized command ${n}`),e.send(r))}else if(t.slice(0,7)==="DXPROJ:"||t.slice(0,7)==="DYPROJ:"){let s=t[1],i=y(t.slice(7));this.websocketTimeout(`proj${s}`,"reset"),this.drawProjection(s,i)}else if(t.slice(0,5)==="CTRL:"){let s=y(t.slice(5))||{},i=!1;if(s.title!==void 0&&typeof document<"u"&&(document.title=s.title),s.x&&s.y&&typeof window<"u"&&(window.moveTo(s.x,s.y),i=!0),s.w&&s.h&&(this.resizeBrowser(Number.parseInt(s.w),Number.parseInt(s.h)),i=!0),s.cw&&s.ch&&f(this.setFixedCanvasSize)&&(this.#i=this.setFixedCanvasSize(Number.parseInt(s.cw),Number.parseInt(s.ch),!0),i=!0),["Menu","StatusBar","Editor","ToolBar","ToolTips"].forEach(r=>{s[r]!==void 0&&this.showSection(r,s[r]==="1")}),s.edit){let r=this.findSnap(s.edit);r&&this.showSection("Editor",!0).then(()=>this.producePadEvent("select",r.getPadPainter(),r))}s.winstate&&typeof window<"u"&&(s.winstate==="iconify"?window.blur():window.focus()),i&&this.sendResized(!0)}else console.log(`unrecognized msg ${t}`)}sendResized(e){let t=this.getRootPad();if(!t||typeof window>"u")return;let s=this.getPadWidth(),i=this.getPadHeight(),n=window.screenLeft,r=window.screenTop,a=window.outerWidth,o=window.outerHeight,l=this.#i?1:0;e||(e=s>0&&i>0&&(t.fCw!==s||t.fCh!==i),e&&(t.fCw=s,t.fCh=i)),e&&this.sendWebsocket(`RESIZED:${JSON.stringify([n,r,a,o,s,i,l])}`)}clickPadButton(e,t){return e==="ToggleGed"?this.activateGed(this,null,"toggle"):e==="ToggleStatus"?this.activateStatusBar("toggle"):super.clickPadButton(e,t)}hasEventStatus(){return this.testUI5()?!1:this.brlayout?this.brlayout.hasStatus():C()?.hasStatusLine()??!1}canStatusBar(){return this.testUI5()||this.brlayout||C()}activateStatusBar(e){this.testUI5()||(this.brlayout?this.brlayout.createStatusLine(23,e):C()?.createStatusLine(23,e),this.processChanges("sbits",this))}showCanvasStatus(...e){if(this.testUI5())return;(this.brlayout||C()?.brlayout)?.showStatus(...e)}hasGed(){return this.testUI5()?!1:this.brlayout?.hasContent()??!1}removeGed(){this.testUI5()||(this.registerForPadEvents(null),this.ged_view&&(this.ged_view.getController().cleanupGed(),this.ged_view.destroy(),delete this.ged_view),this.brlayout?.deleteContent(!0),this.processChanges("sbits",this))}getUi5PanelData(){return{jsroot:{settings:O,create:v,parse:y,toJSON:P,loadScript:F,EAxisBits:W,getColorExec:$}}}activateGed(e,t,s){return u(this,null,function*(){if(this.testUI5()||!this.brlayout)return!1;if(this.brlayout.hasContent())return s==="toggle"||s===!1?this.removeGed():e?.getPadPainter()?.selectObjectPainter(e),!0;if(s===!1)return!1;let i=this.brlayout.createBrowserBtns();return w.createSVG(i,w.diamand,15,"toggle fix-pos mode","browser").style("margin","3px").on("click",()=>this.brlayout.toggleKind("fix")),w.createSVG(i,w.circle,15,"toggle float mode","browser").style("margin","3px").on("click",()=>this.brlayout.toggleKind("float")),w.createSVG(i,w.cross,15,"delete GED","browser").style("margin","3px").on("click",()=>this.removeGed()),this.brlayout.setBrowserContent("<div class='jsroot_browser_hierarchy' id='ged_placeholder'>Loading GED ...</div>"),this.brlayout.setBrowserTitle("GED"),this.brlayout.toggleBrowserKind(t||"float"),new Promise(n=>{A().then(r=>{_("#ged_placeholder").text(""),r.ui.require(["sap/ui/model/json/JSONModel","sap/ui/core/mvc/XMLView"],(a,o)=>{let l=new a({handle:null});o.create({viewName:"rootui5.canv.view.Ged",viewData:this.getUi5PanelData("Ged")}).then(c=>{c.setModel(l),c.placeAt("ged_placeholder"),this.ged_view=c,this.registerForPadEvents(c.getController().padEventsReceiver.bind(c.getController())),e?.getPadPainter()?.selectObjectPainter(e),this.processChanges("sbits",this),n(!0)})})})})})}showSection(e,t){return u(this,null,function*(){if(this.testUI5())return!1;switch(e){case"Menu":break;case"StatusBar":this.activateStatusBar(t);break;case"Editor":return this.activateGed(this,null,t);case"ToolBar":break;case"ToolTips":this.setTooltipAllowed(t);break}return!0})}startFitPanel(e){if(!this.getWebsocket())return!1;let t=e?null:this.getWebsocket().createChannel();return this.sendWebsocket("FITPANEL:"+(e?"standalone":t.getChannelId())),t}completeCanvasSnapDrawing(){let e=this.getRootPad();e&&(this.addPadInteractive(),typeof document<"u"&&!this.embed_canvas&&this.getWebsocket()&&(document.title=e.fTitle),!this.#r&&(this.#r=!0,this._ignore_section_resize=!0,this.showSection("Menu",e.TestBit(H)),this.showSection("StatusBar",e.TestBit(J)),this.showSection("ToolBar",e.TestBit(ee)),this.showSection("Editor",e.TestBit(V)),this.showSection("ToolTips",e.TestBit(q)||this._highlight_connect),this._ignore_section_resize=!1))}processHighlightConnect(e){if(!e?.length||!this._highlight_connect||this.doingDraw()||!this.canSendWebsocket(2))return;let t=e[0]||e[1];if(!t||!t.painter?.getSnapId()||!t.user_info)return;let s=t.painter.getPadPainter()||this;if(!s.getSnapId())return;let i=[s.getSnapId(),t.painter.getSnapId(),"0","0"];t.user_info.binx!==void 0&&t.user_info.biny!==void 0?(i[2]=t.user_info.binx.toString(),i[3]=t.user_info.biny.toString()):t.user_info.bin!==void 0&&(i[2]=t.user_info.bin.toString());let n=JSON.stringify(i);this.#n!==n&&(this.#n=n,this.sendWebsocket(`HIGHLIGHT:${n}`))}processChanges(e,t,s){if(this.isReadonly()||!this.canSendWebsocket(2)||!T(e))return;let i="";switch(t||(t=this),e){case"sbits":i="STATUSBITS:"+this.getStatusBits();break;case"frame":case"zoom":f(t.getWebPadOptions)||(t=t.getPadPainter()),f(t.getWebPadOptions)&&(i="OPTIONS6:"+t.getWebPadOptions("only_this"));break;case"padpos":i="OPTIONS6:"+t.getWebPadOptions("with_subpads");break;case"drawopt":t.getSnapId()&&(i="DRAWOPT:"+JSON.stringify([t.getSnapId(),t.getDrawOpt()||""]));break;case"pave_moved":{let n=Y(t);n&&(i="PRIMIT6:"+P(n));break}case"logx":case"logy":case"logz":{let n=t.getPadPainter(),r=n?.getRootPad();if(n?.getSnapId()&&r){let a="SetLog"+e[3],o=r["fLog"+e[3]];t=n,e=`exec:${a}(${o})`}break}}if(!i&&f(t?.getSnapId)&&e.slice(0,5)==="exec:"){let n=t.getSnapId(s);n&&(i="PRIMIT6:"+P({_typename:"TWebObjectOptions",snapid:n,opt:e.slice(5),fcust:"exec",fopt:[]}))}i?this.sendWebsocket(i):console.log(`Unprocessed changes ${e} for painter of ${t?.getObject()?._typename} subelem ${s}`)}selectActivePad(e,t,s){if(!this.getSnapId()||!e)return;let i=null,n=!1,r=e.matchObjectType(X);e.getSnapId()&&this.getWebsocket()&&(i={_typename:"TWebPadClick",padid:e.getSnapId(),objid:"",x:-1,y:-1,dbl:!1}),!e.is_active_pad&&!r&&(n=!0,this.forEachPainterInPad(a=>a.drawActiveBorder(null,a===e),"pads")),t?.hasSnapId()&&i&&(n=!0,i.objid=t.getSnapId()),s&&i&&(n=!0,i.x=Math.round(s.x||0),i.y=Math.round(s.y||0),s.dbl&&(i.dbl=!0)),i&&(n||r)&&this.sendWebsocket("PADCLICKED:"+P(i))}getStatusBits(){let e=0;return this.hasEventStatus()&&(e|=J),this.hasGed()&&(e|=V),this.isTooltipAllowed()&&(e|=q),this.use_openui&&(e|=H),e}produceJSON(e){let t=this.getObject();if(t._typename!==S)return;let s=t.fFillStyle===0,i=[],n=[],r=[];s&&(t.fFillStyle=1001),this.forEachPainterInPad(o=>{let l=o.getRootPad(!0);o.getNumPainters()&&l?.fPrimitives&&!l.fPrimitives.arr.length&&(r.push(l.fPrimitives),o.forEachPainterInPad(m=>{if(m.isSecondary())return;let d=m.getObject();d?._typename&&l.fPrimitives.Add(d,m.getDrawOpt())},"objects"));let c=o.getMainPainter(),g=o.getFramePainter();if(!f(c?.getHisto)||!f(c?.getDimension))return;let p=c.getHisto(),B=c.getDimension();if(!p?.fXaxis)return;let E=(m,d)=>{g?.zoomChangedInteractive(m)&&(i.push({axis:d,f:d.fFirst,l:d.fLast,b:d.fBits}),d.fFirst=c.getSelectIndex(m,"left",1),d.fLast=c.getSelectIndex(m,"right"),d.SetBit(W.kAxisRange,d.fFirst>0||d.fLast<d.fNbins))};E("x",p.fXaxis),B>1&&E("y",p.fYaxis),B>2&&E("z",p.fZaxis),B===2&&g?.zoomChangedInteractive("z")&&(n.push({hist:p,min:p.fMinimum,max:p.fMaximum}),p.fMinimum=g.zoom_zmin??g.zmin,p.fMaximum=g.zoom_zmax??g.zmax)},"pads");let a=P(t,e);return s&&(t.fFillStyle=0),i.forEach(o=>{o.axis.fFirst=o.f,o.axis.fLast=o.l,o.axis.fBits=o.b}),n.forEach(o=>{o.hist.fMinimum=o.min,o.hist.fMaximum=o.max}),r.forEach(o=>o.Clear()),a}resizeBrowser(e,t){!e||!t||this.isBatchMode()||this.embed_canvas||this.batch_mode||(L.qt6&&e>100&&t>60&&(e-=3,t-=30),this.getWebsocket()?.resizeWindow(e,t))}static draw(e,t,s){return u(this,null,function*(){let i=!t;i&&(t=v(S));let n=new h(e,t,s,i?"auto":!0);if(n.checkSpecialsInPrimitives(t,!0),!i&&t.fCw&&t.fCh){let r=n.selectDom(),a;if(n.isBatchMode()){let o=r.property("_batch_use_canvsize");a=o||o===void 0}else{let o=r.node().getBoundingClientRect();a=!o.height&&o.width>.1*t.fCw}a&&(r.style("width",t.fCw+"px").style("height",t.fCh+"px").attr("width",t.fCw).attr("height",t.fCh),n._setFixedSize(!0))}return n.createCanvasSvg(0),n.addPadButtons(),i&&s.indexOf("noframe")<0&&Z(n,null),U({pp:n,active:!0}),n.drawPrimitives().then(()=>(n.addPadInteractive(),n.showPadButtons(),n))})}};function Q(h,e){return u(this,null,function*(){if(!h)return Promise.reject(Error("Painter not provided in ensureTCanvas"));let t=e===!1||e==="3d"?"noframe":"",s=()=>{if(t!=="noframe"||!f(h.getUserRanges))return null;let r=h.getUserRanges();if(!r)return null;let a=v(S),o=r.maxx-r.minx||1,l=r.maxy-r.miny||1;return a.fX1=r.minx-o*x.fPadLeftMargin,a.fX2=r.maxx+o*x.fPadRightMargin,a.fY1=r.miny-l*x.fPadBottomMargin,a.fY2=r.maxy+l*x.fPadTopMargin,a},i=h.getPadPainter()||R(h.selectDom());return(i?Promise.resolve(i):I.draw(h.getDom(),s(),t)).then(r=>(e!==!1&&r.getFrameSvg().selectChild(".main_layer").empty()&&!r.getFramePainter()&&Z(r,null,e),h.addToPadPrimitives(r),h))})}function ce(h,e,t){return u(this,null,function*(){let s=v(S),i=new I(h,s,t);return i.addPadButtons(),i.syncDraw(!0).then(()=>i.redrawPadSnap(e)).then(()=>(i.confirmDraw(),i.showPadButtons(),i))})}function le(h,e,t){return u(this,null,function*(){let s=new D(h,e);return s.mode3d=t==="3d",Q(s,!1).then(()=>s.redraw())})}Object.assign(z.jsroot,{ensureTCanvas:Q,TPadPainter:j,TCanvasPainter:I});export{I as a,Q as b,ce as c,le as d};
