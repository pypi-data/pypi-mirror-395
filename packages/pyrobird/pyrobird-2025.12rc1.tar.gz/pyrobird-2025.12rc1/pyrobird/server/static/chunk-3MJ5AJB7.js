import{a as Le,c as Je}from"./chunk-STN7OMLL.js";import{a as Ce,b as Ue,c as We,d as Ke,e as qe}from"./chunk-HB357Z3Y.js";import{a as _e}from"./chunk-OI5V6APH.js";import{a as x,b as Oe,d as ne,e as Ee,f as He,g as Ve,h as $e,i as Ne,j as Ze,k as Ge,l as Ye,m as ye,n as ee,o as xe,r as Xe}from"./chunk-S3FA7C5I.js";import{b as Re}from"./chunk-DLJYFRIS.js";import{f as ae,n as Ae,s as Me,t as Ie,v as pe}from"./chunk-MAT3H5WR.js";import{k as je}from"./chunk-KYPE3LET.js";function et(e,r,t=!1,a=!1){let i;if(r?.children)for(let h=0;h<r.children.length&&(i=r.children[h],!i.axis_draw);++h)i=void 0;if(!i)return;if(!e){r.remove(i);return}let n=e.position,d=1;n.x<0&&n.y>=0?d=2:n.x>=0&&n.y>=0?d=3:n.x>=0&&n.y<0&&(d=4);let m=(h,_)=>(h<=d&&(h+=4),h>d&&h<d+_),s=h=>{for(let _=0;_<h.children?.length;++_)h.children[_].zoom!==void 0&&(h.children[_].zoom_disabled=!h.visible)};for(let h=0;h<i.children.length;++h){let _=i.children[h];if(_.grid)_.visible=a&&m(_.grid,3);else if(_.zid)_.visible=m(_.zid,2),s(_);else if(_.xyid)_.visible=m(_.xyid,3),s(_);else if(_.xyboxid){let B=5,z=0;a&&!t?(B=3,z=-2):t&&!a?B=3:!t&&!a&&(B=_.bottom?3:0),_.visible=m(_.xyboxid+z,B),!_.visible&&_.bottom&&a&&(_.visible=m(_.xyboxid,3))}else if(_.zboxid){let B=2,z=0;t&&a?B=5:a&&!t?B=4:!a&&t&&(z=-2,B=4),_.visible=m(_.zboxid+z,B)}}}function Pe(e,r,t,a){if(e.options.System===Ce)return r;let i=e.getFramePainter(),n=1/i.size_x3d,d=1/i.size_y3d;if(t&&a&&(n*=t/(t-1),d*=a/(a-1)),e.options.System===Ue)for(let m=0;m<r.length;m+=3){let s=(1-r[m]*n)*Math.PI,h=.5+.5*r[m+1]*d;r[m]=Math.cos(s)*h*i.size_x3d,r[m+1]=Math.sin(s)*h*i.size_y3d}else if(e.options.System===We)for(let m=0;m<r.length;m+=3){let s=(1-r[m]*n)*Math.PI,h=.5+r[m+2]/i.size_z3d/4;r[m]=Math.cos(s)*h*i.size_x3d,r[m+2]=(1+Math.sin(s)*h)*i.size_z3d}else if(e.options.System===Ke)for(let m=0;m<r.length;m+=3){let s=(1+r[m]*n)*Math.PI,h=r[m+1]*d*Math.PI,_=.5+r[m+2]/i.size_z3d/4;r[m]=_*Math.cos(h)*Math.cos(s)*i.size_x3d,r[m+1]=_*Math.cos(h)*Math.sin(s)*i.size_y3d,r[m+2]=(1+_*Math.sin(h))*i.size_z3d}else if(e.options.System===qe)for(let m=0;m<r.length;m+=3){let s=(1-r[m]*n)*Math.PI,h=r[m+1]*d*Math.PI,_=.5+r[m+2]/i.size_z3d/4;r[m]=_*Math.cos(s)*i.size_x3d,r[m+1]=_*Math.sin(h)/Math.cos(h)*i.size_y3d/2,r[m+2]=(1+_*Math.sin(s))*i.size_z3d}return r}function Be(e,r,t,a,i){let n=new x.BufferGeometry;return e.options.System===Ce?(n.setAttribute("position",new x.BufferAttribute(r,3)),t?n.setAttribute("normal",new x.BufferAttribute(t,3)):n.computeVertexNormals()):(Pe(e,r,a,i),n.setAttribute("position",new x.BufferAttribute(r,3)),n.computeVertexNormals()),n}function tt(e,r){e.camera&&(e.scene.remove(e.camera),ye(e.camera),delete e.camera),r?e.camera=new x.OrthographicCamera(-1.3*e.size_x3d,1.3*e.size_x3d,2.3*e.size_z3d,-.7*e.size_z3d,.001,40*e.size_z3d):e.camera=new x.PerspectiveCamera(45,e.scene_width/e.scene_height,1,40*e.size_z3d),e.camera.up.set(0,0,1),e.pointLight=new x.DirectionalLight(16777215,3),e.pointLight.position.set(e.size_x3d/2,e.size_y3d/2,e.size_z3d/2),e.camera.add(e.pointLight),e.lookat=new x.Vector3(0,0,r?.3*e.size_z3d:.8*e.size_z3d),e.scene.add(e.camera)}function it(e,r){let t=e.getPadPainter()?.getRootPad(!0),a=e.camera.isOrthographicCamera?1:1.4,i=Math.max(.75*e.size_x3d,e.size_z3d),n=Math.max(.75*e.size_y3d,e.size_z3d),d=null;if(r&&(d=new x.Vector3,i===n?d.set(-1.6*i,-3.5*n,a*e.size_z3d):i>n?d.set(-2*i,-3.5*n,a*e.size_z3d):d.set(-3.5*i,-2*n,a*e.size_z3d)),t&&(r||!e.zoomChangedInteractive())&&Number.isFinite(t.fTheta)&&Number.isFinite(t.fPhi)&&(t.fTheta!==e.camera_Theta||t.fPhi!==e.camera_Phi)){d||(d=new x.Vector3),i=3*Math.max(e.size_x3d,e.size_z3d),n=3*Math.max(e.size_y3d,e.size_z3d);let m=(270-t.fPhi)/180*Math.PI,s=(t.fTheta-10)/180*Math.PI;d.set(i*Math.cos(m)*Math.cos(s),n*Math.sin(m)*Math.cos(s),e.size_z3d+(a-.9)*(i+n)*Math.sin(s))}return d}function Se(e,r){let t=it(e,r);if(t&&(e.camera.position.copy(t),r=!0),r&&e.camera.lookAt(e.lookat),r&&e.camera.isOrthographicCamera&&e.scene_width&&e.scene_height){let a=e.scene_width/e.scene_height,i=e.camera.right-e.camera.left,n=e.camera.top-e.camera.bottom;if(a>i/n){let d=(e.camera.right+e.camera.left)/2;e.camera.left=d-n*a/2,e.camera.right=d+n*a/2}else{let d=(e.camera.top+e.camera.bottom)/2;e.camera.top=d+i/a/2,e.camera.bottom=d-i/a/2}}e.camera.updateProjectionMatrix()}function nt(e){let r=e.camera.position,t=e.lookat,a=r.distanceTo(t),i=Math.sqrt((r.x-t.x)**2+(r.y-t.y)**2),n=Math.atan2((r.z-t.z)/a,i/a)/Math.PI*180,d=270-Math.atan2((r.y-t.y)/i,(r.x-t.x)/i)/Math.PI*180,m=e.getPadPainter()?.getRootPad(!0);e.camera_Phi=d>=360?d-360:d,e.camera_Theta=n,m&&Number.isFinite(e.camera_Phi)&&Number.isFinite(e.camera_Theta)&&(m.fPhi=e.camera_Phi,m.fTheta=e.camera_Theta)}function st(e){e.control=Ye(e,e.camera,e.scene,e.renderer,e.lookat);let r=e,t=e.getMainPainter();if(e.access3dKind()===Me.Embed3D.Embed){let a=e.getCanvPainter()?.getPadScale();a&&e.control.tooltip?.setScale(a)}e.control.processMouseMove=function(a){let i=null,n=null,d=null,m=r.isTooltipAllowed();for(let s=0;s<a.length;++s)if(m&&ae(a[s].object?.tooltip)){if(i=a[s].object.tooltip(a[s]),i){n=a[s].object;break}}else a[s].object?.zoom&&!d&&(d=a[s].object);if(i&&!i.use_itself){let s=1e-4*r.size_x3d,h=1e-4*r.size_y3d,_=1e-4*r.size_z3d;(i.x1>i.x2||i.y1>i.y2||i.z1>i.z2)&&console.warn("check 3D hints coordinates"),i.x1-=s,i.x2+=s,i.y1-=h,i.y2+=h,i.z1-=_,i.z2+=_}if(r.highlightBin3D(i,n),!i&&d&&ae(r.get3dZoomCoord)){let s=d.zoom,h=d.globalIntersect(this.raycaster),_=r.get3dZoomCoord(h,s);return s==="z"&&d.use_y_for_z&&(s="y"),{name:s,title:"axis object",line:s+" : "+r.axisAsText(s,_),only_status:!0}}return i?.lines?i:""},e.control.processMouseLeave=function(){r.highlightBin3D(null)},e.control.contextMenu=function(a,i){let n="painter",d=t;if(i)for(let s=0;s<i.length;++s){let h=i[s].object;if(h.zoom){n=h.zoom,d=null;break}if(ae(h.painter?.fillContextMenu)){d=h.painter;break}}let m=t.getFramePainter();ae(m?.showContextMenu)&&m.showContextMenu(n,a,d)}}function ot(e,r,t,a){if(e===-1){if(!this.mode3d)return;if(!ae(this.clear3dCanvas)){console.error(`Strange, why mode3d=${this.mode3d} is configured!`);return}let d=r?this.toplevel:null;return d&&(this.scene?.remove(d),this.toplevel=null),et(null,this.toplevel),this.clear3dCanvas(),ye(this.scene),this.control?.cleanup(),Ne(this.renderer),delete this.size_x3d,delete this.size_y3d,delete this.size_z3d,delete this.tooltip_mesh,delete this.scene,delete this.toplevel,delete this.camera,delete this.pointLight,delete this.renderer,delete this.control,this.render_tmout&&(clearTimeout(this.render_tmout),delete this.render_tmout),this.mode3d=!1,this.getG()&&!r&&this.createFrameG(),d}if(this.mode3d=!0,"toplevel"in this){this.scene.remove(this.toplevel),ye(this.toplevel),delete this.tooltip_mesh,delete this.toplevel,this.control?.hideTooltip();let d=new x.Object3D;return this.scene.add(d),this.toplevel=d,this.resize3D(),Se(this,!1),Promise.resolve(!0)}e=He(e,this.isBatchMode()),Ve(this);let i=this.getSizeFor3d(void 0,e);this.size_z3d=100,this.x3dscale=r||1,this.y3dscale=t||1;let n=i.height>10&&i.width>10?Math.round(i.width/i.height*this.size_z3d):this.size_z3d;return this.size_x3d=n*this.x3dscale,this.size_y3d=n*this.y3dscale,Oe().then(()=>(this.scene=new x.Scene,this.toplevel=new x.Object3D,this.scene.add(this.toplevel),this.scene_width=i.width,this.scene_height=i.height,this.scene_x=i.x??0,this.scene_y=i.y??0,this.camera_Phi=30,this.camera_Theta=30,tt(this,a),Se(this,!0),$e(this.scene_width,this.scene_height,e))).then(d=>(this.renderer=d,d?(this.webgl=d.jsroot_render3d===Me.Render3D.WebGL,this.add3dCanvas(i,d.jsroot_dom,this.webgl),this.first_render_tm=0,this.enable_highlight=!1,!this.isBatchMode()&&this.webgl&&!Ae()&&st(this),this):this))}function rt(e){let r=!1;this.control&&(this.control.cleanup(),delete this.control,r=!0),tt(this,e),Se(this,!0),r&&st(this),this.render3D()}function at(e,r,t){if(e){if(!this.toplevel)return console.error("3D objects are not yet created in the frame");r&&t&&this.remove3DMeshes(r),this.toplevel.add(e),e.painter=r}}function ht(e){let r=[];if(!e||!this.toplevel)return r;for(let t=0;t<this.toplevel.children.length;++t){let a=this.toplevel.children[t];a.painter===e&&r.push(a)}return r}function lt(e){this.get3DMeshes(e).forEach(t=>{this.toplevel.remove(t),ye(t)})}function dt(e){if(e===-1111){let i=pe(),n=Ee(!1,0,i);if(n.setSize(this.scene_width,this.scene_height),n.render(this.scene,this.camera),n.makeOuterHTML){let d=i.createElement("div");return d.innerHTML=n.makeOuterHTML(),d.childNodes[0]}return n.domElement}e===void 0&&(e=5);let r=this.isBatchMode();if(e>0&&!this.usesvg&&!r){this.render_tmout||(this.render_tmout=setTimeout(()=>this.render3D(0),e));return}if(this.render_tmout&&(clearTimeout(this.render_tmout),delete this.render_tmout),!this.renderer)return;Ze(this.renderer);let t=new Date;et(this.camera,this.toplevel,this.opt3d?.FrontBox,this.opt3d?.BackBox),this.renderer.render(this.scene,this.camera),Ge(this.renderer);let a=new Date;this.first_render_tm===0?(this.first_render_tm=a.getTime()-t.getTime(),this.enable_highlight=this.first_render_tm<1200&&this.isTooltipAllowed(),this.first_render_tm>500&&console.log(`three.js r${x.REVISION}, first render tm = ${this.first_render_tm}`)):nt(this),this.processRender3D&&this.forEachPainter(i=>{ae(i.handleRender3D)&&i.handleRender3D()},"objects")}function ct(){return this.renderer}function mt(){let e=this.getSizeFor3d(this.access3dKind());if(this.apply3dSize(e),this.scene_width===e.width&&this.scene_height===e.height||e.width<10||e.height<10)return!1;this.scene_width=e.width,this.scene_height=e.height,this.camera.aspect=this.scene_width/this.scene_height,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.scene_width,this.scene_height);let r=e.height>10&&e.width>10?Math.round(e.width/e.height*this.size_z3d):this.size_z3d,t=r*this.x3dscale,a=r*this.y3dscale;return Math.abs(t-this.size_x3d)>.15*this.size_z3d||Math.abs(a-this.size_y3d)>.15*this.size_z3d?(this.size_x3d=t,this.size_y3d=a,this.control?.position0?.copy(it(this,!0)),1):!0}function xt(e,r){let t=!e||e.x1===void 0||!this.enable_highlight,a=!1,i=null,n=!0,d=this.getMainPainter();if((!d?.provideUserTooltip||!d?.hasUserTooltip())&&(d=null),this.tooltip_selfmesh&&(n=this.tooltip_selfmesh!==r,this.tooltip_selfmesh.material.color=this.tooltip_selfmesh.save_color,delete this.tooltip_selfmesh,a=!0),this.tooltip_mesh&&(i=this.tooltip_mesh,this.toplevel.remove(this.tooltip_mesh),delete this.tooltip_mesh,a=!0),t){a&&(this.render3D(),d?.provideUserTooltip(null));return}if(e.use_itself)r.save_color=r.material.color,r.material.color=new x.Color(e.color),this.tooltip_selfmesh=r,a=n;else{a=!0;let m=xe.Indexes,s=xe.Normals,h=xe.Vertices,_=new x.Color(e.color?e.color:16711680),B=e.opacity||1,z,p;if(i)z=i.geometry.attributes.position.array,i.geometry.attributes.position.needsUpdate=!0,i.material.color=_,i.material.opacity=B;else{z=new Float32Array(m.length*3),p=new Float32Array(m.length*3);let C=new x.BufferGeometry;C.setAttribute("position",new x.BufferAttribute(z,3)),C.setAttribute("normal",new x.BufferAttribute(p,3));let D=new x.MeshBasicMaterial({color:_,opacity:B,vertexColors:!1});i=new x.Mesh(C,D)}e.x1===e.x2&&console.warn(`same tip X ${e.x1} ${e.x2}`),e.y1===e.y2&&console.warn(`same tip Y ${e.y1} ${e.y2}`),e.z1===e.z2&&(e.z2=e.z1+1e-4);for(let C=0,D=-3;C<m.length;++C){let F=h[m[C]];z[C*3]=e.x1+F.x*(e.x2-e.x1),z[C*3+1]=e.y1+F.y*(e.y2-e.y1),z[C*3+2]=e.z1+F.z*(e.z2-e.z1),p&&(C%6===0&&(D+=3),p[C*3]=s[D],p[C*3+1]=s[D+1],p[C*3+2]=s[D+2])}this.tooltip_mesh=i,this.toplevel.add(i),e.$painter&&e.$painter.options.System!==Ce&&(Pe(e.$painter,z),i.geometry.computeVertexNormals())}a&&this.render3D(),a&&e.$projection&&ae(e.$painter?.redrawProjection)&&e.$painter.redrawProjection(e.ix-1,e.ix,e.iy-1,e.iy),a&&d?.getObject()&&d.provideUserTooltip({obj:d.getObject(),name:d.getObject().fName,bin:e.bin,cont:e.value,binx:e.ix,biny:e.iy,binz:e.iz,grx:(e.x1+e.x2)/2,gry:(e.y1+e.y2)/2,grz:(e.z1+e.z2)/2})}function ft(e){this.opt3d=e}function gt(e,r,t){t||(t={ndim:2}),t.drawany===!1?t.draw=!1:t.drawany=!0;let a=t.v7?null:this.getPadPainter()?.getRootPad(!0),i=-this.size_x3d,n=this.size_x3d,d=-this.size_y3d,m=this.size_y3d,s=0,h=2*this.size_z3d,_=this.size_z3d,B=this.xmin,z=this.xmax,p=this.ymin,C=this.ymax,D=this.zmin,F=this.zmax,A=!1,N=!1;this.size_z3d||(i=this.xmin,n=this.xmax,d=this.ymin,m=this.ymax,s=this.zmin,h=this.zmax,_=h-s),"zoom_xmin"in this&&"zoom_xmax"in this&&this.zoom_xmin!==this.zoom_xmax&&(B=this.zoom_xmin,z=this.zoom_xmax),"zoom_ymin"in this&&"zoom_ymax"in this&&this.zoom_ymin!==this.zoom_ymax&&(p=this.zoom_ymin,C=this.zoom_ymax,A=!0),"zoom_zmin"in this&&"zoom_zmax"in this&&this.zoom_zmin!==this.zoom_zmax&&(D=this.zoom_zmin,F=this.zoom_zmax,N=!0),t.use_y_for_z&&(this.zmin=this.ymin,this.zmax=this.ymax,D=p,F=C,N=A,p=0,C=1),this.lego_zmin=D,this.lego_zmax=F,t.zmult!==void 0&&!N&&(F*=t.zmult),this.x_handle=new r(null,this.xaxis),t.v7?(this.x_handle.setPadPainter(this.getPadPainter()),this.x_handle.assignSnapId(this.getSnapId())):t.hist_painter&&this.x_handle.setHistPainter(t.hist_painter,"x"),this.x_handle.configureAxis("xaxis",this.xmin,this.xmax,B,z,!1,[i,n],{log:a?.fLogx??0,reverse:t.reverse_x,logcheckmin:!0}),this.x_handle.assignFrameMembers(this,"x"),this.x_handle.extractDrawAttributes(_),this.y_handle=new r(null,this.yaxis),t.v7?(this.y_handle.setPadPainter(this.getPadPainter()),this.y_handle.assignSnapId(this.getSnapId())):t.hist_painter&&this.y_handle.setHistPainter(t.hist_painter,"y"),this.y_handle.configureAxis("yaxis",this.ymin,this.ymax,p,C,!1,[d,m],{log:a&&!t.use_y_for_z?a.fLogy:0,reverse:t.reverse_y,logcheckmin:t.ndim>1}),this.y_handle.assignFrameMembers(this,"y"),this.y_handle.extractDrawAttributes(_),this.z_handle=new r(null,this.zaxis),t.v7?(this.z_handle.setPadPainter(this.getPadPainter()),this.z_handle.assignSnapId(this.getSnapId())):t.hist_painter&&this.z_handle.setHistPainter(t.hist_painter,"z"),this.z_handle.configureAxis("zaxis",this.zmin,this.zmax,D,F,!1,[s,h],{value_axis:t.ndim===1||t.ndim===2,log:(t.use_y_for_z||t.ndim===2?a?.fLogv:void 0)??a?.fLogz??0,reverse:t.reverse_z,logcheckmin:t.ndim>2}),this.z_handle.assignFrameMembers(this,"z"),this.z_handle.extractDrawAttributes(_),this.setRootPadRange(a,!0);let E={},v={},w=this.x_handle.createTicks(!1,!0),g=this.y_handle.createTicks(!1,!0),L=this.z_handle.createTicks(!1,!0),y=1;function I(o,l){let c=(l==="ticks"?o.ticksColor:o.lineatt.color)||"black",M=l==="ticks"?o.ticksWidth:o.lineatt.width,f=`${c}_${M}`;return v[f]||(v[f]=new x.LineBasicMaterial(ne(c,{linewidth:M,vertexColors:!1}))),v[f]}function T(o,l,c){let M=c||(l==="title"?o.titleFont?.color:o.labelsFont?.color)||"black";return E[M]||(E[M]=new x.MeshBasicMaterial(ne(M,{vertexColors:!1}))),E[M]}let S=new x.Object3D;S.axis_draw=!0,e.add(S);let H=[],P=[],Z=0,V=0,oe=this.x_handle.isCenteredLabels(),J=this.x_handle.isRotateLabels();for(;w.next();){let o=w.grpos,l=w.kind===1,c=this.x_handle.format(w.tick,2);if(w.last_major()?this.x_handle.fTitle||(c="x"):c===null&&(l=!1,c=""),l&&c&&t.draw&&(!oe||!w.last_major())){let M=w.get_modifier();M?.fLabText&&(c=M.fLabText);let f=_e(this,c,this.x_handle.labelsFont.size);f.computeBoundingBox();let b=f.boundingBox.max.x-f.boundingBox.min.x,k=f.boundingBox.max.y-f.boundingBox.min.y;f.center=!0,f.offsety=this.x_handle.labelsOffset+(m-d)*.005,V=Math.max(V,b),Z=Math.max(Z,k),M?.fTextColor&&(f.color=this.getColor(M.fTextColor)),f.grx=o,P.push(f);let u=0;w.last_major()||(u=Math.abs(w.next_major_grpos()-o),b>0&&u>0&&(y=Math.min(y,.9*u/b))),J&&(f.rotate=1),oe&&(u||(u=Math.min(o-i,n-o)),f.grx+=u/2)}H.push(o,0,0,o,this.x_handle.ticksSize*(l?-1:-.6),0)}if(this.x_handle.fTitle&&t.draw){let o=_e(this,this.x_handle.fTitle,this.x_handle.titleFont.size);o.computeBoundingBox(),o.center=this.x_handle.titleCenter,o.opposite=this.x_handle.titleOpposite,o.offsety=1.6*this.x_handle.titleOffset+(m-d)*.005,o.grx=(i+n)/2,o.kind="title",this.x_handle.isRotateTitle()&&(o.rotate=2),P.push(o)}this.get3dZoomCoord=function(o,l){let c=this[`scale_${l}min`],M=this[`scale_${l}max`],f=o[l];switch(l){case"x":f=(f+this.size_x3d)/2/this.size_x3d;break;case"y":f=(f+this.size_y3d)/2/this.size_y3d;break;case"z":f=f/2/this.size_z3d;break}return this["log"+l]?f=Math.exp(Math.log(c)+f*(Math.log(M)-Math.log(c))):f=c+f*(M-c),f};let W=(o,l,c)=>{let M=new x.BufferGeometry,f=Math.max(this[o+"_handle"].ticksSize,.005*l),b;o==="z"?b=new Float32Array([0,0,0,f*4,0,2*l,f*4,0,0,0,0,0,0,0,2*l,f*4,0,2*l]):b=new Float32Array([-l,0,0,l,-f*4,0,l,0,0,-l,0,0,-l,-f*4,0,l,-f*4,0]),M.setAttribute("position",new x.BufferAttribute(b,3)),M.computeVertexNormals();let k=new x.MeshBasicMaterial({transparent:!0,vertexColors:!1,side:x.DoubleSide,opacity:0}),u=new x.Mesh(M,k);return u.zoom=o,u.size_3d=l,u.tsz=f,u.use_y_for_z=c,o==="y"&&u.rotateZ(Math.PI/2).rotateX(Math.PI),u.v1=new x.Vector3(b[0],b[1],b[2]),u.v2=new x.Vector3(b[6],b[7],b[8]),u.v3=new x.Vector3(b[3],b[4],b[5]),u.globalIntersect=function(q){if(!this.v1||!this.v2||!this.v3)return;let O=new x.Plane;O.setFromCoplanarPoints(this.v1,this.v2,this.v3),O.applyMatrix4(this.matrixWorld);let U=q.ray.origin.clone(),re=U.clone().addScaledVector(q.ray.direction,1e10),j=O.intersectLine(new x.Line3(U,re),new x.Vector3);if(!j)return;let X=-this.size_3d,me=this.size_3d;return this.zoom==="z"&&(X=0,me=2*this.size_3d),j[this.zoom]<X?j[this.zoom]=X:j[this.zoom]>me&&(j[this.zoom]=me),j},u.showSelection=function(q,O){let U=this.children?this.children[0]:null,re;if(!q||!O)return U&&(this.remove(U),ye(U)),U;if(!this.geometry)return!1;if(U)re=U.geometry;else{re=this.geometry.clone();let X=re.getAttribute("position").array;this.zoom==="z"?X[6]=X[3]=X[15]=this.tsz:X[4]=X[16]=X[13]=-this.tsz,U=new x.Mesh(re,new x.MeshBasicMaterial({color:65280,side:x.DoubleSide,vertexColors:!1})),this.add(U)}let j=re.getAttribute("position").array;return this.zoom==="z"?(j[2]=j[11]=j[8]=q[this.zoom],j[5]=j[17]=j[14]=O[this.zoom]):(j[0]=j[9]=j[12]=q[this.zoom],j[6]=j[3]=j[15]=O[this.zoom]),re.getAttribute("position").needsUpdate=!0,!0},u},$=new x.Object3D,de;$.position.set(0,d,s),$.rotation.x=1/4*Math.PI,$.xyid=2,$.painter=this.x_handle,t.draw&&(de=ee(H,I(this.x_handle,"ticks")),$.add(de)),P.forEach(o=>{let l=o.boundingBox.max.x-o.boundingBox.min.x,c=o.boundingBox.max.y-o.boundingBox.min.y,M=o.rotate===1?c:l,f=o.center?o.grx-M/2:o.opposite?i:n-M,b=-y*(o.rotate===1?V:Z)-this.x_handle.ticksSize-o.offsety,k=new x.Matrix4;k.set(y,0,0,f,0,y,0,b,0,0,1,0,0,0,0,1);let u=new x.Mesh(o,T(this.x_handle,o.kind,o.color));o.rotate&&u.rotateZ(o.rotate*Math.PI/2),o.rotate===1&&u.translateY(-c),o.rotate===2&&u.translateX(-l),u.applyMatrix4(k),$.add(u)}),t.zoom&&t.drawany&&$.add(W("x",this.size_x3d)),S.add($),$=new x.Object3D,$.position.set(0,m,s),$.rotation.x=3/4*Math.PI,$.painter=this.x_handle,t.draw&&$.add(new x.LineSegments(de.geometry,de.material)),P.forEach(o=>{let l=o.boundingBox.max.x-o.boundingBox.min.x,c=o.boundingBox.max.y-o.boundingBox.min.y,M=o.rotate===1?c:l,f=o.center?o.grx+M/2:o.opposite?i+M:n,b=-y*(o.rotate===1?V:Z)-this.x_handle.ticksSize-o.offsety,k=new x.Matrix4;k.set(-y,0,0,f,0,y,0,b,0,0,-1,0,0,0,0,1);let u=new x.Mesh(o,T(this.x_handle,o.kind,o.color));o.rotate&&u.rotateZ(o.rotate*Math.PI/2),o.rotate===1&&u.translateY(-c),o.rotate===2&&u.translateX(-l),u.applyMatrix4(k),$.add(u)}),$.xyid=4,t.zoom&&t.drawany&&$.add(W("x",this.size_x3d)),S.add($),P=[],y=1,V=Z=0,H=[];let fe=this.y_handle.isCenteredLabels(),he=this.y_handle.isRotateLabels();for(;g.next();){let o=g.grpos,l=g.kind===1,c=this.y_handle.format(g.tick,2);if(g.last_major()?this.y_handle.fTitle||(c="y"):c===null&&(l=!1,c=""),l&&c&&t.draw&&(!fe||!g.last_major())){let M=g.get_modifier();M?.fLabText&&(c=M.fLabText);let f=_e(this,c,this.y_handle.labelsFont.size);f.computeBoundingBox();let b=f.boundingBox.max.x-f.boundingBox.min.x,k=f.boundingBox.max.y-f.boundingBox.min.y;f.center=!0,V=Math.max(V,b),Z=Math.max(Z,k),M?.fTextColor&&(f.color=this.getColor(M.fTextColor)),f.gry=o,f.offsetx=this.y_handle.labelsOffset+(n-i)*.005,P.push(f);let u=0;g.last_major()||(u=Math.abs(g.next_major_grpos()-o),b>0&&(y=Math.min(y,.9*u/b))),fe&&(u||(u=Math.min(o-d,m-o)),f.gry+=u/2),he&&(f.rotate=1)}H.push(0,o,0,this.y_handle.ticksSize*(l?-1:-.6),o,0)}if(this.y_handle.fTitle&&t.draw){let o=_e(this,this.y_handle.fTitle,this.y_handle.titleFont.size);o.computeBoundingBox(),o.center=this.y_handle.titleCenter,o.opposite=this.y_handle.titleOpposite,o.offsetx=1.6*this.y_handle.titleOffset+(n-i)*.005,o.gry=(d+m)/2,o.kind="title",this.y_handle.isRotateTitle()&&(o.rotate=2),P.push(o)}if(!t.use_y_for_z){let o,l=new x.Object3D;l.position.set(i,0,s),l.rotation.y=-1/4*Math.PI,l.painter=this.y_handle,t.draw&&(o=ee(H,I(this.y_handle,"ticks")),l.add(o)),P.forEach(c=>{let M=c.boundingBox.max.x-c.boundingBox.min.x,f=c.boundingBox.max.y-c.boundingBox.min.y,b=c.rotate===1?f:M,k=-y*(c.rotate===1?V:Z)-this.y_handle.ticksSize-c.offsetx,u=c.center?c.gry+b/2:c.opposite?d+b:m,q=new x.Matrix4;q.set(0,y,0,k,-y,0,0,u,0,0,1,0,0,0,0,1);let O=new x.Mesh(c,T(this.y_handle,c.kind,c.color));c.rotate&&O.rotateZ(c.rotate*Math.PI/2),c.rotate===1&&O.translateY(-f),c.rotate===2&&O.translateX(-M),O.applyMatrix4(q),l.add(O)}),l.xyid=3,t.zoom&&t.drawany&&l.add(W("y",this.size_y3d)),S.add(l),l=new x.Object3D,l.position.set(n,0,s),l.rotation.y=-3/4*Math.PI,l.painter=this.y_handle,t.draw&&l.add(new x.LineSegments(o.geometry,o.material)),P.forEach(c=>{let M=c.boundingBox.max.x-c.boundingBox.min.x,f=c.boundingBox.max.y-c.boundingBox.min.y,b=c.rotate===1?f:M,k=-y*(c.rotate===1?V:Z)-this.y_handle.ticksSize-c.offsetx,u=c.center?c.gry-b/2:c.opposite?d:m-b,q=new x.Matrix4;q.set(0,y,0,k,y,0,0,u,0,0,-1,0,0,0,0,1);let O=new x.Mesh(c,T(this.y_handle,c.kind,c.color));c.rotate&&O.rotateZ(c.rotate*Math.PI/2),c.rotate===1&&O.translateY(-f),c.rotate===2&&O.translateX(-M),O.applyMatrix4(q),l.add(O)}),l.xyid=1,t.zoom&&t.drawany&&l.add(W("y",this.size_y3d)),S.add(l)}P=[],y=1,H=[];let ce=null,ge=null,we=null,Q=0,be=this.z_handle.isCenteredLabels(),De=this.z_handle.isRotateLabels();for(this.size_z3d&&t.drawany&&(ce=[],ge=[]);L.next();){let o=L.grpos,l=L.kind===1,c=this.z_handle.format(L.tick,2);if(c===null&&(l=!1,c=""),l&&c&&t.draw&&(!be||!L.last_major())){let M=L.get_modifier();M?.fLabText&&(c=M.fLabText);let f=_e(this,c,this.z_handle.labelsFont.size);f.computeBoundingBox();let b=f.boundingBox.max.x-f.boundingBox.min.x,k=f.boundingBox.max.y-f.boundingBox.min.y;f.translate(-b,-k/2,0),M?.fTextColor&&(f.color=this.getColor(M.fTextColor)),f.grz=o,P.push(f),we!==null&&k>0&&(y=Math.min(y,.9*(o-we)/k)),Q=Math.max(Q,b),we=o}ce&&l&&ce.push(i,0,o,n,0,o),ge&&l&&ge.push(0,d,o,0,m,o),H.push(0,0,o,this.z_handle.ticksSize*(l?1:.6),0,o)}if(ce?.length){let o=new x.LineDashedMaterial({color:this.x_handle.ticksColor,dashSize:2,gapSize:2}),l=ee(ce,o);l.position.set(0,m,0),l.grid=2,l.visible=!1,S.add(l);let c=new x.LineSegments(l.geometry,o);c.position.set(0,d,0),c.grid=4,c.visible=!1,S.add(c)}if(ge?.length){let o=new x.LineDashedMaterial({color:this.y_handle.ticksColor,dashSize:2,gapSize:2}),l=ee(ge,o);l.position.set(n,0,0),l.grid=3,l.visible=!1,S.add(l);let c=new x.LineSegments(l.geometry,o);c.position.set(i,0,0),c.grid=1,c.visible=!1,S.add(c)}let G=[],ue=t.draw?ee(H,I(this.z_handle,"ticks")):null;for(let o=0;o<4;++o){if(G.push(new x.Object3D),P.forEach((l,c)=>{let M=new x.Matrix4,f=l.boundingBox.max.x-l.boundingBox.min.x,b=l.grz;be&&(c<P.length-1?b=(b+P[c+1].grz)/2:c>0&&(b=Math.min(1.5*b-P[c-1].grz*.5,h))),M.set(-y,0,0,this.z_handle.ticksSize+(n-i)*.005+this.z_handle.labelsOffset,0,0,1,0,0,y,0,b);let k=new x.Mesh(l,T(this.z_handle));De&&k.rotateZ(-Math.PI/2).translateX(f/2),k.applyMatrix4(M),G[o].add(k)}),this.z_handle.fTitle&&t.draw){let l=_e(this,this.z_handle.fTitle,this.z_handle.titleFont.size);l.computeBoundingBox();let c=l.boundingBox.max.x-l.boundingBox.min.x,M=l.boundingBox.max.y-l.boundingBox.min.y,f=this.z_handle.isRotateTitle(),b=this.z_handle.titleCenter?(h+s-c)/2:(this.z_handle.titleOpposite?s:h-c)+(f?c:0),k=new x.Matrix4;k.set(-y,0,0,this.z_handle.ticksSize+(n-i)*.005+Q+this.z_handle.titleOffset,0,0,1,0,0,y,0,b);let u=new x.Mesh(l,T(this.z_handle,"title"));u.rotateZ(Math.PI*(f?1.5:.5)),f&&u.translateY(-M),u.applyMatrix4(k),G[o].add(u)}t.draw&&ue&&G[o].add(o===0?ue:new x.LineSegments(ue.geometry,ue.material)),t.zoom&&t.drawany&&G[o].add(W("z",this.size_z3d,t.use_y_for_z)),G[o].zid=o+2,S.add(G[o]),G[o].painter=this.z_handle}if(G[0].position.set(i,m,0),G[0].rotation.z=3/4*Math.PI,G[1].position.set(n,m,0),G[1].rotation.z=1/4*Math.PI,G[2].position.set(n,d,0),G[2].rotation.z=-1/4*Math.PI,G[3].position.set(i,d,0),G[3].rotation.z=-3/4*Math.PI,!t.drawany)return;let R=I(this.x_handle),se=ee([i,0,0,n,0,0],R,null,!0);for(let o=0;o<2;++o){let l=new x.LineSegments(se,R);l.position.set(0,d,o===0?s:h),l.xyboxid=2,l.bottom=o===0,S.add(l),l=new x.LineSegments(se,R),l.position.set(0,m,o===0?s:h),l.xyboxid=4,l.bottom=o===0,S.add(l)}let te=I(this.y_handle),K=ee([0,d,0,0,m,0],te,null,!0);for(let o=0;o<2;++o){let l=new x.LineSegments(K,te);l.position.set(i,0,o===0?s:h),l.xyboxid=3,l.bottom=o===0,S.add(l),l=new x.LineSegments(K,te),l.position.set(n,0,o===0?s:h),l.xyboxid=1,l.bottom=o===0,S.add(l)}let Y=I(this.z_handle),le=ee([0,0,s,0,0,h],Y,null,!0);for(let o=0;o<4;++o){let l=new x.LineSegments(le,Y);l.zboxid=G[o].zid,l.position.copy(G[o].position),S.add(l)}}function _t(e,r,t){e=this.x_handle.gr(e),r=this.y_handle.gr(r),t=this.z_handle.gr(t);let a=new x.Vector3().set(e,r,t);a.project(this.camera),a.x=(a.x+1)/2,a.y=(a.y+1)/2;let i=this.getPadPainter(),n=i?.getPadWidth(),d=i?.getPadHeight();return n&&d&&(a.x=(this.scene_x+a.x*this.scene_width)/n,a.y=(this.scene_y+a.y*this.scene_height)/d),a}function ut(e){Object.assign(e,{create3DScene:ot,add3DMesh:at,get3DMeshes:ht,remove3DMeshes:lt,getRenderer:ct,render3D:dt,resize3D:mt,change3DCamera:rt,highlightBin3D:xt,set3DOptions:ft,drawXYZ:gt,convert3DtoPadNDC:_t})}function Pt(a,i){return je(this,arguments,function*(e,r,t=Me.Render3D.None){let n=e.getFramePainter(),d=e.getOptions(),m=e.getHisto(),s=e.getDimension();return ut(n),n.create3DScene(t,d.x3dscale,d.y3dscale,d.Ortho).then(()=>(n.setAxesRanges(m.fXaxis,e.xmin,e.xmax,m.fYaxis,e.ymin,e.ymax,m.fZaxis,e.zmin,e.zmax,e),n.set3DOptions(d),n.drawXYZ(n.toplevel,r,{ndim:s,use_y_for_z:s===1,hist_painter:e,zmult:d.zmult??1,zoom:t!==Me.Render3D.None&&Ie.Zooming,draw:d.Axis!==-1,drawany:d.isCartesian(),reverse_x:d.RevX,reverse_y:d.RevY}),n))})}function Qe(e){if(e.faceIndex<0||e.faceIndex>=this.face_to_bins_index.length)return null;let r=this.tip_painter;if(!r)return console.error("painter for tip handling is not there"),null;let t=this.handle,a=r.getFramePainter(),i=r.getHisto(),n=r.get3DToolTip(this.face_to_bins_index[e.faceIndex]),d=Math.min(a.size_x3d,Math.max(-a.size_x3d,t.grx[n.ix-1]+t.xbar1*(t.grx[n.ix]-t.grx[n.ix-1]))),m=Math.min(a.size_x3d,Math.max(-a.size_x3d,t.grx[n.ix-1]+t.xbar2*(t.grx[n.ix]-t.grx[n.ix-1]))),s=Math.min(a.size_y3d,Math.max(-a.size_y3d,t.gry[n.iy-1]+t.ybar1*(t.gry[n.iy]-t.gry[n.iy-1]))),h=Math.min(a.size_y3d,Math.max(-a.size_y3d,t.gry[n.iy-1]+t.ybar2*(t.gry[n.iy]-t.gry[n.iy-1])));n.x1=Math.min(d,m),n.x2=Math.max(d,m),n.y1=Math.min(s,h),n.y2=Math.max(s,h);let _=this.baseline,B=n.value;return i.$baseh&&(_=i.$baseh.getBinContent(n.ix,n.iy)),B<_&&([_,B]=[B,_]),n.z1=a.grz(Math.max(this.zmin,_)),n.z2=a.grz(Math.min(this.zmax,B)),n.color=this.tip_color,n.$painter=r,n.$projection=r.getDimension()===2&&ae(r.isProjection)&&r.isProjection(),n}function Dt(e,r=!1){if(!e.draw_content)return;let t=xe.Vertices,a=xe.Indexes,i=xe.Normals,n=xe.Segments,d=[0,1,1,2,2,3,3,0],m=[new x.Vector3(0,0,0),new x.Vector3(0,1,0),new x.Vector3(1,1,0),new x.Vector3(1,0,0)],s=e.getFramePainter(),h=e.prepareDraw({rounding:!1,use3d:!0,extra:1}),_=e.options.cutg,B=h.i1,z=h.i2,p=h.j1,C=h.j2,D=e.getHisto(),F=D.$baseh,A=e.options.Lego===11||e.options.Lego===13,N=D.getBin(z,C)<65535;if(B>=z||p>=C)return;let E,v,w,g,L,y,I,T,S,H,P,Z=s.z_handle.getScaleMin(),V=s.z_handle.getScaleMax(),oe=(R,se,te)=>(T=D.getBinContent(R+1,se+1),F?I=F.getBinContent(R+1,se+1):e.options.BaseLine!==!1?I=e.options.BaseLine:I=e.options.Zero?Z:0,T<I&&([I,T]=[T,I]),I>=v||T<E||_&&!_.IsInside(D.fXaxis.GetBinCoord(R+.5),D.fYaxis.GetBinCoord(se+.5))?!1:(S=T===E||I>=T,!S||te>0?!0:F?!1:e.options.Zero||Z>0?!0:e.options.ShowEmpty)),J=[Z,V],W=null;(e.options.Lego===12||e.options.Lego===14)&&(r?(W=s.getHistPalette(),e.createContour(s,W,{full_z_range:!0}),J=W.getContour(),Z=J.at(0),V=J.at(-1)):(J=e.createContour(D.fContour?D.fContour.length:20,s.lego_zmin,s.lego_zmax).arr,W=e.getHistPalette()));for(let R=0;R<J.length-1;++R){E=J[R],v=J[R+1],W&&R===J.length-2&&v<V&&(v=V);let se=s.grz(E),te=s.grz(v),K=0,Y=0;for(w=B;w<z;++w)for(g=p;g<C;++g)oe(w,g,R)&&(H=!S&&R>0,P=!S&&T>v&&R<J.length-2,K+=S?12:a.length,H&&(K-=6),P&&(K-=6),A&&!S&&(K-=12,Y+=12));let le=new Float32Array(K*3),o=new Float32Array(K*3),l=N?new Uint16Array(K/3):new Uint32Array(K/3),c=Y===0?null:new Float32Array(Y*3),M=Y===0?null:new Float32Array(Y*3),f=Y===0?null:N?new Uint16Array(Y/3):new Uint32Array(Y/3),b=0,k=0,u;for(w=B;w<z;++w){let X=h.grx[w]+h.xbar1*(h.grx[w+1]-h.grx[w]),me=h.grx[w]+h.xbar2*(h.grx[w+1]-h.grx[w]);for(g=p;g<C;++g){if(!oe(w,g,R))continue;H=!S&&R>0,P=!S&&T>v&&R<J.length-2;let ze=h.gry[g]+h.ybar1*(h.gry[g+1]-h.gry[g]),ie=h.gry[g]+h.ybar2*(h.gry[g+1]-h.gry[g]),ve=I<=E?se:s.grz(I),ke=T>v?te:s.grz(T);u=0,L=0,S&&(u+=12,L+=24);let Fe=D.getBin(w+1,g+1),Te=a.length;for(H&&(Te-=6);L<Te;)y=t[a[L]],A&&L<12?(c[k]=X+y.x*(me-X),c[k+1]=ze+y.y*(ie-ze),c[k+2]=ve+y.z*(ke-ve),M[k]=i[u],M[k+1]=i[u+1],M[k+2]=i[u+2],k%9===0&&(f[k/9]=Fe),k+=3):(le[b]=X+y.x*(me-X),le[b+1]=ze+y.y*(ie-ze),le[b+2]=ve+y.z*(ke-ve),o[b]=i[u],o[b+1]=i[u+1],o[b+2]=i[u+2],b%9===0&&(l[b/9]=Fe),b+=3),++L,L%6===0&&(u+=3,P&&L===a.length-12&&(L+=6,u+=3))}}let q=Be(e,le,o),O=r?3:D.fFillColor,U=e.getColor(O);W?U=r?W.getColor(R):W.calcColor(R,J.length):(e.options.Lego===1||O<2)&&(O=1,U="white");let re=new x.MeshBasicMaterial(ne(U,{vertexColors:!1})),j=new x.Mesh(q,re);if(j.face_to_bins_index=l,j.tip_painter=e,j.zmin=Z,j.zmax=V,j.baseline=e.options.BaseLine!==!1?e.options.BaseLine:e.options.Zero?Z:0,j.tip_color=O===3?16711680:65280,j.handle=h,j.tooltip=Qe,s.add3DMesh(j),Y>0){let X=Be(e,c,M),me=new x.Color(O<2?16711680:Re(U).darker(.5).toString()),ze=new x.MeshBasicMaterial({color:me,vertexColors:!1}),ie=new x.Mesh(X,ze);ie.face_to_bins_index=f,ie.tip_painter=e,ie.handle=j.handle,ie.tooltip=Qe,ie.zmin=j.zmin,ie.zmax=j.zmax,ie.baseline=j.baseline,ie.tip_color=j.tip_color,s.add3DMesh(ie)}}if(e.options.Lego>12)return;let $=0,de=0;for(v=V,E=Z,w=B;w<z;++w)for(g=p;g<C;++g)oe(w,g,0)&&($+=S?m.length:t.length,de+=S?d.length:n.length);let fe=$<=65520;fe||($=de*3);let he=new Float32Array($*3),ce=fe?new Uint16Array(de):null,ge=s.grz(Z),we=s.grz(V),Q=0,be=0;for(w=B;w<z;++w){let R=h.grx[w]+h.xbar1*(h.grx[w+1]-h.grx[w]),se=h.grx[w]+h.xbar2*(h.grx[w+1]-h.grx[w]);for(g=p;g<C;++g){if(!oe(w,g,0))continue;let te=h.gry[g]+h.ybar1*(h.gry[g+1]-h.gry[g]),K=h.gry[g]+h.ybar2*(h.gry[g+1]-h.gry[g]),Y=I<=Z?ge:s.grz(I),le=T>V?we:s.grz(T),o=S?d:n,l=S?m:t;if(fe){for(L=0;L<o.length;++L)ce[be++]=Q/3+o[L];for(L=0;L<l.length;++L)y=l[L],he[Q]=R+y.x*(se-R),he[Q+1]=te+y.y*(K-te),he[Q+2]=Y+y.z*(le-Y),Q+=3}else for(L=0;L<o.length;++L)y=l[o[L]],he[Q]=R+y.x*(se-R),he[Q+1]=te+y.y*(K-te),he[Q+2]=Y+y.z*(le-Y),Q+=3}}let De=r?e.v7EvalColor("line_color","lightblue"):e.getColor(D.fLineColor),G=new x.LineBasicMaterial(ne(De,{linewidth:r?e.v7EvalAttr("line_width",1):D.fLineWidth})),ue=ee(Pe(e,he),G,fe?ce:null);s.add3DMesh(ue)}function zt(e){let r=Math.floor(e.index/6);if(r<0||r>=this.intersect_index.length)return null;let t=this.tip_painter,a=t.getHisto(),i=t.getFramePainter(),n=t.get3DToolTip(this.intersect_index[r]),d=Math.min(i.size_x3d,Math.max(-i.size_x3d,i.grx(a.fXaxis.GetBinLowEdge(n.ix)))),m=Math.min(i.size_x3d,Math.max(-i.size_x3d,i.grx(a.fXaxis.GetBinLowEdge(n.ix+1)))),s=Math.min(i.size_y3d,Math.max(-i.size_y3d,i.gry(a.fYaxis.GetBinLowEdge(n.iy)))),h=Math.min(i.size_y3d,Math.max(-i.size_y3d,i.gry(a.fYaxis.GetBinLowEdge(n.iy+1))));return n.x1=Math.min(d,m),n.x2=Math.max(d,m),n.y1=Math.min(s,h),n.y2=Math.max(s,h),n.z1=i.grz(n.value-n.error<this.zmin?this.zmin:n.value-n.error),n.z2=i.grz(n.value+n.error>this.zmax?this.zmax:n.value+n.error),n.color=this.tip_color,n}function Lt(e,r=!1){let t=e.getFramePainter(),a=e.getHisto(),i=e.prepareDraw({rounding:!1,use3d:!0,extra:1}),n=t.z_handle.getScaleMin(),d=t.z_handle.getScaleMax(),m=e.options.cutg,s,h,_,B,z,p,C,D,F,A,N,E=0,v=null,w=null,g=0,L=()=>e.options.Zero||n>0?!1:!e.options.ShowEmpty;for(let S=0;S<2;++S){for(s=i.i1;s<i.i2;++s)for(p=i.grx[s],D=i.grx[s+1],h=i.j1;h<i.j2;++h)if(B=a.getBinContent(s+1,h+1),!(B<n||B>d)&&!(B===n&&L())&&!(m&&!m.IsInside(a.fXaxis.GetBinCoord(s+.5),a.fYaxis.GetBinCoord(h+.5)))){if(S===0){E+=3;continue}_=a.getBin(s+1,h+1),z=e.getBinErrors(a,_,B),w[g/18]=_,C=i.gry[h],F=i.gry[h+1],A=t.grz(B-z.low<n?n:B-z.low),N=t.grz(B+z.up>d?d:B+z.up),v[g]=p,v[g+3]=D,v[g+1]=v[g+4]=(C+F)/2,v[g+2]=v[g+5]=(A+N)/2,g+=6,v[g]=v[g+3]=(p+D)/2,v[g+1]=C,v[g+4]=F,v[g+2]=v[g+5]=(A+N)/2,g+=6,v[g]=v[g+3]=(p+D)/2,v[g+1]=v[g+4]=(C+F)/2,v[g+2]=A,v[g+5]=N,g+=6}if(S===0){if(E===0)return;v=new Float32Array(E*6),w=new Int32Array(E/3)}}let y=r?e.v7EvalColor("line_color","lightblue"):e.getColor(a.fLineColor),I=new x.LineBasicMaterial(ne(y,{linewidth:r?e.v7EvalAttr("line_width",1):a.fLineWidth})),T=ee(v,I);T.tip_painter=e,T.intersect_index=w,T.zmin=n,T.zmax=d,T.tip_color=a.fLineColor===3?16711680:65280,T.tooltip=zt,t.add3DMesh(T)}function yt(e,r=!1,t=!1){let a=e.getFramePainter(),i=e.prepareDraw({rounding:!1,use3d:!0,extra:100,middle:0}),n=e.getHisto(),d=e.getContourLevels(),m=e.getHistPalette(),s=[],h=2*a.size_z3d;Le(n,i,d,m,(B,z,p,C,D,F)=>{if(!(D-C<3)&&!(r&&(h=a.grz(d[F]),h<0||h>2*a.size_z3d)))for(let A=C;A<D;++A)s.push(z[A],p[A],h),s.push(z[A+1],p[A+1],h)});let _=ee(s,Xe(e,t?"line_":n));a.add3DMesh(_)}function St(e,r=!1){let t=e.getHisto(),a=e.getFramePainter(),i=a.z_handle.getScaleMin(),n=a.logz?z=>z<i?-.1:a.grz(z):a.grz,d=0,m=2*a.size_z3d,s=e.prepareDraw({rounding:!1,use3d:!0,extra:1,middle:.5,cutg:ae(e.options?.cutg?.IsInside)?e.options?.cutg:null});if(s.i2-s.i1<2||s.j2-s.j1<2)return;let h=null,_=null,B=null;if(s.dolines=!0,r){let z=0;switch(e.options.Surf){case 11:z=2;break;case 12:case 15:case 17:z=2,s.dolines=!1;break;case 14:s.dolines=!1,s.donormals=!0;break;case 16:z=1,s.dogrid=!0,s.dolines=!1;break;default:h=a.z_handle.createTicks(!0),s.dogrid=!0;break}z>0&&(B=a.getHistPalette(),z===2&&e.createContour(a,B,{full_z_range:!0}),h=B.getContour())}else switch(e.options.Surf){case 11:h=e.getContourLevels(),B=e.getHistPalette();break;case 12:case 15:case 17:h=e.getContourLevels(),B=e.getHistPalette(),s.dolines=!1;break;case 14:s.dolines=!1,s.donormals=!0;break;case 16:h=e.getContourLevels(),s.dogrid=!0,s.dolines=!1;break;default:h=a.z_handle.createTicks(!0),s.dogrid=!0;break}if(h){_=new Float32Array(h.length);for(let z=0;z<h.length;++z)_[z]=n(h[z])}else _=[d,m];if(s.grz=n,s.grz_min=d,s.grz_max=m,Je(t,s,h,(z,p,C)=>{let D=Be(e,p,null,s.i2-s.i1,s.j2-s.j1),F=D.getAttribute("normal").array;if(s.donormals&&z===1)for(let v=s.i1;v<s.i2;++v)for(let w=s.j1;w<s.j2;++w){let g=((v-s.i1)*(s.j2-s.j1)+(w-s.j1))*8;if(C[g]===-1)continue;let L=C[g]>=0?g:g+9+C[g],y=g+8,I=0,T=0,S=0;for(let H=L;H<y;++H){let P=C[H];if(P<0)return console.error("FAILURE in NORMALS RECALCULATIONS");I+=F[P],T+=F[P+1],S+=F[P+2]}I/=y-L,T/=y-L,S/=y-L;for(let H=L;H<y;++H){let P=C[H];F[P]=I,F[P+1]=T,F[P+2]=S}}let A,N;if(r)A=B?.getColor(z-1)??e.getColor(5);else if(B)A=B.calcColor(z,_.length);else{let v=e.options.histoFillColor||t.fFillColor;e.options.Surf===13?A="white":e.options.Surf===14?A=v>1?e.getColor(v):"grey":A=v>1?e.getColor(v):"white"}A||(A="white"),e.options.Surf===14?N=new x.MeshLambertMaterial(ne(A,{side:x.DoubleSide,vertexColors:!1})):N=new x.MeshBasicMaterial(ne(A,{side:x.DoubleSide,vertexColors:!1}));let E=new x.Mesh(D,N);a.add3DMesh(E),E.painter=e},(z,p)=>{let C=e.getColor(t.fLineColor)??"white",D;z?D=e.options.Surf===1?new x.LineDashedMaterial({color:0,dashSize:2,gapSize:2}):new x.LineBasicMaterial(ne(C)):D=new x.LineBasicMaterial(ne(C,{linewidth:t.fLineWidth}));let F=ee(Pe(e,p,s.i2-s.i1,s.j2-s.j1),D);F.painter=e,a.add3DMesh(F)}),e.options.Surf===17&&yt(e,!1,r),e.options.Surf===13){s=e.prepareDraw({rounding:!1,use3d:!0,extra:100,middle:0});let z=e.getContourLevels(),p=e.getHistPalette(),C=-1,D=m;Le(t,s,z,p,(F,A,N,E,v)=>{if(A[v]===A[E]&&N[v]===N[E]&&v--,v-E<3)return;let w=[];for(let P=E;P<=v;++P)(P===E||A[P]!==A[P-1]||N[P]!==N[P-1])&&w.push(new x.Vector2(A[P],N[P]));let g=w.length<3?null:x.ShapeUtils.triangulateShape(w,[]);if(!g?.length)return;(C<0||C!==F)&&(C=F,D+=5e-5*m);let L=new Float32Array(g.length*9),y=new Float32Array(g.length*9),I=0;for(let P=0;P<g.length;++P){let Z=g[P];for(let V=0;V<3;++V){let oe=w[Z[V]];L[I]=oe.x,L[I+1]=oe.y,L[I+2]=D,y[I]=0,y[I+1]=0,y[I+2]=1,I+=3}}let T=Be(e,L,y,s.i2-s.i1,s.j2-s.j1),S=new x.MeshBasicMaterial(ne(p.getColor(F),{side:x.DoubleSide,opacity:.5,vertexColors:!1})),H=new x.Mesh(T,S);H.painter=e,a.add3DMesh(H)})}}export{Pe as a,Be as b,Pt as c,Dt as d,Lt as e,yt as f,St as g};
