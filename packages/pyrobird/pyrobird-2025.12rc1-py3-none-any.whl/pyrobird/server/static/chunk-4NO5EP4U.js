import{c as Q}from"./chunk-3MJ5AJB7.js";import{a as dt,c as mt}from"./chunk-3W3OTHNE.js";import{h as xt}from"./chunk-HB357Z3Y.js";import{a as L,n as ft,o as O,q as lt}from"./chunk-S3FA7C5I.js";import{b as gt}from"./chunk-LNTKXTVM.js";import{c as J,h as ht}from"./chunk-MFPRCIVI.js";import{H as W,J as at}from"./chunk-DLJYFRIS.js";import{$a as st,Va as nt,Ya as rt,f as et,ib as ot,u as U,x as it}from"./chunk-MAT3H5WR.js";import{k as V}from"./chunk-KYPE3LET.js";var ut=class tt extends xt{#t;getDimension(){return 3}scanContent(t){if(t&&this.nbinsx&&this.nbinsy&&this.nbinsz)return;let n=this.getHisto();this.extractAxesProperties(3),this.gminbin=this.gmaxbin=n.getBinContent(1,1,1),this.gminposbin=null;for(let e=0;e<this.nbinsx;++e)for(let i=0;i<this.nbinsy;++i)for(let h=0;h<this.nbinsz;++h){let l=n.getBinContent(e+1,i+1,h+1);l<this.gminbin?this.gminbin=l:l>this.gmaxbin&&(this.gmaxbin=l),l>0&&(this.gminposbin===null||this.gminposbin>l)&&(this.gminposbin=l)}this.gminposbin===null&&this.gmaxbin>0&&(this.gminposbin=this.gmaxbin*1e-4),this.draw_content=this.gmaxbin||this.gminbin,this.transferFunc=this.findFunction(nt,"TransferFunction"),this.transferFunc?.SetBit(it(9),!0)}countStat(t,n){let e=this.getHisto(),i=e.fXaxis,h=e.fYaxis,l=e.fZaxis,g=this.getSelectIndex("x","left"),z=this.getSelectIndex("x","right"),x=this.getSelectIndex("y","left"),d=this.getSelectIndex("y","right"),s=this.getSelectIndex("z","left"),_=this.getSelectIndex("z","right"),S=this.getFramePainter(),r={name:e.fName,entries:0,eff_entries:0,integral:0,meanx:0,meany:0,meanz:0,rmsx:0,rmsy:0,rmsz:0,skewx:0,skewy:0,skewz:0,skewd:0,kurtx:0,kurty:0,kurtz:0,kurtd:0},B=Math.abs(e.fTsumw)>1e-300&&!S.isAxisZoomed("x")&&!S.isAxisZoomed("y")&&!S.isAxisZoomed("z"),p,b,T,G,E,k,D,I,P,w,m=0,A=0,Y=0,K=0,Z=0,R=0,N=0,a=0;for(et(t)||(t=null),p=0;p<this.nbinsx+2;++p)for(G=i.GetBinCoord(p-.5),E=p<g?0:p>z?2:1,b=0;b<this.nbinsy+2;++b)for(k=h.GetBinCoord(b-.5),D=b<x?0:b>d?2:1,T=0;T<this.nbinsz+2;++T)I=l.GetBinCoord(T-.5),P=T<s?0:T>_?2:1,!(t&&!t(G,k,I))&&(w=e.getBinContent(p,b,T),r.entries+=w,!B&&E===1&&D===1&&P===1&&(m+=w,A+=w*w,Y+=G*w,K+=k*w,Z+=I*w,R+=G**2*w,N+=k**2*w,a+=I**2*w));if(B&&(m=e.fTsumw,A=e.fTsumw2,Y=e.fTsumwx,R=e.fTsumwx2,K=e.fTsumwy,N=e.fTsumwy2,Z=e.fTsumwz,a=e.fTsumwz2),Math.abs(m)>1e-300&&(r.meanx=Y/m,r.meany=K/m,r.meanz=Z/m,r.rmsx=Math.sqrt(Math.abs(R/m-r.meanx*r.meanx)),r.rmsy=Math.sqrt(Math.abs(N/m-r.meany*r.meany)),r.rmsz=Math.sqrt(Math.abs(a/m-r.meanz*r.meanz))),r.integral=m,e.fEntries>0&&(r.entries=e.fEntries),r.eff_entries=A?m*m/A:Math.abs(m),n&&!this.isTH2Poly()){let u=0,M=0,y=0,o=0,F=0,c=0,f=0;for(p=g;p<z;++p)for(G=i.GetBinCoord(p+.5),b=x;b<d;++b)for(k=h.GetBinCoord(b+.5),T=s;T<_;++T){if(I=l.GetBinCoord(T+.5),t&&!t(G,k,I))continue;let X=e.getBinContent(p+1,b+1,T+1);f+=X,u+=X*Math.pow(G-r.meanx,3),M+=X*Math.pow(k-r.meany,3),y+=X*Math.pow(I-r.meany,3),o+=X*Math.pow(G-r.meanx,4),F+=X*Math.pow(k-r.meany,4),c+=X*Math.pow(k-r.meany,4)}let C=Math.pow(r.rmsx,3),v=Math.pow(r.rmsy,3),j=Math.pow(r.rmsz,3),$=Math.pow(r.rmsx,4),q=Math.pow(r.rmsy,4),H=Math.pow(r.rmsz,4);f*C&&(r.skewx=u/(f*C)),f*v&&(r.skewy=M/(f*v)),f*j&&(r.skewz=y/(f*j)),r.skewd=r.eff_entries>0?Math.sqrt(6/r.eff_entries):0,f*$&&(r.kurtx=o/(f*$)-3),f*q&&(r.kurty=F/(f*q)-3),f*H&&(r.kurtz=c/(f*H)-3),r.kurtd=r.eff_entries>0?Math.sqrt(24/r.eff_entries):0}return r}fillStatistic(t,n,e){if(this.isIgnoreStatsFill())return!1;n===1&&(n=1111);let i=n%10,h=Math.floor(n/10)%10,l=Math.floor(n/100)%10,g=Math.floor(n/1e3)%10,z=Math.floor(n/1e6)%10,x=Math.floor(n/1e7)%10,d=Math.floor(n/1e8)%10,s=this.countStat(void 0,x>0||d>0);return t.clearPave(),i>0&&t.addText(s.name),h>0&&t.addText("Entries = "+t.format(s.entries,"entries")),l>0&&(t.addText("Mean x = "+t.format(s.meanx)),t.addText("Mean y = "+t.format(s.meany)),t.addText("Mean z = "+t.format(s.meanz))),g>0&&(t.addText("Std Dev x = "+t.format(s.rmsx)),t.addText("Std Dev y = "+t.format(s.rmsy)),t.addText("Std Dev z = "+t.format(s.rmsz))),z>0&&t.addText("Integral = "+t.format(s.integral,"entries")),x===2?(t.addText(`Skewness x = ${t.format(s.skewx)} #pm ${t.format(s.skewd)}`),t.addText(`Skewness y = ${t.format(s.skewy)} #pm ${t.format(s.skewd)}`),t.addText(`Skewness z = ${t.format(s.skewz)} #pm ${t.format(s.skewd)}`)):x>0&&(t.addText(`Skewness x = ${t.format(s.skewx)}`),t.addText(`Skewness y = ${t.format(s.skewy)}`),t.addText(`Skewness z = ${t.format(s.skewz)}`)),d===2?(t.addText(`Kurtosis x = ${t.format(s.kurtx)} #pm ${t.format(s.kurtd)}`),t.addText(`Kurtosis y = ${t.format(s.kurty)} #pm ${t.format(s.kurtd)}`),t.addText(`Kurtosis z = ${t.format(s.kurtz)} #pm ${t.format(s.kurtd)}`)):d>0&&(t.addText(`Kurtosis x = ${t.format(s.kurtx)}`),t.addText(`Kurtosis y = ${t.format(s.kurty)}`),t.addText(`Kurtosis z = ${t.format(s.kurtz)}`)),e&&t.fillFunctionStat(this.findFunction(rt),e,3),!0}getBinTooltips(t,n,e){let i=[],h=this.getHisto();i.push(this.getObjectHint(),`x = ${this.getAxisBinTip("x",h.fXaxis,t)}  xbin=${t+1}`,`y = ${this.getAxisBinTip("y",h.fYaxis,n)}  ybin=${n+1}`,`z = ${this.getAxisBinTip("z",h.fZaxis,e)}  zbin=${e+1}`);let l=h.getBinContent(t+1,n+1,e+1);if(l===Math.round(l)?i.push(`entries = ${l}`):i.push(`entries = ${W(l,U.fStatFormat)}`),this.matchObjectType(st)){let g=h.getBinError(h.getBin(t+1,n+1,e+1));i.push("error = "+(g===Math.round(g)?g.toString():W(g,U.fPaintTextFormat)))}return i}draw3DScatter(){let t=this.getObject(),n=this.getFramePainter(),e=this.getSelectIndex("x","left",.5),i=this.getSelectIndex("x","right",0),h=this.getSelectIndex("y","left",.5),l=this.getSelectIndex("y","right",0),g=this.getSelectIndex("z","left",.5),z=this.getSelectIndex("z","right",0),x,d,s,_;if(i<=e||l<=h||z<=g)return Promise.resolve(!0);let S=this.gmaxbin>1e3?1e3/this.gmaxbin:1,r=Math.max(0,this.gminbin),B=0,p=0;for(x=e;x<i;++x)for(d=h;d<l;++d)for(s=g;s<z;++s)_=t.getBinContent(x+1,d+1,s+1),p+=_,_>r&&(B+=Math.round(_*S));if(B>(n.webgl?1e5:3e4))return!1;let b=new lt(B,n.webgl,n.size_x3d/200),T=new Int32Array(B),G=new at(p),E=0;for(x=e;x<i;++x)for(d=h;d<l;++d)for(s=g;s<z;++s){if(_=t.getBinContent(x+1,d+1,s+1),_<=r)continue;let k=Math.round(_*S);for(let D=0;D<k;++D){let I=t.fXaxis.GetBinCoord(x+G.random()),P=t.fYaxis.GetBinCoord(d+G.random()),w=t.fZaxis.GetBinCoord(s+G.random());T[E++]=t.getBin(x+1,d+1,s+1),b.addPoint(n.grx(I),n.gry(P),n.grz(w))}}return b.createPoints({color:this.getColor(t.fMarkerColor)}).then(k=>(n.add3DMesh(k),k.bins=T,k.tip_painter=this,k.tip_color=t.fMarkerColor===3?16711680:65280,k.tooltip=function(D){let I=Math.floor(D.index/this.nvertex);if(I<0||I>=this.bins.length)return null;let P=this.tip_painter,w=P.getHisto(),m=P.get3DToolTip(this.bins[I]);return m.x1=n.grx(w.fXaxis.GetBinLowEdge(m.ix)),m.x2=n.grx(w.fXaxis.GetBinLowEdge(m.ix+1)),m.y1=n.gry(w.fYaxis.GetBinLowEdge(m.iy)),m.y2=n.gry(w.fYaxis.GetBinLowEdge(m.iy+1)),m.z1=n.grz(w.fZaxis.GetBinLowEdge(m.iz)),m.z2=n.grz(w.fZaxis.GetBinLowEdge(m.iz+1)),m.color=this.tip_color,m.opacity=.3,m},!0))}draw3DBins(){return V(this,null,function*(){if(!this.draw_content)return!1;let t=this.getOptions(),n=t.BoxStyle;if(!n&&t.Scat){let a=this.draw3DScatter();if(a!==!1)return a;n=12}else!n&&!t.GLBox&&!t.GLColor&&!t.Lego&&(n=12);let e=this.getHisto(),i=this.getFramePainter(),h=!1,l=!1,g=!1,z=1,x=-1,d=this.getPadPainter()?.getRootPad()?.fLogv,s=!0,_=0,S=this.getColor(e.fFillColor),r=.5,B;if(!n&&t.Lego&&(n=t.Lego===1?10:t.Lego),t.GLBox===11||t.GLBox===12)r=.4,h=!0,t.GLBox===12&&(g=!0),B=new L.SphereGeometry(.5,i.webgl?16:8,i.webgl?12:6),B.applyMatrix4(new L.Matrix4().makeRotationX(Math.PI/2)),B.computeVertexNormals();else{let a=O.Indexes,u=O.Normals,M=O.Vertices,y=a.length*3,o=new Float32Array(y),F=new Float32Array(y);for(let c=0,f=-3;c<a.length;++c){let C=M[a[c]];o[c*3]=C.x-.5,o[c*3+1]=C.y-.5,o[c*3+2]=C.z-.5,c%6===0&&(f+=3),F[c*3]=u[f],F[c*3+1]=u[f+1],F[c*3+2]=u[f+2]}l=!0,n===12?g=!0:n===13?(g=!0,l=!1):t.GLColor&&(g=!0,z=.5,s=!1,l=!1,x=0,h=!0),B=new L.BufferGeometry,B.setAttribute("position",new L.BufferAttribute(o,3)),B.setAttribute("normal",new L.BufferAttribute(F,3))}this.#t=n,s&&d?this.gminposbin&&this.gmaxbin>this.gminposbin?(_=Math.log(this.gminposbin)-.1,s=1/(Math.log(this.gmaxbin)-_)):(d=0,s=1):s&&(s=this.gminbin||this.gmaxbin?1/Math.max(Math.abs(this.gminbin),Math.abs(this.gmaxbin)):1);let p=a=>{if(x>=0&&a<x)return 0;if(!s)return 1;if(d){if(a<=0)return 0;a=Math.log(a)-_}return Math.pow(Math.abs(a*s),.3333)},b=this.getSelectIndex("x","left",.5),T=this.getSelectIndex("x","right",0),G=this.getSelectIndex("y","left",.5),E=this.getSelectIndex("y","right",0),k=this.getSelectIndex("z","left",.5),D=this.getSelectIndex("z","right",0);if(T<=b||E<=G||D<=k)return!1;let I=g?this.getContour():null,P=g?this.getHistPalette():null,w=[],m=[],A=[],Y=[],K=[],Z=this.transferFunc&&dt(this.transferFunc,!0)?this.transferFunc:null;for(let a=b;a<T;++a){let u=i.grx(e.fXaxis.GetBinLowEdge(a+1)),M=i.grx(e.fXaxis.GetBinLowEdge(a+2));for(let y=G;y<E;++y){let o=i.gry(e.fYaxis.GetBinLowEdge(y+1)),F=i.gry(e.fYaxis.GetBinLowEdge(y+2));for(let c=k;c<D;++c){let f=e.getBinContent(a+1,y+1,c+1);if(!t.GLColor&&(f===0||f<this.gminbin))continue;let C=p(f);if(C<.001)continue;if(g){let q=I.getPaletteIndex(P,f);if(q===null)continue;if(m.push(P.getColor(q)),Z){let H=mt(Z,f,!1)*3;K.push(!H||H<0?0:H>1?1:H)}}let v=i.grz(e.fZaxis.GetBinLowEdge(c+1)),j=i.grz(e.fZaxis.GetBinLowEdge(c+2));A.push(e.getBin(a+1,y+1,c+1));let $=new L.Matrix4;$.scale(new L.Vector3((M-u)*C,(F-o)*C,(j-v)*C)),$.setPosition((M+u)/2,(F+o)/2,(j+v)/2),w.push($),f<0&&Y.push($)}}}function R(a){let u=this.binid;if(u===void 0){if(a.instanceId===void 0||a.instanceId>=this.bins.length)return;u=this.bins[a.instanceId]}let M=this.tip_painter,y=M.getHisto(),o=M.get3DToolTip(u),F=i.grx(y.fXaxis.GetBinCoord(o.ix-1)),c=i.grx(y.fXaxis.GetBinCoord(o.ix)),f=i.gry(y.fYaxis.GetBinCoord(o.iy-1)),C=i.gry(y.fYaxis.GetBinCoord(o.iy)),v=i.grz(y.fZaxis.GetBinCoord(o.iz-1)),j=i.grz(y.fZaxis.GetBinCoord(o.iz)),$=this.get_weight(o.value)*this.tipscale;return o.x1=(c+F)/2-(c-F)*$,o.x2=(c+F)/2+(c-F)*$,o.y1=(C+f)/2-(C-f)*$,o.y2=(C+f)/2+(C-f)*$,o.z1=(j+v)/2-(j-v)*$,o.z2=(j+v)/2+(j-v)*$,o.color=this.tip_color,o}if(g&&(Z||z!==1))for(let a=0;a<w.length;++a){let u=Z?K[a]:z,M=new L.Color(m[a]),y=h?new L.MeshLambertMaterial({color:M,opacity:u,transparent:u<1,vertexColors:!1}):new L.MeshBasicMaterial({color:M,opacity:u,transparent:u<1,vertexColors:!1}),o=new L.Mesh(B,y);o.applyMatrix4(w[a]),o.tip_painter=this,o.binid=A[a],o.tipscale=r,o.tip_color=e.fFillColor===3?16711680:65280,o.get_weight=p,o.tooltip=R,i.add3DMesh(o)}else{g&&(S=new L.Color(1,1,1));let a=h?new L.MeshLambertMaterial({color:S,vertexColors:!1}):new L.MeshBasicMaterial({color:S,vertexColors:!1}),u=new L.InstancedMesh(B,a,w.length);for(let M=0;M<w.length;++M)u.setMatrixAt(M,w[M]),g&&u.setColorAt(M,new L.Color(m[M]));u.tip_painter=this,u.bins=A,u.tipscale=r,u.tip_color=e.fFillColor===3?16711680:65280,u.get_weight=p,u.tooltip=R,i.add3DMesh(u)}if(l){let u=function(M,y){if(!y)return;let o=new Float32Array(y.length*M.length*3);for(let F=0,c=0;F<y.length;++F){let f=y[F].elements;for(let C=0;C<M.length;++C,c+=3){let v=O.Vertices[M[C]];o[c]=f[12]+(v.x-.5)*f[0],o[c+1]=f[13]+(v.y-.5)*f[5],o[c+2]=f[14]+(v.z-.5)*f[10]}}i.add3DMesh(ft(o,a))};var N=u;let a=new L.LineBasicMaterial({color:this.getColor(e.fLineColor)});u(O.Segments,w),u(O.Crosses,Y)}return!0})}redraw(t){return V(this,null,function*(){let n=this.getFramePainter(),e=this.getOptions(),i=Promise.resolve(!0),h=!0;if(t==="resize"){let l=n.resize3D();l!==1&&(h=!1,l&&n.render3D())}return h&&(i=Q(this,J,e.Render3D).then(()=>this.draw3DBins()).then(()=>{n.render3D(),this.updateStatWebCanvas(),n.addKeysHandler()})),this.isMainPainter()&&(i=i.then(()=>this.drawColorPalette(e.Zscale&&(this.#t===12||this.#t===13||e.GLBox===12)))),i.then(()=>this.updateFunctions()).then(()=>this.updateHistTitle()).then(()=>this)})}fillToolbar(){let t=this.getPadPainter();t&&(t.addPadButton("auto_zoom","Unzoom all axes","ToggleZoom","Ctrl *"),this.draw_content&&t.addPadButton("statbox","Toggle stat box","ToggleStatBox"),t.addPadButton("th2colorz","Toggle color palette","ToggleColorZ"),t.showPadButtons())}canZoomInside(t,n,e){let i=this.getHisto();return i&&(i=i[`f${t.toUpperCase()}axis`]),!i||i.FindBin(e,.5)-i.FindBin(n,0)>1}autoZoom(){let t=this.getSelectIndex("x","left"),n=this.getSelectIndex("x","right"),e=this.getSelectIndex("y","left"),i=this.getSelectIndex("y","right"),h=this.getSelectIndex("z","left"),l=this.getSelectIndex("z","right"),g=this.getObject(),z,x,d;if(t===n||e===i||h===l)return;let s=g.getBinContent(t+1,e+1,h+1);for(z=t;z<n;++z)for(x=e;x<i;++x)for(d=h;d<l;++d)s=Math.min(s,g.getBinContent(z+1,x+1,d+1));if(s>0)return;let _=n,S=t,r=i,B=e,p=l,b=h;for(z=t;z<n;++z)for(x=e;x<i;++x)for(d=h;d<l;++d)g.getBinContent(z+1,x+1,d+1)>s&&(z<_&&(_=z),z>=S&&(S=z+1),x<r&&(r=x),x>=B&&(B=x+1),d<p&&(p=d),d>=b&&(b=d+1));let T,G,E,k,D,I,P=!1;if(_===S-1&&_>t+1&&S<n-1&&(_--,S++),r===B-1&&r>e+1&&B<i-1&&(r--,B++),p===b-1&&p>h+1&&b<l-1&&(p--,b++),(_>t||S<n)&&_<S-1&&(T=g.fXaxis.GetBinLowEdge(_+1),G=g.fXaxis.GetBinLowEdge(S+1),P=!0),(r>e||B<i)&&r<B-1&&(E=g.fYaxis.GetBinLowEdge(r+1),k=g.fYaxis.GetBinLowEdge(B+1),P=!0),(p>h||b<l)&&p<b-1&&(D=g.fZaxis.GetBinLowEdge(p+1),I=g.fZaxis.GetBinLowEdge(b+1),P=!0),P)return this.getFramePainter().zoom(T,G,E,k,D,I)}fillHistContextMenu(t){let n=this.getSupportedDrawOptions();t.addDrawMenu("Draw with",n,e=>{if(e.indexOf(ot)===0)return this.showInspector(e);this.decodeOptions(e),this.interactiveRedraw(!0,"drawopt")})}static build3d(t,n){return V(this,null,function*(){let e=new tt(null,t);e.mode3d=!0,e.decodeOptions(n),e.scanContent();let i=new ht(null,null);return e.getFramePainter=()=>i,Q(e,J).then(()=>e.draw3DBins()).then(()=>i.create3DScene(-1,!0))})}static draw(t,n,e){return V(this,null,function*(){let i=new tt(t,n);return i.mode3d=!0,gt(i,"3d").then(()=>(i.setAsMainPainter(),i.decodeOptions(e),i.checkPadRange(),i.scanContent(),i.createStat(),i.redraw())).then(()=>i.drawFunctions()).then(()=>(i.fillToolbar(),i))})}};export{ut as a};
