import{b as m}from"./chunk-LNTKXTVM.js";import{ka as O}from"./chunk-DLJYFRIS.js";import{a as u,k as y}from"./chunk-KYPE3LET.js";var C=(()=>{class r{static CONSTANTS={DELAY:0,OFFSET_X:10,OFFSET_Y:-10,PADDING:8,BORDER_RADIUS:4};constructor(e){this.painter=e,this.tooltip=null,this.content="",this.x=0,this.y=0}cleanup(){this.tooltip!==null&&(document.body.removeChild(this.tooltip),this.tooltip=null)}createTooltip(){this.tooltip||(this.tooltip=document.createElement("div"),this.tooltip.style.cssText=`
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: ${r.CONSTANTS.PADDING}px;
            border-radius: ${r.CONSTANTS.BORDER_RADIUS}px;
            font-size: 12px;
            pointer-events: none;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 200px;
            word-wrap: break-word;
        `,document.body.appendChild(this.tooltip))}showTooltip(){this.tooltip||this.createTooltip(),this.tooltip.innerHTML=this.content,this.tooltip.style.left=this.x+r.CONSTANTS.OFFSET_X+"px",this.tooltip.style.top=this.y+r.CONSTANTS.OFFSET_Y+"px",this.tooltip.style.opacity="1"}hideTooltip(){this.tooltip&&(this.tooltip.style.opacity="0")}generateTooltipContent(e){let t=e.fNChildren===0,i=e.fName.length>0?`<strong>${e.fName}</strong><br>`:"";i+=`<i>${t?"Column":"Field"}</i><br>`,i+=`Size: ${this.painter.getDataStr(e.fSize)}<br>`,t&&e.fType!==void 0&&(i+=`Type: ${e.fType}<br>`),t||(i+=`Children: ${e.fNChildren}<br>`);let o=this.painter.getObject();if(o.fNodes&&o.fNodes.length>0){let h=o.fNodes[0].fSize,s=(e.fSize/h*100).toFixed(2);i+=`Disk Usage: ${s}%`}return i}}return r})();function _(r){let b=14695981039346656037n,e=1099511628211n,t=b;for(let i=0;i<r.length;++i){let o=BigInt(r.charCodeAt(i)&255);t^=o,t*=e}return t}var v=(()=>{class r extends O{static CONSTANTS={STROKE_WIDTH:.15,STROKE_COLOR:"black",COLOR_HOVER_BOOST:10,DATA_UNITS:["B","KB","MB","GB","TB","PB","EB"],MAIN_TREEMAP:{LEFT:.025,BOTTOM:.05,RIGHT:.825,TOP:.9},LEGEND:{START_Y:.835,ITEM_HEIGHT:.05,BOX_WIDTH:.05,TEXT_OFFSET_X:.01,TEXT_OFFSET_Y:.01,TEXT_LINE_SPACING:.015,MAX_ITEMS:10},TEXT:{SIZE_VW:.6,MIN_RECT_WIDTH:.025,MIN_RECT_HEIGHT:.05,PADDING:10,LEAF_OFFSET_Y:.015},INDENT:.005,LEGEND_INDENT_MULTIPLIER:4};constructor(e,t,i){super(e,t,i),this.tooltip=new C(this),this.rootIndex=0,this.parentIndices=[]}cleanup(){this._frame_hidden&&(delete this._frame_hidden,this.getPadPainter()?.getFrameSvg().style("display",null)),this.tooltip.cleanup(),super.cleanup()}appendRect(e,t,i,o=r.CONSTANTS.STROKE_COLOR,h=r.CONSTANTS.STROKE_WIDTH,s=null){let T=this.getG().append("rect").attr("x",this.axisToSvg("x",e.x,this.isndc)).attr("y",this.axisToSvg("y",e.y,this.isndc)).attr("width",`${Math.abs(t.x-e.x)*100}%`).attr("height",`${Math.abs(t.y-e.y)*100}%`).attr("fill",i).attr("stroke",o).attr("stroke-width",h).attr("pointer-events","fill");return s&&(T.datum(s),this.attachPointerEventsTreeMap(T,s)),T}appendText(e,t,i,o,h="start"){return this.getG().append("text").attr("x",this.axisToSvg("x",t.x,this.isndc)).attr("y",this.axisToSvg("y",t.y,this.isndc)).attr("font-size",`${i}vw`).attr("fill",o).attr("text-anchor",h).attr("pointer-events","none").text(e)}getRgbList(e){return e.slice(4,-1).split(",").map(t=>parseInt(t))}toRgbStr(e){return`rgb(${e.join()})`}attachPointerEventsTreeMap(e,t){let i=e.attr("fill"),o=this.toRgbStr(this.getRgbList(i).map(n=>Math.min(n+r.CONSTANTS.COLOR_HOVER_BOOST,255))),h=()=>{e.attr("fill",o),this.tooltip.content=this.tooltip.generateTooltipContent(t),this.tooltip.x=0,this.tooltip.y=0},s=()=>{e.attr("fill",i),this.tooltip.hideTooltip()},T=n=>{this.tooltip.x=n.pageX,this.tooltip.y=n.pageY,this.tooltip.showTooltip()},c=()=>{let n=this.getObject(),a=n.fNodes.findIndex(l=>l===t);if(a===this.rootIndex)this.rootIndex=this.parentIndices[a];else{let l=a;for(;this.parentIndices[l]!==this.rootIndex;)l=this.parentIndices[l];this.rootIndex=l,n.fNodes[l].fNChildren===0&&(this.rootIndex=this.parentIndices[a])}this.redraw()};this.attachPointerEvents(e,{mouseenter:h,mouseleave:s,mousemove:T,click:c})}attachPointerEventsLegend(e,t){let i=this.getG().selectAll("rect"),o=()=>{i.filter(s=>s!==void 0&&s.fType!==t).attr("opacity","0.5")},h=()=>{i.attr("opacity","1")};this.attachPointerEvents(e,{mouseenter:o,mouseleave:h,mousemove:()=>{},click:()=>{}})}attachPointerEvents(e,t){for(let[i,o]of Object.entries(t))e.on(i,o)}computeColor(e){let t=Number(_(String(e))&0xFFFFFFFFn),i=t>>16&255,o=t>>8&255,h=t&255;return this.toRgbStr([i,o,h])}getDataStr(e){let t=r.CONSTANTS.DATA_UNITS,i=Math.floor(Math.log10(e)/3);return`${(e/Math.pow(1e3,i)).toFixed(2)}${t[i]}`}computeWorstRatio(e,t,i,o,h){if(e.length===0)return 0;let s=e.reduce((c,n)=>c+n.fSize,0);if(s===0)return 0;let T=0;for(let c of e){let n=h?c.fSize*t*o/(s*s*i):c.fSize*i*o/(s*s*t),a=Math.max(n,1/n);a>T&&(T=a)}return T}squarifyChildren(e,t,i,o){let h=t.topRight.x-t.bottomLeft.x,s=t.topRight.y-t.bottomLeft.y,T=[...e].sort((a,l)=>l.fSize-a.fSize),c=[],n=u({},t.bottomLeft);for(;T.length>0;){let a=[],l=1/0,x=t.topRight.x-n.x,N=t.topRight.y-n.y;if(x<=0||N<=0)break;for(;T.length>0;){a.push(T.shift());let S=this.computeWorstRatio(a,x,N,o,i);if(S>l){T.unshift(a.pop());break}l=S}let f=a.reduce((S,E)=>S+E.fSize,0);if(f===0)continue;let d=i?f/o*s:f/o*h,p=0;for(let S of a){let E=S.fSize/f*(i?h:s),I=i?{x:n.x+p,y:n.y}:{x:n.x,y:n.y+p},g=i?{x:n.x+p+E,y:n.y+d}:{x:n.x+d,y:n.y+p+E};c.push({node:S,rect:{bottomLeft:I,topRight:g}}),p+=E}i?n.y+=d:n.x+=d}return c}drawLegend(){let e=this.getObject(),t={},i=[this.rootIndex];for(;i.length>0;){let s=e.fNodes[i.pop()];s.fNChildren===0&&(t[s.fType]=(t[s.fType]||0)+s.fSize),i=i.concat(Array.from({length:s.fNChildren},(T,c)=>c+s.fChildrenIdx))}let o=Object.entries(t).sort((s,T)=>T[1]-s[1]).slice(0,r.CONSTANTS.LEGEND.MAX_ITEMS).filter(([,s])=>s>0),h=r.CONSTANTS.LEGEND;o.forEach(([s,T],c)=>{let n=h.START_Y-c*h.ITEM_HEIGHT,a=h.START_Y+h.ITEM_HEIGHT+h.TEXT_OFFSET_X,l=r.CONSTANTS.TEXT.SIZE_VW,x=this.appendRect({x:h.START_Y,y:n},{x:h.START_Y+h.ITEM_HEIGHT,y:n-h.ITEM_HEIGHT},this.computeColor(s));this.attachPointerEventsLegend(x,s);let N=`${(T/e.fNodes[this.rootIndex].fSize*100).toFixed(2)}%`,f=`(${this.getDataStr(T)} / ${this.getDataStr(e.fNodes[this.rootIndex].fSize)})`;[s,f,N].forEach((d,p)=>this.appendText(d,{x:a,y:n-h.TEXT_OFFSET_Y-h.TEXT_LINE_SPACING*p},l,"black"))})}trimText(e,t){let i=e.node(),o=i.textContent,h=Math.abs(this.axisToSvg("x",t.topRight.x,this.isndc)-this.axisToSvg("x",t.bottomLeft.x,this.isndc))-r.CONSTANTS.TEXT.PADDING;for(;i.getComputedTextLength&&i.getComputedTextLength()>h&&o.length>0;)o=o.slice(0,-1),i.textContent=o+"\u2026";return o}drawTreeMap(e,t,i=0){let o=e.fNChildren===0,h=o?this.computeColor(e.fType):"rgb(100,100,100)";this.appendRect({x:t.bottomLeft.x,y:t.topRight.y},{x:t.topRight.x,y:t.bottomLeft.y},h,r.CONSTANTS.STROKE_COLOR,r.CONSTANTS.STROKE_WIDTH,e);let s=t.topRight.x-t.bottomLeft.x,T=t.topRight.y-t.bottomLeft.y,c=`${e.fName} (${this.getDataStr(e.fSize)})`,n=r.CONSTANTS.TEXT,a=s<=n.MIN_RECT_WIDTH||T<=n.MIN_RECT_HEIGHT?0:n.SIZE_VW;if(a>0){let l=this.appendText(c,{x:t.bottomLeft.x+(o?s/2:r.CONSTANTS.INDENT),y:o?(t.bottomLeft.y+t.topRight.y)/2:t.topRight.y-n.LEAF_OFFSET_Y},a,"white",o?"middle":"start");l.textContent=this.trimText(l,t)}if(!o&&e.fNChildren>0){let l=this.getObject(),x=l.fNodes.slice(e.fChildrenIdx,e.fChildrenIdx+e.fNChildren),N=x.reduce((f,d)=>f+d.fSize,0);if(N>0){let f=r.CONSTANTS.INDENT,d={bottomLeft:{x:t.bottomLeft.x+f,y:t.bottomLeft.y+f},topRight:{x:t.topRight.x-f,y:t.topRight.y-f*r.CONSTANTS.LEGEND_INDENT_MULTIPLIER}},p=d.topRight.x-d.bottomLeft.x,S=d.topRight.y-d.bottomLeft.y,E=p>S;this.squarifyChildren(x,d,E,N).forEach(({node:g,rect:A})=>{this.drawTreeMap(g,A,i+1)})}}}createParentIndices(){let e=this.getObject();this.parentIndices=new Array(e.fNodes.length).fill(0),e.fNodes.forEach((t,i)=>{for(let o=t.fChildrenIdx;o<t.fChildrenIdx+t.fNChildren;o++)this.parentIndices[o]=i})}getDirectory(){let e=this.getObject(),t="",i=this.rootIndex;for(;i!==0;)t=e.fNodes[i].fName+"/"+t,i=this.parentIndices[i];return t}redraw(){let e=this.getPadPainter().getFrameSvg();e.empty()||(e.style("display","none"),this._frame_hidden=!0);let t=this.getObject();if(this.createG(),this.isndc=!0,t.fNodes&&t.fNodes.length>0){this.createParentIndices();let i=r.CONSTANTS.MAIN_TREEMAP;this.drawTreeMap(t.fNodes[this.rootIndex],{bottomLeft:{x:i.LEFT,y:i.BOTTOM},topRight:{x:i.RIGHT,y:i.TOP}}),this.drawLegend(),this.appendText(this.getDirectory(),{x:r.CONSTANTS.MAIN_TREEMAP.LEFT,y:r.CONSTANTS.MAIN_TREEMAP.TOP+.01},r.CONSTANTS.TEXT.SIZE_VW,"black")}return this}static draw(e,t,i){return y(this,null,function*(){let o=new r(e,t,i);return m(o,!1).then(()=>o.redraw())})}}return r})();export{v as a};
