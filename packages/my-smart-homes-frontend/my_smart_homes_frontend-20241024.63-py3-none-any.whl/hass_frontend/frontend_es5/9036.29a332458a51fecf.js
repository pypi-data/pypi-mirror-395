"use strict";(self.webpackChunkhome_assistant_frontend=self.webpackChunkhome_assistant_frontend||[]).push([["9036"],{7527:function(e,t,r){r.a(e,async function(e,a){try{r.r(t);r(79827),r(35748),r(99342),r(35058),r(86149),r(65315),r(837),r(22416),r(88238),r(34536),r(16257),r(20152),r(44711),r(72108),r(77030),r(39118),r(95013);var s=r(69868),o=r(84922),i=r(11991),l=r(75907),n=(r(70490),r(86160),r(43716)),u=r(40328),c=r(80475),h=r(94327),d=r(8868),_=r(73941),g=r(75335),y=e([c,n,d]);[c,n,d]=y.then?(await y)():y;let p,v,f,b,m,x=e=>e;const w={group_by_floor:!0,group_by_area:!0};class M extends((0,u.E)((0,g.Q)(o.WF))){setConfig(e){this._config=Object.assign(Object.assign({},w),e)}hassSubscribe(){var e;return[(0,n.tb)(this.hass,{key:null===(e=this._config)||void 0===e?void 0:e.collection_key}).subscribe(e=>{this._data=e})]}getCardSize(){return 5}getGridOptions(){return{columns:12,min_columns:6,rows:6,min_rows:2}}shouldUpdate(e){if(e.has("_config")||e.has("_data")||e.has("_isMobileSize"))return!0;if(e.has("hass")){const t=e.get("hass");if(!t||!this._entities.size)return!0;for(const e of this._entities)if(t.states[e]!==this.hass.states[e])return!0}return!1}render(){if(!this._config)return o.s6;if(!this._data)return(0,o.qy)(p||(p=x`${0}`),this.hass.localize("ui.panel.lovelace.cards.energy.loading"));const e=this._data.prefs,t=this._computePowerData(e),r=getComputedStyle(this),a=[],s=[],i={id:"home",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.home"),value:Math.max(0,t.used_total),color:r.getPropertyValue("--primary-color").trim(),index:1};a.push(i),t.from_battery>0&&(a.push({id:"battery",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.battery"),value:t.from_battery,color:r.getPropertyValue("--energy-battery-out-color").trim(),index:0}),s.push({source:"battery",target:"home"})),t.to_battery>0&&(a.push({id:"battery_in",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.battery"),value:t.to_battery,color:r.getPropertyValue("--energy-battery-in-color").trim(),index:1}),t.grid_to_battery>0&&s.push({source:"grid",target:"battery_in"}),t.solar_to_battery>0&&s.push({source:"solar",target:"battery_in"})),t.from_grid>0&&(a.push({id:"grid",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.grid"),value:t.from_grid,color:r.getPropertyValue("--energy-grid-consumption-color").trim(),index:0}),s.push({source:"grid",target:"home"})),t.solar>0&&(a.push({id:"solar",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.solar"),value:t.solar,color:r.getPropertyValue("--energy-solar-color").trim(),index:0}),s.push({source:"solar",target:"home"})),t.to_grid>0&&(a.push({id:"grid_return",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_distribution.grid"),value:t.to_grid,color:r.getPropertyValue("--energy-grid-return-color").trim(),index:2}),t.battery_to_grid>0&&s.push({source:"battery",target:"grid_return"}),t.solar_to_grid>0&&s.push({source:"solar",target:"grid_return"}));let n=i.value;const u=[],c={};e.device_consumption.forEach((e,t)=>{if(!e.stat_rate)return;const a=this._getCurrentPower(e.stat_rate);if(a<.01)return;const o={id:e.stat_rate,label:e.name||this._getEntityLabel(e.stat_rate),value:a,color:(0,h.fI)(t,r),index:4,parent:e.included_in_stat};o.parent?(c[o.id]=o.parent,s.push({source:o.parent,target:o.id})):n-=a,u.push(o)});const d=u.filter(e=>!c[e.id]),{group_by_area:_,group_by_floor:g}=this._config;if(_||g){const{areas:e,floors:t}=this._groupByFloorAndArea(d);Object.keys(t).sort((e,t)=>{var r,a,s,o;return(null!==(r=null===(a=this.hass.floors[t])||void 0===a?void 0:a.level)&&void 0!==r?r:-1/0)-(null!==(s=null===(o=this.hass.floors[e])||void 0===o?void 0:o.level)&&void 0!==s?s:-1/0)}).forEach(o=>{let i=`floor_${o}`;"no_floor"!==o&&g?(a.push({id:i,label:this.hass.floors[o].name,value:t[o].value,index:2,color:r.getPropertyValue("--primary-color").trim()}),s.push({source:"home",target:i})):i="home",t[o].areas.forEach(t=>{let o;if("no_area"!==t&&_){var l;const n=`area_${t}`;a.push({id:n,label:(null===(l=this.hass.areas[t])||void 0===l?void 0:l.name)||t,value:e[t].value,index:3,color:r.getPropertyValue("--primary-color").trim()}),s.push({source:i,target:n,value:e[t].value}),o=n}else o=i;e[t].devices.forEach(e=>{s.push({source:o,target:e.id,value:e.value})})})})}else d.forEach(e=>{s.push({source:"home",target:e.id,value:e.value})});const y=this._getDeviceSections(c,u);y.forEach((e,t)=>{e.forEach(e=>{a.push(Object.assign(Object.assign({},e),{},{index:4+t}))})}),n>0&&(a.push({id:"untracked",label:this.hass.localize("ui.panel.lovelace.cards.energy.energy_devices_detail_graph.untracked_consumption"),value:n,color:r.getPropertyValue("--state-unavailable-color").trim(),index:3+y.length}),s.push({source:"home",target:"untracked",value:n}));const m=a.some(e=>e.value>0),w="vertical"===this._config.layout||"horizontal"!==this._config.layout&&this._isMobileSize;return(0,o.qy)(v||(v=x` <ha-card .header="${0}" class="${0}"> <div class="card-content"> ${0} </div> </ha-card> `),this._config.title,(0,l.H)({"is-grid":"grid"===this.layout,"is-panel":"panel"===this.layout,"is-vertical":w}),m?(0,o.qy)(f||(f=x`<ha-sankey-chart .data="${0}" .vertical="${0}" .valueFormatter="${0}"></ha-sankey-chart>`),{nodes:a,links:s},w,this._valueFormatter):(0,o.qy)(b||(b=x`${0}`),this.hass.localize("ui.panel.lovelace.cards.energy.no_data")))}_computePowerData(e){this._entities.clear();let t=0,r=0,a=0,s=0,o=0;e.energy_sources.filter(e=>"solar"===e.type).forEach(e=>{if("solar"===e.type&&e.stat_rate){const r=this._getCurrentPower(e.stat_rate);r>0&&(t+=r)}}),e.energy_sources.filter(e=>"grid"===e.type&&e.power).forEach(e=>{"grid"===e.type&&e.power&&e.power.forEach(e=>{const t=this._getCurrentPower(e.stat_rate);t>0?r+=t:t<0&&(a+=Math.abs(t))})}),e.energy_sources.filter(e=>"battery"===e.type).forEach(e=>{if("battery"===e.type&&e.stat_rate){const t=this._getCurrentPower(e.stat_rate);t>0?s+=t:t<0&&(o+=Math.abs(t))}});const i=r+t+s-a-o;let l=t,n=r,u=s,c=o,h=a,d=Math.max(i,0),_=0,g=0,y=0,p=0,v=0,f=0,b=0;const m=Math.max(0,Math.min(c,n-d));_+=m,c-=m,n-=m,y=Math.min(l,c),c-=y,l-=y,p=Math.min(l,h),h-=p,l-=p,g=Math.min(u,h),u-=g,h-=g;const x=Math.min(n,c);return _+=x,n-=x,c-=x,v=Math.min(d,l),d-=v,l-=v,f=Math.min(u,d),u-=f,d-=f,b=Math.min(d,n),n-=b,d-=b,{solar:t,from_grid:r,to_grid:a,from_battery:s,to_battery:o,grid_to_battery:_,battery_to_grid:g,solar_to_battery:y,solar_to_grid:p,used_solar:v,used_grid:b,used_battery:f,used_total:Math.max(0,i)}}_groupByFloorAndArea(e){const t={no_area:{value:0,devices:[]}},r={no_floor:{value:0,areas:["no_area"]}};return e.forEach(e=>{const a=this.hass.states[e.id],{area:s,floor:o}=a?(0,_.l)(a,this.hass.entities,this.hass.devices,this.hass.areas,this.hass.floors):{area:null,floor:null};s?(s.area_id in t?(t[s.area_id].value+=e.value,t[s.area_id].devices.push(e)):t[s.area_id]={value:e.value,devices:[e]},o?o.floor_id in r?(r[o.floor_id].value+=e.value,r[o.floor_id].areas.includes(s.area_id)||r[o.floor_id].areas.push(s.area_id)):r[o.floor_id]={value:e.value,areas:[s.area_id]}:(r.no_floor.value+=e.value,r.no_floor.areas.includes(s.area_id)||r.no_floor.areas.unshift(s.area_id))):(t.no_area.value+=e.value,t.no_area.devices.push(e))}),{areas:t,floors:r}}_getDeviceSections(e,t){const r=[],a=[],s=Object.values(e),o={};return t.forEach(t=>{const o=t.id in e;s.includes(t.id)&&!o?r.push(t):a.push(t)}),Object.entries(e).forEach(([e,t])=>{r.some(e=>e.id===t)||(o[e]=t)}),r.length>0?[r,...this._getDeviceSections(o,a)]:[t]}_getCurrentPower(e){this._entities.add(e);const t=this.hass.states[e];if(!t)return 0;const r=parseFloat(t.state);if(isNaN(r))return 0;switch(t.attributes.unit_of_measurement){case"W":return r/1e3;case"mW":return r/1e6;case"MW":return 1e3*r;case"GW":return 1e6*r;case"TW":return 1e9*r;default:return r}}_getEntityLabel(e){const t=this.hass.states[e];return t&&t.attributes.friendly_name||e}constructor(...e){super(...e),this._entities=new Set,this.hassSubscribeRequiredHostProps=["_config"],this._valueFormatter=e=>`<div style="direction:ltr; display: inline;">\n      ${(0,d.ZV)(e,this.hass.locale,e<.1?{maximumFractionDigits:3}:void 0)}\n      kW</div>`}}M.styles=(0,o.AH)(m||(m=x`ha-card{height:400px;display:flex;flex-direction:column;--chart-max-height:none}ha-card.is-vertical{height:500px}ha-card.is-grid,ha-card.is-panel{height:100%}.card-content{flex:1;display:flex}`)),(0,s.__decorate)([(0,i.MZ)({attribute:!1})],M.prototype,"hass",void 0),(0,s.__decorate)([(0,i.MZ)({attribute:!1})],M.prototype,"layout",void 0),(0,s.__decorate)([(0,i.wk)()],M.prototype,"_config",void 0),(0,s.__decorate)([(0,i.wk)()],M.prototype,"_data",void 0),M=(0,s.__decorate)([(0,i.EM)("hui-power-sankey-card")],M),a()}catch(p){a(p)}})}}]);
//# sourceMappingURL=9036.29a332458a51fecf.js.map