name: Build and Attach DMG to Release

on:
  release:
    types: [created]

permissions:
  contents: write
  
jobs:
  build-dmg:
    runs-on: macos-latest
    env:
      HAS_MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE != '' }}
      HAS_MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD != '' }}
      VERSION: ${{ github.event.release.tag_name }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install uv
      uses: astral-sh/setup-uv@v5

    - name: Install project dependencies
      run: |
        uv sync

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Set up CocoaPods
      uses: maxim-lobanov/setup-cocoapods@v1
      with:
        version: latest

    - name: Import Code Signing Certificate (if available)
      if: ${{ env.HAS_MACOS_CERTIFICATE == 'true' && env.HAS_MACOS_CERTIFICATE_PASSWORD == 'true' }}
      run: |
        set -e  # Exit on any error
        
        # Create temporary keychain
        KEYCHAIN_PASSWORD="temp_keychain_password"
        KEYCHAIN_NAME="temp.keychain-db"
        
        security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
        security default-keychain -s "$KEYCHAIN_NAME"
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
        security set-keychain-settings -t 3600 -u "$KEYCHAIN_NAME"
        
        # Decode PKCS12 certificate
        echo "${{ secrets.MACOS_CERTIFICATE }}" | base64 --decode > certificate.p12
        
        # Verify file exists and has content
        if [ ! -s certificate.p12 ]; then
            echo "âŒ Certificate file is empty or missing"
            exit 1
        fi
        
        # Import PKCS12 to keychain (specifying format explicitly is required)
        echo "Importing certificate..."
        security import certificate.p12 \
            -k "$KEYCHAIN_NAME" \
            -P "${{ secrets.MACOS_CERTIFICATE_PASSWORD }}" \
            -f pkcs12 \
            -T /usr/bin/codesign
        
        # Allow codesign to access the certificate
        security set-key-partition-list \
            -S apple-tool:,apple:,codesign: \
            -s \
            -k "$KEYCHAIN_PASSWORD" \
            "$KEYCHAIN_NAME" 2>/dev/null || true
        
        # Set code signing identity
        if [ -n "${{ secrets.CODESIGN_IDENTITY }}" ]; then
            echo "CODESIGN_IDENTITY=${{ secrets.CODESIGN_IDENTITY }}" >> $GITHUB_ENV
            echo "âœ… Code signing certificate imported: ${{ secrets.CODESIGN_IDENTITY }}"
        else
            # Auto-detect identity from certificate
            CERT_IDENTITY=$(security find-identity -v -p codesigning "$KEYCHAIN_NAME" | grep -v "0 valid identities" | head -1 | awk -F'"' '{print $2}')
            if [ -z "$CERT_IDENTITY" ]; then
                # Fallback to any identity if no codesigning specific one found
                CERT_IDENTITY=$(security find-identity -v "$KEYCHAIN_NAME" | grep -v "0 valid identities" | head -1 | awk -F'"' '{print $2}')
            fi
            
            if [ -z "$CERT_IDENTITY" ]; then
                echo "âŒ No signing identity found"
                exit 1
            fi
            
            echo "CODESIGN_IDENTITY=$CERT_IDENTITY" >> $GITHUB_ENV
            echo "âœ… Code signing certificate imported (auto-detected): $CERT_IDENTITY"
        fi
        
        # Clean up
        rm -f certificate.p12

    - name: Build DMG
      run: |
        make build-mac

    - name: Cleanup Code Signing
      if: ${{ env.HAS_MACOS_CERTIFICATE == 'true' && env.HAS_MACOS_CERTIFICATE_PASSWORD == 'true' }}
      run: |
        # Remove temporary keychain
        security delete-keychain temp.keychain || true
        echo "ðŸ§¹ Cleaned up code signing keychain"

    - name: Find and verify DMG was created
      id: find-dmg
      run: |
        ls -la gui_dist/
        DMG_FILE=$(find gui_dist/ -name "*.dmg" -type f | head -1)
        if [ -z "$DMG_FILE" ]; then
          echo "âŒ DMG file not found!"
          echo "Contents of gui_dist/:"
          ls -la gui_dist/ || echo "gui_dist/ directory not found"
          exit 1
        fi
        echo "âœ… DMG file created successfully: $DMG_FILE"
        echo "dmg_path=$DMG_FILE" >> $GITHUB_OUTPUT
        echo "dmg_name=$(basename $DMG_FILE)" >> $GITHUB_OUTPUT

    - name: Get DMG info
      id: dmg-info
      run: |
        DMG_SIZE=$(ls -lh "${{ steps.find-dmg.outputs.dmg_path }}" | awk '{print $5}')
        echo "size=$DMG_SIZE" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ DMG Size: $DMG_SIZE"
        echo "ðŸ“¦ DMG Name: ${{ steps.find-dmg.outputs.dmg_name }}"

    - name: Upload DMG to Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release upload ${{ github.event.release.tag_name }} \
          "${{ steps.find-dmg.outputs.dmg_path }}" \
          --clobber \
          --repo ${{ github.repository }}