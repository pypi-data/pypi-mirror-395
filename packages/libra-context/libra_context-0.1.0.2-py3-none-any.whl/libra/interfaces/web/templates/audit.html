{% extends "base.html" %}

{% block title %}Audit Log{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Audit Log</h1>
    <p>View context request history</p>
</div>

<form method="GET" action="{{ url_for('audit_page') }}">
    <div class="filters">
        <div class="form-group">
            <label for="agent_id">Agent</label>
            <input type="text" name="agent_id" id="agent_id" placeholder="Filter by agent" value="{{ filter_agent or '' }}">
        </div>
        <div class="form-group">
            <button type="submit" class="btn btn-primary">Filter</button>
            <a href="{{ url_for('audit_page') }}" class="btn btn-secondary">Clear</a>
        </div>
    </div>
</form>

{% if entries %}
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Agent</th>
                <th>Task</th>
                <th>Contexts Served</th>
                <th>Tokens Used</th>
                <th>Budget</th>
                <th>Mode</th>
                <th>Latency</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in entries %}
            <tr>
                <td>{{ entry.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>{{ entry.agent_id or 'anonymous' }}</td>
                <td class="content-preview">{{ entry.task[:60] }}{% if entry.task|length > 60 %}...{% endif %}</td>
                <td>{{ entry.contexts_served|length }}</td>
                <td>{{ entry.tokens_used }}</td>
                <td>{{ entry.tokens_budget }}</td>
                <td>{{ entry.librarian_mode }}</td>
                <td>{{ entry.latency_ms }}ms</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if total_pages > 1 %}
<div class="pagination">
    {% if current_page > 1 %}
    <a href="{{ url_for('audit_page', page=current_page - 1, agent_id=filter_agent) }}">&laquo; Prev</a>
    {% else %}
    <span class="disabled">&laquo; Prev</span>
    {% endif %}

    {% for p in range(1, total_pages + 1) %}
        {% if p == current_page %}
        <span class="active">{{ p }}</span>
        {% elif p == 1 or p == total_pages or (p >= current_page - 2 and p <= current_page + 2) %}
        <a href="{{ url_for('audit_page', page=p, agent_id=filter_agent) }}">{{ p }}</a>
        {% elif p == current_page - 3 or p == current_page + 3 %}
        <span>...</span>
        {% endif %}
    {% endfor %}

    {% if current_page < total_pages %}
    <a href="{{ url_for('audit_page', page=current_page + 1, agent_id=filter_agent) }}">Next &raquo;</a>
    {% else %}
    <span class="disabled">Next &raquo;</span>
    {% endif %}
</div>
{% endif %}

<p style="margin-top: 1rem; color: var(--color-text-muted);">
    Showing {{ entries|length }} of {{ total_entries }} entries
</p>
{% else %}
<div class="empty-state">
    <h3>No audit entries found</h3>
    {% if filter_agent %}
    <p>Try <a href="{{ url_for('audit_page') }}">clearing the filter</a> to see all entries.</p>
    {% else %}
    <p>Audit entries will appear here when contexts are queried.</p>
    {% endif %}
</div>
{% endif %}
{% endblock %}
