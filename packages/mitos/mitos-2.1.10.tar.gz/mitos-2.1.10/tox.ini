[tox]
envlist = lint, type, py37, integration-py37
isolated_build = true

; Shared settings for all environments unless overridden
[testenv]
usedevelop = true

[testenv:lint]
basepython = python3.7
deps =
    flake8==5.0.4
    black==22.10.0
    isort==5.11.5
commands =
    black --check --diff .
    isort --check-only .
    flake8

[testenv:type]
deps =
    mypy==1.4.1
    types-setuptools
commands = mypy .

[testenv:py37]
deps =
    pytest==7.4.4
commands = pytest test

[testenv:integration-py37]
install_command = pip install --no-deps {opts} {packages}
usedevelop = false
allowlist_externals =
    mkdir
    bash
    diff
conda_channels =
    conda-forge
    bioconda
conda_deps =
    python=3.7
    biopython==1.73
    blast>=2.9
    hmmer=3.4
    infernal>=1.1.5
    viennarna
    r-base
    r-ggplot2
    r-reshape2
    typing_extensions
    openjdk >8
    reportlab
    pillow
    libtiff
commands =
    ; simple test showing help
    runmitos -h

    ; run refseq63 reference data on small sequence
    mkdir -p NC_012920
    runmitos -i test/NC_012920.fasta -o NC_012920 -R refdata/ -r refseq63m -c 2 --zip
    python -c "import os; assert os.path.exists('NC_012920/result.png')"
    python -c "import os; assert os.path.exists('NC_012920.zip')"
    ; compare result.mitos with expected output
    diff NC_012920/result.mitos test/result_NC_012920.mitos

    ; test --alarab
    runmitos -i test/NC_012920.fasta -o NC_012920 -R refdata/ -r refseq63m -c 2 --alarab --zip
    ; compare result.mitos with expected output
    diff NC_012920/result.mitos test/result_NC_012920_alarab.mitos

    ;------------------ functional tests for scripts ----------------------

    ; analyse.py
    bash -c "analyse -n cox1 -s 16569 test/NC_012920.bed test/NC_012920.bed > test/output_analyse.txt"
    diff test/output_analyse.txt test/result_analyse.txt

    ; drawmitos.py
    drawmitos -i test/NC_012920.bed -o test/output_drawmitos.png -l 16569
    diff test/output_drawmitos.png test/result_NC_012920.png

    ; gcpp.py
    bash -c "gcpp -r 5 1 2 3 > test/output_gcpp.txt"
    diff test/output_gcpp.txt test/result_gcpp.txt

    ; getfeatures.py
    bash -c "getfeatures test/NC_019653.gb -f '> %name %start %stop %s' -n trnS2 > test/output_getfeatures.txt"
    diff test/output_getfeatures.txt test/result_getfeatures.txt

    ; getinfo.py
    getinfo -f ">%a %n %c %s" -o test/output_getinfo.txt test/NC_019653.gb
    diff test/output_getinfo.txt test/result_getinfo.txt

    ; refseqsplit.py
    refseqsplit -f test/dummy_genbank.gb -d test -t Bacteria -v
    diff test/DUMMY1.gb test/result_refseqsplit.gb

    ; subseq.py
    subseq -f test/NC_019653.gb -m "> %a %s" -o test/output_subseq.txt --position 0,10,1
    diff test/output_subseq.txt test/result_subseq.txt

    ; taxtree.py
    bash -c "taxtree \
        --gbdir test/taxtree_test \
        --names test/taxtree_test/taxtree_names.dmp \
        --nodes test/taxtree_test/taxtree_nodes.dmp \
        --merged test/taxtree_test/taxtree_merged.dmp \
        > test/output_taxtree.txt"
    diff test/output_taxtree.txt test/result_taxtree.txt

    ; update_blastdb.py
    update_blastdb --indir test/update_blastdb_test --beddir test/update_blastdb_test --outdir test/update_blastdb_test
    diff test/update_blastdb_test/auxinfo.json test/result_update_blastdb.json

    ; update_hmm.py
    bash -c "update_hmm -gb test/update_hmm_test -hm test/update_hmm_test -o test/update_hmm_test/output"
    python test/update_hmm_test/update_hmm_check_output.py
    bash -c "tail -n +17 test/update_hmm_test/output/new_hmms/cox1.db > test/update_hmm_test/output/new_hmms/cox1_tail.db"
    bash -c "tail -n +17 test/update_hmm_test/output/new_hmms/nad2.db > test/update_hmm_test/output/new_hmms/nad2_tail.db"
    diff test/update_hmm_test/output/new_hmms/cox1_tail.db test/update_hmm_test/expected/cox1_expected.db
    diff test/update_hmm_test/output/new_hmms/nad2_tail.db test/update_hmm_test/expected/nad2_expected.db
