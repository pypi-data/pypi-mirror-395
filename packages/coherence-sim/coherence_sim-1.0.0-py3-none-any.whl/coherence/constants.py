"""
Фундаментальные константы Вселенной.

Этот модуль содержит измеренные физические константы,
используемые в моделях когерентности и голографических расчётах.

Размерный анализ
----------------
Все величины в модели безразмерные, кроме масс бозонов:

- alpha (α_fs): безразмерная, ≈ 1/137
- A_s: безразмерная, амплитуда скалярных возмущений
- n_s: безразмерная, спектральный индекс
- m_z, m_w: [ГэВ], массы бозонов
- k: безразмерная (в голографической формуле)

Формулы для k:
1. k = π × α × ln(1/A_s) / n_s  — полностью безразмерная
2. k = (49/8) × α × Δm / M_ref  — требует M_ref = 1 ГэВ для безразмерности
"""

from dataclasses import dataclass, field
from typing import Dict

import numpy as np

# Нормирующий масштаб массы для формулы с бозонами [ГэВ]
M_REF_GEV: float = 1.0


@dataclass
class UniverseConstants:
    """
    Фундаментальные константы нашей Вселенной.

    Атрибуты:
    ---------
    alpha : float
        Постоянная тонкой структуры (≈ 1/137) [безразмерная]
    A_s : float
        Амплитуда скалярных возмущений (Planck 2018) [безразмерная]
    n_s : float
        Спектральный индекс (Planck 2018) [безразмерная]
    m_z : float
        Масса Z-бозона [ГэВ]
    m_w : float
        Масса W-бозона [ГэВ]
    k_observed : float
        Голографический параметр (наблюдаемый) [безразмерная]

    Примеры:
    --------
    >>> from coherence.constants import UniverseConstants
    >>> c = UniverseConstants()
    >>> print(f"1/α ≈ {c.inverse_alpha:.2f}")
    1/α ≈ 137.04
    """

    # Постоянная тонкой структуры (электромагнитное взаимодействие) [безразмерная]
    alpha: float = 0.0072973525693

    # Космологические параметры (Planck 2018) [безразмерные]
    A_s: float = 2.100e-9  # Амплитуда скалярных возмущений
    n_s: float = 0.9649  # Спектральный индекс

    # Массы бозонов [ГэВ]
    m_z: float = 91.1876  # Масса Z-бозона
    m_w: float = 80.3790  # Масса W-бозона

    # Голографический параметр (наблюдаемый) [безразмерная]
    k_observed: float = 0.483678

    # Расширенные космологические параметры (Planck 2018)
    H0: float = 67.36  # Постоянная Хаббла [км/с/Мпк]
    Omega_m: float = 0.315  # Плотность материи [безразмерная]
    Omega_lambda: float = 0.685  # Плотность тёмной энергии [безразмерная]
    sigma_8: float = 0.811  # Амплитуда флуктуаций [безразмерная]

    # Неопределённости измерений
    uncertainties: Dict[str, float] = field(
        default_factory=lambda: {
            "alpha": 0.0000000011,
            "A_s": 0.030e-9,
            "n_s": 0.0042,
            "m_z": 0.0021,
            "m_w": 0.012,
            "k": 0.007725,
        }
    )

    @property
    def delta_m(self) -> float:
        """Разность масс бозонов (m_Z - m_W)."""
        return self.m_z - self.m_w

    @property
    def inverse_alpha(self) -> float:
        """Обратная постоянная тонкой структуры (≈ 137)."""
        return 1 / self.alpha

    @property
    def k_over_alpha(self) -> float:
        """Соотношение k/α (≈ 66)."""
        return self.k_observed / self.alpha

    def k_formula_old(self, m_ref: float = M_REF_GEV) -> float:
        """
        Вычисление k по формуле с массами бозонов.

        k = (49/8) × α × Δm / M_ref

        Для безразмерности требуется нормирующий масштаб M_ref.
        При M_ref = 1 ГэВ формула численно совпадает с наблюдаемым k.

        Parameters:
        -----------
        m_ref : float
            Нормирующий масштаб массы [ГэВ]. По умолчанию 1 ГэВ.

        Returns:
        --------
        float
            Теоретическое значение k [безразмерная]

        Note:
        -----
        Физическое обоснование M_ref = 1 ГэВ требует дополнительного
        исследования. Возможные кандидаты: масса протона, характерный
        масштаб QCD, или это просто численное совпадение.
        """
        return (49 / 8) * self.alpha * self.delta_m / m_ref

    def k_formula_new(self) -> float:
        """
        Вычисление k по голографической формуле.

        k = π × α × ln(1/A_s) / n_s

        Эта формула полностью безразмерная:
        - π: безразмерная математическая константа
        - α: безразмерная (постоянная тонкой структуры)
        - ln(1/A_s): безразмерная (логарифм безразмерной величины)
        - n_s: безразмерная (спектральный индекс)

        Returns:
        --------
        float
            Теоретическое значение k [безразмерная]
        """
        return np.pi * self.alpha * np.log(1 / self.A_s) / self.n_s

    def k_formula_dark_energy(self) -> float:
        """
        Вычисление k с учётом тёмной энергии.

        k = k_holographic × (1 - Ω_λ)

        Returns:
        --------
        float
            Теоретическое значение k с поправкой на тёмную энергию
        """
        return self.k_formula_new() * (1 - self.Omega_lambda)

    def k_formula_entropic(self) -> float:
        """
        Энтропийная формула для k.

        k = α × 66 (эмпирическое соотношение)

        Returns:
        --------
        float
            Значение k по энтропийной формуле
        """
        return self.alpha * 66.0

    def k_formula_information(self) -> float:
        """
        Информационная формула для k.

        k = α × π × ln(10) / n_s

        Returns:
        --------
        float
            Значение k по информационной формуле
        """
        S_planck = np.pi * np.log(10)  # Энтропия Планка
        return self.alpha * S_planck / self.n_s

    def k_error_percent(self, formula: str = "new") -> float:
        """
        Относительная ошибка формулы (%).

        Parameters:
        -----------
        formula : str
            'new' или 'old'

        Returns:
        --------
        float
            Ошибка в процентах
        """
        k_theoretical = self.k_formula_new() if formula == "new" else self.k_formula_old()
        return abs(self.k_observed - k_theoretical) / self.k_observed * 100

    def effective_alpha(self, scale: float = 100) -> float:
        """
        Эффективный параметр α для модели когерентности.

        α_eff = k / (scale × α)

        Parameters:
        -----------
        scale : float
            Масштабный фактор (по умолчанию 100)

        Returns:
        --------
        float
            Эффективный α (≈ 0.66 при scale=100)
        """
        return self.k_observed / (scale * self.alpha)

    def summary(self) -> str:
        """Текстовое описание всех констант."""
        return f"""
Фундаментальные константы Вселенной:
====================================
Постоянная тонкой структуры:
  α = {self.alpha:.10f}
  1/α = {self.inverse_alpha:.4f}

Космологические параметры (Planck 2018):
  A_s = {self.A_s:.3e}
  n_s = {self.n_s:.4f}

Массы бозонов:
  m_Z = {self.m_z:.4f} ГэВ
  m_W = {self.m_w:.4f} ГэВ
  Δm = {self.delta_m:.4f} ГэВ

Голографический параметр:
  k (наблюдаемый) = {self.k_observed:.6f}
  k (новая формула) = {self.k_formula_new():.6f}
  k (старая формула) = {self.k_formula_old():.6f}

Ключевые соотношения:
  k/α ≈ {self.k_over_alpha:.2f}
  α_eff ≈ {self.effective_alpha():.4f}
"""


# Стандартные этапы эволюции Вселенной
UNIVERSE_STAGES = [
    "Планковская эпоха",
    "Инфляция",
    "Кварк-глюонная плазма",
    "Нуклеосинтез",
    "Рекомбинация",
    "Тёмные века",
    "Первые звёзды",
    "Галактики",
    "Солнечная система",
    "Жизнь",
    "Разум",
    "Сейчас",
]

# Сокращённые названия этапов для графиков
UNIVERSE_STAGES_SHORT = [
    "Планк",
    "Инфляция",
    "КГП",
    "Нуклео",
    "Рекомб",
    "Тьма",
    "Звёзды",
    "Галактики",
    "Солнце",
    "Жизнь",
    "Разум",
    "Сейчас",
]

# Гипотетические будущие этапы эволюции
FUTURE_STAGES = {
    13: "Техносфера",
    14: "Киберсфера",
    15: "Ноосфера",
    16: "Планетарный разум",
    17: "Солнечный разум",
    18: "Галактический разум",
    19: "Межгалактическая сеть",
    20: "Вселенский разум",
    21: "Мультиверсные связи",
    22: "Трансцендентность",
    23: "Абсолютная когерентность",
    24: "Омега-точка",
}
