version: '3.8'

services:
  # Genesis node (node 0)
  node0:
    build: .
    container_name: thermo-node-0
    command: ["--id", "node0", "--port", "50051", "--genesis"]
    ports:
      - "50051:50051"
    networks:
      - thermo-network
    environment:
      - PYTHONUNBUFFERED=1
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.connect(('localhost', 50051)); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Peer node 1
  node1:
    build: .
    container_name: thermo-node-1
    command: ["--id", "node1", "--port", "50052", "--peer", "node0:50051"]
    ports:
      - "50052:50052"
    networks:
      - thermo-network
    depends_on:
      - node0
    environment:
      - PYTHONUNBUFFERED=1

  # Peer node 2
  node2:
    build: .
    container_name: thermo-node-2
    command: ["--id", "node2", "--port", "50053", "--peer", "node0:50051", "--peer", "node1:50052"]
    ports:
      - "50053:50053"
    networks:
      - thermo-network
    depends_on:
      - node0
      - node1
    environment:
      - PYTHONUNBUFFERED=1

  # Peer node 3
  node3:
    build: .
    container_name: thermo-node-3
    command: ["--id", "node3", "--port", "50054", "--peer", "node0:50051"]
    ports:
      - "50054:50054"
    networks:
      - thermo-network
    depends_on:
      - node0
    environment:
      - PYTHONUNBUFFERED=1

networks:
  thermo-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
