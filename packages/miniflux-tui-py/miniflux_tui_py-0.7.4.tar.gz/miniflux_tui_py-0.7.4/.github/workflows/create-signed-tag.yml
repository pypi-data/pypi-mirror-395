---
name: Create Signed Release Tag

on:
  workflow_dispatch:
    inputs:
      version:
        description: Version to tag (e.g. 0.5.2)
        required: true

permissions:
  contents: read
  # Minimal permissions: only need to create and push tags and OIDC token access for Gitsign

jobs:
  sign-and-push-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Harden the runner (audit mode)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Checkout repository  # zizmor: This workflow doesn't generate artifacts
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Gitsign for keyless signing
        uses: chainguard-dev/actions/setup-gitsign@3e8a2a226fad9e1ecbf2d359b8a7697554a4ac6d # main

      - name: Configure git identity
        run: |
          set -euo pipefail
          git config user.name "Miniflux Release Bot"
          git config user.email "release@reuteras.net"

      - name: Create signed tag
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          set -euo pipefail
          TAG="v${VERSION}"

          if git rev-parse "${TAG}" >/dev/null 2>&1; then
            echo "Tag ${TAG} already exists locally; refusing to overwrite." >&2
            exit 1
          fi

          if git ls-remote --tags origin "${TAG}" | grep -q "${TAG}$"; then
            echo "Tag ${TAG} already exists on origin; aborting." >&2
            exit 1
          fi

          git tag -s "${TAG}" -m "${TAG}"
          git push origin "${TAG}"
