---
name: Create Issue for Dependabot PRs

on:
  pull_request:
    types: [opened]

permissions:
  contents: read
  pull-requests: read

jobs:
  create-issue-for-dependabot:
    name: Create Tracking Issue
    runs-on: ubuntu-latest
    permissions:
      issues: write
    if: |
      github.event.pull_request.user.login == 'dependabot[bot]' &&
      github.event.pull_request.user.type == 'Bot'
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Create issue for Dependabot PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;

            const title = `[Dependabot] ${pr.title}`;
            const prLink = `[PR #${pr.number}](${pr.html_url})`;
            const body = `Dependabot has opened a pull request for dependency updates.\n\n` +
              `**Related PR:** ${prLink}\n\n` +
              `**PR Title:** ${pr.title}\n\n` +
              `**Dependency Details:**\n${pr.body || 'No additional details provided'}\n\n` +
              `---\n*This is an automatically generated tracking issue.*`;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['dependencies', 'dependabot']
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `Tracking issue created: #${issue.data.number}`
            });

            console.log(`Created issue #${issue.data.number} for PR #${pr.number}`);
