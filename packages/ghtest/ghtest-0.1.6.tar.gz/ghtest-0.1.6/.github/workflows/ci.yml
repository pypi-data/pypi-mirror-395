name: CI

on: [push, pull_request, workflow_dispatch]

permissions:
  contents: write
  id-token: write

jobs:
  ci:
    uses: k4144/actions/.github/workflows/project-ci.yml@main
    with:
      python-version: "3.13"
      package-name: "ghtest"
      publish-on: "main"
    secrets:
      pypi-token: ${{ secrets.PYPI_TOKEN }}

  publish:
    needs: ci
    if: needs.ci.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Download distribution artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.ci.outputs.dist_artifact }}
          path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          # user and password can be commented out if a trusted publisher is set on pypi
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}

