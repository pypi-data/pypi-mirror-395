"use strict";(self.webpackChunk_datalayer_ui=self.webpackChunk_datalayer_ui||[]).push([[1162],{640:(e,t,n)=>{n.a(e,async(e,s)=>{try{n.d(t,{JX:()=>D});var o=n(9387),i=n(63948),a=n(77544),l=n(72870),r=n(94064),c=n(51671),d=n(88037),u=n(98238),h=n(72490),m=n(14809),p=n(63279),g=n(69453),_=n(3349),f=n(2375),C=n(41273),v=n(97543),x=n(18683);function w(e,t,n){return(t=b(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function b(e){var t=y(e,"string");return"symbol"==typeof t?t:t+""}function y(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var s=n.call(e,t||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}const k="dla-Cell-footer";class E{constructor(e){w(this,"_isDisposed",!1),w(this,"_cellFooters",new WeakMap),w(this,"_cellResetters",new WeakMap),w(this,"_panel",void 0),w(this,"_settings",{dateFormat:"yyy-MM-dd HH:mm:ss",showDate:!0,showLiveExecutionTime:!0}),this._panel=e,this._panel.content.model?.cells.changed.connect(this.onCellsChanged,this),this._panel.content.modelChanged.connect(()=>{this._panel.content.model?.cells.changed.connect(this.onCellsChanged,this)}),this._panel.context.sessionContext.statusChanged.connect(this.onKernelStatusChanged,this)}get settings(){return this._settings}set settings(e){u.JSONExt.deepEqual(this._settings,e)||(this._settings=e,this.onCellsChanged(this._panel.context.model.cells,{type:"set",newIndex:0,newValues:Array.from(this._panel.context.model.cells),oldIndex:0,oldValues:Array.from(this._panel.context.model.cells)}))}get isDisposed(){return this._isDisposed}dispose(){this.isDisposed||(this._isDisposed=!0,h.Signal.clearData(this))}onKernelStatusChanged(e,t){["starting","restarting","autorestarting"].includes(t)&&this._panel.content.widgets.forEach(e=>{this._cellResetters.get(e.model)?.emit(void 0)})}onCellsChanged(e,t){t.oldValues.forEach(e=>{this._removeFooter(e)}),Promise.all(t.newValues.map(e=>this._addFooter(e)))}async _addFooter(e){if("code"===e.type){const t=this._panel.content.widgets.find(t=>t.model===e);if(t){await t.ready;const n=new h.Signal(this),s=d._Q.create((0,x.jsx)(g.WV,{children:(0,x.jsx)(M,{model:e,stateReset:n})}));this._cellFooters.has(e)&&this._cellFooters.get(e)?.dispose(),this._cellFooters.set(e,t),this._cellResetters.set(e,n);const o=()=>{this._cellFooters.delete(e),this._cellFooters.delete(e),s.dispose()};t.disposed.connect(o),this._panel.disposed.disconnect(o),m.x0.attach(s,t.inputArea.editorWidget.node)}}}_removeFooter(e){this._cellFooters.get(e)?.dispose()}}const S=e=>{const t=new Date;try{return(0,f.GP)(t,e),{isValid:!0}}catch(e){return{isValid:!1,message:e.message}}},R=(e,t="yyy-MM-dd HH:mm:ss")=>(0,f.GP)(e,t),N=(e,t)=>{const n=36e5,s=864e5;let o=(0,_.b)(e,t);if(o<1e3)return`${o}ms`;const i=Math.floor(o/s);o%=s;const a=Math.floor(o/n);o%=n;const l=Math.floor(o/6e4);o%=6e4;let r="";return i&&(r+=`${i}d `),(i||a)&&(r+=`${a}h `),(i||a||l)&&(r+=`${l}m `),i||(r+=`${(o/1e3).toFixed(a?0:2)}s`),r.trim()};class D{constructor(e,t){w(this,"_tracker",void 0),w(this,"_extensions",new WeakMap),w(this,"_settings",{showLiveExecutionTime:!0,showDate:!0,dateFormat:"yyy-MM-dd HH:mm:ss"}),this._tracker=e,t&&t.load("@datalayer/ui:plugin").then(e=>{e&&(this._updateSettings(e),e.changed.connect(this._updateSettings.bind(this)),t.load("@jupyterlab/notebook-extension:tracker").then(e=>e.set("recordTiming",!0),e=>{console.error("@datalayer/ui: Could not force metadata recording.",e)}))}).catch(e=>{console.error("@datalayer/ui: Could not load settings",e)})}createNew(e,t){const n=new E(e);return this._extensions.set(e,n),e.disposed.connect(()=>{this._extensions.delete(e)}),n}_updateSettings(e){const t={showLiveExecutionTime:e.get("showLiveExecutionTime").composite,showDate:e.get("showDate").composite},n=e.get("dateFormat").composite,s=S(n);s.isValid?t.dateFormat=n:(t.dateFormat="yyy-MM-dd HH:mm:ss",console.warn("Invalid date format in Execute Time extension setting",s.message??"")),this._settings={...this._settings,...t},this._tracker.forEach(e=>{const t=this._extensions.get(e);t&&(t.settings={...this._settings})})}}function M(e){const{model:t,stateReset:n}=e,{enqueueToast:s}=(0,C.d)(),[d,h]=(0,o.useState)(""),[m,g]=(0,o.useState)(""),[_,f]=(0,o.useState)(null),[w,b]=(0,o.useState)(""),[y,E]=(0,o.useState)(""),[S,D]=(0,o.useState)(""),[M,I]=(0,o.useState)(v.kU.getRemoteCell(t)??null),[T,j]=(0,o.useState)(v.sn.UNKNOWN),[O,A]=(0,o.useState)("");(0,o.useEffect)(()=>{const e=()=>{j(v.sn.UNKNOWN),A(""),I(null)};return n.connect(e),()=>{n.disconnect(e)}},[n]),(0,o.useEffect)(()=>{const e=()=>{const n=t.getMetadata("datalayer")?.kernel;let s="",c="";if(n){let e=l.A;switch(s=n.displayName??"Unknown kernel",c=`${s} running `,n.location){case"local":c+="locally.";break;case"browser":e=i.A,c+="in your browser.";break;default:!1===n.params?.notebook?(e=r.A,c+="remotely."):(e=a.A,c+="in a Notebook Remote Runtime.")}f(e?(0,o.createElement)(e,{title:n.location}):null),h(s),g(c)}else f(null),h(""),g("");const d=t.getMetadata("execution");if(!d||!u.JSONExt.isObject(d))return w&&b(""),y&&E(""),void(S&&D(""));const m=d["iopub.status.busy"],p=m?new Date(m):null,_=d["shell.execute_reply.started"]||d["iopub.execute_input"],C=_?new Date(_):null,v=d.execution_failed,x=d["shell.execute_reply"]??v,k=x?new Date(x):null,M=x&&!d["iopub.execute_input"],I=setInterval(()=>{if(w.startsWith("Execution started at")){if(t.getMetadata("execution").execution_failed)return clearInterval(I),void e();if(C){const e=N(new Date,C);E(`${e} ${S?`(${S})`:""}`)}}else clearInterval(I)},100);let T="";if(M)T="";else if(k&&C){const e=N(k,C);D(e),T=v?"Failed":"Last executed",T&&(T+=` at ${R(k,"yyy-MM-dd HH:mm:ss")}`),T+=` in ${e}`}else C?T=`Execution started at ${R(C,"yyy-MM-dd HH:mm:ss")}`:p&&(S&&E(`N/A (${S})`),T=`Execution queued at ${R(p,"yyy-MM-dd HH:mm:ss")}`);w!==T&&b(T)},n=(e,{notebook:n,cell:s})=>{if(s.model===t){const e=v.kU.getRemoteCell(t)??null;j(e?.state??v.sn.QUEUED),A(e?.state?"":"Queued"),I(e)}},d=(e,{notebook:n,cell:o,success:i,error:a})=>{if(o.model!==t)return;const l=i?v.sn.DONE:v.sn.ERROR;j(M?.state??l),A(M?.reason??""),M?.state===v.sn.ERROR&&s(M.reason??"Failed to execute cell on a remote kernel.",{variant:"error"})};return e(),t.metadataChanged.connect(e),"code"===t.type&&(c.Ft.executionScheduled.connect(n),c.Ft.executed.connect(d)),()=>{t.metadataChanged.disconnect(e),"code"===t.type&&(c.Ft.executionScheduled.disconnect(n),c.Ft.executed.disconnect(d))}},[t,M]),(0,o.useEffect)(()=>{const e=(e,t)=>{switch(j(t),t){case v.sn.QUEUED:A("Queued");break;case v.sn.ERROR:A(e.reason??"");break;case v.sn.EXECUTING:A("Runningâ€¦");break;case v.sn.EXPORTING:A("Exporting dataâ€¦");break;case v.sn.IMPORTING:A("Importing dataâ€¦");break;case v.sn.STARTING_KERNEL:A(e.reason??"Starting the kernelâ€¦");break;default:A("")}};return M?.stateChanged.connect(e),()=>{M?.stateChanged.disconnect(e)}},[M]);const P=!!_;let U=!1,$=100,F=P?"var(--jp-brand-color1)":"var(--jp-brand-color3)",K="var(--jp-brand-color1)",G="";switch(T){case v.sn.QUEUED:G="ðŸ’¤ï¸Ž",$=0;break;case v.sn.UNKNOWN:$=0;break;case v.sn.DONE:G="âœ”ï¸Ž",F=P?"var(--jp-success-color1)":"var(--jp-success-color3)",K="var(--jp-success-color1)";break;case v.sn.ERROR:G="âŒï¸Ž",F=P?"var(--jp-error-color1)":"var(--jp-error-color3)",K="var(--jp-error-color1)";break;case v.sn.EXECUTING:G="âš¡ï¸Ž",U=!0,$=40;break;case v.sn.EXPORTING:G="ðŸ“¤ï¸Ž",U=!0,$=90;break;case v.sn.IMPORTING:G="ðŸ“¥ï¸Ž",U=!0,$=30;break;case v.sn.STARTING_KERNEL:G="ðŸ”¥ï¸Ž",U=!0,$=20}const W=[k];return P&&W.push("jp-mod-foreign"),(0,x.jsxs)("div",{className:W.join(" "),children:[(0,x.jsx)("div",{style:{minHeight:"3px"},children:T!==v.sn.UNKNOWN&&(0,x.jsx)(p.z,{sx:{maxHeight:"3px"},progress:$,bg:F,animated:U,barSize:"small"})}),(0,x.jsxs)("div",{children:[(0,x.jsx)("span",{style:{color:K},title:O||void 0,children:`${G} ${O}`.trimEnd()}),(0,x.jsx)("span",{children:t.getMetadata("execution")&&(0,x.jsx)(x.Fragment,{children:w})}),(0,x.jsxs)("span",{className:"dla-Cell-footer-runtime",title:m,children:[_,d]})]})]})}s()}catch(I){s(I)}})},1162:(e,t,n)=>{n.a(e,async(e,s)=>{try{n.d(t,{dU:()=>y,wj:()=>w,zg:()=>b});var o=n(88037),i=n(59179),a=n(51671),l=n(89460),r=n(69453),c=n(5279),d=n(69584),u=n(14809),h=n(9448),m=n(60372),p=n(640),g=n(97543),_=n(71518),f=n(92843),C=n(18683),v=e([p]),x=v.then?(await v)():v;p=x[0];const w=()=>{a.Ft.run=g.kU.run,a.Ft.runAll=g.kU.runAll,a.Ft.runAllAbove=g.kU.runAllAbove,a.Ft.runAllBelow=g.kU.runAllBelow,a.Ft.runAndAdvance=g.kU.runAndAdvance,a.Ft.runAndInsert=g.kU.runAndInsert,a.Ft.runCells=g.kU.runCells},b={id:"@datalayer/ui:runtimes:cell-executor",description:"Handle runtime code execution per cell.",requires:[_.qk,l.fI],optional:[i.qe,c.co,i.zG],autoStart:!1,activate:(e,t,n,s,i,a)=>{g.kU.serviceManager=t,w(),s?.addFactory("Cell","dla-Runtimes-picker",s=>{const l=n.find(e=>!(!e.model||!Array.from(e.model.cells).find(e=>e===s.model)));return"code"!==s.model.type?new u.x0:o._Q.create((0,C.jsxs)(h.az,{display:"flex",children:[(0,C.jsx)(h.az,{children:(0,C.jsx)(r.WV,{children:(0,C.jsx)(f.zl,{model:s.model,preference:l?.sessionContext?{id:l.sessionContext.session?.kernel?.id,language:l.sessionContext.specsManager.specs?.kernelspecs[l.sessionContext.session?.kernel?.name??""]?.language}:void 0,sessionContext:l?.sessionContext})})}),(0,C.jsx)(h.az,{children:(0,C.jsx)(r.WV,{children:(0,C.jsx)(m.B,{logIn:e.commands.hasCommand("@datalayer/ui:runtimes:create-widget")?()=>e.commands.execute("@datalayer/ui:runtimes:create-widget"):void 0,markdownParser:i??void 0,sanitizer:a??void 0,model:s.model,preference:l?.sessionContext?{id:l.sessionContext.session?.kernel?.id,language:l.sessionContext.specsManager.specs?.kernelspecs[l.sessionContext.session?.kernel?.name??""]?.language,location:l.sessionContext.location}:void 0,multiServiceManager:t,sessionContext:l?.sessionContext,translator:void 0})})})]}))})}},y={id:"@datalayer/ui:runtimes:cell-footer",description:"Cell footer with runtime information.",requires:[l.fI],optional:[d.X],autoStart:!1,activate:(e,t,n)=>{e.docRegistry.addWidgetExtension("Notebook",new p.JX(t,n))}};s()}catch(e){s(e)}})},71518:(e,t,n)=>{n.d(t,{Pl:()=>l,TT:()=>a,UC:()=>o,qk:()=>i});var s=n(98238);const o="@datalayer/ui:runtimes:plugin",i=new s.Token("@datalayer/ui:runtimes:multi-service-manager"),a=new s.Token("@datalayer/ui:runtimes:browser-router"),l=new s.Token(o)},92843:(e,t,n)=>{n.d(t,{YN:()=>_,zl:()=>m});var s=n(9387),o=n(85181),i=n(88037),a=n(72490),l=n(58875),r=n(38621),c=n(9448),d=n(59176),u=n(18683);function h(e,t,n){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function m(e){const{model:t}=e,[n,o]=(0,s.useState)(!1),[i,a]=(0,s.useState)(!1),h=(0,s.useCallback)(()=>{o(!1)},[]);return(0,s.useEffect)(()=>{const e=e=>{const t=e.getMetadata("datalayer")??{};a(!!t.kernel)};return e(t),t.metadataChanged.connect(e),()=>{t.metadataChanged.disconnect(e)}},[t]),i?(0,u.jsxs)(c.az,{className:"dla-Cell-variables-icon",children:[(0,u.jsx)(l.K,{style:{color:"var(--jp-brand-color1)",width:"33px",marginTop:"-2px"},icon:r.HGl,"aria-label":"Set variables to transfer between Runtimes",variant:"invisible",size:"small",title:"Set variables to transfer between Runtimes",onClick:e=>{e.preventDefault(),o(!0)}}),n&&(0,u.jsx)(d.m,{...e,onClose:h})]}):(0,u.jsx)(u.Fragment,{})}class p{constructor(e,t){this.commands=t,h(this,"_isDisposed",!1),h(this,"_cellActions",new WeakMap),h(this,"_panel",void 0),this._panel=e,this._panel.content.model?.cells.changed.connect(this.updateConnectedCell,this),this._panel.content.modelChanged.connect(()=>{this._panel.content.model?.cells.changed.connect(this.updateConnectedCell,this)})}get isDisposed(){return this._isDisposed}dispose(){this.isDisposed||(this._isDisposed=!0,a.Signal.clearData(this))}updateConnectedCell(e,t){t.oldValues.forEach(e=>{this._removeAction(e)}),Promise.all(t.newValues.map(e=>this._addAction(e)))}async _addAction(e){const t=this._panel.content.widgets.find(t=>t.model===e);if("code"===t?.model.type){await t.ready;const n=i._Q.create((0,u.jsx)(m,{model:t.model,preference:this._panel.sessionContext?{id:this._panel.sessionContext.session?.kernel?.id,language:this._panel.sessionContext.specsManager.specs?.kernelspecs[this._panel.sessionContext.session?.kernel?.name??""]?.language}:void 0,sessionContext:this._panel.sessionContext,translator:this._panel.translator}));n.addClass("dla-Cell-action"),this._cellActions.has(e)&&this._cellActions.get(e)?.dispose(),this._cellActions.set(e,t),this._panel.disposed.connect(()=>{this._cellActions.delete(e),n.dispose()}),t.layout.addWidget(n)}}_removeAction(e){this._cellActions.get(e)?.dispose()}}class g{constructor(e){this.commands=e,h(this,"_extensions",new WeakMap)}createNew(e,t){const n=new p(e,this.commands);return this._extensions.set(e,n),e.disposed.connect(()=>{this._extensions.delete(e)}),n}}const _={id:"@datalayer/ui:runtimes:cell-action",description:"Cell action item",optional:[o.sQ],autoStart:!1,activate:(e,t)=>{e.docRegistry.addWidgetExtension("Notebook",new g(e.commands))}}},97543:(e,t,n)=>{n.d(t,{kU:()=>x,sn:()=>b});var s=n(2335),o=n(55881),i=n(63711),a=n(51671),l=n(85181),r=n(38921),c=n(98238),d=n(72490),u=n(94247),h=n(36848),m=n(9857),p=n(30681),g=n(92202),_=n(26127),f=n(92131);function C(e,t,n){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const v=new WeakMap;class x{static getRemoteCell(e){return v.get(e)}static run(e,t,n,s){if(!e.model||!e.activeCell)return Promise.resolve(!1);const o=w.getState(e),i=w.runSelected(e,t,n,s);return w.handleRunState(e,o,!1),i}static runCells(e,t,n,s,o){if(!e.model)return Promise.resolve(!1);const i=w.getState(e),a=w.runCells(e,t,n,s,o);return w.handleRunState(e,i,!1),a}static runAll(e,t,n,s){if(!e.model||!e.activeCell)return Promise.resolve(!1);const o=w.getState(e),i=e.widgets.length,a=w.runCells(e,e.widgets,t,n,s);return e.activeCellIndex=i,e.deselectAll(),w.handleRunState(e,o,!0),a}static runAllAbove(e,t,n,s){const{activeCell:o,activeCellIndex:i,model:a}=e;if(!a||!o||i<1)return Promise.resolve(!1);const l=w.getState(e),r=w.runCells(e,e.widgets.slice(0,e.activeCellIndex),t,n,s);return e.deselectAll(),w.handleRunState(e,l,!0),r}static runAllBelow(e,t,n,s){if(!e.model||!e.activeCell)return Promise.resolve(!1);const o=w.getState(e),i=e.widgets.length,a=w.runCells(e,e.widgets.slice(e.activeCellIndex),t,n,s);return e.activeCellIndex=i,e.deselectAll(),w.handleRunState(e,o,!0),a}static async runAndAdvance(e,t,n,s){if(!e.model||!e.activeCell)return Promise.resolve(!1);const o=w.getState(e),a=w.runSelected(e,t,n,s),l=e.model;return e.activeCellIndex===e.widgets.length-1?(l.sharedModel.insertCell(e.widgets.length,{cell_type:e.notebookConfig.defaultCell,metadata:"code"===e.notebookConfig.defaultCell?{trusted:!0}:{}}),e.activeCellIndex++,!1===e.activeCell?.inViewport&&await(0,i.signalToPromise)(e.activeCell.inViewportChanged,200).catch(()=>{}),e.mode="edit"):e.activeCellIndex++,w.handleRunState(e,o,!0),a}static async runAndInsert(e,t,n,s){if(!e.model||!e.activeCell)return Promise.resolve(!1);const o=w.getState(e),a=w.runSelected(e,t,n,s);return e.model.sharedModel.insertCell(e.activeCellIndex+1,{cell_type:e.notebookConfig.defaultCell,metadata:"code"===e.notebookConfig.defaultCell?{trusted:!0}:{}}),e.activeCellIndex++,!1===e.activeCell?.inViewport&&await(0,i.signalToPromise)(e.activeCell.inViewportChanged,200).catch(()=>{}),e.mode="edit",w.handleRunState(e,o,!0),a}}C(x,"serviceManager",null);let w,b=function(e){return e[e.QUEUED=0]="QUEUED",e[e.STARTING_KERNEL=1]="STARTING_KERNEL",e[e.IMPORTING=2]="IMPORTING",e[e.EXECUTING=3]="EXECUTING",e[e.EXPORTING=4]="EXPORTING",e[e.UNKNOWN=5]="UNKNOWN",e[e.DONE=6]="DONE",e[e.ERROR=7]="ERROR",e}({});class y{constructor({cell:e,sessionContext:t,metadata:n}){C(this,"cell",void 0),C(this,"sessionContext",void 0),C(this,"metadata",void 0),this.cell=e,this.sessionContext=t,this.metadata=n}get connection(){return this.sessionContext?.session?.kernel??void 0}failedExecution(e){this.cell.setPrompt("")}cancelExecution(){this.cell.setPrompt("")}scheduleExecution(){this.cell.model.sharedModel.transact(()=>{this.cell.model.clearExecution()},!1),this.cell.model.sharedModel.getSource().trim()&&this.cell.setPrompt("*")}processCell(){return Promise.resolve(!1)}}class k extends y{constructor(e){super(e),C(this,"_connection",void 0),C(this,"_reason",null),C(this,"_isDisposed",!1),C(this,"_runtimeDesc",void 0),C(this,"_processed",null),C(this,"_state",b.QUEUED),C(this,"_stateChanged",new d.Signal(this)),C(this,"_variablesIn",void 0),C(this,"_variableOut",void 0);const t=this.cell.model.getMetadata("datalayer")??{};this._runtimeDesc=t.kernel,this._variablesIn=Array.isArray(t.in)?t.in:[],this._variableOut="string"==typeof t.out?t.out:""}get connection(){return this._connection}get isDisposed(){return this._isDisposed}get reason(){return this._reason}get state(){return this._state}setState(e,t){this._state===e&&this._reason===t||(this._reason=t??null,this._state=e,this._stateChanged.emit(this._state))}get stateChanged(){return this._stateChanged}failedExecution(e){super.failedExecution(),this.setState(b.ERROR,e)}cancelExecution(){super.cancelExecution(),this.setState(b.ERROR)}scheduleExecution(){super.scheduleExecution(),this.setState(b.QUEUED)}dispose(){this._isDisposed||(this._isDisposed=!0,this._connection?.dispose(),d.Signal.clearData(this))}async processCell(){let e;await this.setupKernel();try{this._processed=new c.PromiseDelegate,this._processCell().then(e=>{this._processed?.resolve(e)}).catch(e=>{this._processed?.reject(e)}),e=await this._processed.promise}finally{await this.teardownKernel()}return e}async _processCell(){if(!this._connection){const e=`Failed to process a remote cell '${this.cell.model.id}'.`;throw this.setState(b.ERROR,e),new Error(e)}if(this._variablesIn.length){if(!this.sessionContext){const e="Unable to import variables; no document kernel available.";throw this.setState(b.ERROR,e),new Error(e)}this.setState(b.IMPORTING);const e=this.sessionContext.specsManager.specs.kernelspecs[this.sessionContext.session.kernel.model.name];if(!await E(e.language,this.sessionContext.session.kernel,this._variablesIn,this._connection)){const e=`Failed to transfer ${this._variablesIn.join(", ")} to ${this._connection.location} - ${this._connection.name} (${this._connection.id})`;throw this.setState(b.ERROR,e),new Error(e)}}this.setState(b.EXECUTING);const e=await o.Yr.execute(this.cell,{session:{kernel:this._connection}},this.metadata);if(console.debug(`@datalayer/ui:runtimes: Capture cell ${this.cell.model.id} execution`,e),this.metadata.deletedCells&&(this.metadata.deletedCells.length=0),!e)return!1;if("ok"===e.content.status){if(this._variableOut){if(!this.sessionContext){const e="Unable to export variables; no document kernel available.";throw this.setState(b.ERROR,e),new Error(e)}this.setState(b.EXPORTING);const e=this.sessionContext.specsManager.specs.kernelspecs[this.sessionContext.session.kernel.model.name];if(!await E(e.language,this._connection,[this._variableOut],this.sessionContext.session.kernel)){const e=`Failed to transfer ${this._variableOut} from ${this._connection.location} - ${this._connection.name} (${this._connection.id})`;throw this.setState(b.ERROR,e),new Error(e)}}return this.setState(b.DONE),!0}throw this.setState(b.ERROR),new a.id(e.content)}async setupKernel(){if(!x.serviceManager){const e="No service manager available";throw this.setState(b.ERROR,e),new Error(e)}this.setState(b.STARTING_KERNEL),this._connection&&(this._connection.id===this._runtimeDesc.kernelId&&this._connection.name===this._runtimeDesc.name&&(this._connection.location??"local")===runtimeDescription.location||this._connection.dispose(),this._connection.isDisposed&&(this._connection?.connectionStatusChanged.disconnect(this.onConnectionChanged,this),this._connection?.statusChanged.disconnect(this.onKernelStatusChanged,this),this._connection=void 0));const e=!1!==this._runtimeDesc.params?.notebook;switch(this._connection?.status){case"idle":case"busy":case"autorestarting":case"restarting":case"starting":break;default:{this._connection?.dispose(),this._connection?.connectionStatusChanged.disconnect(this.onConnectionChanged,this),this._connection?.statusChanged.disconnect(this.onKernelStatusChanged,this),this._connection=void 0;const t=(0,g.R)(this._runtimeDesc.location)?x.serviceManager.remote?.runtimesManager:x.serviceManager[this._runtimeDesc.location]?.kernels;if(e&&this._runtimeDesc.kernelId)try{this._connection=t?.connectTo({model:{id:this._runtimeDesc.kernelId,name:this._runtimeDesc.name},handleComms:!0})}catch(e){if(!e||"Unable to find the kernel."!==e.message)throw e;console.log(`Persistent kernel ${this._runtimeDesc.kernelId} does not exist. Starting a new one...`)}if(!this._connection)try{const{credits:n}=_.J7.getState(),{configuration:s,runtimeModels:o}=f.LH.getState(),i=(n?.available??0)/Math.max(s.maxCellRuntimes-o.filter(e=>"cell"===e.type).length,1);if(i<m.c)throw new Error("You do not have enough credits to start a Cell Remote Runtime.");this._connection=await(t?.startNew({environmentName:this._runtimeDesc.name,type:e?"notebook":"cell",creditsLimit:i,capabilities:this._runtimeDesc.params?.capabilities},{handleComms:!0}))}catch(t){if(503===t.response?.status)(0,s.f1)("Unable to create a new remote kernel",`No kernel available for environment '${this._runtimeDesc.name}' sets for cell '${this.cell.model.id}' of notebook '${this.sessionContext?.path??"unknown"}'. Please try again later.`);else if("MaxRuntimesExceededError"===t.name){if(!e){const e=new c.PromiseDelegate,t=window.setTimeout(()=>{e.reject("Timeout")},3e5),n=f.LH.subscribe(t=>{t.runtimeModels.filter(e=>"cell"===e.type).length<t.configuration.maxCellRuntimes&&e.resolve()});try{return this.setState(b.STARTING_KERNEL,"Waiting for a cell kernel to stopâ€¦"),await e.promise,clearTimeout(t),this.setupKernel()}catch(e){console.log("Waiting for free kernel slot expired.")}finally{n()}}(0,s.f1)("Unable to create a new remote kernel",`${t.message} Cell '${this.cell.model.id}' of notebook '${this.sessionContext?.path??"unknown"}' cannot be executed.`)}else 404===t.response?.status&&(0,s.f1)("Unable to create a new remote kernel",`Unknown environment '${this._runtimeDesc.name}' sets for cell '${this.cell.model.id}' of notebook '${this.sessionContext?.path??"unknown"}'. Please select an existing environment.`);throw this.setState(b.ERROR,"string"==typeof t?t:t.message??"Unable to start a kernel"),t}this._connection&&(this._connection?.connectionStatusChanged.connect(this.onConnectionChanged,this),this._connection?.statusChanged.connect(this.onKernelStatusChanged,this),this._connection.location=this._runtimeDesc.location,e&&(this._runtimeDesc.kernelId=this._connection.id,this.cell.model.setMetadata("datalayer",Object.assign(this.cell.model.getMetadata("datalayer")??{},{kernel:this._runtimeDesc}))))}}if(!this._connection){const e=`Unable to start a kernel for cell ${this.cell.model.id} with ${JSON.stringify(this._runtimeDesc)}`;throw this.setState(b.ERROR,e),new Error(e)}}async teardownKernel(){!1===this._runtimeDesc.params?.notebook&&(this._connection&&!this._connection.isDisposed&&((0,g.R)(this._runtimeDesc.location)?x.serviceManager.remote.runtimesManager.shutdown(this._connection.id):this._connection.shutdown(),this._connection.dispose()),this._connection?.connectionStatusChanged.disconnect(this.onConnectionChanged,this),this._connection?.statusChanged.disconnect(this.onKernelStatusChanged,this),this._connection=void 0)}onConnectionChanged(){"disconnected"===this._connection?.connectionStatus&&this._processed?.reject("Kernel has been disconnected")}onKernelStatusChanged(){["dead","terminating"].includes(this._connection?.status??"")&&this._processed?.reject(`Kernel status '${this._connection?.status}' is not appropriate`)}}async function E(e,t,n,s){const o=new p.J(e),i=o.saveVariables(n),a=await new h.D({connection:t}).execute(i),l=a.get(0)?.data["text/plain"]??"";if(!l)return!1;{const e=o.loadVariables(l),t=await new h.D({connection:s}).execute(e),i=t.get(0)?.data["text/plain"]||"[]",a=JSON.parse(i.slice(1,i.length-1));if(!n.every(e=>a.includes(e)))return!1;console.debug(`Successfully transfered ${n.join(", ")}`)}return!0}!function(e){const t=a.Ft.executed,n=a.Ft.executionScheduled,i=a.Ft.selectionExecuted;async function d(e,d,p,g,_){const f=d[-1];e.mode="command";try{const C=await Promise.all(d.map(i=>async function(e,i,d,p,g){const _=await async function({notebook:e,cell:s,sessionContext:o}){if("code"!==s.model.type)return!1;const i={deletedCells:e.model?.deletedCells??[],recordTiming:e.notebookConfig.recordTiming},a=!!(s.model.getMetadata("datalayer")??{}).kernel,l=new(a?k:y)({cell:s,sessionContext:o,metadata:i});if(a){v.set(s.model,l);const e=()=>{v.delete(s.model),l.dispose()};s.disposed.connect(e),o?.disposed.connect(e)}return async function(e,s){const o=new c.PromiseDelegate;h.has(e)||h.set(e,[]);const i=h.get(e),a=0===i.length;return n.emit({notebook:e,cell:s.cell}),s.scheduleExecution(),i.push({cell:s,done:o}),a&&m(i).catch(e=>{console.error("Fail to start processing the cell queue",e)}),o.promise.then(()=>{t.emit({notebook:e,cell:s.cell,success:!0})}).catch(n=>{t.emit({notebook:e,cell:s.cell,success:!1,error:n})}),o.promise}(e,l)}({notebook:e,cell:i,sessionContext:d});if(_)return!0;const f=(g=g||l.wK).load("jupyterlab");switch(i.model.type){case"markdown":i.rendered=!0,i.inputHidden=!1,t.emit({notebook:e,cell:i,success:!0});break;case"code":if(d){if(d.isTerminating){await(0,s.ui)({title:f.__("Kernel Terminating"),body:f.__("The kernel for %1 appears to be terminating. You can not run any cell for now.",d.session?.path),buttons:[s.lG.okButton()]});break}if(d.pendingInput)return await(0,s.ui)({title:f.__("Cell not executed due to pending input"),body:f.__("The cell has not been executed to avoid kernel deadlock as there is another pending input! Submit your pending input and try again."),buttons:[s.lG.okButton()]}),!1;if(d.hasNoKernel&&await d.startKernel()&&p&&await p.selectKernel(d),d.hasNoKernel)return i.model.sharedModel.transact(()=>{i.model.clearExecution()}),!0;const l=e.model?.deletedCells??[];n.emit({notebook:e,cell:i});let c=!1;try{const t={deletedCells:l,recordTiming:e.notebookConfig.recordTiming};console.debug(`@datalayer/ui:runtimes: Processing normally cell ${i.model.id}`);const n=i.model.sharedModel.source;if((0,u.ZP)(i)){const e=i.model.getMetadata("datalayer").datasource,t=e.variant??"",s=e.database??"",o=e.outputBucket??"",a=e.destinationVar??"";i.model.sharedModel.setSource(`%%${t} ${s} ${o} ${a}\n\n${n}`),i.model.sharedModel.setMetadata("editable",!1)}const s=await o.Yr.execute(i,d,t).finally(()=>{(0,u.ZP)(i)&&(i.model.sharedModel.setSource(n),i.model.sharedModel.setMetadata("editable",!0))})??void 0;l.splice(0,l.length),c=(()=>{if(i.isDisposed)return!1;if(!s)return!0;if("ok"===s.content.status){const t=s.content;return t.payload&&t.payload.length&&function(e,t,n){const s=e.payload?.filter(e=>"set_next_input"===e.source)[0];if(!s)return;const o=s.text;if(s.replace)return void n.model.sharedModel.setSource(o);const i=t.model.sharedModel,a=t.model.cells,l=(0,r.findIndex)(a,e=>e===n.model);-1===l?i.insertCell(i.cells.length,{cell_type:"code",source:o,metadata:{trusted:!1}}):i.insertCell(l+1,{cell_type:"code",source:o,metadata:{trusted:!1}})}(t,e,i),!0}throw new a.id(s.content)})()}catch(n){if(!i.isDisposed&&!n.message.startsWith("Canceled"))throw t.emit({notebook:e,cell:i,success:!1,error:n}),n;c=!1}return c&&t.emit({notebook:e,cell:i,success:!0}),c}i.model.sharedModel.transact(()=>{i.model.clearExecution()},!1)}return Promise.resolve(!0)}(e,i,p,g,_)));return!e.isDisposed&&(i.emit({notebook:e,lastCell:f}),e.update(),C.every(e=>e))}catch(t){if(!t.message||!t.message.startsWith("KernelReplyNotOK"))throw t;return d.map(e=>{"code"===e.model.type&&null===e.model.executionCount&&e.setPrompt("")}),i.emit({notebook:e,lastCell:f}),e.update(),!1}}e.getState=function(e){return{wasFocused:e.node.contains(document.activeElement),activeCellId:e.activeCell?.model.id??null}},e.handleRunState=async function(e,t,n=!1){const{activeCell:s,activeCellIndex:o}=e;n&&s&&await e.scrollToItem(o,"smart",0).catch(e=>{}),(t.wasFocused||"edit"===e.mode)&&e.activate()},e.runCells=d,e.runSelected=function(e,t,n,s){e.mode="command";let o=e.activeCellIndex;const i=e.widgets.filter((t,n)=>{const s=e.isSelectedOrActive(t);return s&&(o=n),s});return e.activeCellIndex=o,e.deselectAll(),d(e,i,t,n,s)};const h=new WeakMap;async function m(e){const t=e[0];if(!t)return Promise.resolve();const{done:n,cell:s}=t;try{const t=await s.processCell();n.resolve(t),e.shift(),m(e).catch(e=>{console.error("Error processing cell queue")})}catch(t){for(s.failedExecution(t.message),n.reject(t),s===e[0]?.cell&&e.shift();e.length;){const{done:t,cell:n}=e.shift()??{};n?.cancelExecution(),t?.reject("Canceled")}}}}(w||(w={}))}}]);