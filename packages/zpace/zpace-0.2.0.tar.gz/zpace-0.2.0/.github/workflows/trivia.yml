---
name: Trivia on a pull request
on:
  pull_request:
    types: [opened]

jobs:
  trivia:
    runs-on: ubuntu-latest

    steps:
      - name: Post Trivia Questions
        uses: actions/github-script@v7
        with:
          script: |
            const res = await fetch("https://opentdb.com/api.php?amount=3&type=multiple");
            const data = await res.json();

            // Node.js-compatible HTML entity decoder
            function decodeHtml(html) {
              return html
                .replace(/&quot;/g, '"')
                .replace(/&#039;/g, "'")
                .replace(/&amp;/g, "&")
                .replace(/&lt;/g, "<")
                .replace(/&gt;/g, ">")
                .replace(/&nbsp;/g, " ")
                .replace(/&deg;/g, "¬∞")
                .replace(/&ldquo;/g, "‚Äú")
                .replace(/&rdquo;/g, "‚Äù")
                .replace(/&lsquo;/g, "‚Äò")
                .replace(/&rsquo;/g, "‚Äô");
            }

            const questions = data.results.map((q, i) => {
              const choices = [...q.incorrect_answers, q.correct_answer]
                .sort(() => Math.random() - 0.5)
                .map((a, idx) => `${String.fromCharCode(65 + idx)}) ${decodeHtml(a)}`)
                .join("\n");
              return `### üß© Q${i + 1}: ${decodeHtml(q.question)}\n${choices}\n\n`;
            }).join("\n\n\n");

            const committer = context.payload.sender.login;
            const quote = "> You got this! Remember, every bug is just a feature in disguise.";

            const header = `## ‚∏ú(ÔΩ°ÀÉ ·µï ÀÇ )‚∏ù‚ô° Thank you for opening this Pull Request, ${committer}!\n\n## ( À∂¬∞„ÖÅ¬∞) !! It's Trivia Time!\nHere are 3 trivia questions to keep you entertained while CI runs.\n*(Feel free to demonstrate your knowledge and reply!)*\n\n`;
            const body = `${header}${questions}\n\n${quote}`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
