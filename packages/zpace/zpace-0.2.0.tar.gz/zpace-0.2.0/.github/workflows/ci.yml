---
name: CI
on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12", "3.13", "3.14", "pypy3.9", "pypy3.10", "pypy3.11"]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true

    - name: Set up Python ${{ matrix.python-version }}
      run: uv python install ${{ matrix.python-version }}

    - name: Install dependencies
      run: uv sync

    - name: Run tests
      run: uv run pytest -v

    - name: Run linter
      run: uv run ruff check .

    - name: Check formatting
      run: uv run ruff format --check .

    - name: Test CLI
      run: |
        uv run python main.py --help
        uv run python main.py . -n 5 -m 1000

  mypy:
    name: Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Type check with mypy
        run: uv run mypy .

  post-dog:
    if: github.event_name == 'pull_request'
    name: Celebrate with a Dog!
    needs: [test, mypy]  # Only run if `test` and `mypy` succeed
    runs-on: ubuntu-latest

    steps:
      - name: Fetch a random dog
        id: dog
        run: |
          DOG_URL=$(curl -s https://dog.ceo/api/breeds/image/random | jq -r '.message')
          echo "dog_url=$DOG_URL" >> $GITHUB_OUTPUT
      - name: Post dog in PR comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ‰ **All tests passed! Here's a dog for you!** ğŸ¶\n\n![Dog](${{ steps.dog.outputs.dog_url }})`
            })
