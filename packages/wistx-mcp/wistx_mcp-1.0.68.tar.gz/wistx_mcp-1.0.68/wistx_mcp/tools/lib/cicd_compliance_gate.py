"""CI/CD Compliance Gate Generator for WISTX.

This module generates compliance gates for CI/CD pipelines that:
- Integrate with GitHub Actions, GitLab CI, Azure DevOps, and Jenkins
- Enforce compliance thresholds before deployment
- Generate compliance reports as pipeline artifacts
- Support blocking and warning modes
- Provide SARIF output for GitHub Security tab integration

Industry Standards Implemented:
- NIST SP 800-53 Rev. 5 (SA-11: Developer Testing and Evaluation)
- ISO 27001:2022 (A.8.25: Secure Development Life Cycle)
- SOC 2 CC8.1 (Change Management)
- PCI-DSS v4.0 Requirement 6.2 (Secure Development)
"""

import logging
from dataclasses import dataclass, field
from enum import Enum
from typing import Any

logger = logging.getLogger(__name__)


class CICDPlatform(Enum):
    """Supported CI/CD platforms."""
    GITHUB_ACTIONS = "github_actions"
    GITLAB_CI = "gitlab_ci"
    AZURE_DEVOPS = "azure_devops"
    JENKINS = "jenkins"
    BITBUCKET = "bitbucket"
    CIRCLECI = "circleci"


class GateMode(Enum):
    """Compliance gate enforcement modes."""
    BLOCKING = "blocking"      # Fail pipeline on compliance violations
    WARNING = "warning"        # Warn but allow pipeline to continue
    AUDIT = "audit"           # Log only, no pipeline impact


class SeverityThreshold(Enum):
    """Severity levels for compliance violations."""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


@dataclass
class ComplianceGateConfig:
    """Configuration for compliance gate."""
    # Gate behavior
    mode: GateMode = GateMode.BLOCKING
    fail_on_severity: SeverityThreshold = SeverityThreshold.HIGH
    
    # Compliance frameworks to check
    frameworks: list[str] = field(default_factory=lambda: ["SOC2", "PCI-DSS"])
    
    # Thresholds
    min_compliance_score: float = 80.0
    max_critical_findings: int = 0
    max_high_findings: int = 3
    
    # Scanning options
    scan_iac: bool = True
    scan_secrets: bool = True
    scan_dependencies: bool = True
    scan_containers: bool = True
    
    # Output options
    generate_sarif: bool = True
    generate_report: bool = True
    upload_evidence: bool = True
    
    # WISTX API configuration
    wistx_api_url: str = "https://api.wistx.io"
    
    # Notification settings
    notify_on_failure: bool = True
    slack_webhook_secret: str = ""
    teams_webhook_secret: str = ""


class CICDComplianceGateGenerator:
    """Generates CI/CD compliance gate configurations for various platforms.
    
    This generator creates pipeline configurations that integrate WISTX
    compliance scanning into the CI/CD workflow, enforcing compliance
    requirements before code reaches production.
    """
    
    def __init__(self, config: ComplianceGateConfig | None = None):
        """Initialize the generator.
        
        Args:
            config: Compliance gate configuration
        """
        self.config = config or ComplianceGateConfig()
    
    def generate(self, platform: CICDPlatform) -> dict[str, Any]:
        """Generate compliance gate configuration for a platform.
        
        Args:
            platform: Target CI/CD platform
            
        Returns:
            Dictionary containing configuration files and instructions
        """
        generators = {
            CICDPlatform.GITHUB_ACTIONS: self._generate_github_actions,
            CICDPlatform.GITLAB_CI: self._generate_gitlab_ci,
            CICDPlatform.AZURE_DEVOPS: self._generate_azure_devops,
            CICDPlatform.JENKINS: self._generate_jenkins,
            CICDPlatform.BITBUCKET: self._generate_bitbucket,
            CICDPlatform.CIRCLECI: self._generate_circleci,
        }
        
        generator = generators.get(platform)
        if not generator:
            raise ValueError(f"Unsupported platform: {platform}")
        
        return generator()
    
    def _generate_github_actions(self) -> dict[str, Any]:
        """Generate GitHub Actions workflow for compliance scanning."""
        workflow = self._get_github_actions_workflow()
        
        return {
            "platform": "GitHub Actions",
            "files": {
                ".github/workflows/wistx-compliance.yml": workflow,
            },
            "secrets_required": [
                "WISTX_API_KEY",
                "SLACK_WEBHOOK_URL" if self.config.slack_webhook_secret else None,
            ],
            "setup_instructions": self._get_github_setup_instructions(),
        }
    
    def _get_github_actions_workflow(self) -> str:
        """Generate GitHub Actions workflow YAML."""
        mode_config = self._get_mode_config()
        
        return f'''# WISTX Compliance Gate - GitHub Actions
# Generated by WISTX Context Augmentation Platform
# Standards: NIST SP 800-53 SA-11, ISO 27001 A.8.25, SOC 2 CC8.1

name: WISTX Compliance Gate

on:
  pull_request:
    branches: [main, master, develop]
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      scan_mode:
        description: 'Scan mode (blocking/warning/audit)'
        required: false
        default: '{self.config.mode.value}'

permissions:
  contents: read
  security-events: write
  pull-requests: write

env:
  WISTX_API_URL: {self.config.wistx_api_url}
  COMPLIANCE_FRAMEWORKS: "{','.join(self.config.frameworks)}"
  MIN_COMPLIANCE_SCORE: {self.config.min_compliance_score}
  MAX_CRITICAL_FINDINGS: {self.config.max_critical_findings}
  MAX_HIGH_FINDINGS: {self.config.max_high_findings}

jobs:
  compliance-scan:
    name: WISTX Compliance Scan
    runs-on: ubuntu-latest
    outputs:
      compliance_score: ${{{{ steps.scan.outputs.compliance_score }}}}
      critical_count: ${{{{ steps.scan.outputs.critical_count }}}}
      high_count: ${{{{ steps.scan.outputs.high_count }}}}
      gate_passed: ${{{{ steps.evaluate.outputs.gate_passed }}}}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install WISTX CLI
        run: |
          pip install wistx-cli
      
      - name: Run Infrastructure-as-Code Scan
        if: {str(self.config.scan_iac).lower()}
        id: iac-scan
        run: |
          wistx scan iac \\
            --frameworks "$COMPLIANCE_FRAMEWORKS" \\
            --output-format sarif \\
            --output-file iac-results.sarif
        env:
          WISTX_API_KEY: ${{{{ secrets.WISTX_API_KEY }}}}
      
      - name: Run Secret Detection
        if: {str(self.config.scan_secrets).lower()}
        id: secret-scan
        run: |
          wistx scan secrets \\
            --output-format sarif \\
            --output-file secrets-results.sarif
        env:
          WISTX_API_KEY: ${{{{ secrets.WISTX_API_KEY }}}}
      
      - name: Run Dependency Scan
        if: {str(self.config.scan_dependencies).lower()}
        id: dep-scan
        run: |
          wistx scan dependencies \\
            --frameworks "$COMPLIANCE_FRAMEWORKS" \\
            --output-format sarif \\
            --output-file deps-results.sarif
        env:
          WISTX_API_KEY: ${{{{ secrets.WISTX_API_KEY }}}}
      
      - name: Run Container Scan
        if: {str(self.config.scan_containers).lower()}
        id: container-scan
        run: |
          wistx scan containers \\
            --frameworks "$COMPLIANCE_FRAMEWORKS" \\
            --output-format sarif \\
            --output-file container-results.sarif
        env:
          WISTX_API_KEY: ${{{{ secrets.WISTX_API_KEY }}}}
      
      - name: Aggregate Compliance Results
        id: scan
        run: |
          wistx compliance aggregate \\
            --frameworks "$COMPLIANCE_FRAMEWORKS" \\
            --min-score $MIN_COMPLIANCE_SCORE \\
            --output-format json \\
            --output-file compliance-report.json
          
          # Extract metrics for gate evaluation
          SCORE=$(jq -r '.compliance_score' compliance-report.json)
          CRITICAL=$(jq -r '.findings.critical' compliance-report.json)
          HIGH=$(jq -r '.findings.high' compliance-report.json)
          
          echo "compliance_score=$SCORE" >> $GITHUB_OUTPUT
          echo "critical_count=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high_count=$HIGH" >> $GITHUB_OUTPUT
        env:
          WISTX_API_KEY: ${{{{ secrets.WISTX_API_KEY }}}}
      
      - name: Evaluate Compliance Gate
        id: evaluate
        run: |
          SCORE=${{{{ steps.scan.outputs.compliance_score }}}}
          CRITICAL=${{{{ steps.scan.outputs.critical_count }}}}
          HIGH=${{{{ steps.scan.outputs.high_count }}}}
          
          GATE_PASSED="true"
          FAILURE_REASONS=""
          
          if (( $(echo "$SCORE < $MIN_COMPLIANCE_SCORE" | bc -l) )); then
            GATE_PASSED="false"
            FAILURE_REASONS="Compliance score ($SCORE%) below threshold ($MIN_COMPLIANCE_SCORE%)"
          fi
          
          if [ "$CRITICAL" -gt "$MAX_CRITICAL_FINDINGS" ]; then
            GATE_PASSED="false"
            FAILURE_REASONS="$FAILURE_REASONS; Critical findings ($CRITICAL) exceed limit ($MAX_CRITICAL_FINDINGS)"
          fi
          
          if [ "$HIGH" -gt "$MAX_HIGH_FINDINGS" ]; then
            GATE_PASSED="false"
            FAILURE_REASONS="$FAILURE_REASONS; High findings ($HIGH) exceed limit ($MAX_HIGH_FINDINGS)"
          fi
          
          echo "gate_passed=$GATE_PASSED" >> $GITHUB_OUTPUT
          echo "failure_reasons=$FAILURE_REASONS" >> $GITHUB_OUTPUT
      
      - name: Upload SARIF Results
        if: {str(self.config.generate_sarif).lower()}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: .
          category: wistx-compliance
      
      - name: Upload Compliance Report
        if: {str(self.config.generate_report).lower()}
        uses: actions/upload-artifact@v4
        with:
          name: wistx-compliance-report
          path: |
            compliance-report.json
            *.sarif
          retention-days: 90
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const score = '${{{{ steps.scan.outputs.compliance_score }}}}';
            const critical = '${{{{ steps.scan.outputs.critical_count }}}}';
            const high = '${{{{ steps.scan.outputs.high_count }}}}';
            const passed = '${{{{ steps.evaluate.outputs.gate_passed }}}}' === 'true';
            
            const status = passed ? 'âœ… PASSED' : 'âŒ FAILED';
            const emoji = passed ? 'ðŸŽ‰' : 'âš ï¸';
            
            const body = `## ${{emoji}} WISTX Compliance Gate ${{status}}
            
            | Metric | Value | Threshold |
            |--------|-------|-----------|
            | Compliance Score | ${{score}}% | ${{process.env.MIN_COMPLIANCE_SCORE}}% |
            | Critical Findings | ${{critical}} | ${{process.env.MAX_CRITICAL_FINDINGS}} |
            | High Findings | ${{high}} | ${{process.env.MAX_HIGH_FINDINGS}} |
            
            **Frameworks Checked**: ${{process.env.COMPLIANCE_FRAMEWORKS}}
            
            [View Full Report](../actions/runs/${{context.runId}})
            
            ---
            *Generated by WISTX Context Augmentation Platform*`;
            
            github.rest.issues.createComment({{
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            }});
      
      - name: Enforce Gate ({self.config.mode.value} mode)
        if: steps.evaluate.outputs.gate_passed == 'false'
        run: |
          echo "::error::Compliance gate failed: ${{{{ steps.evaluate.outputs.failure_reasons }}}}"
          {mode_config}
'''
    
    def _get_mode_config(self) -> str:
        """Get mode-specific configuration."""
        if self.config.mode == GateMode.BLOCKING:
            return "exit 1"
        elif self.config.mode == GateMode.WARNING:
            return 'echo "::warning::Compliance issues detected but gate is in warning mode"'
        else:  # AUDIT
            return 'echo "::notice::Compliance scan completed in audit mode"'
    
    def _get_github_setup_instructions(self) -> str:
        """Get setup instructions for GitHub Actions."""
        return """
## GitHub Actions Setup Instructions

### 1. Add Required Secrets

Go to your repository Settings > Secrets and variables > Actions, and add:

- `WISTX_API_KEY`: Your WISTX API key (required)
- `SLACK_WEBHOOK_URL`: Slack webhook for notifications (optional)

### 2. Enable GitHub Advanced Security (Optional)

To see SARIF results in the Security tab:
1. Go to Settings > Code security and analysis
2. Enable "Code scanning"

### 3. Configure Branch Protection (Recommended)

1. Go to Settings > Branches > Branch protection rules
2. Add rule for `main` branch
3. Enable "Require status checks to pass before merging"
4. Add "WISTX Compliance Scan" as required check

### 4. Customize Thresholds

Edit `.github/workflows/wistx-compliance.yml` to adjust:
- `MIN_COMPLIANCE_SCORE`: Minimum passing score (default: 80%)
- `MAX_CRITICAL_FINDINGS`: Maximum critical findings allowed (default: 0)
- `MAX_HIGH_FINDINGS`: Maximum high findings allowed (default: 3)
"""

    def _generate_gitlab_ci(self) -> dict[str, Any]:
        """Generate GitLab CI configuration for compliance scanning."""
        gitlab_ci = self._get_gitlab_ci_config()

        return {
            "platform": "GitLab CI",
            "files": {
                ".gitlab-ci.yml": gitlab_ci,
                ".gitlab/compliance-policy.yml": self._get_gitlab_policy(),
            },
            "variables_required": [
                "WISTX_API_KEY",
            ],
            "setup_instructions": self._get_gitlab_setup_instructions(),
        }

    def _get_gitlab_ci_config(self) -> str:
        """Generate GitLab CI YAML configuration."""
        return f'''# WISTX Compliance Gate - GitLab CI
# Generated by WISTX Context Augmentation Platform
# Standards: NIST SP 800-53 SA-11, ISO 27001 A.8.25, SOC 2 CC8.1

stages:
  - compliance-scan
  - compliance-gate
  - deploy

variables:
  WISTX_API_URL: {self.config.wistx_api_url}
  COMPLIANCE_FRAMEWORKS: "{','.join(self.config.frameworks)}"
  MIN_COMPLIANCE_SCORE: "{self.config.min_compliance_score}"
  MAX_CRITICAL_FINDINGS: "{self.config.max_critical_findings}"
  MAX_HIGH_FINDINGS: "{self.config.max_high_findings}"
  GATE_MODE: "{self.config.mode.value}"

# Compliance scanning job
wistx-compliance-scan:
  stage: compliance-scan
  image: python:3.11-slim
  before_script:
    - pip install wistx-cli
  script:
    # Infrastructure-as-Code scan
    - |
      if [ "{str(self.config.scan_iac).lower()}" = "true" ]; then
        wistx scan iac \\
          --frameworks "$COMPLIANCE_FRAMEWORKS" \\
          --output-format json \\
          --output-file iac-results.json
      fi

    # Secret detection
    - |
      if [ "{str(self.config.scan_secrets).lower()}" = "true" ]; then
        wistx scan secrets \\
          --output-format json \\
          --output-file secrets-results.json
      fi

    # Dependency scan
    - |
      if [ "{str(self.config.scan_dependencies).lower()}" = "true" ]; then
        wistx scan dependencies \\
          --frameworks "$COMPLIANCE_FRAMEWORKS" \\
          --output-format json \\
          --output-file deps-results.json
      fi

    # Container scan
    - |
      if [ "{str(self.config.scan_containers).lower()}" = "true" ]; then
        wistx scan containers \\
          --frameworks "$COMPLIANCE_FRAMEWORKS" \\
          --output-format json \\
          --output-file container-results.json || true
      fi

    # Aggregate results
    - |
      wistx compliance aggregate \\
        --frameworks "$COMPLIANCE_FRAMEWORKS" \\
        --min-score $MIN_COMPLIANCE_SCORE \\
        --output-format json \\
        --output-file compliance-report.json

    # Generate GitLab-compatible reports
    - |
      wistx compliance convert \\
        --input compliance-report.json \\
        --output-format gitlab-sast \\
        --output-file gl-sast-report.json

    - |
      wistx compliance convert \\
        --input compliance-report.json \\
        --output-format gitlab-dependency \\
        --output-file gl-dependency-scanning-report.json
  artifacts:
    paths:
      - compliance-report.json
      - "*-results.json"
    reports:
      sast: gl-sast-report.json
      dependency_scanning: gl-dependency-scanning-report.json
    expire_in: 90 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Compliance gate evaluation
wistx-compliance-gate:
  stage: compliance-gate
  image: alpine:latest
  needs:
    - wistx-compliance-scan
  before_script:
    - apk add --no-cache jq bc
  script:
    - |
      SCORE=$(jq -r '.compliance_score' compliance-report.json)
      CRITICAL=$(jq -r '.findings.critical // 0' compliance-report.json)
      HIGH=$(jq -r '.findings.high // 0' compliance-report.json)

      echo "============================================"
      echo "WISTX Compliance Gate Results"
      echo "============================================"
      echo "Compliance Score: $SCORE%"
      echo "Critical Findings: $CRITICAL"
      echo "High Findings: $HIGH"
      echo "============================================"

      GATE_PASSED="true"

      if [ $(echo "$SCORE < $MIN_COMPLIANCE_SCORE" | bc -l) -eq 1 ]; then
        echo "âŒ FAILED: Score ($SCORE%) below threshold ($MIN_COMPLIANCE_SCORE%)"
        GATE_PASSED="false"
      fi

      if [ "$CRITICAL" -gt "$MAX_CRITICAL_FINDINGS" ]; then
        echo "âŒ FAILED: Critical findings ($CRITICAL) exceed limit ($MAX_CRITICAL_FINDINGS)"
        GATE_PASSED="false"
      fi

      if [ "$HIGH" -gt "$MAX_HIGH_FINDINGS" ]; then
        echo "âŒ FAILED: High findings ($HIGH) exceed limit ($MAX_HIGH_FINDINGS)"
        GATE_PASSED="false"
      fi

      if [ "$GATE_PASSED" = "false" ]; then
        if [ "$GATE_MODE" = "blocking" ]; then
          echo "Gate mode: BLOCKING - Pipeline will fail"
          exit 1
        elif [ "$GATE_MODE" = "warning" ]; then
          echo "Gate mode: WARNING - Issues detected but allowing pipeline to continue"
        else
          echo "Gate mode: AUDIT - Logging only"
        fi
      else
        echo "âœ… PASSED: All compliance checks passed"
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Example deploy job (only runs if gate passes)
deploy:
  stage: deploy
  needs:
    - wistx-compliance-gate
  script:
    - echo "Deploying application..."
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
'''

    def _get_gitlab_policy(self) -> str:
        """Generate GitLab security policy YAML."""
        return f'''# WISTX Compliance Policy for GitLab
# This policy enforces compliance scanning on all pipelines

type: pipeline_execution_policy
name: WISTX Compliance Enforcement
description: Enforces WISTX compliance scanning before deployment
enabled: true
rules:
  - type: pipeline
    branches:
      - main
      - master
      - develop
    content:
      include:
        - project: '$CI_PROJECT_PATH'
          file: '.gitlab-ci.yml'
          ref: '$CI_COMMIT_SHA'
actions:
  - scan: sast
  - scan: dependency_scanning
  - scan: secret_detection
'''

    def _get_gitlab_setup_instructions(self) -> str:
        """Get setup instructions for GitLab CI."""
        return """
## GitLab CI Setup Instructions

### 1. Add CI/CD Variables

Go to Settings > CI/CD > Variables and add:

- `WISTX_API_KEY`: Your WISTX API key (masked, protected)

### 2. Enable Security Features

Go to Settings > Security & Compliance:
1. Enable SAST
2. Enable Dependency Scanning
3. Enable Secret Detection

### 3. Configure Merge Request Approvals (Recommended)

Go to Settings > Merge requests:
1. Enable "Pipelines must succeed"
2. Add approval rule requiring security team review

### 4. Set Up Compliance Framework (Ultimate)

If using GitLab Ultimate:
1. Go to Settings > General > Compliance framework
2. Create framework with WISTX compliance requirements
"""

    def _generate_azure_devops(self) -> dict[str, Any]:
        """Generate Azure DevOps pipeline for compliance scanning."""
        return {
            "platform": "Azure DevOps",
            "files": {
                "azure-pipelines.yml": self._get_azure_devops_pipeline(),
            },
            "variables_required": [
                "WISTX_API_KEY",
            ],
            "setup_instructions": self._get_azure_setup_instructions(),
        }

    def _get_azure_devops_pipeline(self) -> str:
        """Generate Azure DevOps pipeline YAML."""
        return f'''# WISTX Compliance Gate - Azure DevOps
# Generated by WISTX Context Augmentation Platform

trigger:
  branches:
    include:
      - main
      - master
      - develop

pr:
  branches:
    include:
      - main
      - master

variables:
  WISTX_API_URL: {self.config.wistx_api_url}
  COMPLIANCE_FRAMEWORKS: '{",".join(self.config.frameworks)}'
  MIN_COMPLIANCE_SCORE: {self.config.min_compliance_score}
  MAX_CRITICAL_FINDINGS: {self.config.max_critical_findings}
  MAX_HIGH_FINDINGS: {self.config.max_high_findings}

stages:
  - stage: ComplianceScan
    displayName: 'WISTX Compliance Scan'
    jobs:
      - job: Scan
        displayName: 'Run Compliance Scans'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.11'

          - script: pip install wistx-cli
            displayName: 'Install WISTX CLI'

          - script: |
              wistx scan iac \\
                --frameworks "$(COMPLIANCE_FRAMEWORKS)" \\
                --output-format json \\
                --output-file $(Build.ArtifactStagingDirectory)/iac-results.json
            displayName: 'IaC Compliance Scan'
            env:
              WISTX_API_KEY: $(WISTX_API_KEY)

          - script: |
              wistx compliance aggregate \\
                --frameworks "$(COMPLIANCE_FRAMEWORKS)" \\
                --min-score $(MIN_COMPLIANCE_SCORE) \\
                --output-format json \\
                --output-file $(Build.ArtifactStagingDirectory)/compliance-report.json
            displayName: 'Aggregate Compliance Results'
            env:
              WISTX_API_KEY: $(WISTX_API_KEY)

          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: $(Build.ArtifactStagingDirectory)
              artifactName: 'compliance-reports'

          - script: |
              SCORE=$(jq -r '.compliance_score' $(Build.ArtifactStagingDirectory)/compliance-report.json)
              CRITICAL=$(jq -r '.findings.critical // 0' $(Build.ArtifactStagingDirectory)/compliance-report.json)

              echo "##vso[task.setvariable variable=COMPLIANCE_SCORE;isOutput=true]$SCORE"
              echo "##vso[task.setvariable variable=CRITICAL_COUNT;isOutput=true]$CRITICAL"

              if [ $(echo "$SCORE < $(MIN_COMPLIANCE_SCORE)" | bc -l) -eq 1 ]; then
                echo "##vso[task.logissue type=error]Compliance score ($SCORE%) below threshold"
                exit 1
              fi

              if [ "$CRITICAL" -gt "$(MAX_CRITICAL_FINDINGS)" ]; then
                echo "##vso[task.logissue type=error]Critical findings ($CRITICAL) exceed limit"
                exit 1
              fi
            displayName: 'Evaluate Compliance Gate'
            name: gate
'''

    def _get_azure_setup_instructions(self) -> str:
        """Get setup instructions for Azure DevOps."""
        return """
## Azure DevOps Setup Instructions

### 1. Add Pipeline Variables

Go to Pipelines > Edit > Variables:

- `WISTX_API_KEY`: Your WISTX API key (mark as secret)

### 2. Configure Branch Policies

Go to Repos > Branches > Branch policies for main:
1. Require a minimum number of reviewers
2. Check for linked work items
3. Build validation: Add WISTX compliance pipeline

### 3. Set Up Service Connection (Optional)

For advanced integrations:
1. Project Settings > Service connections
2. Create new service connection for WISTX
"""

    def _generate_jenkins(self) -> dict[str, Any]:
        """Generate Jenkins pipeline for compliance scanning."""
        return {
            "platform": "Jenkins",
            "files": {
                "Jenkinsfile": self._get_jenkinsfile(),
            },
            "credentials_required": [
                "wistx-api-key",
            ],
            "setup_instructions": self._get_jenkins_setup_instructions(),
        }

    def _get_jenkinsfile(self) -> str:
        """Generate Jenkinsfile."""
        scan_iac = str(self.config.scan_iac).lower()
        scan_secrets = str(self.config.scan_secrets).lower()
        scan_deps = str(self.config.scan_dependencies).lower()
        frameworks = ",".join(self.config.frameworks)

        return f"""// WISTX Compliance Gate - Jenkins Pipeline
// Generated by WISTX Context Augmentation Platform

pipeline {{
    agent any

    environment {{
        WISTX_API_KEY = credentials('wistx-api-key')
        WISTX_API_URL = '{self.config.wistx_api_url}'
        COMPLIANCE_FRAMEWORKS = '{frameworks}'
        MIN_COMPLIANCE_SCORE = '{self.config.min_compliance_score}'
        MAX_CRITICAL_FINDINGS = '{self.config.max_critical_findings}'
        MAX_HIGH_FINDINGS = '{self.config.max_high_findings}'
    }}

    stages {{
        stage('Install WISTX CLI') {{
            steps {{
                sh 'pip install wistx-cli'
            }}
        }}

        stage('Compliance Scan') {{
            parallel {{
                stage('IaC Scan') {{
                    when {{ expression {{ return {scan_iac} }} }}
                    steps {{
                        sh 'wistx scan iac --frameworks "$COMPLIANCE_FRAMEWORKS" --output-format json --output-file iac-results.json'
                    }}
                }}
                stage('Secret Scan') {{
                    when {{ expression {{ return {scan_secrets} }} }}
                    steps {{
                        sh 'wistx scan secrets --output-format json --output-file secrets-results.json'
                    }}
                }}
                stage('Dependency Scan') {{
                    when {{ expression {{ return {scan_deps} }} }}
                    steps {{
                        sh 'wistx scan dependencies --frameworks "$COMPLIANCE_FRAMEWORKS" --output-format json --output-file deps-results.json'
                    }}
                }}
            }}
        }}

        stage('Aggregate Results') {{
            steps {{
                sh 'wistx compliance aggregate --frameworks "$COMPLIANCE_FRAMEWORKS" --min-score $MIN_COMPLIANCE_SCORE --output-format json --output-file compliance-report.json'
            }}
        }}

        stage('Compliance Gate') {{
            steps {{
                script {{
                    def report = readJSON file: 'compliance-report.json'
                    def score = report.compliance_score
                    def critical = report.findings?.critical ?: 0
                    def high = report.findings?.high ?: 0

                    echo "Compliance Score: ${{score}}%"
                    echo "Critical Findings: ${{critical}}"
                    echo "High Findings: ${{high}}"

                    if (score < env.MIN_COMPLIANCE_SCORE.toFloat()) {{
                        error "Compliance score (${{score}}%) below threshold (${{env.MIN_COMPLIANCE_SCORE}}%)"
                    }}

                    if (critical > env.MAX_CRITICAL_FINDINGS.toInteger()) {{
                        error "Critical findings (${{critical}}) exceed limit (${{env.MAX_CRITICAL_FINDINGS}})"
                    }}

                    if (high > env.MAX_HIGH_FINDINGS.toInteger()) {{
                        error "High findings (${{high}}) exceed limit (${{env.MAX_HIGH_FINDINGS}})"
                    }}

                    echo "Compliance gate passed"
                }}
            }}
        }}
    }}

    post {{
        always {{
            archiveArtifacts artifacts: '*.json', fingerprint: true
            publishHTML([
                allowMissing: false,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: '.',
                reportFiles: 'compliance-report.json',
                reportName: 'WISTX Compliance Report'
            ])
        }}
        failure {{
            echo 'Compliance gate failed - review findings before proceeding'
        }}
    }}
}}
"""

    def _get_jenkins_setup_instructions(self) -> str:
        """Get setup instructions for Jenkins."""
        return """
## Jenkins Setup Instructions

### 1. Add Credentials

Go to Manage Jenkins > Credentials:

1. Add new credential of type "Secret text"
2. ID: `wistx-api-key`
3. Secret: Your WISTX API key

### 2. Install Required Plugins

- Pipeline
- Pipeline Utility Steps (for readJSON)
- HTML Publisher (for reports)

### 3. Configure Multibranch Pipeline

1. New Item > Multibranch Pipeline
2. Add branch source (GitHub/GitLab/Bitbucket)
3. Build Configuration: by Jenkinsfile
"""

    def _generate_bitbucket(self) -> dict[str, Any]:
        """Generate Bitbucket Pipelines configuration."""
        return {
            "platform": "Bitbucket Pipelines",
            "files": {
                "bitbucket-pipelines.yml": self._get_bitbucket_pipeline(),
            },
            "variables_required": [
                "WISTX_API_KEY",
            ],
            "setup_instructions": """
## Bitbucket Pipelines Setup

### 1. Add Repository Variables

Go to Repository settings > Pipelines > Repository variables:

- `WISTX_API_KEY`: Your WISTX API key (secured)

### 2. Enable Pipelines

Go to Repository settings > Pipelines > Settings:
- Enable Pipelines
""",
        }

    def _get_bitbucket_pipeline(self) -> str:
        """Generate Bitbucket Pipelines YAML."""
        return f'''# WISTX Compliance Gate - Bitbucket Pipelines
# Generated by WISTX Context Augmentation Platform

image: python:3.11-slim

definitions:
  steps:
    - step: &compliance-scan
        name: WISTX Compliance Scan
        script:
          - pip install wistx-cli
          - wistx scan iac --frameworks "{','.join(self.config.frameworks)}" --output-format json --output-file iac-results.json
          - wistx compliance aggregate --frameworks "{','.join(self.config.frameworks)}" --min-score {self.config.min_compliance_score} --output-format json --output-file compliance-report.json
          - |
            SCORE=$(python -c "import json; print(json.load(open('compliance-report.json'))['compliance_score'])")
            echo "Compliance Score: $SCORE%"
            if [ $(echo "$SCORE < {self.config.min_compliance_score}" | bc -l) -eq 1 ]; then
              echo "Compliance gate failed"
              exit 1
            fi
        artifacts:
          - compliance-report.json
          - "*.json"

pipelines:
  pull-requests:
    '**':
      - step: *compliance-scan

  branches:
    main:
      - step: *compliance-scan
      - step:
          name: Deploy
          deployment: production
          trigger: manual
          script:
            - echo "Deploying..."
'''

    def _generate_circleci(self) -> dict[str, Any]:
        """Generate CircleCI configuration."""
        return {
            "platform": "CircleCI",
            "files": {
                ".circleci/config.yml": self._get_circleci_config(),
            },
            "context_required": [
                "wistx-credentials",
            ],
            "setup_instructions": """
## CircleCI Setup

### 1. Create Context

Go to Organization Settings > Contexts:

1. Create context: `wistx-credentials`
2. Add environment variable: `WISTX_API_KEY`

### 2. Configure Project

Go to Project Settings:
1. Enable "Only build pull requests"
2. Add branch protection rules
""",
        }

    def _get_circleci_config(self) -> str:
        """Generate CircleCI config YAML."""
        return f'''# WISTX Compliance Gate - CircleCI
# Generated by WISTX Context Augmentation Platform

version: 2.1

orbs:
  python: circleci/python@2.1

jobs:
  compliance-scan:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout
      - run:
          name: Install WISTX CLI
          command: pip install wistx-cli
      - run:
          name: Run Compliance Scan
          command: |
            wistx scan iac \\
              --frameworks "{','.join(self.config.frameworks)}" \\
              --output-format json \\
              --output-file iac-results.json

            wistx compliance aggregate \\
              --frameworks "{','.join(self.config.frameworks)}" \\
              --min-score {self.config.min_compliance_score} \\
              --output-format json \\
              --output-file compliance-report.json
      - run:
          name: Evaluate Compliance Gate
          command: |
            SCORE=$(python -c "import json; print(json.load(open('compliance-report.json'))['compliance_score'])")
            echo "Compliance Score: $SCORE%"

            if [ $(echo "$SCORE < {self.config.min_compliance_score}" | bc -l) -eq 1 ]; then
              echo "Compliance gate failed"
              exit 1
            fi

            echo "Compliance gate passed"
      - store_artifacts:
          path: compliance-report.json
          destination: compliance-reports

workflows:
  compliance:
    jobs:
      - compliance-scan:
          context: wistx-credentials
          filters:
            branches:
              only:
                - main
                - master
                - develop
'''

    def generate_pre_commit_hooks(self) -> dict[str, Any]:
        """Generate pre-commit hooks for local compliance checking.

        Returns:
            Dictionary containing pre-commit configuration and scripts
        """
        return {
            "files": {
                ".pre-commit-config.yaml": self._get_pre_commit_config(),
                "scripts/wistx-pre-commit.sh": self._get_pre_commit_script(),
            },
            "setup_instructions": self._get_pre_commit_instructions(),
        }

    def _get_pre_commit_config(self) -> str:
        """Generate pre-commit configuration."""
        return f'''# WISTX Compliance Pre-commit Hooks
# Generated by WISTX Context Augmentation Platform
# Install: pip install pre-commit && pre-commit install

repos:
  # WISTX Compliance Checks
  - repo: local
    hooks:
      - id: wistx-iac-scan
        name: WISTX IaC Compliance Scan
        entry: scripts/wistx-pre-commit.sh iac
        language: script
        files: \\.(tf|yaml|yml|json)$
        exclude: ^(node_modules|.git)/
        stages: [commit]
        verbose: true

      - id: wistx-secret-scan
        name: WISTX Secret Detection
        entry: scripts/wistx-pre-commit.sh secrets
        language: script
        files: .*
        exclude: ^(node_modules|.git)/
        stages: [commit]
        verbose: true

  # Standard security hooks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: detect-private-key
      - id: check-added-large-files
        args: ['--maxkb=1000']
      - id: check-merge-conflict

  # Terraform formatting (if applicable)
  - repo: https://github.com/antonbabenko/pre-commit-terraform
    rev: v1.86.0
    hooks:
      - id: terraform_fmt
      - id: terraform_validate
      - id: terraform_tflint

  # YAML linting
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.33.0
    hooks:
      - id: yamllint
        args: [-c=.yamllint.yml]

# Default stages
default_stages: [commit, push]

# Fail fast on first error
fail_fast: false

# Minimum pre-commit version
minimum_pre_commit_version: '3.0.0'
'''

    def _get_pre_commit_script(self) -> str:
        """Generate pre-commit shell script."""
        return f'''#!/bin/bash
# WISTX Pre-commit Compliance Check
# Generated by WISTX Context Augmentation Platform

set -e

SCAN_TYPE="${{1:-iac}}"
FRAMEWORKS="{','.join(self.config.frameworks)}"
MIN_SCORE={self.config.min_compliance_score}

# Colors for output
RED='\\033[0;31m'
GREEN='\\033[0;32m'
YELLOW='\\033[1;33m'
NC='\\033[0m' # No Color

echo -e "${{YELLOW}}Running WISTX $SCAN_TYPE compliance check...${{NC}}"

# Check if WISTX CLI is installed
if ! command -v wistx &> /dev/null; then
    echo -e "${{RED}}Error: WISTX CLI not installed. Run: pip install wistx-cli${{NC}}"
    exit 1
fi

# Check for API key
if [ -z "$WISTX_API_KEY" ]; then
    echo -e "${{YELLOW}}Warning: WISTX_API_KEY not set. Running in offline mode.${{NC}}"
fi

# Run appropriate scan
case $SCAN_TYPE in
    iac)
        wistx scan iac \\
            --frameworks "$FRAMEWORKS" \\
            --staged-only \\
            --output-format summary \\
            --min-score $MIN_SCORE
        ;;
    secrets)
        wistx scan secrets \\
            --staged-only \\
            --output-format summary
        ;;
    deps)
        wistx scan dependencies \\
            --frameworks "$FRAMEWORKS" \\
            --output-format summary
        ;;
    *)
        echo -e "${{RED}}Unknown scan type: $SCAN_TYPE${{NC}}"
        exit 1
        ;;
esac

RESULT=$?

if [ $RESULT -eq 0 ]; then
    echo -e "${{GREEN}}âœ… WISTX compliance check passed${{NC}}"
else
    echo -e "${{RED}}âŒ WISTX compliance check failed${{NC}}"
    echo -e "${{YELLOW}}Review findings above before committing.${{NC}}"
    exit 1
fi
'''

    def _get_pre_commit_instructions(self) -> str:
        """Get pre-commit setup instructions."""
        return """
## Pre-commit Hooks Setup

### 1. Install pre-commit

```bash
pip install pre-commit
```

### 2. Install WISTX CLI

```bash
pip install wistx-cli
```

### 3. Set up hooks

```bash
# Make script executable
chmod +x scripts/wistx-pre-commit.sh

# Install pre-commit hooks
pre-commit install
pre-commit install --hook-type pre-push
```

### 4. Configure API Key (Optional)

For full compliance checking, set your API key:

```bash
export WISTX_API_KEY="your-api-key"
```

Or add to your shell profile (~/.bashrc, ~/.zshrc).

### 5. Test the hooks

```bash
pre-commit run --all-files
```

### 6. Skip hooks (emergency only)

```bash
git commit --no-verify -m "Emergency fix"
```

Note: Skipping hooks should be rare and documented.
"""

    def generate_all(self) -> dict[str, Any]:
        """Generate compliance gate configurations for all platforms.

        Returns:
            Dictionary containing configurations for all supported platforms
        """
        results = {
            "generated_at": "auto",
            "config": {
                "mode": self.config.mode.value,
                "frameworks": self.config.frameworks,
                "min_compliance_score": self.config.min_compliance_score,
                "max_critical_findings": self.config.max_critical_findings,
                "max_high_findings": self.config.max_high_findings,
            },
            "platforms": {},
            "pre_commit": self.generate_pre_commit_hooks(),
        }

        for platform in CICDPlatform:
            try:
                results["platforms"][platform.value] = self.generate(platform)
            except Exception as e:
                logger.error(f"Failed to generate config for {platform}: {e}")
                results["platforms"][platform.value] = {"error": str(e)}

        return results


# Convenience function for direct use
def generate_compliance_gate(
    platform: str | CICDPlatform,
    mode: str = "blocking",
    frameworks: list[str] | None = None,
    min_score: float = 80.0,
    max_critical: int = 0,
    max_high: int = 3,
) -> dict[str, Any]:
    """Generate compliance gate configuration for a CI/CD platform.

    Args:
        platform: Target CI/CD platform (github_actions, gitlab_ci, etc.)
        mode: Gate mode (blocking, warning, audit)
        frameworks: Compliance frameworks to check
        min_score: Minimum compliance score threshold
        max_critical: Maximum critical findings allowed
        max_high: Maximum high findings allowed

    Returns:
        Dictionary containing configuration files and setup instructions
    """
    if isinstance(platform, str):
        platform = CICDPlatform(platform)

    config = ComplianceGateConfig(
        mode=GateMode(mode),
        frameworks=frameworks or ["SOC2", "PCI-DSS"],
        min_compliance_score=min_score,
        max_critical_findings=max_critical,
        max_high_findings=max_high,
    )

    generator = CICDComplianceGateGenerator(config)
    return generator.generate(platform)

