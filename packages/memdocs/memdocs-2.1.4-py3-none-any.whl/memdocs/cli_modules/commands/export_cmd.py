"""
Export command - Export docs for AI assistants.
"""

import json
import sys
from datetime import datetime
from pathlib import Path
from typing import Any

import click
import yaml

from memdocs import cli_output as out


@click.command()
@click.argument("export_format", type=click.Choice(["cursor", "claude", "continue"]))
@click.option(
    "--output",
    type=click.Path(path_type=Path),
    help="Output file path",
)
@click.option(
    "--docs-dir",
    type=click.Path(path_type=Path),
    default=Path(".memdocs/docs"),
    help="Documentation directory",
)
@click.option(
    "--include-symbols/--no-symbols",
    default=True,
    help="Include code symbols in export",
)
def export(export_format: str, output: Path | None, docs_dir: Path, include_symbols: bool) -> None:
    """Export docs for AI assistants.

    Examples:

        memdocs export cursor --output .cursorrules
        memdocs export claude --output .claude-context.md
        memdocs export continue
    """
    out.print_header("MemDocs Export")
    out.step(f"Exporting to [cyan]{export_format}[/cyan] format")

    if not docs_dir.exists():
        out.error(f"Docs directory not found: {docs_dir}")
        out.info("Run [cyan]memdocs review[/cyan] first to generate docs")
        sys.exit(1)

    # Load summary
    summary_path = docs_dir / "summary.md"
    if not summary_path.exists():
        out.error("summary.md not found")
        out.info("Run [cyan]memdocs review[/cyan] first")
        sys.exit(1)

    summary = summary_path.read_text(encoding="utf-8")

    # Load symbols if requested
    symbols_section = ""
    if include_symbols:
        symbols_path = docs_dir / "symbols.yaml"
        if symbols_path.exists():
            with open(symbols_path, encoding="utf-8") as f:
                symbols_data = yaml.safe_load(f)

            if symbols_data and "symbols" in symbols_data:
                symbols_section = "\n\n## üó∫Ô∏è Code Map\n\n"
                symbols_by_file: dict[str, list[Any]] = {}

                # Group symbols by file
                for symbol in symbols_data["symbols"]:
                    file_path = str(symbol.get("file", "unknown"))
                    if file_path not in symbols_by_file:
                        symbols_by_file[file_path] = []
                    symbols_by_file[file_path].append(symbol)

                # Format by file
                for file_path, symbols in sorted(symbols_by_file.items()):
                    symbols_section += f"\n### {file_path}\n\n"
                    for sym in symbols:
                        kind = sym.get("kind", "unknown")
                        name = sym.get("name", "unknown")
                        line = sym.get("line", 0)
                        sig = sym.get("signature", "")

                        if sig:
                            symbols_section += (
                                f"- **{kind}** `{name}` (line {line})\n  ```\n  {sig}\n  ```\n"
                            )
                        else:
                            symbols_section += f"- **{kind}** `{name}` (line {line})\n"

    # Load graph
    graph_section = ""
    graph_path = docs_dir.parent / "memory" / "graph.json"
    if graph_path.exists():
        with open(graph_path, encoding="utf-8") as f:
            graph_data = json.load(f)

        graph_section = "\n\n## üîó Memory Graph\n\n"
        if "features" in graph_data:
            graph_section += "**Recent Features:**\n"
            for feature in graph_data.get("features", [])[:5]:
                graph_section += f"- {feature.get('title', 'Untitled')}\n"

    # Format based on target
    if export_format == "cursor":
        output_path = output or Path(".cursorrules")
        content = f"""# Project Memory (Auto-generated by doc-intelligence)
# Last updated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

## üìö Documentation

{summary}
{symbols_section}
{graph_section}

---

## üí° Tips for Cursor

- Ask: "What does [function_name] do?"
- Ask: "Where is [feature] implemented?"
- Ask: "Explain the architecture"
- Reference symbols by file:line (e.g., src/auth/jwt.py:33)

---

*Generated by [doc-intelligence](https://github.com/Smart-AI-Memory/memdocs)*
*Regenerate with: `memdocs export cursor`*
"""

    elif export_format == "continue":
        output_path = output or Path(".continue/context.md")
        content = f"""# Project Context

{summary}
{symbols_section}
{graph_section}
"""

    else:  # claude
        output_path = output or Path(".claude-context.md")
        content = f"""{summary}
{symbols_section}
{graph_section}
"""

    # Ensure output directory exists
    output_path.parent.mkdir(parents=True, exist_ok=True)

    with out.spinner(f"Writing {format} export"):
        output_path.write_text(content, encoding="utf-8")

    out.print_rule("Export Complete", style="green")
    out.success(f"Exported to [green]{output_path}[/green]")

    if include_symbols and symbols_section:
        symbol_count = len(symbols_data.get("symbols", []))
        out.info(f"Included {symbol_count} code symbols")
