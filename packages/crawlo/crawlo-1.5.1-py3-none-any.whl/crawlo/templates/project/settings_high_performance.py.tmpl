# -*- coding: UTF-8 -*-
"""
{{project_name}} 项目配置文件（高性能版）
=============================
基于 Crawlo 框架的高性能爬虫项目配置。
适合大规模高并发场景。
"""

# =================================== 基础配置 ===================================

# 项目基本信息
PROJECT_NAME = '{{project_name}}'

# 运行模式：standalone/distributed/auto
RUN_MODE = 'standalone'

# 并发配置
CONCURRENCY = 32
MAX_RUNNING_SPIDERS = 10
DOWNLOAD_DELAY = 0.1
RANDOMNESS = False  # 禁用随机延迟以保证性能

# =================================== 核心组件配置 ===================================

# 下载器：AioHttpDownloader/HttpXDownloader/CurlCffiDownloader
DOWNLOADER = 'crawlo.downloader.aiohttp_downloader.AioHttpDownloader'

# 队列类型：memory/redis/auto
QUEUE_TYPE = 'auto'

# 去重过滤器：MemoryFilter/AioRedisFilter
# 高性能模式下，如果Redis可用则使用Redis去重，否则使用内存去重
FILTER_CLASS = 'crawlo.filters.aioredis_filter.AioRedisFilter'

# 默认去重管道：MemoryDedupPipeline/RedisDedupPipeline
# 高性能模式下，如果Redis可用则使用Redis去重，否则使用内存去重
DEFAULT_DEDUP_PIPELINE = 'crawlo.pipelines.redis_dedup_pipeline.RedisDedupPipeline'

# =================================== 爬虫配置 ===================================

# 爬虫模块配置
SPIDER_MODULES = ['{{project_name}}.spiders']

# 默认请求头
# DEFAULT_REQUEST_HEADERS = {}

# 允许的域名
# ALLOWED_DOMAINS = []

# 数据管道
# 如需添加自定义管道，请取消注释并添加
# PIPELINES = [
#     'crawlo.pipelines.mysql_pipeline.AsyncmyMySQLPipeline',  # MySQL 存储（使用asyncmy异步库）
#     # '{{project_name}}.pipelines.CustomPipeline',  # 用户自定义管道示例
# ]

# =================================== 系统配置 ===================================

# 扩展组件
# 如需添加自定义扩展，请取消注释并添加
# EXTENSIONS = [
#     # '{{project_name}}.extensions.CustomExtension',  # 用户自定义扩展示例
# ]

# 中间件
# 如需添加自定义中间件，请取消注释并添加
# MIDDLEWARES = [
#     # '{{project_name}}.middlewares.CustomMiddleware',  # 用户自定义中间件示例
# ]

# 日志配置
LOG_LEVEL = 'INFO'
LOG_FILE = 'logs/{{project_name}}.log'
LOG_ENCODING = 'utf-8'  # 明确指定日志文件编码
LOG_MAX_BYTES = 50 * 1024 * 1024  # 50MB，适用于高负载场景
LOG_BACKUP_COUNT = 20  # 20个备份文件，适用于高负载场景
# 如果不想要日志轮转，可以设置 LOG_MAX_BYTES = 0
# 当LOG_MAX_BYTES或LOG_BACKUP_COUNT为0时，日志轮转将被禁用，文件会持续增长
STATS_DUMP = True

# 输出配置
OUTPUT_DIR = 'output'

# =================================== 数据库配置 ===================================

# Redis配置
REDIS_HOST = '127.0.0.1'
REDIS_PORT = 6379
REDIS_PASSWORD = ''
REDIS_DB = 0

# 根据是否有密码生成 URL
if REDIS_PASSWORD:
    REDIS_URL = f'redis://:{REDIS_PASSWORD}@{REDIS_HOST}:{REDIS_PORT}/{REDIS_DB}'
else:
    REDIS_URL = f'redis://{REDIS_HOST}:{REDIS_PORT}/{REDIS_DB}'

# MySQL配置
MYSQL_HOST = '127.0.0.1'
MYSQL_PORT = 3306
MYSQL_USER = 'root'
MYSQL_PASSWORD = '123456'
MYSQL_DB = '{{project_name}}'
MYSQL_TABLE = '{{project_name}}_data'
MYSQL_BATCH_SIZE = 100
MYSQL_USE_BATCH = True  # 是否启用批量插入

# MySQL SQL生成行为控制配置
MYSQL_AUTO_UPDATE = False  # 是否使用 REPLACE INTO（完全覆盖已存在记录）
MYSQL_INSERT_IGNORE = False  # 是否使用 INSERT IGNORE（忽略重复数据）
MYSQL_UPDATE_COLUMNS = ()  # 冲突时需更新的列名；指定后 MYSQL_AUTO_UPDATE 失效

# MongoDB配置
MONGO_URI = 'mongodb://localhost:27017'
MONGO_DATABASE = '{{project_name}}_db'
MONGO_COLLECTION = '{{project_name}}_items'
MONGO_MAX_POOL_SIZE = 200
MONGO_MIN_POOL_SIZE = 20
MONGO_BATCH_SIZE = 100  # 批量插入条数
MONGO_USE_BATCH = True  # 是否启用批量插入

# =================================== 网络配置 ===================================

# 代理配置
PROXY_ENABLED = False  # 是否启用代理

# 简单代理（SimpleProxyMiddleware）
PROXY_LIST = []  # 代理列表

# 动态代理（ProxyMiddleware）
PROXY_API_URL = ""  # 代理API地址

# 代理提取方式："proxy" 或 "data.proxy"
PROXY_EXTRACTOR = "proxy"

# 代理刷新控制
PROXY_REFRESH_INTERVAL = 60  # 代理刷新间隔（秒）
PROXY_API_TIMEOUT = 10  # API超时时间

# 浏览器指纹模拟（仅CurlCffiDownloader有效）
CURL_BROWSER_TYPE = "chrome"  # 可选：chrome/edge/safari/firefox

# 自定义浏览器版本映射
CURL_BROWSER_VERSION_MAP = {
    "chrome": "chrome136",
    "edge": "edge101",
    "safari": "safari184",
    "firefox": "firefox135",
}

# 下载器优化配置
# 下载器健康检查
DOWNLOADER_HEALTH_CHECK = True  # 是否启用下载器健康检查
HEALTH_CHECK_INTERVAL = 30  # 健康检查间隔（秒）

# 请求统计配置
REQUEST_STATS_ENABLED = True  # 是否启用请求统计
STATS_RESET_ON_START = False  # 启动时是否重置统计

# HttpX专用配置
HTTPX_HTTP2 = True  # 是否启用HTTP/2支持
HTTPX_FOLLOW_REDIRECTS = True  # 是否自动跟随重定向

# AioHttp专用配置
AIOHTTP_AUTO_DECOMPRESS = True  # 是否自动解压响应
AIOHTTP_FORCE_CLOSE = False  # 是否强制关闭连接

# 通用优化配置
CONNECTION_TTL_DNS_CACHE = 300  # DNS缓存TTL（秒）
CONNECTION_KEEPALIVE_TIMEOUT = 15  # Keep-Alive超时（秒）

# 内存监控配置
MEMORY_MONITOR_ENABLED = False  # 是否启用内存监控
MEMORY_MONITOR_INTERVAL = 60  # 内存监控检查间隔（秒）
MEMORY_WARNING_THRESHOLD = 80.0  # 内存使用率警告阈值（百分比）
MEMORY_CRITICAL_THRESHOLD = 90.0  # 内存使用率严重阈值（百分比）