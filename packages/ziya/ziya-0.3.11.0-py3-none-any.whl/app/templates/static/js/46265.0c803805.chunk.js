"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[46265],{46265:(e,n,t)=>{t.r(n),t.d(n,{default:()=>E});var s=t(89379),i=t(65043),l=(t(85271),t(6381)),o=t(32442),a=t(42214),r=t(6658),c=t(91957),d=t(94828),m=t(15492),g=t(57721),h=t(15615),u=t(88143),p=t(31219),x=t(33359),f=t(70579);const y=e=>{let{index:n,isInline:t=!1}=e;const{currentMessages:y,currentConversationId:v,addMessageToConversation:j,setIsStreaming:C,setConversations:A,streamingConversations:w,addStreamingConversation:b,streamedContentMap:M,setStreamedContentMap:k,removeStreamingConversation:S,editingMessageIndex:I,setEditingMessageIndex:R}=(0,l.v)(),[z,N]=(0,i.useState)(y[n].content),{checkedKeys:E}=(0,a.X)(),K=(0,i.useRef)(null),{TextArea:T}=r.A,F=I===n;(0,i.useEffect)(()=>{F&&K.current&&setTimeout(()=>{K.current&&K.current.focus()},100)},[F]);return(0,f.jsxs)("div",{children:[t&&F&&null,F&&!t&&(0,f.jsxs)("div",{style:{width:"100%"},children:[(0,f.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px",width:"100%"},children:[(0,f.jsx)("div",{className:"message-sender",children:"You:"}),(0,f.jsxs)(c.A,{children:[(0,f.jsx)(d.A,{title:"Cancel editing",children:(0,f.jsx)(m.Ay,{icon:(0,f.jsx)(h.A,{}),onClick:()=>{R(null),N(y[n].content)},size:"small",children:"Cancel"})}),(0,f.jsx)(d.A,{title:"Save changes to context",children:(0,f.jsx)(m.Ay,{icon:(0,f.jsx)(u.A,{}),onClick:()=>{A(e=>e.map(e=>{if(e.id===v){const t=e.messages.map((e,t)=>t===n?(0,s.A)((0,s.A)({},e),{},{content:z,_timestamp:Date.now()}):e);return(0,s.A)((0,s.A)({},e),{},{messages:t,_version:Date.now()})}return e})),R(null)},size:"small",children:"Save"})}),(0,f.jsx)(d.A,{title:"Send to model, remove newer responses",children:(0,f.jsx)(m.Ay,{icon:(0,f.jsx)(p.A,{}),onClick:async()=>{R(null),k(new Map);const e=y.slice(0,n+1);e[n]=(0,s.A)((0,s.A)({},e[n]),{},{content:z,_timestamp:Date.now(),_edited:!0,_truncatedAfter:!0}),A(n=>n.map(n=>n.id===v?(0,s.A)((0,s.A)({},n),{},{messages:e,_version:Date.now(),_editInProgress:!0}):n)),b(v);try{await(0,o.fu)(e,z,(0,g.F)(E),v,M,k,C,S,j,w.has(v))&&A(e=>e.map(e=>e.id===v?(0,s.A)((0,s.A)({},e),{},{_editInProgress:!1}):e))}catch(t){console.error("Error sending message:",t),S(v)}finally{C(!1)}},size:"small",type:"primary",children:"Submit"})})]})]}),(0,f.jsx)(T,{ref:K,autoFocus:!0,style:{width:"100%",minHeight:"100px",resize:"vertical"},value:z,onChange:e=>N(e.target.value),autoSize:{minRows:3,maxRows:20},placeholder:"Edit your message..."})]}),!F&&(t||!F)&&(0,f.jsx)(d.A,{title:"Edit",children:(0,f.jsx)(m.Ay,{icon:(0,f.jsx)(x.A,{}),onClick:()=>{R(n)}})})]})};var v=t(76775),j=t(91686),C=t(42144),A=t(22643),w=t(9356),b=t(94471),M=t(8347);const k=(0,i.memo)(e=>{let{previousModel:n,newModel:t,changeKey:s}=e;const{isDarkMode:i}=(0,M.D)(),l={container:{padding:"12px 16px",borderRadius:"8px",backgroundColor:i?"rgba(25, 118, 210, 0.15)":"rgba(25, 118, 210, 0.08)",border:"1px solid ".concat(i?"#2c6cb0":"#90caf9"),marginBottom:"12px",marginTop:"4px",display:"flex",alignItems:"center",boxShadow:i?"0 2px 8px rgba(0, 0, 0, 0.15)":"0 1px 3px rgba(0, 0, 0, 0.1)"},icon:{fontSize:"20px",marginRight:"12px",color:i?"#90caf9":"#1976d2"},text:{color:i?"#e3f2fd":"#0d47a1",fontWeight:500,fontSize:"14px"},modelName:{fontWeight:600,color:i?"#bbdefb":"#1565c0"}};return(0,f.jsxs)("div",{style:l.container,children:[(0,f.jsx)("span",{style:l.icon,children:"\ud83d\udd04"}),(0,f.jsxs)("span",{style:l.text,children:["Model changed from ",(0,f.jsx)("span",{style:l.modelName,children:n})," to ",(0,f.jsx)("span",{style:l.modelName,children:t})]})]})},(e,n)=>(!e.changeKey||!n.changeKey||e.changeKey===n.changeKey)&&(e.previousModel===n.previousModel&&e.newModel===n.newModel&&e.changeKey===n.changeKey));k.displayName="ModelChangeNotification";const S=k;var I=t(8627),R=t(89277),z=t(26944);const N=(0,i.memo)(e=>{let{enableCodeApply:n,onOpenShellConfig:t}=e;const{currentMessages:r,editingMessageIndex:c,isTopToBottom:h,isLoadingConversation:u,addStreamingConversation:p,streamingConversations:x,currentConversationId:M,setIsStreaming:k,setStreamedContentMap:N,isStreaming:E,addMessageToConversation:K,removeStreamingConversation:T,streamedContentMap:F,userHasScrolled:O,updateProcessingState:_,setConversations:B,toggleMessageMute:W,recordManualScroll:D}=(0,l.v)(),{checkedKeys:L}=(0,a.X)(),H=(0,I.ot)(),Y=(0,i.useRef)(!0),P=(0,i.useMemo)(()=>({isCurrentlyStreaming:x.has(M),hasStreamedContent:F.has(M)&&""!==F.get(M),streamedContent:F.get(M)||""}),[x,F,M]),{isCurrentlyStreaming:q,hasStreamedContent:U}=P,X=(0,i.useRef)(!1),Q=(0,i.useRef)(null),V=(0,i.useRef)({});(0,i.useEffect)(()=>{var e;V.current={},null===(e=Q.current)||void 0===e||e.resetAfterIndex(0)},[r.length]);(0,i.useCallback)(e=>{var n,t,s,i,l;if(V.current[e])return V.current[e];const o=h?e:r.length-1-e,a=r[o];if(!a)return 100;const c=(null===(n=a.content)||void 0===n?void 0:n.length)||0;if("system"===a.role)return 60;if(null!==(t=a.content)&&void 0!==t&&t.includes("```diff")||null!==(s=a.content)&&void 0!==s&&s.includes("diff --git")){const e=a.content.split("\n").length;return Math.min(5e3,200+22*e)}if(null!==(i=a.content)&&void 0!==i&&i.includes("```")){const e=a.content.split("\n").length;return Math.min(3e3,180+20*e)}return null!==(l=a.content)&&void 0!==l&&l.includes("\x3c!-- TOOL_BLOCK")?Math.min(2e3,150+15*Math.floor(c/100)):Math.min(2e3,100+22*Math.floor(c/80))},[r,h]);const G=(0,i.useCallback)((e,n)=>{var t;V.current[e]!==n&&(V.current[e]=n,null===(t=Q.current)||void 0===t||t.resetAfterIndex(e))},[]),J=(0,i.useCallback)(e=>{const n=r[e];if(!n||"human"!==n.role)return!1;const t=e+1,s=t<r.length,i=s?r[t]:null;return!s||"assistant"!==(null===i||void 0===i?void 0:i.role)},[r]),Z=(0,i.useCallback)(e=>J(e)?(0,f.jsx)(d.A,{title:"The AI response may have failed. Click to retry.",children:(0,f.jsx)(m.Ay,{icon:(0,f.jsx)(C.A,{}),type:"primary",size:"small",onClick:async()=>{const n=r[e],t=document.querySelector(".chat-container");if(t){(h?t.scrollHeight-t.scrollTop-t.clientHeight<50:t.scrollTop<50)||(D(),console.log("\ud83d\udcdc Retry while scrolled away - position locked"))}p(M);try{const e=r.filter(e=>!e.muted);await(0,o.fu)(e,n.content,(0,g.F)(L||[]),M,F,N,k,T,K,x.has(M),e=>_(M,e))}catch(s){k(!1),T(M),console.error("Error retrying message:",s)}},children:"Retry AI Response"})}):null,[J,r,h,D,p,M,L,F,N,k,T,K,x,_]),$=(0,i.useCallback)(e=>{if(c===e)return null;const n=r[e];return J(e)?null:n&&"system"!==n.role?(0,f.jsx)(d.A,{title:n.muted?"Unmute (include in context)":"Mute (exclude from context)",children:(0,f.jsx)(m.Ay,{icon:n.muted?(0,f.jsx)(A.A,{}):(0,f.jsx)(w.A,{}),type:"default",size:"small",style:{padding:"0 8px",minWidth:"32px",height:"32px"},onClick:()=>{W(M,e)}})}):null},[c,r,J,W,M]),ee=(0,i.useCallback)(e=>{if(c===e)return null;const n=r[e];return J(e)?null:n&&"human"===n.role?q?null:(0,f.jsx)(d.A,{title:"Resubmit this question",children:(0,f.jsx)(m.Ay,{icon:(0,f.jsx)(C.A,{}),type:"default",size:"small",style:{padding:"0 8px",minWidth:"32px",height:"32px"},onClick:()=>{N(new Map);const t=r.slice(0,e+1),i=t.filter(e=>!e.muted);B(e=>e.map(e=>e.id===M?(0,s.A)((0,s.A)({},e),{},{messages:t,_version:Date.now()}):e)),p(M),(async()=>{try{await(0,o.fu)(i,n.content,(0,g.F)(L||[]),M,F,N,k,T,K,x.has(M),e=>_(M,e))}catch(e){k(!1),T(M),console.error("Error resubmitting message:",e)}})(),H("")}})}):null},[c,r,J,q,N,B,M,p,L,F,N,k,T,K,x,_,H]),ne=(0,i.useRef)(new Map);(0,i.useEffect)(()=>{ne.current.forEach((e,n)=>{if(e){const t=e.getBoundingClientRect().height;t>0&&G(n,t)}})});(0,i.useCallback)(e=>{let{index:i,style:l}=e;const o=h?i:r.length-1-i,a=r[o],d=o+1,m=d<r.length,g=m?r[d]:null;if(!a)return(0,f.jsx)("div",{style:l});const u="human"===a.role&&!q&&!U&&(o===r.length-1||m&&"assistant"!==(null===g||void 0===g?void 0:g.role));"system"===a.role&&a.modelChange?"".concat(a.modelChange.from,"->").concat(a.modelChange.to):a.content;return(0,f.jsx)("div",{ref:e=>{e&&ne.current.set(i,e)},style:(0,s.A)((0,s.A)({},l),{},{overflow:"visible"}),className:"message ".concat(a.role||"").concat(a.muted?" muted":"").concat(u?" needs-response":""),children:"system"===a.role&&a.modelChange?(0,f.jsx)(S,{previousModel:a.modelChange.from,changeKey:a.modelChange.changeKey,newModel:a.modelChange.to}):a.content?(0,f.jsxs)(f.Fragment,{children:["human"===a.role&&(0,f.jsxs)("div",{style:{display:c===o?"none":"flex",justifyContent:"space-between"},children:[(0,f.jsx)("div",{className:"message-sender",children:"You:"}),(0,f.jsxs)("div",{style:{display:"flex",gap:"8px",alignItems:"center",marginRight:"8px"},children:[$(o),ee(o),u&&Z(o),(0,f.jsx)(y,{index:o,isInline:!0})]})]}),"human"===a.role&&c===o?(0,f.jsx)(y,{index:o,isInline:!1}):"human"===a.role&&a.content?(0,f.jsxs)(f.Fragment,{children:[a.images&&a.images.length>0&&(0,f.jsx)("div",{style:{marginBottom:"12px",display:"flex",gap:"8px",flexWrap:"wrap"},children:a.images.map((e,n)=>(0,f.jsxs)("div",{style:{position:"relative",display:"inline-block"},children:[(0,f.jsx)(v.A,{src:"data:".concat(e.mediaType,";base64,").concat(e.data),alt:e.filename||"Attached image",width:120,height:120,style:{objectFit:"cover",borderRadius:"4px",border:"1px solid #d9d9d9"},preview:{mask:(0,f.jsx)(b.A,{})}}),e.filename&&(0,f.jsx)("div",{style:{fontSize:"11px",textAlign:"center",marginTop:"4px",maxWidth:"120px",overflow:"hidden",textOverflow:"ellipsis"},children:e.filename})]},n))}),(0,f.jsx)("div",{className:"message-content",children:(0,f.jsx)(z.MarkdownRenderer,{markdown:a.content,enableCodeApply:n,onOpenShellConfig:t,isStreaming:E||x.has(M)})})]}):"assistant"===a.role&&a.content?(0,f.jsxs)(f.Fragment,{children:[(0,f.jsxs)("div",{style:{display:"flex",justifyContent:"space-between"},children:[(0,f.jsx)("div",{className:"message-sender",children:"AI:"}),(0,f.jsx)("div",{style:{display:"flex",gap:"8px",alignItems:"center",marginRight:"8px"},children:$(o)}),Z(o)]}),(0,f.jsx)("div",{className:"message-content",children:(0,f.jsx)(z.MarkdownRenderer,{markdown:a.content,enableCodeApply:n,onOpenShellConfig:t,isStreaming:E||x.has(M)})})]}):null]}):null},"message-".concat(a.id||o))},[r,h,q,U,c,$,ee,Z,n,E,x,M,G]);const te=h?r:[...r].reverse(),se=(0,i.useRef)(0),ie=(0,i.useRef)(new Set),le=(0,i.useRef)(new Set);(0,i.useCallback)(e=>F.has(e)&&""!==F.get(e),[F]);(0,i.useEffect)(()=>{Math.abs(r.length-se.current)>2&&((0,R.QU)()&&(0,R.cY)("Conversation messages updated:",{messageCount:r.length,previousCount:se.current,isVisible:Y.current,displayOrder:h?"top-down":"bottom-up"}),se.current=r.length);const e=new IntersectionObserver(e=>{e.forEach(e=>{Y.current=e.isIntersecting})},{threshold:.1});return()=>e.disconnect()},[h,r.length]),(0,i.useEffect)(()=>{const e=X.current?new Set([M]):new Set,n=(new Set(Array.from(x)),X.current),t=q;X.current=t;(x.size<e.size||n&&!t)&&(n&&!t?console.log("\u2705 Current conversation finished streaming"):x.size<e.size&&(console.log("\ud83d\udccc Background conversation finished - locking scroll position"),D()))},[q,x,M,D]),(0,i.useEffect)(()=>{const e=e=>{const{previousModel:n,newModel:t}=e.detail,s="".concat(n,"->").concat(t);le.current.has(s)||(le.current.add(s),n&&t&&K({role:"system",content:"Model changed from ".concat(n," to ").concat(t),modelChange:{from:n,to:t,changeKey:s}},M))};return window.addEventListener("modelChanged",e),()=>{le.current.clear(),ie.current.clear(),window.removeEventListener("modelChanged",e)}},[M,K]);const oe=u?r.length>0?"Loading messages (".concat(r.length," loaded)..."):"Loading conversation...":"",ae=u&&r.length>0,re=u&&0===r.length;return(0,f.jsxs)("div",{style:{position:"relative"},children:[re&&(0,f.jsx)("div",{style:{position:"fixed",top:"var(--header-height)",left:"var(--folder-panel-width)",right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:1e3},children:(0,f.jsx)(j.A,{size:"large",tip:oe})}),(0,f.jsxs)("div",{style:{opacity:u?.5:1,minHeight:"50px"},className:"conversation-messages-container",children:[ae&&(0,f.jsxs)("div",{style:{position:"sticky",top:0,backgroundColor:"rgba(0, 0, 0, 0.7)",color:"#fff",padding:"8px 16px",borderRadius:"4px",margin:"8px 0",display:"flex",alignItems:"center",gap:"8px",zIndex:1e3},children:[(0,f.jsx)(j.A,{size:"small"}),(0,f.jsx)("span",{children:oe})]}),(null===te||void 0===te?void 0:te.map((e,s)=>{const i=h?s:r.length-1-s,l=i+1,o=l<r.length,a=o?r[l]:null,d="human"===e.role&&!q&&!U&&(i===r.length-1||o&&"assistant"!==(null===a||void 0===a?void 0:a.role));"system"===e.role&&e.modelChange?"".concat(e.modelChange.from,"->").concat(e.modelChange.to):e.content;return(0,f.jsx)("div",{className:"message ".concat(e.role||"").concat(e.muted?" muted":"").concat(d?" needs-response":""),children:"system"===e.role&&e.modelChange?(0,f.jsx)(S,{previousModel:e.modelChange.from,changeKey:e.modelChange.changeKey,newModel:e.modelChange.to}):e.content?(0,f.jsxs)(f.Fragment,{children:["human"===e.role&&(0,f.jsxs)("div",{style:{display:c===i?"none":"flex",justifyContent:"space-between"},children:[(0,f.jsx)("div",{className:"message-sender",children:"You:"}),(0,f.jsxs)("div",{style:{display:"flex",gap:"8px",alignItems:"center",marginRight:"8px"},children:[$(i),ee(i),d&&Z(i),(0,f.jsx)(y,{index:i,isInline:!0})]})]}),"human"===e.role&&c===i?(0,f.jsx)(y,{index:i,isInline:!1}):"human"===e.role&&(e.content||e.images&&e.images.length>0)?(0,f.jsxs)(f.Fragment,{children:[e.images&&e.images.length>0&&(0,f.jsx)("div",{style:{marginBottom:"12px",display:"flex",gap:"8px",flexWrap:"wrap"},children:e.images.map((e,n)=>(0,f.jsxs)("div",{style:{position:"relative",display:"inline-block"},children:[(0,f.jsx)(v.A,{src:"data:".concat(e.mediaType,";base64,").concat(e.data),alt:e.filename||"Attached image",width:120,height:120,style:{objectFit:"cover",borderRadius:"4px",border:"1px solid #d9d9d9"},preview:{mask:(0,f.jsx)(b.A,{})}}),e.filename&&(0,f.jsx)("div",{style:{fontSize:"11px",textAlign:"center",marginTop:"4px",maxWidth:"120px",overflow:"hidden",textOverflow:"ellipsis"},children:e.filename})]},n))}),e.content&&(0,f.jsx)("div",{className:"message-content",children:(0,f.jsx)(z.MarkdownRenderer,{markdown:e.content,enableCodeApply:n,onOpenShellConfig:t,isStreaming:E||x.has(M)})})]}):"assistant"===e.role&&e.content?(0,f.jsxs)(f.Fragment,{children:[(0,f.jsxs)("div",{style:{display:"flex",justifyContent:"space-between"},children:[(0,f.jsx)("div",{className:"message-sender",children:"AI:"}),(0,f.jsx)("div",{style:{display:"flex",gap:"8px",alignItems:"center",marginRight:"8px"},children:$(i)}),Z(i)]}),(0,f.jsx)("div",{className:"message-content",children:(0,f.jsx)(z.MarkdownRenderer,{markdown:e.content,enableCodeApply:n,onOpenShellConfig:t,isStreaming:E||x.has(M)})})]}):null]}):null},"message-".concat(e.id||s))}))||null,(!te||0===te.length)&&(0,f.jsx)("div",{style:{textAlign:"center",padding:"2rem",color:"#999"},children:"No messages in this conversation yet."})]})]})},(e,n)=>e.enableCodeApply===n.enableCodeApply);N.displayName="Conversation";const E=N}}]);
//# sourceMappingURL=46265.0c803805.chunk.js.map